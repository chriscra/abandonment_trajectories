---
title: "Red List"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

This is my starter markdown document trying to figure out how to use the `rredlist` package (see here: https://github.com/ropensci/rredlist). Seems like I'm able to download species records via rl_sp()...but only in groups of 10,000. Though, this wouldn't take all that long to do with a for loop for all species, right? I can also download by country.

If I want the details of each assessment, I can download those using `rl_narrative()`, using the ID of each species.

See here for more resources on how to use the IUCN Red List API: https://apiv3.iucnredlist.org/api/v3/docs



```{r}
install.packages("rredlist")
library(rredlist)


# token: 31df6b731b3beddd8ae51206fc1861b0f8b264ea14f2c4fce7edf0d0f1254d1a

IUCN_REDLIST_KEY <- "31df6b731b3beddd8ae51206fc1861b0f8b264ea14f2c4fce7edf0d0f1254d1a"

rl_citation(key = IUCN_REDLIST_KEY)
rl_version(key = IUCN_REDLIST_KEY)
rl_sp_count(key = IUCN_REDLIST_KEY)

kiribati <- rl_sp_country(country = "KI", key = IUCN_REDLIST_KEY)
kiribati

rl_countries(key = IUCN_REDLIST_KEY)

test <- rl_sp(page = 3, key = IUCN_REDLIST_KEY)

test$result %>% as_tibble()

f_arctica <- rl_search('Fratercula arctica', key = IUCN_REDLIST_KEY)

f_arctica$result[, "scientific_name"]

# download the narrative assessment information (same as the stuff in the spreadsheet titled: "assessments")
bass <- rl_narrative(id = 1078, key = IUCN_REDLIST_KEY)
bass$result %>% as_tibble()

bass$result$conservationmeasures
```


```{r for-loop}
redlist <- test$result[0,]
names(redlist)

rl_sp_count(key = IUCN_REDLIST_KEY)
118677/10000

redlist <- data.frame(matrix(ncol = 12))
names(redlist) <- c("taxonid", "kingdom_name", "phylum_name", "class_name", "order_name", "family_name", "genus_name", "scientific_name", "infra_rank", "infra_name", "population", "category")

redlist_l <- vector(mode = "list", length = 12)

for (i in 0:11) {
  temp <- rl_sp(page = i, key = IUCN_REDLIST_KEY)
  redlist_l[[i+1]] <- temp$result
  Sys.sleep(4)
}
redlist <- do.call("rbind", redlist_l)
object_size(redlist)
nrow(redlist)
as_tibble(redlist)

118677 * 2 / 60 / 60

redlist %>% names
redlist$category %>% table

tic()
nar <- rl_narrative(id = 18, key = IUCN_REDLIST_KEY)
Sys.sleep(2)
toc() # 4.776 seconds

# number of threatened species: 32,418
redlist %>% filter(category %in% c("CR", "EN", "VU")) %>% nrow()

32418 * 5 / 60 / 60 # 45 hours to download the data. 
# alternatively, you can do this on the cluster, in parallel.

fwrite(redlist, file = "/Users/christophercrawford/Google Drive/_Projects/data/Bd/IUCN_RedList/redlist_2020_06_24.csv")

redlist <- fread(file = "/Users/christophercrawford/Google Drive/_Projects/data/Bd/IUCN_RedList/redlist_2020_06_24.csv")

redlist
```

