---
title: "Trajectories of Abandonment and Biodiversity, start document"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
Repository for work to investigate the trajectories of abandoned agricultural land, and implications for biodiversity

```{r initialize}
source("scripts/0_start.R")
```

```{r load-rasters}
# Land use class codes:
#       1. Non-vegetated area (e.g. water, urban, barren land)
#       2. Woody vegetation
#       3. Cropland 
#       4. Herbaceous land (e.g. grassland)

bsmall <- brick(paste0(p_dat, "/Abandonment/belarus_small.tif"))
plot(bsmall)
dt_bsmall <- as.data.table.raster(bsmall)
object_size(dt_bsmall)

b87_r <- raster("/Users/christophercrawford/Google Drive/_Projects/data/Abandonment/belarus_1987.tif")

b88_r <- raster("/Users/christophercrawford/Google Drive/_Projects/data/Abandonment/belarus_1988.tif")

extent(b87_r)
extent(b88_r)
ncell(b87_r)
ncell(b88_r)

dt_b87 <- as.data.table.raster(b87_r)
dt_b88 <- as.data.table.raster(b88_r)
object_size(dt_b87)
object_size(dt_b88)
b <- merge(dt_b87, dt_b88, by = c("x","y"), sort = FALSE)

object_size(b)
((object_size(bs) - object_size(dt_b88))/2)*30


bs <- b[belarus_1987 > 0]

bs[, sum := (belarus_1987 + belarus_1988)]


names(b)[3] <- "y1988"

object_size(belarus_1988)

plot(belarus_1988, main = "Belarus 1988")

hist(belarus_1988, main = "Belarus 1988 distribution of values")
cellStats(belarus_1988, stat = "min") # 1
cellStats(belarus_1988, stat = "max") # 4


belarus_1988

b[, .N]
b[y1988 == 2, ][, .(value = 2, count = .N)]
b[y1988 == 2, ][, sum(y1988)]
b[, sum(y1988)]

hist(b[, 3])

b_counts <- b[, .(count = .N), by = y1988]

barplot(data = b_counts, count ~ y1988)
```

```{r plot-trajectory-per-pixel}
plot(dt_bsmall[1, ])

dt_bsmall[1, -c(1,2)] %>% as.data.frame() %>% plot()
year <- c(1987:2017)
dt_bsmall[1:5, -c(1,2)]
dt_bsmall[1, -c(1,2)] %>% as.matrix()
sub <- dt_bsmall[1:10, -c(1,2)]
names(sub) <- gsub("smolensk", "", names(sub))
 
sub <- sub[, pixel := c(1:10)]

sub_melt <- melt(sub, id.vars = "pixel", variable.name = "year", value.name = "land_use", na.rm = TRUE)

ggplot(data = sub_melt) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  geom_line(mapping = aes(x = year, y = land_use, group = pixel, color = land_use), 
            size = 2) +
  facet_grid(rows = vars(pixel), scales = "free_x", switch = "x") + 
  ylim(1, 4)

#       1. Non-vegetated area (e.g. water, urban, barren land)
#       2. Woody vegetation
#       3. Cropland 
#       4. Herbaceous land (e.g. grassland)



plot(as.matrix(dt_bsmall[1:5, -c(1,2)]))
as.matrix(dt_bsmall[1:5, -c(1,2)])



test <- as.matrix(dt_bsmall[1:5, -c(1,2)])
dat <- t(test)

as.matrix(dt_bsmall[1, -c(1,2)])[1:31]
df <- data.frame(
  year = year,
  "land_use" = as.matrix(dt_bsmall[1, -c(1,2)])[1:31]
)


ggplot(data = dat) +
  geom_line(mapping = aes(x = facet, y = mean_jac_w, color = weight))

colnames(test) <- 1987:2017

plot(df)
t(test)
```

```{r rs-timeseries}
library(raster)

# Create test matrices with value of 1 for agriculture and 2 for non-agriculture
mat1 <- matrix(rep(1, 9), nrow = 3, ncol = 3)
mat2 <- matrix(c(rep(1, 3), 2, 2, 1), nrow = 3, ncol = 3)
mat3 <- matrix(c(rep(1, 3), 2, 1, 1), nrow = 3, ncol = 3)

# Create raster stack, with one raster for each year
rastStack <- stack(raster(mat1),
                   raster(mat2),raster(mat2),
                   raster(mat1),
                   raster(mat2), raster(mat3), 
                   raster(mat1))
# Name the years
yrs <- 1:nlayers(rastStack)
names(rastStack) <- paste("yr", yrs, sep = "")

# Have a look
# yr2 -> two cells change to non-agriculture
# yr4 -> the two cells change back to agriculture
# yr5 -> the same two cells change to non-agriculture
# yr6 -> one of the two cells changes back to agriculture
# yr7 -> the other cell also changes back to agriculture
plot(rastStack)

# Sequential difference between years
# value of 0 = no difference compared to previous year
# value of 1 = change from agriculture to non-agriculture
# value of -1 = change from non-agriculture to agriculture
running_diff <- calc(rastStack, fun = diff)

# Multiply by the year to record the year in which change took place
running_diff2 <- running_diff * yrs[-1]

# Identify years with zero change
minVals <- minValue(running_diff2)
maxVals <- maxValue(running_diff2)
nochange <- running_diff2[[which(maxVals == 0 & minVals == 0)]]

# For each cell, we now know the year in which it changed from agriculture to 
# non-agriculture and (potentially) back to agriculture, from which we can calculate
# the number of non-agriculture periods and total time as non-agriculture

# Number non-agriculture periods = number years (bands) where cell value is positive
noncrop_count <- sum(running_diff2 > 0)
# Number agriculture reversions = number years (bands) where cell value is negative
crop_count <- sum(running_diff2 < 0)

# Convert original stack to binary -> 1 if non-agriculture, 0 if agriculture
rastStack_bi <- rastStack
rastStack_bi[rastStack_bi == 1] <- 0
rastStack_bi[rastStack_bi == 2] <- 1
# Total time as non-agriculture = sum across years
noncrop_duration <- calc(rastStack_bi, fun = sum)

# Average length of time as non-agriculture = total duration / N non-crop periods
noncrop_duration_avg <- noncrop_duration / noncrop_count
plot(noncrop_duration_avg)

# cell 2 [1,2] changes from agriculture in 2001, back to agriculture in 2003 = 2 years
# cell 2 [1,2] changes from agriculture in 2004, back to agriculture in 2006 = 2 years
# cell 2 [1,2] total time = 4 years; avg time = 4 years / 2 periods = 2 years

# cell 5 [2,2] changes from agriculture in 2001, back to agriculture in 2003 = 2 years
# cell 5 [2,2] changes from agriculture in 2004, back to agriculture in 2005 = 1 year
# cell 5 [2,2] total time = 3 years; avg time = 3 years / 2 periods = 1.5 years

```


```{r time-series}
bsmall
dt_bsmall

```


```{r dt-testing}
library(data.table)
set.seed(1L)
test
## Create a data table
DT <- data.table(V1 = rep(c(1L, 2L), 5)[-10],
                V2 = 1:9,
                V3 = c(0.5, 1.0, 1.5),
                V4 = rep(LETTERS[1:3], 3))

class(DT)
DT

DT[V1 == 1]

DT[, sum(V1)]
```



```{r animate}
# https://www.rdocumentation.org/packages/raster/versions/3.1-5/topics/animate

bsmall

animate(bsmall, pause=0.25, main = "smolensk", zlim = c(1, 4), maxpixels=5000, n=2)

```


```{python}
x = 'hello, python world!'
print(x.split(' '))

# DJ uses iPython

```


