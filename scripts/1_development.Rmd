---
title: "Trajectories of Abandonment and Biodiversity, start document"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
Repository for work to investigate the trajectories of abandoned agricultural land, and implications for biodiversity

```{r initialize}
source("scripts/0_start.R")
```

```{r load-rasters}

# Land use class codes:
#       1. Non-vegetated area (e.g. water, urban, barren land)
#       2. Woody vegetation
#       3. Cropland 
#       4. Herbaceous land (e.g. grassland)

bs <- brick(paste0(p_dat, "Abandonment/belarus_small.tif"))
plot(bs)
plot(bs$smolensk1987)
dt_bs <- as.data.table.raster(bs)


# update column names
names(dt_bs) <- gsub("smolensk", "y", names(dt_bs))
dt_bs

object_size(dt_bs)
nlayers(bs) # 31 years in the time series
ncol(dt_bs) # 31 years, plus x and y = 33.


# full landsat scene, but just for individual years
b87_r <- raster("/Users/christophercrawford/Google Drive/_Projects/data/Abandonment/belarus_1987.tif")
b88_r <- raster("/Users/christophercrawford/Google Drive/_Projects/data/Abandonment/belarus_1988.tif")

plot(b87_r)
plot(b88_r)
extent(b87_r)
extent(b88_r)
ncell(b87_r)
ncell(b88_r)

# as data.tables
dt_b87 <- as.data.table.raster(b87_r)
dt_b88 <- as.data.table.raster(b88_r)
object_size(dt_b87)
object_size(dt_b87[, .(x, y)])
object_size(dt_b87[, .(belarus_1987)]) # 378 MB approximately for each year.
object_size(dt_b87) + object_size(dt_b87[, .(belarus_1987)])*30 # this is an approximation of how large the full data.table of the full scene, as a data.table, would be. 
# 13.2 GB. This is huge. I'll have to come up with some better way to do this... 
# perhaps start by figuring this out in R, then transfer it to python, and then google earth. 

object_size(dt_b88)


dt_b87_88 <- merge(dt_b87, dt_b88, by = c("x","y"), sort = FALSE)
object_size(dt_b87_88)
object_size(dt_b87_88[, .(belarus_1987, belarus_1988)])


dt_b87_88_sub <- dt_b87_88[belarus_1987 > 0]

dt_b87_88_sub[, sum := (belarus_1987 + belarus_1988)]


names(dt_b87_88)[3] <- "y1988"

object_size(belarus_1988)

plot(belarus_1988, main = "Belarus 1988")

hist(belarus_1988, main = "Belarus 1988 distribution of values")
cellStats(belarus_1988, stat = "min") # 1
cellStats(belarus_1988, stat = "max") # 4


belarus_1988

dt_b87_88[, .N]
dt_b87_88[y1988 == 2, ][, .(value = 2, count = .N)]
dt_b87_88[y1988 == 2, ][, sum(y1988)]
dt_b87_88[, sum(y1988)]

hist(dt_b87_88[, 3])

dt_b87_88_counts <- dt_b87_88[, .(count = .N), by = y1988]

barplot(data = dt_b87_88_counts, count ~ y1988)
```

```{r rebecca-senior-time-series}
library(raster)

# Create test matrices with value of:
# 1 for agriculture and 
# 2 for non-agriculture
mat1 <- matrix(rep(1, 9), nrow = 3, ncol = 3)
mat2 <- matrix(c(rep(1, 3), 2, 2, 1), nrow = 3, ncol = 3)
mat3 <- matrix(c(rep(1, 3), rep(c(2, 1, 1), 2)), nrow = 3, ncol = 3)

# Create raster stack, with one raster for each year (randomly)
rastStack <- stack(raster(mat1),
                   raster(mat2), raster(mat2),
                   raster(mat1),
                   raster(mat2), raster(mat3), 
                   raster(mat1))

# Name the years
yrs <- 1:nlayers(rastStack)
names(rastStack) <- paste("yr", yrs, sep = "")

# Have a look
# yr2 -> two cells change to non-agriculture
# yr4 -> the two cells change back to agriculture
# yr5 -> the same two cells change to non-agriculture
# yr6 -> one of the two cells changes back to agriculture
# yr7 -> the other cell also changes back to agriculture
plot(rastStack)
plot(rastStack, breaks = c(-1, 0, 1, 2), col = c("gray", "yellow", "green"))

plot(rastStack, breaks = c(-1, 0, 1, 2), col = rev(terrain.colors(3)))
# 1 = brown, agriculture
# 2 = green, non-agriculture


# Sequential difference between years
# value of 0 = no difference compared to previous year (brown)
# value of 1 = change from agriculture to non-agriculture (green)
# value of -1 = change from non-agriculture to agriculture (gray)
running_diff <- calc(rastStack, fun = diff)
plot(rastStack, breaks = c(-1, 0, 1, 2), col = rev(terrain.colors(3)))
plot(running_diff, breaks = c(-2, -1, 0, 1), col = c("#ECB176FF", # brown
                                                     "#F2F2F2FF", # gray
                                                     "#00A600FF" # green
                                                     ))

# FYI: base::diff() # calculates the differences between each entry in a vector, or in this case, differences between cells across multiple years: i.e. 1987 - 1988, 1989 - 1988, 1990 - 1989, 1991 - 1990, etc.

# Multiply by the year to record the year in which change took place (and whether it was ag -> non-ag [positive], or non-ag -> ag [negative])
running_diff2 <- running_diff * yrs[-1] 
plot(running_diff2)

# Identify years with zero change
minVals <- minValue(running_diff2) # this is the years in which at least one pixel changed from noncrop (2) to crop (1), therefore yielding a negative value. 
minVals

maxVals <- maxValue(running_diff2) # this simply tells you years in which at least one pixel changed from ag to non-ag.
maxVals
# note, this can capture years in which both types of transitions took place (year 6)
nochange <- running_diff2[[which(maxVals == 0 & minVals == 0)]] # which index is 0 in both maxVals and minVals? Subset the stack by that index
plot(nochange)
 
plot(running_diff2) # tells you the year (the absolute value of the cell), and the transition type (negative means non-ag to ag, positive means ag to non-ag) 

# For each cell, we now know the year in which it changed from agriculture to non-agriculture
# and (potentially) back to agriculture (from running_diff2), from which we can calculate
# the number of non-agriculture periods and total time as non-agriculture

# count the number of "transitions", i.e. number of times the cell switched from crop to noncrop
# Number non-agriculture transitions = number years (bands) where cell value is positive
noncrop_count <- sum(running_diff2 > 0)
# Number agriculture reversions = number years (bands) where cell value is negative
crop_count <- sum(running_diff2 < 0)

plot(running_diff2)
plot(noncrop_count)
plot(crop_count)


# Convert original stack to binary -> 1 if non-agriculture, 0 if agriculture
rastStack_bi <- rastStack
rastStack_bi[rastStack_bi == 1] <- 0
rastStack_bi[rastStack_bi == 2] <- 1
# Total time as non-agriculture = sum across years
noncrop_duration <- calc(rastStack_bi, fun = sum)
plot(noncrop_duration)
plot(calc(rastStack, fun = sum))

# Average length of time as non-agriculture = total duration / N non-crop periods
noncrop_duration_avg <- noncrop_duration / noncrop_count
plot(noncrop_duration_avg)

# cell 2 [1,2] changes from agriculture in 2001, back to agriculture in 2003 = 2 years
# cell 2 [1,2] changes from agriculture in 2004, back to agriculture in 2006 = 2 years
# cell 2 [1,2] total time = 4 years; avg time = 4 years / 2 periods = 2 years

# cell 5 [2,2] changes from agriculture in 2001, back to agriculture in 2003 = 2 years
# cell 5 [2,2] changes from agriculture in 2004, back to agriculture in 2005 = 1 year
# cell 5 [2,2] total time = 3 years; avg time = 3 years / 2 periods = 1.5 years

```

```{r plot-trajectory-per-pixel}

# subset the data.table, for plotting
sub <- dt_bs[1:10, -c(1,2)]
names(sub) <- gsub("y", "", names(sub))
sub[, pixel := c(1:10)]
sub

sub_melt <- melt(sub, id.vars = "pixel", 
                 variable.name = "year", 
                 value.name = "land_use", na.rm = TRUE)

sub_melt$year <- gsub("y", "", sub_melt$year)

str(sub_melt)
sub_melt <- as_tibble(sub_melt) %>%
  mutate(land_use = as_factor(land_use))

sub_melt
# this plot shows the land-use trajectories of 10 individual pixels.
gg_10_px_traj <- ggplot(data = sub_melt, 
                        mapping = aes(x = year, y = land_use, group = pixel)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  geom_line(mapping = aes(color = factor(land_use)), size = 2) +
  facet_grid(rows = vars(pixel), scales = "free_x", switch = "x") + 
  # scale_fill_gradient(low="red", high="yellow") +
  ylim(1, 4)

gg_10_px_traj
#       1. Non-vegetated area (e.g. water, urban, barren land)
#       2. Woody vegetation
#       3. Cropland 
#       4. Herbaceous land (e.g. grassland)

gg_10_px_traj + scale_colour_manual(values = c("orange", "red", "blue", "green"))
lc_cols <- c("dark")
terrain.colors(4)
show_col(terrain.colors(9))
terrain.colors(9)[5]

gg_10_px_traj + lc_cols
lc_cols <- scale_color_manual(name = "Land Cover Classes",
                     labels = c("1" = "1. Non-veg",
                                "2" = "2. Woody veg",
                                "3" = "3. Crop",
                                "4" = "4. Grassland"),
                     values = c("1" = "gray80",
                                "2" = terrain.colors(9)[1], # dark green
                                "3" = terrain.colors(9)[5], # gold
                                "4" = terrain.colors(9)[3] # light green
                                )
                     ) 
```

```{r data.table-time-series}
dt_bs

gg_10_px_traj

```


```{r dt-testing}
library(data.table)
set.seed(1L)
test
## Create a data table
DT <- data.table(V1 = rep(c(1L, 2L), 5)[-10],
                V2 = 1:9,
                V3 = c(0.5, 1.0, 1.5),
                V4 = rep(LETTERS[1:3], 3))

class(DT)
DT

DT[V1 == 1]

DT[, sum(V1)]
```



```{r animate}
# https://www.rdocumentation.org/packages/raster/versions/3.1-5/topics/animate

bs

animate(bs, pause = 1, main = "smolensk", zlim = c(1, 4), maxpixels=5000, n=2)

```



