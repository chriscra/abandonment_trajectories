---
title: "The impermanence of cropland abandonment limits potential for environmental benefits (draft)"
author: Christopher L. Crawford,$^a$$^*$ He Yin,$^b$ Volker Radeloff,$^c$ and David S. Wilcove$^{a, d}$
date: "`r format(Sys.time(), '%B %d, %Y')`"
abstract: |
  | $^a$Princeton School of Public and International Affairs, Princeton University, Princeton, NJ
  | $^b$Department of Geography, Kent State University, Kent, OH
  | $^c$Department of Forest & Wildlife Ecology, University of Wisconsin - Madison, Madison, WI
  | $^d$Department of Ecology & Evolutionary Biology, Princeton University, Princeton, NJ
  |
  | $^*$Corresponding Author, ccrawford@princeton.edu, Robertson Hall, Princeton University, Princeton, NJ
output:
  bookdown::word_document2:
    reference_docx: /Users/christophercrawford/Google_Drive/_Projects/writing/scripts/word_style_ref.docx
    number_sections: false
  bookdown::pdf_document2: 
    keep_tex: true
  bookdown::html_document2:
    toc: true
editor_options:
  chunk_output_type: console
bibliography: [/Users/christophercrawford/Google_Drive/Library/library.bib, packages.bib]
nocite: |
  @RStudio, @R-rmarkdown, @R-bookdown, @R-knitr
header-includes:
  \newcommand{\beginsupplement}{\setcounter{figure}{0} \setcounter{section}{0} \setcounter{table}{0} \setcounter{equation}{0} \renewcommand{\thefigure}{S\arabic{figure}} \renewcommand{\thesection}{S\arabic{section}} \renewcommand{\thetable}{S\arabic{table}} \renewcommand\theequation{S\arabic{equation}}}
---
```{r preview-chapter, eval=FALSE, include = FALSE}
rmarkdown::render("scripts/abn_trajectories_ms.Rmd",
                  output_file = paste0(p_proj, "writing/previews/", "abn_duration_draft", format(Sys.Date(), ("_%Y_%m_%d")), ".docx"))


# Save PDF with SI for linking below:
rmarkdown::render("scripts/abn_trajectories_ms.Rmd",
                  output_file = paste0(p_proj, "writing/previews/", "abn_duration_draft_w_SI.pdf"),
                  output_format = "bookdown::pdf_document2")

# bookdown::preview_chapter(
#   input = "abn_trajectories_ms.Rmd",
#   output_format = "bookdown::word_document2",
#   output_file = paste0("abn_duration_draft", format(Sys.Date(), ("_%Y_%m_%d")), ".docx"),
#   output_dir = paste0(p_proj, "writing/previews"),
#   output_options = 
#     list(reference_docx = "/Users/christophercrawford/Google_Drive/_Projects/writing/scripts/word_style_ref.docx"),
#   preview = TRUE)
```

```{r set-chunk-opts, include = FALSE}
# set default chunk options
knitr::opts_chunk$set(
  # out.width = "1\\textwidth",  # if compiling a pdf, include this option
  # comment = NA,
  # fig.width=6, fig.height=6, 
  echo = FALSE # the code itself will NOT be printed with results
  )
```
```{r load-packages-functions, eval = TRUE, echo = FALSE, include = FALSE}
source("/Users/christophercrawford/Google_Drive/_Projects/abandonment_trajectories/scripts/0_start.R")
source(paste0(p_proj, "scripts/util/_util_master.R"))
# devtools::install_github("benmarwick/wordcountaddin", type = "source", dependencies = TRUE)
```

```{r produce-package-bib, include = FALSE, eval = FALSE}
needed_packages
github_packages
knitr::write_bib(x = c(needed_packages, github_packages), file = 'packages.bib')
knitr::write_bib(x = c("car"), file = 'extra.bib')

citation(package = needed_packages[1])

# knitr::write_bib(x = c(needed_packages[c(14)]), file = 'packages_top.bib')

needed_packages[1]
packageDescription(needed_packages[1])
```

```{r load-files, include = FALSE}
# set run:
run_label <- "_2021_03_13"

# Additional paths --------------------------------------------------- #
p_plots <- "/Users/christophercrawford/Google_Drive/_Projects/abandonment_trajectories/output/plots/"

# load general spatial data on site locations --------------------------------------------------- #
site_df <- read.csv(file = paste0(p_dat_derived, "site_df.csv"))
site_df_w_size <- read.csv(file = paste0(p_dat_derived, "site_df_w_size.csv"))
site_sf <- st_read(paste0(p_dat_derived, "site_sf.shp"))


# load all length data (distilled)
length_distill_df <- read_csv(file = paste0(p_dat_derived, run_label, "/", 
                                            "length_distill_df", run_label, ".csv"))

# load mean length data
mean_length_df <- read_csv(file = paste0(p_dat_derived, run_label, "/", "mean_length_df", run_label, ".csv"))

# load summary statistic derived from lengths
summary_stats_all_sites <- read_csv(file = paste0(p_dat_derived, run_label, "/", "summary_stats_all_siteS", run_label, ".csv"))
summary_stats_all_sites_pooled <- read_csv(file = paste0(p_dat_derived, run_label, "/", "summary_stats_all_sites_pooled", run_label, ".csv"))

# load area summary stats:
area_summary_df <- read_csv(file = paste0(p_dat_derived, run_label, "/", "area_summary_df", run_label, ".csv"))
area_recult_threshold <- read_csv(file = paste0(p_dat_derived, run_label, "/", "area_recult_threshold", run_label, ".csv"))


# load stats on proportion of abandoned cropland by land cover
abn_lc_count_2017 <- read_csv(file = paste0(p_dat_derived, run_label, "/", "abn_lc_count_2017", run_label, ".csv"))
abn_prop_lc_2017 <- read_csv(file = paste0(p_dat_derived, run_label, "/", "abn_prop_lc_2017", run_label, ".csv"))


# load combined persistence, area, and turnover datasets:
persistence_dat <- read_csv(file = paste0(p_dat_derived, "abn_decay_data", run_label, ".csv")) %>%
  mutate(site = as.factor(site),
         bins = as.factor(bins),
         year_abn_bins = as.factor(year_abn_bins),
         cohort = as.factor(cohort))

area_dat <- read_csv(file = paste0(p_dat_derived, "area_dat", run_label, ".csv"))
turnover_dat <- read_csv(file = paste0(p_dat_derived, "turnover_dat", run_label, ".csv"))



# load decay rate data
load(file = paste0(p_dat_derived, run_label, "/decay_mod_coef_dfs.rds"), 
     verbose = TRUE)

# load extrapolation data
extrapolate_df_l3 <- read_csv(file = paste0(p_dat_derived, run_label, "/extrapolate_df_l3", run_label, ".csv"))


# load data for shaanxi maps --------------------------------------------------- #

# load data for decay models --------------------------------------------------- #
fitted_df_l3 <- read_csv(file = paste0(p_dat_derived, run_label, "/decay_mod_fitted_df_l3", run_label, ".csv"))

load(file = paste0(p_dat_derived, run_label, "/decay_mod_coef_dfs.rds"), verbose = TRUE)
# contains:
# coef_df_l3, coef_df_wide_l3, mean_coef_df_l3, mean_coef_df_wide_l3, mean_coef_proj_l3, time_to_l3


# load extrapolation data
extrapolate_df_l3 <- read_csv(file = paste0(p_dat_derived, run_label, "/extrapolate_df_l3", run_label, ".csv"))
```

```{r misc-YAML, eval = FALSE}

# 
# - $^a$Princeton School of Public and International Affairs, Princeton University, Princeton, NJ
# - $^b$Department of Geography, Kent State University, Kent, OH
# - $^c$Department of Forest & Wildlife Ecology, University of Wisconsin - Madison, Madison, WI
# - $^d$Department of Ecology & Evolutionary Biology, Princeton University, Princeton, NJ
# 

# date: '`r format(Sys.Date(), "%B %d, %Y")`'
# 
# - Christopher L. Crawford^[Corresponding Author, ccrawford@princeton.edu, Robertson
#   Hall, Princeton University, Princeton, NJ] ^[Princeton University]
# - He Yin^[Kent State University]
# - Volker Radeloff^[University of Wisconsin, Madison]
# - David S. Wilcove^[Princeton University]

# author:
# - Christopher L. Crawford^[Corresponding Author, ccrawford@princeton.edu, Robertson Hall, Princeton University, Princeton, NJ] $^1$
# - He Yin$^2$
# - Volker Radeloff$^3$
# - David S. Wilcove$^{1, 4}$
# date: 
#   $^1$Princeton School of Public and International Affairs, Princeton University, Princeton, NJ \newline 
#   $^2$Department of Geography, Kent State University, Kent, OH \newline 
#   $^3$Department of Forest & Wildlife Ecology, University of Wisconsin - Madison, Madison, WI \newline 
#   $^4$Department of Ecology & Evolutionary Biology, Princeton University, Princeton, NJ
```

```{r rmd-tips}
# Reference sections by including a tag directly after a header, such as {#section-label}, and then reference in line with the following:
# See Section \@ref(section-label)


# figures:
# this is a chunk for including a pre-existing plot or graphic.
#knitr::include_graphics("/Users/christophercrawford/Google_Drive/_Projects/Zambia/agroEcoTradeoff/external/plots/Estes-plots_test.png")

# Figure captions:
# https://bookdown.org/yihui/rmarkdown-cookbook/cross-ref.html

# manually write figure captions outside of chunk with the following
# (ref:caption-label) Figure caption text.

# Chunk options:
# include = FALSE - this means that the code will still be evaluated, but none of the output will be included in the resulting document.

# fig.cap = '(ref:caption-label)' in the chunk options

# cross reference in line with: \@ref(fig:chunk-label) (or eq:label, or tab:label)

# can also include a list of figures by including the following in the YAML
# lof: True
# or, as I currently have it.
# \listoffigures

```

```{r get-summary-stats, include = FALSE}
summary_stats_all_sites
extrapolate_df_l3


abn_duration_stats <- list(
  mean_duration = summary_stats_all_sites$mean_of_means %>% round(digits = 2),
  sd_duration = summary_stats_all_sites$mean_of_sds %>% round(digits = 2),
  
  extrapolation_low = extrapolate_df_l3 %>% select(site, max_mean_age) %>% unique() %>% arrange(max_mean_age) %>% .$max_mean_age %>% .[1] %>% round(digits = 1),
  extrapolation_high = extrapolate_df_l3 %>% select(site, max_mean_age) %>% unique() %>% arrange(max_mean_age) %>% .$max_mean_age %>% .[9] %>% round(digits = 1),
  
  duration_min = mean_length_df %>% 
    filter(abn_threshold == 5, length_type == "all") %>% 
    slice_min(mean_duration) %>% 
    select(mean_duration) %>% round(digits = 2),
  
  duration_min_site = mean_length_df %>% 
    filter(abn_threshold == 5, length_type == "all") %>% 
    slice_min(mean_duration) %>% .$site %>% capwords(),
  
  duration_max = mean_length_df %>% 
    filter(abn_threshold == 5, length_type == "all") %>% 
    slice_max(mean_duration) %>% 
    select(mean_duration) %>% round(digits = 2),
  
  duration_max_site = mean_length_df %>% 
    filter(abn_threshold == 5, length_type == "all") %>% 
    slice_max(mean_duration) %>% .$site %>% gsub("_", " & ",.) %>% capwords(),
  
  sd_min = mean_length_df %>% filter(abn_threshold == 5, length_type == "all") %>% slice_min(sd_duration) %>% select(sd_duration) %>% round(digits = 2),
  
  sd_min_site = mean_length_df %>% filter(abn_threshold == 5, length_type == "all") %>% slice_min(sd_duration) %>% .$site %>% capwords(),
  
  sd_max = mean_length_df %>% filter(abn_threshold == 5, length_type == "all") %>% slice_max(sd_duration) %>% select(sd_duration) %>% round(digits = 2),
  sd_max_site = mean_length_df %>% filter(abn_threshold == 5, length_type == "all") %>% slice_max(sd_duration) %>% .$site %>% gsub("_", " ",.) %>% capwords()
)
```

```{r pnas-formatting}
# https://www.pnas.org/authors/submitting-your-manuscript
# PNAS direct submission articles are usually about 4000 words with 50 references and 4 figures (though there is some variation and flexibility). The format follows: Intro, Results (possibly with sections), Discussion, Materials & Methods, Acknowledgements, References (in order they are cited). Though submissions are “format neutral” at the start, it doesn’t seem too difficult to format to match this from the start. 
# Some recent relevant articles in PNAS: Rudel et al. 2009, Wright & Wimberly 2013, Norden et al. 2015, Lambin & Meyfroidt 2011, Griscom et al. 2017, Nerlekar & Veldman 2020.

```


# Abstract
*Must be <250 words (currently 238)*

Agricultural expansion is a major cause of land-use change globally, but millions of hectares of cropland are being abandoned as a result of demographic, economic, and environmental changes.
These abandoned croplands could be immensely valuable for carbon sequestration and biodiversity restoration.
However, their environmental value depends on the duration and persistence of abandonment, which is poorly known.
Here, we use high-resolution satellite imagery to examine the timing and duration of abandonment at eleven sites across four continents that experienced cropland abandonment from 1987 and 2017.
We find that abandonment is by and large fleeting, lasting on average only `r abn_duration_stats$mean_duration` years (SD = `r abn_duration_stats$sd_duration`).^[*Note: both values reported are the means of each site's corresponding summary statistics, i.e. the mean of means and mean of standard deviations*]
At most sites, more than 50% of abandoned croplands were projected to be recultivated within 30 years, and some sites, particularly in Eastern Europe, Russia, and the US, showed accelerating rates of recultivation.
If current rates of abandonment continue, the mean duration of abandonment at most sites will likely plateau between `r abn_duration_stats$extrapolation_low` and `r abn_duration_stats$extrapolation_high` years by about 2040.
Counter to optimistic assumptions, most abandonment is unlikely to be permanent and will produce little in the way of benefits for carbon or biodiversity.
New policies and incentives will be needed to lengthen the period of abandonment so as to generate these and other benefits.
Until then, abandoned croplands will remain untapped opportunities.

## Significance Statement
*Must be <120 words (currently 121)*

Demographic, economic, and environmental changes often result in cropland abandonment. 
While sometimes seen as a threat to food security and cultural landscapes, abandonment is increasing billed as an opportunity for habitat restoration and carbon sequestration.
However, those environmental benefits largely depend on how long ecosystems can regenerate in abandoned croplands and accumulate carbon and biodiversity, which takes decades in many ecosystems.
Existing studies often rely on single snapshots in time to estimate abandonment, and ignored recultivation.
Using annual land-cover maps, we track abandonment and recultivation at eleven sites across four continents that have recently experienced abandonment.
Contrary to previous assumptions, abandonment is short-lived and lands are frequently recultivated.
Until policymakers take steps to reduce recultivation, abandonment will remain a missed opportunity.

## Keywords

# Introduction

Populations are in flux around the world, as people seek new economic opportunities in cities and flee changing environments and conflicts.
Coupled with environmental changes and other factors that render some agricultural lands economically inviable, this rural outmigration has contributed to a growing global trend of agricultural abandonment.
In a world with increasing competition for land, abandoned agricultural lands are highly sought after for diverse goals such as increased cultivation, biofuel production, and carbon sequestration; to conservation scientists, this land represents a potentially large source of new habitat for wildlife as vegetation regenerates.

However, understanding agricultural abandonment and its potential impacts on biodiversity requires not only detailed information on where and how abandonment is taking place, but critically, what happens to abandoned lands after they are abandoned.
Most estimates of abandonment are either inferred from aggregated estimates of regional cultivation (e.g. from FAO data on cultivated area; [@Isbell2019; @Munroe2013]), or from estimates of the gross area abandoned in a given year [@Lark2015].
Both approaches lack spatial and temporal detail on the trajectories taken by individual pieces of land, which is critical for understanding the environmental implications of abandonment [@Yin2020].

Recent efforts to quantify the potential for biofuel production in abandoned agricultural lands present a good example. 
Most of these studies use two snapshots in time, estimating abandoned lands as those in agriculture in the early time step and non-agriculture in the later time step. 
For example, @Naess2021 use land cover maps from the ESA-CCI from 1992 and 2015, identifying 83 million hectares of abandoned cropland globally. 
They also review a range of similar estimates of abandonment that differ in geography and time scale, but all share a similar challenge: estimates of abandonment at a particular instant in time may represent significant overestimates as a result of dynamic patterns of abandonment and recultivation. 
Key papers they cite are: @Ramankutty1999 (207 Mha), @Campbell2008 (286 Mha), @Estel2015, @Li2018, @Alcantara2013, @Yu2018, @Yu2019.

```{r include = FALSE}
# *Need: read through papers, sort out my contribution.*
# Insert context based on papers by @Estel2015 (recultivation, timing), @Estel2018, @Dara2018 (timing, recultivation, northern Kazakhstan), @Alcantara2013, @Lesiv2018 (methods of mapping), @Smaliychuk2016 (recultivation, predictors, Ukraine), @Prishchepov2013 (predictors), @Baumann2011 (), @Pazur2020 (Slovakia), @Levers2018a (predictors), @PerpinaCastillo2021 (predictors, model), @Meyfroidt2016 (drivers, tradeoffs, recultivation, timing, Russia/Ukraine/Kazakhstan), @Crouzeilles2020 (Atlantic Forest, predictors)
```


Recent advances in satellite imagery-based mapping have made it possible to produce maps of agricultural abandonment with both high spatial resolution and temporal resolution, allowing us to ask questions about the timing and trajectories of agricultural abandonment.
Here, we utilize a new time-series of agricultural abandonment derived from publicly available Landsat imagery (1987-2017, 31 years) to investigate how long abandonment lasts, how abandoned lands "decay," and which factors seem to determine the length of abandonment and recultivation. 
Specifically, we ask the following questions:

1. How long is abandoned land typically abandoned for, and how does this differ across sites?
2. What do abandonment decay rates (recultivation rates) look like at each site, and how do these differ between sites and through time?
3. Finally, what factors are most important for determining which pieces of land remain abandoned for longer periods of time, and which lands are recultivated?

We use case studies of Brazil (2), the US (2), Southern & Eastern Europe (4), the Middle East (1), and China (2) to provide a better understanding of how these patterns vary across regions [@Yin2020] (see Figure \@ref(fig:site-locations)).

@Yin2020 established several methodological advances, including improvement in the mapping of 1) the timing of initial abandonment (year first abandoned), and 2) the abandonment rate (amount of abandoned land in a given year divided by the amount of agricultural land in either a) the previous year or b) the beginning of the time series). However, Yin et al. did not assess the persistence of abandonment (how long abandoned lands stay abandoned for), frequency and patterns of recultivation, spatial predictors of abandonment persistence and recultivation, patterns of fragmentation in the resulting landscape, nor the implications of these for biodiversity. (These last two are likely for a second paper.)

Previous studies of Costa Rica [@Reid2018] and the Amazon [@Nunes2020, @Smith2020] have focused on the persistence and timing of secondary forest growth and age (as identified by the presence of woody vegetation regrowth), but not exclusively on abandoned agricultural lands.
Identifying forest regeneration by picking up the signal of woody regrowth in satellite imagery may miss abandonment at earlier stages or that is regenerating into non-forest habitats [@Yin2020].
Focusing on abandonment itself, not only to detecting the regeneration of woody vegetation, provides a better understanding of the outcomes of abandonment, and provides critical context for understanding the potential that abandonment holds for habitat regeneration, carbon sequestration, and other land uses.

Many studies of regeneration also do not consider patterns of persistence, or age of abandonment or regeneration [@Yin2020].
@Crouzeilles2020 only consider pixels as regenerated if they were in forest in 2016 and had been forest for at least 3 years, without assessing average persistence.
@Aide2019 assess changes in woody vegetation over a 14 year period, but do so by averaging across years, losing the temporal pattern or regeneration and recultivation.
@Yin2020 define land as abandoned when it has been continuously uncultivated for 5 years, but do not assess the length of time abandoned in detail.

## Research questions

Our primary goal is to understand the temporal nature of agricultural abandonment by exploring the trajectories taken by each piece of abandoned land through time.
Our main questions are simple: How durable is cropland abandonment? How long is abandoned farmland really "abandoned"? If some farmland is not truly abandoned, what happens to it? 

<!-- ## Foreshadow the results -->
We find that abandonment is not a permanent phenomenon.
In fact, the period of abandonment varies quite a bit around the world and through time.
In order to assess the effect of abandonment on biodiversity, carbon sequestration, and food security, we need a better understanding of how long agricultural abandonment lasts, how abandoned lands "decay," and which factors seem to predict the timing and decay.

In pursuit of this understanding, we address three specific questions: 1) How long does cropland abandonment last, on average, and how does this vary geographically? 2) How quickly is land recultivated, as measured by tracking abandoned croplands and the rate at which they "decay" (i.e. are recultivated) through time? How do these recultivation rates vary across sites, and through time? (What proportion of abandoned land remains abandoned long-term [e.g. >20 years]) 3) Finally, if recultivation rates stay about the same, and a similar amount of land is newly abandoned each year, how can we expect the mean age of abandoned croplands to change into the future?

<!-- ## Foreshadow the methods, how we do this -->

Together, these questions provide a clearer picture of the timing and persistence of abandonment at various sites around the world, improving our understanding the conservation implications of agricultural abandonment, and providing crucial context to inform policies designed to manage abandoned lands.


*Add additional detail on what makes our study special.*
This will be the first study with multiple sites and a global perspective. It also:
- makes use of more accurate and finer resolution abandonment maps 
- covers a longer time period than other recent studies
- provides more detail on not just when recultivation happens, but the total time abandoned land is actually abandoned for
- looks at predictors of abandonment length, not just whether abandonment happens at all. 
- characterizes this recultivation as decay rates for the first time, and looks at trends in this by site, and over time. 

These simple insights about the trajectories taken by abandoned agricultural land will provide much needed context to broad statements about recent and future abandonment and the contribution that abandonment many make to habitat regeneration and biodiversity conservation [@Chazdon2020].
The bulk of abandoned land may be relatively short-lived, from the perspective of ecological succession or carbon sequestration, and unlikely to regenerate into valuable habitat on its own without active policies to protect this land and encourage regeneration.



# Results

```{r results-outline, include = FALSE}
# Overarching question: how durable is abandonment?
# 
# Main questions:
# 1. How long does abandonment last, on average? How does this vary geographically?
# 2. How quickly is land recultivated, as measured by "abandonment decay rates"?
    # a. How do they vary across sites? (i.e. What proportion of abandoned land remains abandoned long-term [e.g. >20 years])
    # b. How do these decay rates vary through time at each site?
# 3. Extrapolation: if decay rates stay about the same, and a similar amount of land is newly abandoned each year, how will mean abandonment durations change into the future?
# 
# ________________
# Results outline:
# Four pieces: 1) describing the abandonment we saw in terms of area, scale, land cover outcomes, and recultivation, 2) duration of abandonment, 3) decay rates, and 4) extrapolation. 
# 
# Basics - describe the abandonment we saw at our sites
# -	how much abandonment occurred, as a proportion of site area? (Total area abandoned (% of total site area), and range of area abandoned at each site.)
# -	When did abandonment take place? (Some took place early on in the time series, some later) (could include the figure with area abandoned))
# -	what land cover did that abandoned land end up in?
# -	about how much of that land was recultivated over the course of the time series? This then leads into statistics of duration... ->
# 
# *Abandonment Duration:
# -	mean duration across all sites (mean of means, with mean of standard deviations)
# -	range of mean durations at individual sites (minimum and maximum)
# -	range of all durations within individual sites - how wide was the variation?
# 
# *Decay rates:
# -	mean decay rates by site across all cohorts (Fig. ). 
# -	time to 50% recultivation, 100% recultivation, min and max by site.
# -	rate of changes through time.
# 
# *Extrapolation:
# -	mean abandonment duration at each site in the extrapolation, overall
# -	min and max mean duration, with sites
# -	Most of the sites have a mean duration of less than ~20 years, and plateau by about 2040. 
# -	even at Shaanxi, the site projected to see the most durable abandonment, we see that a relatively small amount of land will remain abandoned for longer than 50 years. 
```

```{r}
# ## Results outline - OLD
# 
# Fig. 0. Site locations
# 

# Initial composite figure, showing the basics:
# - mean duration
# - area abandoned raw and/or as a proportion of site area
# - 



# ### 1. Mean abandonment lengths, by site [the basics]
# 
# - mean length, across sites
# - area abandoned by age class over time (for a single site)
# - area by land cover over time (for a single site)
# 
# Fig. 1. Mean abandonment duration (years) by site, for all periods and max length
# Fig. 2. Area abandoned, by age class (facet grid all sites) - possible addition is to add the area abn as a proportion of the site areas to this figure
# Fig. 3. Area by land cover, over time (facet grid all sites, SI)
# 
# ### 2. Decay rates, a) by site (average), and b) rate of change of decay rates, by site
# 
# - decay plot for one site (showing individual trajectories, sloping downward)
# - mean decay rate for each site, compared across sites
# - decay rate rate of change (decay rates through time at a single site will go in SI)
# - (?) average abandonment length as derived from decay rates
# 
# Fig. 4. Decay trajectories (single site, Shaanxi) (*) - 
# summary panel for one site, including area abandoned by land cover, decay trajectories, with modeled trajectories & turnover (since the area abandoned is already in the facet grid?) 1 large on top of two smaller
# Fig. 5. Mean decay coefficients by site (vertical, two panels, for log and linear terms, for each site) (SI)
# Fig. 6. Mean decay trajectory by site. (*)
# Fig. 7. Decay rate rate of change, coefficients (vertical, one coefficient for each site, based on the time to 50%, or other proportion) (SI)

# Extrapolation:
# 

# 
# ### 3. Spatial predictors of age and recultivation
# 
# - coefficients on various predictor variables
# - map of *abandonment age in 2017*
# - map of *max age*
# 
# Fig. 8. Coefficients on spatial predictors (vertical, showing coefficients on slope, elevation, suitability, population)
# Fig. 9. Maps of a) abandonment *age in 2017* and b) *max age* for example site.
# 
# 
# Extra results:  
# 
# - Primary post-abandonment land uses. What is formerly abandoned land typically used for? What is the most common land use immediately after abandonment ends? What are the most common land uses of formerly abandoned land at the end of the time series? [Put things into bins: abandoned -> crop, non-crop, urban, and assess frequencies.] May not be all that exciting, since most of the land is likely put into agricultural land. But, worth looking into.

# 1. area abandoned panel, showing total area abandoned as of 2017, ever, and as a proportion of site area. This should go in the SI.
# 2. land cover outcomes of abandoned land.

# facet grids of 1) area by LC, 2) annual turnover, 3) raw persistence plot
# facet grid of decay plots with modeled trajectories
# 
# 

```

```{r get-results-stats, include = FALSE}
# site_r$shaanxi$y2017
# test_area <- raster::area(site_r$shaanxi$y2017)
# plot(test_area)
# ncell(site_r$shaanxi$y2017)
# ncell(test_area)
# names(test_area) <- "area_km2"
# test_dt <- as.data.table.raster(stack(site_r$shaanxi$y2017, test_area))
# test_dt[,sum(area_km2 * 100), by = y2017]
# 1332.768 + 1021861.526 + 153480.420 + 246237.428+ 151124.082

site_df_w_size # note that this includes NA or 0 lc class cells, so is an overestimate. Use the site area from area_summary_df
area_summary_df %>% names
area_summary_df %>% select(site, area_abn_ha_2017, total_site_area_ha_2017, area_as_prop_site) %>% arrange(area_as_prop_site)

# ---------------------------------------------------------------------- #
# area abandoned statistics
area_abn_stats <- list(
  "min" = area_summary_df %>% filter(site != "mato_grosso") %>% slice_min(area_abn_ha_2017) %>% select(area_abn_ha_2017) %>% 
    # as.numeric() %>% 
    prettyNum(big.mark = ","),
  "min_site" = area_summary_df %>% filter(site != "mato_grosso") %>% slice_min(area_abn_ha_2017) %>% .$site %>% capwords(),
  
  "max" = area_summary_df %>% slice_max(area_abn_ha_2017) %>% select(area_abn_ha_2017) %>% round(digits = 0) %>% as.numeric() %>% prettyNum(big.mark = ","),
  "max_site" = area_summary_df %>% slice_max(area_abn_ha_2017) %>% .$site %>% capwords(),

  "mg" = area_summary_df %>% filter(site == "mato_grosso") %>% select(area_abn_ha_2017) %>% round(digits = 0) %>% as.numeric() %>% prettyNum(big.mark = ","),
  "mg_abn_as_percent" = area_summary_df %>% filter(site == "mato_grosso") %>% select(area_as_prop_site) %>% round(digits = 4) * 100,
  
  "total_area_Mha_all_sites" = round(area_summary_df$total_site_area_ha_2017 %>% sum() / 10^6 , digits = 2),
  "total_area_abn_Mha_all_sites" = round(area_summary_df$area_abn_ha_2017 %>% sum() / 10^6, digits = 2),
  "total_area_abn_as_percent" = round((area_summary_df$area_abn_ha_2017 %>% sum() / 10^6) / (area_summary_df$total_site_area_ha_2017 %>% sum() / 10^6), digits = 4) * 100,
  
  "min_area_as_prop_site" = area_summary_df %>% filter(site != "mato_grosso") %>% slice_min(area_as_prop_site) %>% select(area_as_prop_site) %>% round(digits = 4) * 100,
  "min_area_as_prop_site_site" =  area_summary_df %>% filter(site != "mato_grosso") %>% slice_min(area_as_prop_site) %>% .$site %>% capwords(),
  
  "max_area_as_prop_site" = area_summary_df %>% slice_max(area_as_prop_site) %>% select(area_as_prop_site) %>% round(digits = 4) * 100,
  "max_area_as_prop_site_site" = area_summary_df %>% slice_max(area_as_prop_site) %>% .$site %>% capwords()
)

# ---------------------------------------------------------------------- #
# recultivation statistics
recult_stats <- list(
  "mean_thr_5" = area_recult_threshold %>% group_by(abn_threshold) %>% summarise(mean_proportion = mean(proportion_recultivated)) %>% 
    filter(abn_threshold == 5) %>% select(mean_proportion) %>% round(digits = 4) * 100,
  
  "mean_thr_7" = area_recult_threshold %>% group_by(abn_threshold) %>% summarise(mean_proportion = mean(proportion_recultivated)) %>% 
    filter(abn_threshold == 7) %>% select(mean_proportion) %>% round(digits = 4) * 100,
  
  "mean_thr_10" = area_recult_threshold %>% group_by(abn_threshold) %>% summarise(mean_proportion = mean(proportion_recultivated)) %>% 
    filter(abn_threshold == 10) %>% select(mean_proportion) %>% round(digits = 4) * 100
)

abn_duration_stats # see "get-summary-stats"

# ---------------------------------------------------------------------- #
# land cover stats --------------------- #
lc_stats <- list(
  forest_min = abn_prop_lc_2017 %>% 
    filter(lc_2017 == 2) %>% slice_min(prop_lc) %>% 
    select(prop_lc) %>% round(digits = 2) * 100,
  
  forest_min_grassland = (1 - abn_prop_lc_2017 %>% 
                     filter(lc_2017 == 2) %>% slice_min(prop_lc) %>% 
                     select(prop_lc) %>% round(digits = 2)) * 100,
  
  forest_min_site = abn_prop_lc_2017 %>% 
    filter(lc_2017 == 2) %>% slice_min(prop_lc) %>% .$site %>% capwords(),
  
  forest_max = abn_prop_lc_2017 %>% 
    filter(lc_2017 == 2) %>% slice_max(prop_lc) %>% 
    select(prop_lc) %>% round(digits = 2) * 100,
  
  forest_max_grassland = (1 - abn_prop_lc_2017 %>% 
                         filter(lc_2017 == 2) %>% slice_max(prop_lc) %>% 
                         select(prop_lc) %>% round(digits = 2)) * 100,
  
  forest_max_site = abn_prop_lc_2017 %>% filter(lc_2017 == 2) %>% slice_max(prop_lc) %>% .$site %>% capwords()
  )

# ---------------------------------------------------------------------- #
# decay model stats:
t0.5_max_temp <- time_to_l3 %>% filter(p == 0.5) %>%
  select(site, time_to_value, proportion, p) %>% arrange(time_to_value) %>%
  slice_max(time_to_value, n = 3) %>% slice_min(time_to_value)

t0.5_min_temp <- time_to_l3 %>% filter(p == 0.5) %>%
  select(site, time_to_value, proportion, p) %>% arrange(time_to_value) %>% slice_min(time_to_value)

t0_max_temp <- time_to_l3 %>% filter(p == 0) %>%
  select(site, time_to_value, proportion, p) %>% arrange(time_to_value) %>%
  slice_max(time_to_value, n = 3) %>% slice_min(time_to_value)

t0_min_temp <- time_to_l3 %>% filter(p == 0) %>%
  select(site, time_to_value, proportion, p) %>% arrange(time_to_value) %>% slice_min(time_to_value)

decay_stats <- list(
  
  "t0.5_max" = t0.5_max_temp %>% select(time_to_value) %>% round(., digits = 2),
  "t0.5_max_site" = t0.5_max_temp %>% .$site %>% gsub("_", " ",.) %>% capwords(),
  
  "t0.5_min" = t0.5_min_temp %>% select(time_to_value) %>% round(., digits = 2),
  "t0.5_min_site" = t0.5_min_temp %>% .$site %>% gsub("_", " ",.) %>% capwords(),
  
  "t0_max" = t0_max_temp %>% select(time_to_value) %>% round(., digits = 2),
  "t0_max_site" = t0_max_temp %>% .$site %>% gsub("_", " ",.) %>% capwords(),
  
  "t0_min" = t0_min_temp %>% select(time_to_value) %>% round(., digits = 2),
  "t0_min_site" = t0_min_temp %>% .$site %>% gsub("_", " ",.) %>% capwords(),
  
  "shaanxi_0.5" = time_to_l3 %>% filter(p == 0.5, site == "shaanxi") %>% select(time_to_value) %>% round(., digits = 2),
  "shaanxi_0" = time_to_l3 %>% filter(p == 0, site == "shaanxi") %>% select(time_to_value) %>% round(., digits = 2),
  
  "mg_0.5" = time_to_l3 %>% filter(p == 0.5, site == "mato_grosso") %>% select(time_to_value) %>% round(., digits = 2),
  "mg_0" = time_to_l3 %>% filter(p == 0, site == "mato_grosso") %>% select(time_to_value) %>% round(., digits = 2),
  
  "percent_at_20_min" = fitted_df_l3 %>% filter(age == 20) %>% arrange(fitted) %>% slice_min(fitted) %>% .$fitted %>% round(digits = 4) * 100,
  "percent_at_20_min_site" = fitted_df_l3 %>% filter(age == 20) %>% arrange(fitted) %>% slice_min(fitted) %>% .$site %>% capwords(),
  "percent_at_20_max" = fitted_df_l3 %>% filter(age == 20) %>% arrange(fitted) %>% slice_max(fitted) %>% .$fitted %>% round(digits = 4) * 100,
  "percent_at_20_max_site" = fitted_df_l3 %>% filter(age == 20) %>% arrange(fitted) %>% slice_max(fitted) %>% .$site %>% capwords()
)

# ---------------------------------------------------------------------- #
# extrapolation stats:
plateau_times <- extrapolate_df_l3 %>% 
    group_by(site) %>% slice_max(., mean_age, with_ties = FALSE) %>%
    arrange(mean_age) %>% 
    ungroup() %>% mutate(time = year - 1987)

extrapolation_stats <- list(
  "plateau_min" = plateau_times %>% slice_min(mean_age) %>% .$mean_age %>% round(digits = 2),
  "plateau_min_year" = plateau_times %>% slice_min(mean_age) %>% .$year,
  "plateau_min_time" = plateau_times %>% slice_min(mean_age) %>% .$time,
  "plateau_min_site" = plateau_times %>% slice_min(mean_age) %>% .$site %>% capwords(),
  
  "plateau_max" = plateau_times %>% slice_max(mean_age) %>% .$mean_age %>% round(digits = 2),
  "plateau_max_year" = plateau_times %>% slice_max(mean_age) %>% .$year,
  "plateau_max_time" = plateau_times %>% slice_max(mean_age, n = 3) %>% slice_min(mean_age) %>% .$time,
  "plateau_max_site" = plateau_times %>% slice_max(mean_age) %>% .$site %>% capwords()
)

# extrapolate_df_l3$year %>% max()
# 
# extrapolate_df_l3 %>% filter(year == 2150)
# 
# gg_extrapolation_panel_age_b +
#   scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 40)) +
#   geom_vline(xintercept = 2008)
```

(ref:caption-site-locations) Site locations with observed abandonment duration (in years) as of 2017.

```{r site-locations, fig.cap = '(ref:caption-site-locations)', echo=FALSE}
knitr::include_graphics(path = paste0(p_plots, run_label, "/site_locations_w_abn_age_rev", run_label,".pdf"))
```

## Basic results

We find substantial amounts of cropland abandonment, observing a total of `r area_abn_stats$total_area_abn_Mha_all_sites` million ha (Mha) of abandoned croplands by 2017 across our eleven sites (`r area_abn_stats$total_area_abn_as_percent`% of the `r area_abn_stats$total_area_Mha_all_sites` Mha total land area across sites).
Cropland abandonment at individual sites ranged between `r area_abn_stats$min` ha (`r area_abn_stats$min_site`) and `r area_abn_stats$max` ha (`r area_abn_stats$max_site`) as of 2017 (Figure \@ref(fig:area-abn-by-age-class)), and because our sites varied in size, this corresponded to between `r area_abn_stats$min_area_as_prop_site`% (`r area_abn_stats$min_area_as_prop_site_site`) and `r area_abn_stats$max_area_as_prop_site`% (`r area_abn_stats$max_area_as_prop_site_site`) of the total area of each site (Figure \@ref(fig:area-abn-panel)).
The notable exception was our site in the Mato Grosso (Brazil), which only saw `r area_abn_stats$mg` ha of abandoned cropland (`r area_abn_stats$mg_abn_as_percent`% of total site area) as of 2017.

The timing of abandonment varied across sites (Figure \@ref(fig:area-abn-by-age-class)), with some sites showing more abandonment earlier in the time series followed by a gradual leveling off (e.g. Iraq, Bosnia & Herzegovina, Volgograd, Nebraska, & Mato Grosso), some showing consistent abandonment over time (e.g. Eastern Belarus/Smolensk, Russia; Goiás, Brazil; and Wisconsin), and others showing abandonment increasing in the latter half of the time series (e.g. sites in Shaanxi/Shanxi and Chongqing Provinces, China).
The site locations, along with the age of abandoned croplands in years, as of 2017, is shown in Figure \@ref(fig:site-locations).

Abandoned cropland followed different successional trajectories at each site, where the proportion of abandoned cropland distributed between forest and grassland (as of 2017) ranged from a minimum of `r lc_stats$forest_min`% in forest (`r lc_stats$forest_min_grassland`% in grassland) at `r lc_stats$forest_min_site` to a maximum of `r lc_stats$forest_max`% in forest (`r lc_stats$forest_max_grassland`% in grassland) at `r lc_stats$forest_max_site` (see Figure \@ref(fig:abn-prop-lc); cumulative changes in land cover through time are shown for each site in Figure \@ref(fig:area-by-lc)).

## Abandonment duration

However, we also find that many of these abandoned croplands were recultivated during our time series (on average, `r recult_stats$mean_thr_5`% of abandoned area across all sites; Figure \@ref(fig:recult-by-threshold)).
As a result, the mean duration of abandonment across all sites was short: `r abn_duration_stats$mean_duration` years (SD = `r abn_duration_stats$sd_duration`), with a minimum site mean duration of `r abn_duration_stats$duration_min` years (`r abn_duration_stats$duration_min_site`) and a maximum of `r abn_duration_stats$duration_max` years (`r abn_duration_stats$duration_max_site`; see Figure \@ref(fig:mean-abn-duration)).
Abandonment duration varied within sites, with individual site standard deviations ranging between `r abn_duration_stats$sd_min` (`r abn_duration_stats$sd_min_site`) and `r abn_duration_stats$sd_max` years (`r abn_duration_stats$sd_max_site`).

(ref:caption-mean-abn-duration) Mean length of time abandoned (years) throughout our time series across study sites. The mean abandonment duration is calculated across all periods of abandonment (a single pixel may go through multiple periods of abandonment; in red) and across the longest period of abandonment for each pixel throughout the time series (maximum length; in blue).

```{r mean-abn-duration, fig.cap = '(ref:caption-mean-abn-duration)', echo=FALSE}
# (ref:caption-mean-abn-duration) Sites included in this study, from @Yin2020.
# cite inline using the following  \@ref(fig:mean-abn-duration)

knitr::include_graphics(path = paste0(p_plots, run_label, "/mean_lengths", run_label, ".pdf"))
```

(ref:caption-area-abn-by-age-class) Cumulative area abandoned at each site through time, according to age class (in years).

```{r area-abn-by-age-class, fig.cap = '(ref:caption-area-abn-by-age-class)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/abn_area_by_age_grid", run_label, ".pdf"))
```

## Modeling persistence, decay, & recultivation

We tracked groups (i.e. "cohorts") of croplands that were abandoned in a given year, modeling the proportion of each cohort remaining abandoned as a function of time elapsed since initial abandonment (see \@ref(methods), Figure \@ref(fig:abn-decay-s)).
By doing so, we are able to predict how long a given abandoned cropland will persist before it is recultivated, regardless of when it took place during the time series.
This also allows us to calculate the mean recultivation (or "decay") trajectory at each site (Figure \@ref(fig:decay-curves-by-site)).
Recultivation takes place relatively quickly at most of our sites: >50% of abandoned croplands are recultivated within 25 years at almost all sites, where the time required for 50% recultivation ranging between `r decay_stats$t0.5_max` (`r decay_stats$t0.5_max_site`) and `r decay_stats$t0.5_min` years (`r decay_stats$t0.5_min_site`).
The primary exception was our site in Shaanxi/Shanxi Provinces (China), which showed more durable abandonment, requiring `r decay_stats$shaanxi_0.5` years to decline by half, and `r decay_stats$shaanxi_0` years for complete turnover.
Mato Grosso also showed relatively more durable abandonment, requiring `r decay_stats$mg_0.5` years to decline by half and `r decay_stats$mg_0` years for complete turnover. 
However, Mato Grosso showed large amounts of new cultivation over the source of our time series, and with relatively little abandonment (`r area_abn_stats$mg` ha), and should be discounted as a result.

These mean decay trajectories also show wide variation in the proportion of abandoned croplands that last beyond 20 years, as few as `r decay_stats$percent_at_20_min`% of abandoned croplands remained abandoned at `r decay_stats$percent_at_20_min_site`, up to `r decay_stats$percent_at_20_max`% at `r decay_stats$percent_at_20_max_site`.
As Figure \@ref(fig:decay-curves-by-site) shows, many sites cluster around 50% at the 20 year mark.

(ref:caption-decay-curves-by-site) Mean decay trajectories for each site, based on the mean coefficients across all cohorts of abandoned land.

```{r decay-curves-by-site, fig.cap = '(ref:caption-decay-curves-by-site)', echo=FALSE}
# switch to wide (full time span) vs. just the first 50 years
# show_wide <- TRUE
# knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/model_decay_curves_by_site_l3", ifelse(show_wide, "_wide", ""), run_label, ".png"))

knitr::include_graphics(path = paste0(p_plots, run_label, "/decay", "/mean_decay_curves", run_label, ".pdf"))
```

By modeling recultivation for each cohort of abandonment, we are also able to investigate whether recultivation is accelerating at each site. 
Most sites showed a negative trend, indicating that abandoned croplands were being recultivated more quickly over time.
However, a simple linear regression on the time required for half of each cohort of abandoned cropland to be recultivated revealed that most sites did not have a slope significantly different from zero (Figure \@ref(fig:decay-rate-of-change)).
The lone exception was our site in Bosnia & Herzegovina, where croplands abandoned later in the time series were recultivated significantly more quickly.

## Extrapolation

If decay rates remain about the same at each site, and a similar and constant area of cropland is newly abandoned each year, a simple extrapolation indicates that the impermanence we observe is not merely an artifact of the narrow window of our time series.
Extrapolating out multiple decades, we expect the mean duration of abandonment to plateau at 20 years or less at most sites (Figure \@ref(fig:extrapolation-combo)), with the notable exception of Shaanxi, which is projected to plateau at a mean duration of `r extrapolation_stats$plateau_max` years. 
The time it takes to plateau is depends on the time it takes for complete turnover, ranging between `r extrapolation_stats$plateau_min_time`-`r extrapolation_stats$plateau_max_time` years for all sites except Mato Grosso (`r decay_stats$mg_0` years) and Shaanxi (`r decay_stats$shaanxi_0` years).

Looking at the age distribution of abandoned croplands in our extrapolation, we 
Even at Shaanxi, the site projected to see the most durable abandonment, we see that a relatively small amount of land will remain abandoned for longer than 50 years (Figure \@ref(fig:extrapolation-area-by-age)).


# Discussion

```{r disc-outline}

```

Area abandoned is likely to be higher in our sites than across the globe in general, given that we explicitly chose sites that have seen large amounts of recent abandonment.





Even the site with the most durable abandonment is unlikely to see a large amount of land persist for longer than XX years.
In order to increase the environmental benefits provided
Policy makers could address for  increased attention  policy 

The definition of abandonment makes a big difference on both the mean abandonment duration (Figure \@ref(fig:abn-thresholds-mean-duration)), and the recultivation rate (\@ref(fig:recult-by-threshold)). 
It is possible that in many sites, a longer definition of "abandonment" would be more appropriate.
Belarus & Herzegoniva displays a strong bifurcated pattern, where some abandonment remains relatively durable and long-lasting, while other abandonment is recultivated relatively quickly. 

cite to new paper by Susan Cook-Patton (@Cook-Patton2021)

Natural regeneration can represent a viable ecosystem restoration strategy, when given enough time (Zivec et al. 2021, others)
Consequences for water provision (Khorchani et al. 2021, others)

# Materials and Methods {#methods}

```{r methods-outline, include = FALSE}
# ## Outline
# 
# - Definitions of abandonment
# - Describe abandonment map data
#     - statement about R versions
# - Data processing & filtering steps
#     - important filtering steps include a) removing non-abandonment pixels, and b) passing a temporal filter to remove instances of recultivation that last only 1 year.
#     - tracking abandonment trajectories
# - Modeling abandonment decay
#     - why/motivation
#     - modeling approach, diagnostic steps, etc. mostly pointing towards the SI
#     - translating the decay models into a modified prediction of mean length abandoned
# - Spatial predictors
#     - what factors are investigated
#     - modeling approach, short paragraph
# - R packages used that we didn't already specifically mention
# 
# 
# This is the code used for data processing, and should be a good reference for remembering what I did. Probably a good idea to narratively write down what I did in the code, and which SLURM scripts I used, even if just to put in one of the .Rmd analysis documents. 
# ~/Google_Drive/_Projects/abandonment_trajectories/scripts/cluster/analyze_all_sites.R
```

## Abandonment maps

We build on annual land cover maps for 1987-2017 developed by @Yin2020, who used the following approach: [*insert short summary of @Yin2020*].
These maps, derived from publicly available Landsat satellite imagery (1 arc second in resolution, or 30 m at the equator), mapped pixels to four land cover classes: 1) cropland, 2) herbaceous vegetation (e.g. grassland), 3) woody vegetation (e.g. forests), and 4) non-vegetation (e.g. water, urban, or barren land).
We selected 11 sites that were mapped with high accuracy [*ask He for stat to insert here*] and provide broad coverage of different continents and ecosystems (see Figure \@ref(fig:site-locations)).
@Yin2020 selected sites that were likely to have recently experienced agricultural abandonment, due to socioeconomic, political, or environmental reasons.
Thus, our results accurately represent those areas that have recently experienced abandonment, but likely overestimate the overall prevalence of abandonment across all agricultural regions.

## Defining abandonment

Differentiating "true" abandonment from less permanent land-use changes, such as short-term fallowing or crop rotations, is difficult because definitions can vary widely by region and by study.
In fact, abandonment is best viewed as a land-use transition in which land may pass through a spectrum of stages [@Munroe2013].
Here, we define "abandonment" as agricultural land that is no longer under active cultivation and is left free of direct human influence, therefore excluding shifts to less intensive uses such as extensive grazing.
In order to exclude short-term fallow periods, we define croplands as abandoned when they remain uncultivated for five or more consecutive years (following FAO 2016, or 2021, http://www.fao.org/faostat/en/#definitions; we explore the impact of changing this threshold in SI Section \@ref(abn-thresholds)).
We focus exclusively on cropland abandonment, excluding the abandonment of pastures, which is more difficult to discern from satellite imagery (though recent advances have been made; [*add Yin study on grassland abandonment, other citations*]) and is not captured into our data.

## Data processing and filtering

We processed and analyzed our abandonment map data in RStudio version `r rstudioapi::versionInfo()$version` [-@RStudio], using `r R.Version()$version.string`, relying heavily on the `raster` [@R-raster], `data.table` [@R-data.table], and `tidyverse` [@R-tidyverse] packages.

We identified periods of cropland abandonment by tracking each pixel's land cover classification through time and looking for land-cover changes that indicated transitions between agricultural activity and abandonment.
Taking a conservative approach, we considered "agricultural activity" to include both stable cultivation (continuous classification as cropland) and cyclical fallowing (one or more years of cropland followed by fewer than five years of non-cropland).
We classified a pixel as "abandoned" when it transitioned from cropland to either herbaceous or woody vegetation (collectively referred to as "non-cropland"), and subsequently remained classified as non-cropland for five or more consecutive years (following FAO, as above). 
This transition from cropland to abandonment could take place at any point during the time-series, allowing for the abandonment of both long-term or newly converted croplands.
We considered an abandoned pixel to be "recultivated" when it transitioned from abandoned to cropland.
Pixels that transitioned from cropland to the non-vegetation class were not considered "abandoned," and therefore we excluded all non-vegetation pixels from our analysis.*^[These pixels represent a very small portion of our dataset, and non-vegetated land remained about constant or declined over time at most sites.]*

We implemented five- and eight-year moving window temporal filters to smooth land cover trajectories in our time series and address land-cover changes that are temporally unlikely (see SI Section \@ref(methods-si)).
Together with our five-year abandonment threshold, these temporal filters have the ultimate effect of minimizing the effect of very short-term misclassifications that could otherwise look like recultivation.

## Calculating abandonment duration

We calculate abandonment duration as the number of years that elapse between the initial transition from cropland to non-cropland and either recultivation or the end of the time series.
Our abandonment definition implies a minimum abandonment duration of five years.
Because a pixel may go through multiple periods of abandonment (being abandoned and recultivated multiple times throughout the time series), we calculate the mean abandonment duration in two ways: 1) across all distinct periods of abandonment, and 2) across only the longest period of abandonment for each pixel (“maximum abandonment length”) (Figure \@ref(fig:mean-abn-duration)).

## Modeling abandonment decay

The mean abandonment duration tells us about the general persistence of abandoned croplands throughout the time series. 
However, this value is limited by the time series length, and does not account for when the majority of the abandonment took place at a site, nor whether a period of abandonment ends as a results of recultivation or the end of the time series.
As a result, the mean abandonment duration does not tell us how long to expect a piece of land to remain abandoned, nor how abandonment length varies through time.

To address this constraint, we track the trajectory of each pixel through time following its initial abandonment, grouping pixels abandoned in a given year into "cohorts."
For each group ("cohort"), we track recultivation ("decay") by calculating the proportion of each cohort that remains abandoned through time, relative to when that land was first classified as abandoned.

We then ran linear models (using the `stats::lm()` function in R's core statistics package), predicting the proportion of abandoned cropland in each cohort remaining abandoned as a function of time since initial abandonment.
We tested a range of  model specifications, including linear and log transformations of both *proportion* and *time*.
Importantly, we also include *cohort* fixed effects, allowing for the estimation of unique coefficients for each cohort of abandoned land.
These modeled decay trajectories are shown for one example site, Shaanxi/Shanxi Provinces, China, in Figure \@ref(fig:abn-decay-s).

Due to a linear relationship between model residuals and time when including only one term for *time*, we also tested models containing multiple *time* predictor terms, including both log and linear terms.
We selected the highest performing model based on Akaike Information Criterion values (AIC; Figure \@ref(fig:AIC)).
For cohorts of abandonment initially abandoned in years $y = 1988 ... 2013$, our model predicted the proportion $p$ of each cohort $y$ remaining abandoned as a function of time $t$ (i.e. the number of years following initial abandonment), with one log-transformed and one linear term of time (Equation \@ref(eq:mod-spec)).

\begin{equation}
p_{y} = 1 + \beta_{1,y} log(t + 1) + \beta_{2,y} t (\#eq:mod-spec)
\end{equation}

Where $\beta_{1,y}$ represents the regression coefficient on the log term of time $t$ for cohort $y$, and $\beta_{2,y}$ represents the regression coefficient on the linear term of time $t$ for cohort $y$.
We allow for site and cohort level fixed effects, fitting unique coefficients for each cohort at each site.
This corresponds to a `lm()` call of `lm(formula = I(proportion - 1)  ~ 0 + log(time + 1):cohort:site + I(time):cohort:site)`

Model coefficients are shown in Figure \@ref(fig:decay-mod-coef).
Model assumptions were tested through visual inspection of diagnostic plots (Figures \@ref(fig:diag-resid-fitted) and \@ref(fig:diag-qq); full details are contained in Section \@ref(mod-AIC-diag)).
We calculate each site's mean recultivation trend by taking the mean of the model coefficients across all cohorts (Figure \@ref(fig:mean-abn-duration)).

Importantly, this approach also allows us to look at changes in persistence over time, and whether recultivation is accelerating or decelerating.
Based on the modeled recultivation trajectory of each cohort, we calculate the time required for half of a given cohort to be recultivated. 
We then ran a simple linear model on this value on each cohort at each site to uncover temporal changes in recultivation patterns (See Section \@ref(section-methods-rate-of-change)).
Trends were considered statistically significant when the 95% confidence interval for model coefficients (slopes) did not include zero. 
See full results in Figure \@ref(fig:decay-rate-of-change).

(ref:caption-abn-decay-s) Decay of abandoned land at a single site, Shaanxi/Shanxi Provinces, China. This shows the proportion of each cohort of abandoned land (i.e. land abandoned in a given year) that remains abandoned over time. This shows the relative speed at which land is recultivated, through time. Green dots represent observations, green lines represent model results for each individual cohort, and the solid blue line represents the mean trend across all cohorts (averaging across cohorts for each coefficient). All sites are shown together in Figure \@ref(fig:decay-model-grid), and larger individual model results are shown in Figures \@ref(fig:decay-model-indiv-site-b)-\@ref(fig:decay-model-indiv-site-w).

```{r abn-decay-s, fig.cap = '(ref:caption-abn-decay-s)', echo=FALSE}
# knitr::include_graphics(path = paste0(p_plots, run_label, "persistence_proportion", run_label, "_s.png"))
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/ms_fig_l3_cohort", run_label, "_s.png"))
```

### Extrapolation

Based on our modeled decay rates, we extrapolate abandonment and recultivation into the future, asking: if abandonment and recultivation rates stay about the same, how much abandoned land will accumulate, and how long will it last on average?

We make two simple assumptions:  
First, that a constant amount of cropland is newly abandoned each year, based on the mean area of cropland abandoned each year at each site (the "Area Gained" in Figure \@ref(fig:turnover-grid)). 
Second, that all abandoned croplands at a given site are recultivated at the same rate, as determined by the mean trend for that site.
The mean trend, calculated as the mean of the model coefficients across all years of abandonment, is shown in Figure \@ref(fig:decay-curves-by-site).

These results are shown in Figure \@ref(fig:extrapolation-combo), along with a more detailed breakdown in Figure \@ref(fig:extrapolation-area-by-age), which shows the age of abandoned lands by age class. 
We considered a range of alternatives to these two assumptions (*TBD*), as detailed in Section \@ref(section-extrapolation-si), but found these general pattern to hold. 
If anything, (*I expect*) our initial assumptions yield a more optimistic picture of how average duration of abandonment will change into the future.


# Data Availability Statement

Code to replicate these analyses is available on GitHub at [https://github.com/chriscra/abandonment_trajectories](https://github.com/chriscra/abandonment_trajectories), and a static archive can be found at [zenodo (TBD)](https://doi.org/).
*Question for He, Volker: do you intend to make the data public?* 

# Acknowledgements

We thank the following researchers at the University of Wisconsin-Madison, whose land cover maps made this analysis possible: Amintas Brandão, Johanna Buchner, David Helmers, Benjamin G. Iuliano, Niwaeli E. Kimambo, Katarzyna E. Lewińska, Elena Razenkova, Afag Rizayeva, Natalia Rogova, Seth A. Spawn, & Yanhua Xie.
We are deeply indebted to Alex Wiebe, whose statistical advice informed and significantly improved our models of abandonment decay and recultivation.
We also thank members of The Drongos research group for invaluable advice and companionship.
This work was substantially performed using the Princeton Research Computing resources at Princeton University, a consortium of groups led by the Princeton Institute for Computational Science and Engineering (PICSciE) and Office of Information Technology's Research Computing.
This work was supported by the High Meadows Foundation.


\newpage
# References

::: {#refs}
:::

\newpage

<!-- \beginsupplement -->

# Supporting Information

A version of this manuscript that includes the Supporting Information can be found [at this link](https://drive.google.com/file/d/1Y_tnucb_Zia-4qE4-vc02s5hFuMHnIZ9/view?usp=sharing).

```{r figures-outline}
# Main Text Figures:
# 1.	Site locations with maps showing duration of abandonment as of 2017 at each site (*)
# 2.	Mean abandonment duration (all periods, max duration) (*)
# 3.	Area abandoned by age class over time – facet grid, all sites (*)
# a.	possible addition is to add the area abn as a proportion of the site areas to this figure – if time. 
# 4.	Mean decay curve at each site, wide (showing descent from 1 to 0). 
# 5.	Example decay curves with raw data as points, modeled decay trajectories, and mean trajectory – for one site, Shaanxi (as example). In methods section
# 
# SI -----------------------
# 6.	Site locations – plain
# 7.	Area abandoned summary panel: as of 2017, ever, as proportion of total site area, as proportion of cropland area (SI)
# a.	Perhaps better to have just the total area abandoned as of 2017, and as a proportion of site area
# 8.	Land cover outcomes for abandoned croplands as of 2017
# 
# Extended results
# 9.	Area by land cover class, over time – facet grid, all sites (SI)
# 10.	Turnover in abandoned area - facet grid, all sites (SI) 
# 
# Decay
# 11.	Facet grid of decay plots for each site, with model trajectories and mean decay rates
# b.	Alternatively, large decay plot for each site. (currently commented out)
# 12.	Log and linear model coefficients for decay models, by site (vertical two panel plot) (SI)
# 13.	Model AIC comparison plot (SI)
# 14.	Model diagnostic plots (SI) – fitted values vs. residuals.
# 15.	Decay rate - rate of change coefficients – combination of four quadrant plot showing the change in the “time to half” over the course of the time series, together with the coefficient on the right. (SI)
# 
# Extrapolation
# 16.	Extrapolation figure, showing the average abandonment duration over time (and perhaps the area abandoned through time, too) (two panel) (MS)
# 17.	Extrapolation of area abandoned by age classes – facet grid with all sites. (SI)
# 
# Thresholds of abandonment:
# 18.	Abandonment threshold – effect on mean abandonment duration (SI)
# 19.	Abandonment threshold – effect on amounts of recultivation (SI)
# 
# Maps
# 20.	Maps of abandonment duration as of 2017 at each site (levelplots showing distribution on axes, with histogram) (SI)
# 21.	Maps of maximum abandonment duration (levelplots showing distribution on axes, with histogram) (SI)
# 22.	Abandonment duration in 2017 - all sites (SI)
# 23.	Max abandonment duration – all sites
# 
# Extended Results:
# 24.	(x11) Panel grids for each site, including the four summary plots, with histograms of the distribution of abandonment lengths (all periods and max length).
# c.	Example panel grid for Shaanxi, showing a) area abandoned by age class, b) area by land cover class, c) turnover (with or without modelled trajectories), and d) decay. (not necessary, won’t fit)

```

## Extended Methods {#methods-si}

We calculated area using the `raster::area()` function.

### Classifying abandonment
Pixels that remained in cropland or non-cropland classes throughout the entire time series were excluded, as were periods of non-cropland that began in the first year of the time series, even if that pixel was later classified as cropland and subsequently abandoned (leaving only periods of abandonment that we could verify had followed agricultural activity during our time series).

As noted, pixels that transitioned from cropland to the non-vegetation class were not considered "abandoned," and therefore we excluded all non-vegetation pixels from our analysis.
These pixels represent a very small portion of our dataset, and non-vegetated land remained about constant or declined over time at most sites.
See Figure \@ref(fig:area-by-lc).

Restricting the mean abandonment duration to account for only those pixels that are both abandoned and recultivated within the time series would exclude a large portion of our data, and may underestimate the eventual lengths of many periods of abandonment that begin close to the end of our time series.
(Note: assessing temporal changes in mean length abandoned would involve looking at the mean length of time abandoned at each year of Figure \@ref(fig:abn-panel-s)a).


### Temporal filters {#temporal-filters}

In order to address potential classification errors in a single year, we implemented a series of temporal filters intended to smooth the trajectories in our time series by looking for short-term land-cover changes that are temporally unlikely.
We applied five-year and eight-year moving window filters designed to search for short periods of land cover classifications that do not match those immediately before and after, and subsequently update them to match the surrounding classifications.
Specifically, the five-year filter searched for one year periods that did not match the two years immediately before and after (i.e. patterns of 11011, where 1 represents non-cropland and 0 represents cropland), and our eight-year filter searched for two year periods that did not match the three years before and after (i.e. 11100111). 
The central classifications were then updated to match the classes on either end.
We also considered applying modified versions of these moving window filters to the start of the time series, but decided against it, for the sake of consistency and parsimony.

```{r unused-edge-filter-text, include = FALSE, eval = FALSE}
# To be more conservative about the identification of abandonment, we also applied modified versions of these five- and eight-year moving window filters to the start of the times series. 
# By conservatively assuming the years immediately prior to our time series to be classified as non-cropland, we are able to use our moving window filters to exclude additional cases where a one or two year period of cropland may not represent stable cultivation (e.g. reading from left to right, starting in 1987: 011, 1011, 00111, 100111, and 1100111). 
# Non-cropland periods that follow potentially misclassified cropland would more accurately reflect a continuation of existing non-cropland, rather than cropland abandonment.
# 
# This has the effect of applying a three-year threshold on the number of consecutive years of cropland required at the start of the time series in order to confidently signify agricultural activity that could be subsequently abandoned.^[Where 1 represents non-cropland and 0 represents cropland:  
# 87__88__89__90__91__92__93__94  
# 0___1___1___1___1___1___1___1 - caught by edge filter (011)  
# 0___0___1___1___1___1___1___1 - caught by edge filter (00111)  
# 0___0___0___1___1___1___1___1 - Age count starts in '90, classified as abandoned in '94
# ]
# 
# Collectively, these filters mean that the first year a piece of land could be abandoned is 1990, as long as it remains consecutively uncultivated at least through 1994.
# These edge patterns were uncommon, however, with the edge filtering at the beginning of the time series affecting fewer than 7% of pixels at each site. *^[Should this be relative to all pixels, or those that experience some abandonment?]* See Figure 
# 
# No special actions were taken on the end of the time series, with the possible effect of including erroneous recultivation at the end of the time series, making our estimates of the length of time abandoned conservative (i.e. shorter). 
# We decided to only address the edge cases at the start of the time series because we prefer to be conservative by excluding lands that may be consistently noncrop lands from our estimate of abandonment.
# In contrast, edge cases at the end of the time series only affect our estimate of the length of time abandoned, because one or two year periods of cropland, if misclassified, may erroneously mark recultivation in the final years of the time series.
# However, we decline to address any potential misclassifications at the end of the time series in order to take the more conservative approach with regards to recultivation.

knitr::include_graphics(path = paste0(p_plots, run_label, "/temp_filter_counts_plot_full.png"))
```

### Tracking abandonment trajectories

In order to track the persistence of individual ...

This will involve the code in `cc_summarize_abn_dts()` and `cc_calc_persistence()`.
Write a simple sentence describing what we did here.



### Decay models

#### Motivation

Decay rates provide information about how long it takes for land to be recultivated, complementing the mean abandonment length and providing a more nuanced story about how long to expect abandonment to last. 

For example, a site may have a relatively short mean length of abandonment (e.g. Shaanxi/Shanxi Province, with a mean abandonment length of 13 years; see Figure \@ref(fig:site-locations)), but also have a gradual decay rate, indicating that land should stay abandoned for a relatively longer amount of time. 
This may result from more abandonment occurring towards the end of the time series; this land simply does not have as long to age and shows up as younger in our data, regardless of how long it may last.

Looking at abandonment decay rates for each cohort individually allows us to produce a decay rate for each site in general in a way that accounts for when during the time series a piece of land was abandoned (i.e. giving us a sense of how long to expect a given piece of land to remain abandoned, even into the future).

(Note: the following three sentences may be redundant.)
For example, imagine two fields, one abandoned in 1990 and the other abandoned in 2010.
They may both end up remaining abandoned for 15 years, but the second field will show up as having an age of 7 at the end of our time series (which ends in 2017), regardless of how long it lasts.
One way we could deal with this is to only look at land that was affirmatively recultivated; another is to look at decay rates for each cohort, over time.

## Extended results

### Site locations

(ref:caption-site-locations-plain) Site locations, from @Yin2020.

```{r site-locations-plain, fig.cap = '(ref:caption-site-locations-plain)', echo=FALSE}
# just plain site locations
knitr::include_graphics(path = paste0(p_plots, "site_locations_w_labels_long.png"))
```

### Area of each site

The area abandoned at each site is shown in Figure \@ref(fig:area-abn-panel). 
Area by land cover class is shown for each site in Figure \@ref(fig:area-by-lc), and the area abandoned is shared by age class in Figure \@ref(fig:area-abn-by-age-class). 

(ref:caption-area-abn-panel) Area abandoned a) as of 2017, b) at any point between 1987-2017, c) as a proportion of the total site area, and d) as a proportion of the total cropland area in 1987. Note that sites are shown in ascending order of area as a proportion of total site area.

```{r area-abn-panel, fig.cap = '(ref:caption-area-abn-panel)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/area_abn_panel", run_label, ".pdf"))
```

We also find that a significant area of abandoned croplands were recultivated by the end of our time series (Figure \@ref(fig:abn-prop-lc)).

(ref:caption-abn-prop-lc) Proportion of abandoned cropland in each land cover class as of 2017.

```{r abn-prop-lc, fig.cap = '(ref:caption-abn-prop-lc)', echo=FALSE}
knitr::include_graphics(path = paste0(p_plots, run_label, "/abn_prop_lc_2017", run_label, ".pdf"))
```

(ref:caption-area-by-lc) Area in each land cover class at each site through time. Land cover classes are cropland, grassland, woody vegetation, non-vegetation, and abandoned (for at least 5 years).

```{r area-by-lc, fig.cap = '(ref:caption-area-by-lc)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/area_by_lc_grid", run_label, ".pdf"))
```

(ref:caption-turnover-grid) Annual turnover of abandoned croplands at each site, showing the annual gain (dark green) and loss (i.e. recultivation, light green) of abandoned croplands. The black line shows the annual net change.

```{r turnover-grid, fig.cap = '(ref:caption-turnover-grid)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/turnover_grid", run_label, ".pdf"))
```


### The effect of varying abandonment definitions {#abn-thresholds}

- Abandonment threshold, including a higher threshold (something like 6 or 10 years), along with how thresholds change total pixels/area.

(ref:caption-abn-thresholds-mean-duration) Mean abandonment lengths shown for various abandonment thresholds.

```{r abn-thresholds-mean-duration, fig.cap = '(ref:caption-abn-thresholds-mean-duration)'}
knitr::include_graphics(path = paste0(p_output, "plots/", run_label, "/mean_lengths_by_threshold", run_label, ".png"))
```

Like the mean duration of abandonment, the amount of recultivation depends on our definition of abandonment (Figure \@ref(fig:recult-by-threshold)). We find that the mean area of abandoned croplands that get recultivated declines from `r recult_stats$mean_thr_5`% with a 5 year threshold to `r recult_stats$mean_thr_7`% with a 7 year threshold, and `r recult_stats$mean_thr_10`% with a 10 year threshold. 

(ref:caption-recult-by-threshold) Recultivation rates shown for various abandonment thresholds.

```{r recult-by-threshold, fig.cap = '(ref:caption-recult-by-threshold)'}
knitr::include_graphics(path = paste0(p_output, "plots/", run_label, "/recultivation_rates_by_threshold", run_label, ".pdf"))
```


### Maps

Note: may not be necessary, since they will be the focus of Chapter 4. 

Can also include maps for each site of both a) abandonment *age in 2017* (e.g. Figure \@ref(fig:map-abn-age-2017-s)) and b) *max age* (e.g. Figure \@ref(fig:map-abn-age-max-s)) for all sites.

See function `cc_age_levelplot_hist()` to produce these side by side, with site name in the title

(ref:caption-map-abn-age-2017-s) Duration of abandonment (in years) as of 2017, `r site_df$description[9]`.

```{r map-abn-age-2017-s, fig.cap = '(ref:caption-map-abn-age-2017-s)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/spatial_reg/age_duration_2017_w_dist", run_label, site_df$label[9], ".pdf"))
```

(ref:caption-map-abn-age-max-s) Maximum duration of abandonment (in years), `r site_df$description[9]`.

```{r map-abn-age-max-s, fig.cap = '(ref:caption-map-abn-age-max-s)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/spatial_reg/age_duration_max_w_dist", run_label, site_df$label[9], ".pdf"))
```

(ref:caption-map-abn-age-2017) Duration of cropland abandonment (in years) as of 2017 at our 11 sites.

```{r map-abn-age-2017, fig.cap = '(ref:caption-map-abn-age-2017)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/abn_age_maps_2017_rev", run_label, ".pdf"))
```

(ref:caption-map-abn-age-max) Maximum duration of cropland abandonment (in years) at each pixel between 1987-2017.

```{r map-abn-age-max, fig.cap = '(ref:caption-map-abn-age-max)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/abn_age_maps_max_rev", run_label, ".pdf"))
```

### Summary composite figures

(ref:caption-abn-panel-s) Abandonment at a single site (Shaanxi/Shanxi Provinces, China), showing a) accumulation of abandoned land by age class, b) decay of abandoned land by year abandoned, c) the area in each land cover class through time (including both land that has been abandoned for five or more years, as well as any land abandoned for 1 or more years, therefore including short-term fallows), and d) the annual turnover of abandoned land through time. Corresponding results for our other sites are shown in Figures \@ref(fig:panel-b)-\@ref(fig:panel-w).

```{r abn-panel-s, fig.cap = '(ref:caption-abn-panel-s)', echo=FALSE}
# note: this the results panel figure of just Shaanxi province, as an example I had previously intended to have in the main text.
knitr::include_graphics(path = paste0(p_plots, run_label, "/ms_panel", run_label, "_s.png"))
```

\newpage

## Decay models

(ref:caption-decay-model-grid) Decay model results for all sites, showing raw data (green dots) and modeled abandonment trajectories for individual years (green lines). The mean decay trajectory for the site is calculated as the mean of the coefficients for each cohort (solid blue line). Larger model results are shown in Figures \@ref(fig:decay-model-indiv-site-b)-\@ref(fig:decay-model-indiv-site-w).

```{r decay-model-grid, fig.cap = '(ref:caption-decay-model-grid)', echo = FALSE}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", "decay_mod_grid", run_label, ".pdf"))
```

Model results:

- Decay rate rate of change for each site, in four quadrants, with linear regression coefficients (Figure \@ref(fig:decay-rate-of-change))
- Projected proportions remaining after set periods of time (10 years, 20 years, 30 years, etc.)
- Decay curves with model fitted values for each site. (Figure \@ref(fig:decay-rate-of-change), and individual models )
- an alternative representation of the mean decay rate (Figure \@ref(fig:decay-time-to-range))


(ref:caption-decay-mod-coef) Mean decay model coefficients across cohorts at each site. The left panel shows the mean coefficient on the log(time) terms and the right shows the site mean coefficient on the linear time terms. These mean coefficients are used to plot the mean decay trajectories shown in Figure \@ref(fig:decay-curves-by-site).

```{r decay-mod-coef, fig.cap = '(ref:caption-decay-mod-coef)', echo = FALSE}
knitr::include_graphics(
  path = paste0(p_plots, run_label, "/decay/", "l3_cohort_coefs_by_site", run_label, ".png")
  )
```

### Model selection and diagnostics {#mod-AIC-diag}

We chose a model with the following specifications shown in Equation \@ref(eq:mod-spec-SI).
For cohorts of abandonment initially abandoned in years $y = 1988 ... 2013$, we estimate the proportion $p$ of each cohort $y$ remaining abandoned as a function of time $t$ (i.e. based on the number of years after initial abandonment).

\begin{equation}
p_{y} = 1 + \beta_{1,y} log(t + 1) + \beta_{2,y} t (\#eq:mod-spec-SI)
\end{equation}

Where $\beta_{1,y}$ represents the regression coefficient on the log term of time $t$ for cohort $y$, and $\beta_{2,y}$ represents the regression coefficient on the linear term of time $t$ for cohort $y$.
We allow for site and cohort level fixed effects, fitting unique coefficients for each cohort at each site.

This corresponds to a `lm()` call of `lm(formula = I(proportion - 1)  ~ 0 + log(time + 1):cohort:site + I(time):cohort:site)`

Model selection was done based on Akaike Information Criterion (AIC) values (Figure \@ref(fig:AIC)).
We checked linear model assumptions through visual inspection of both residuals vs. fitted plots (Figure \@ref(fig:diag-resid-fitted)) and Q-Q plots (Figure \@ref(fig:diag-qq)).
See also Figure \@ref(fig:diag-combo) to see diagnostic plots for the full model, including all sites.

(ref:caption-AIC) Akaike Information Criterion (AIC) values for various model specifications. More negative AIC values indicate a better model fit.

```{r AIC, fig.cap = '(ref:caption-AIC)', fig.width = 7.5}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", "mod_AIC_mega_plot", run_label, ".png"))
```

(ref:caption-diag-resid-fitted) Residuals vs. fitted diagnostic plots for each site.

```{r diag-resid-fitted, fig.cap = '(ref:caption-diag-resid-fitted)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", "l3_cohort_diag_resid_v_fitted", run_label, ".png"))
```

(ref:caption-diag-qq) QQ plots for each site, calculated using the `car` package (@R-car).

```{r diag-qq, fig.cap = '(ref:caption-diag-qq)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", "l3_cohort_diag_qq_subset", run_label, ".png"))
```

(ref:caption-diag-combo) Diagnostic plots for all sites together.

```{r diag-combo, fig.cap = '(ref:caption-diag-combo)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", "l3_cohort_diag_combo", run_label, ".png"))
```

### Rate of change {#section-methods-rate-of-change}

We examined the rate of change of recultivation rates by calculating the time required for 50% of each cohort to be recultivated and running a simple linear regression on these values as a function of time. 
We estimate the time required for half (50%) of a given cohort of abandoned cropland to be recultivated, $t_{half,s}$, as a function of the year of initial abandonment ($yearabn_{s}$), at each site $s$.
This model is shown in Equation \@ref(eq:rate-of-change-lm).

\begin{equation}
t_{half,s} = \beta_{0,s} + \beta_{1,s} yearabn_{s} (\#eq:rate-of-change-lm)
\end{equation}

Where $\beta_{1,s}$ represents the regression slope on the year abandoned for site $s$ ($yearabn_{s}$), and $\beta_{0,s}$ represents the intercept.
This corresponds to a `lm()` call of `lm(formula = t_half ~ year_abandoned)` run for each site individually (functionally the same as site fixed effects).
Results are shown in Figure \@ref(fig:decay-rate-of-change).

We confirmed that model assumptions were met through visual inspection of residuals vs. fitted plots (Figure \@ref(fig:rate-of-change-diag-resid-fitted)) and Q-Q plots (Figure \@ref(fig:rate-of-change-diag-qq)).

(ref:caption-decay-rate-of-change) The rate of change of decay rates (measured by the time required for 50% of each cohort to be recultivated) at each site over the course of the time series. Individual site trends are shown in the grid at left. Solid lines show simple linear regressions, the slopes of which are shown at right. Gray bands around the linear trends at left and the error bars on slope estimates at the right both represent 95% confidence intervals.

```{r decay-rate-of-change, fig.cap = '(ref:caption-decay-rate-of-change)', echo=FALSE}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/rate_of_change_recultivation_speed_combo", 
                                      "_indiv", run_label, ".pdf"))

# old confidence intervals
# knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/rate_of_change_recultivation_speed_combo",
#                                       "_old", run_label, ".pdf"))


# old version, with quadrants, and old CIs
# knitr::include_graphics(path = paste0(p_plots, run_label, "/presentation/rate_of_change_recultivation_speed", run_label, ".pdf"))
# knitr::include_graphics(path = paste0(p_plots, run_label, "/presentation/rate_of_change_recultivation_speed_old", run_label, ".pdf"))
```

(ref:caption-rate-of-change-diag-resid-fitted) Residuals vs. fitted diagnostic plots for each site, for simple `lm` call corresponding to Eq. \@ref(eq:rate-of-change-lm).

```{r rate-of-change-diag-resid-fitted, fig.cap = '(ref:caption-rate-of-change-diag-resid-fitted)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", "rate_of_change_l3_diag_ind_resid_v_fitted", run_label, ".png"))
```

(ref:caption-rate-of-change-diag-qq) QQ plots for each site, calculated using the `car` package (@R-car).

```{r rate-of-change-diag-qq, fig.cap = '(ref:caption-rate-of-change-diag-qq)'}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", "rate_of_change_l3_diag_ind_qq", run_label, ".png"))
```

(ref:caption-decay-time-to-range) An alternative representation of the mean decay rate for each site (also shown in Figure \@ref(fig:decay-curves-by-site)). The color of each dot corresponds to the proportion remaining after a given amount of time.

```{r decay-time-to-range, fig.cap = '(ref:caption-decay-time-to-range)', echo=FALSE}
# (ref:caption-decay-time-to-range) Sites included in this study, from @Yin2020.
# cite inline using the following  \@ref(fig:decay-time-to-range)

# switch between 1-0 and 1-0.5 by adding or removing all
show_all <- TRUE

knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/time_to_range", 
                                      ifelse(show_all, "_all", ""), "_l3", run_label, ".pdf"))
```


\newpage

## Extrapolating abandonment duration {#section-extrapolation-si}

(ref:caption-extrapolation-combo) The results of our simple extrapolation, including a) the mean age of abandonment, and b) the total area abandoned into the future. Colors corresponding to each site are consistent across the three panels. These extrapolation assume recultivation based on the mean decay trend for each site Figure \@ref(fig:decay-curves-by-site) and annual new abandonment based on the mean annual gain in abandonment shown in Figure \@ref(fig:turnover-grid) (dark green bars).

```{r extrapolation-combo, fig.cap = '(ref:caption-extrapolation-combo)', echo=FALSE}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", 
                                     "extrapolation_combo_SI", run_label, ".pdf"))
```

(ref:caption-extrapolation-area-by-age) Extrapolating area by age bin.

```{r extrapolation-area-by-age, fig.cap = '(ref:caption-extrapolation-area-by-age)', echo=FALSE}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", 
                                      "extrapolate_age_by_age_bin", run_label, ".pdf"))
```

### Alternative assumptions about annual additional abandonment

As noted above, we make two simple assumptions in our extrapolation of abandonment and recultivation: specifically, that 1) recultivation rates remain the same (based on mean recultivation trends at each site, shown in Figure \@ref(fig:decay-curves-by-site), and that 2) a constant amount of cropland is newly abandoned each year, based on the mean annual gain in abandonment shown in Figure \@ref(fig:turnover-grid) (dark green bars).

However, these assumptions may not be very realistic (actually, they almost certainly are not realistic). 
In particular, it is unlikely that a constant amount of land will be newly abandoned each year indefinitely. 
I can think of three alternative assumptions we could make:

1. We could assume that the amount of abandoned land each year would be more likely to gradually decline, so that less and less land is abandoned each year.
2. We could also set a limit to how much total area could be abandoned, perhaps based on a percent of cropland in a site, for example. 
3. Or, finally, we could base this on the trend in abandoned land each year (running a regression on the gain columns in part d of the main results panel figures).

*To do: run this extrapolation for the three different sets of assumptions, and assess the results.*

However, I did it this simple way first, just to illuminate what these trends would mean if they were taken to the extreme. 
And, the extrapolation shows some pretty striking results: many of the sites do not see any land last longer than 20 years. 
The average age of abandonment rarely rises above 20 years, which really isn't that long in terms of carbon storage or biodiversity recovery.

This is not the case in the time series data we have, mostly because at many of the sites, the newer cohorts of land decay more quickly than the older ones. 
Perhaps this is a sign that the least valuable land is abandoned earliest, and therefore is most durable. 
The decay rates for cohorts towards the end of the time series are rather fast at many sites (these cohorts also have the fewest observations), which makes the site average fast as well. 
This is one reason why the mean age is so low in many places. 

#### (*REMOVE*) Alternative mean decay rates

Currently, to get the mean decay rate for each site, I simply average each coefficient (for the log and the linear terms) across all cohorts, and then use these two mean values as the coefficients for the mean site trend (the solid blue lines in Figure \@ref(fig:decay-model-grid)).
I think this makes sense, because it treats each cohort of abandonment equally (rather than giving more weight to cohorts with more observations, i.e. older cohorts). 
Having cohort fixed effects allows for a unique decay rate for each year of abandonment, which makes the models fit very well. 
But, the fits for the recent cohorts with few observations are quite straight. 

Alternatively, however, I can also just run a single regression without the cohort fixed effects, which produces a single estimate for the log and linear coefficients, weighting all points equally (therefore giving more weight to older cohorts with more points; the dashed blue lines in Figure \@ref(fig:decay-model-grid)).

I can then conduct the extrapolation based on the decay rates derived from that single linear regression for each site (in other words, across all cohorts of abandonment).
These extrapolation results are shown below in Figures \@ref(fig:extrapolation-combo-no-fe) and \@ref(fig:extrapolation-area-by-age-no-fe).

However, as you can see, some of the sites have a decay curve that clearly doesn't make sense when extrapolated out (eventually curving upwards over time). 
As a result, I think we should stick with our original method of calculating the mean trend at each site (averaging across the coefficients for each cohort), but I just wanted to call it to your attention.

(ref:caption-extrapolation-combo-no-fe) The results of our simple extrapolation, but assuming a decay trend for each site calculated without cohort fixed effects (a), resulting in b) the mean age of abandonment, and c) the total area abandoned into the future. Colors corresponding to each site are consistent across the three panels.

```{r extrapolation-combo-no-fe, fig.cap = '(ref:caption-extrapolation-combo-no-fe)', echo=FALSE}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", 
                                     "extrapolation_combo_no_fe_tall", run_label, ".pdf"))
```

(ref:caption-extrapolation-area-abn-no-fe) Extrapolating total area abandoned, using site decay rates that do not allow for abandonment cohort fixed effects.

```{r extrapolation-area-abn-no-fe, fig.cap = '(ref:caption-extrapolation-area-abn-no-fe)', include = FALSE, echo=FALSE}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", 
                                      "extrapolate_area_abn_no_fe", run_label, ".png"))
```

(ref:caption-extrapolation-mean-age-no-fe) Extrapolating area by age bin, no fixed effects.

```{r extrapolation-mean-age-no-fe, fig.cap = '(ref:caption-extrapolation-mean-age-no-fe)', include = FALSE, echo=FALSE}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", 
                                      "extrapolate_mean_age_no_fe", run_label, ".png"))
```

(ref:caption-extrapolation-area-by-age-no-fe) Extrapolating area by age bin, assuming site decay rates derived from linear models that do not use cohort fixed effects (treating each observation equally).

```{r extrapolation-area-by-age-no-fe, fig.cap = '(ref:caption-extrapolation-area-by-age-no-fe)', echo=FALSE}
knitr::include_graphics(path = paste0(p_plots, run_label, "/decay/", 
                                      "extrapolate_age_by_age_bin_no_fe", run_label, ".pdf"))
```

\newpage

## Expanded Site Results

### Composite Results Figures

(ref:caption-panel-b) Abandonment patterns for `r site_df$description[1]`, showing a) accumulation of abandoned land by age class, b) decay of abandoned land by year abandoned, c) the area in each land cover class through time (including both land that has been abandoned for five or more years, as well as any land abandoned for 1 or more years, therefore including short-term fallows), d) the annual turnover of abandoned land through time, and e) the distribution of abandonment duration for all periods of cropland abandonment (top) and the maximum duration of abandonment at each pixel (bottom).
(ref:caption-panel-bh) Abandonment patterns for `r site_df$description[2]`, following Figure \@ref(fig:panel-b).
(ref:caption-panel-c) Abandonment patterns for `r site_df$description[3]`, following Figure \@ref(fig:panel-b).
(ref:caption-panel-g) Abandonment patterns for `r site_df$description[4]`, following Figure \@ref(fig:panel-b).
(ref:caption-panel-i) Abandonment patterns for `r site_df$description[5]`, following Figure \@ref(fig:panel-b).
(ref:caption-panel-mg) Abandonment patterns for `r site_df$description[6]`, following Figure \@ref(fig:panel-b).
(ref:caption-panel-n) Abandonment patterns for `r site_df$description[7]`, following Figure \@ref(fig:panel-b).
(ref:caption-panel-o) Abandonment patterns for `r site_df$description[8]`, following Figure \@ref(fig:panel-b).
(ref:caption-panel-s) Abandonment patterns for `r site_df$description[9]`, following Figure \@ref(fig:panel-b).
(ref:caption-panel-v) Abandonment patterns for `r site_df$description[10]`, following Figure \@ref(fig:panel-b).
(ref:caption-panel-w) Abandonment patterns for `r site_df$description[11]`, following Figure \@ref(fig:panel-b).

```{r panel-b, fig.cap = '(ref:caption-panel-b)', echo=FALSE}
# list.files(path = p_plots)

si_panel_figs <- list.files(paste0(p_plots, run_label), pattern = "si_panel", full.names = TRUE)
# grep("_b.png", si_panel_figs, value = TRUE)

knitr::include_graphics(path = si_panel_figs[1])
```

```{r panel-bh, fig.cap = '(ref:caption-panel-bh)', echo=FALSE}
knitr::include_graphics(path = si_panel_figs[2])
```

```{r panel-c, fig.cap = '(ref:caption-panel-c)', echo=FALSE}
knitr::include_graphics(path = si_panel_figs[3])
```

```{r panel-g, fig.cap = '(ref:caption-panel-g)', echo=FALSE}
knitr::include_graphics(path = si_panel_figs[4])
```

```{r panel-i, fig.cap = '(ref:caption-panel-i)', echo=FALSE}
knitr::include_graphics(path = si_panel_figs[5])
```

```{r panel-mg, fig.cap = '(ref:caption-panel-mg)', echo=FALSE}
knitr::include_graphics(path = si_panel_figs[6])
```

```{r panel-n, fig.cap = '(ref:caption-panel-n)', echo=FALSE}
knitr::include_graphics(path = si_panel_figs[7])
```

```{r panel-o, fig.cap = '(ref:caption-panel-o)', echo=FALSE}
knitr::include_graphics(path = si_panel_figs[8])
```

```{r panel-s, fig.cap = '(ref:caption-panel-s)', echo=FALSE}
knitr::include_graphics(path = si_panel_figs[9])
```

```{r panel-v, fig.cap = '(ref:caption-panel-v)', echo=FALSE}
knitr::include_graphics(path = si_panel_figs[10])
```

```{r panel-w, fig.cap = '(ref:caption-panel-w)', echo=FALSE}
knitr::include_graphics(path = si_panel_figs[11])
```

\newpage

### Individual Decay Model Results

(ref:caption-decay-model-indiv-site-b) Decay model results for Eastern Belarus and Smolensk, Russia, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

(ref:caption-decay-model-indiv-site-bh) Decay model results for Bosnia & Herzegovina, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

(ref:caption-decay-model-indiv-site-c) Decay model results for Chongqing Province, China, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

(ref:caption-decay-model-indiv-site-g) Decay model results for Goiás, Brazil, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

(ref:caption-decay-model-indiv-site-i) Decay model results for Iraq, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

(ref:caption-decay-model-indiv-site-mg) Decay model results for Mato Grosso, Brazil, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

(ref:caption-decay-model-indiv-site-n) Decay model results for Nebraska, USA, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

(ref:caption-decay-model-indiv-site-o) Decay model results for Orenburg, Russia, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

(ref:caption-decay-model-indiv-site-s) Decay model results for Shaanxi/Shanxi Provinces, China, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

(ref:caption-decay-model-indiv-site-v) Decay model results for Volgograd, Russia, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

(ref:caption-decay-model-indiv-site-w) Decay model results for Wisconsin, USA, showing raw data (green dots), modeled abandonment trajectories for individual years (green lines), and the mean decay trajectory for the site as a whole (blue lines). The mean decay trajectory is calculated in two ways: 1) from the mean of the coefficients for each cohort (solid blue line), and 2) as a single linear regression without cohort-level fixed effects (F.E.; dashed blue line).

```{r decay-model-indiv-site-b, fig.cap = '(ref:caption-decay-model-indiv-site-b)', echo = FALSE}
decay_model_figs <- list.files(paste0(p_plots, run_label, "/decay"), 
                               pattern = paste0("^l3_cohort_plus", run_label), full.names = TRUE)

knitr::include_graphics(path = decay_model_figs[1])
```


```{r decay-model-indiv-site-bh, fig.cap = '(ref:caption-decay-model-indiv-site-bh)', echo=FALSE}
knitr::include_graphics(path = decay_model_figs[2])
```

```{r decay-model-indiv-site-c, fig.cap = '(ref:caption-decay-model-indiv-site-c)', echo=FALSE}
knitr::include_graphics(path = decay_model_figs[3])
```

```{r decay-model-indiv-site-g, fig.cap = '(ref:caption-decay-model-indiv-site-g)', echo=FALSE}
knitr::include_graphics(path = decay_model_figs[4])
```

```{r decay-model-indiv-site-i, fig.cap = '(ref:caption-decay-model-indiv-site-i)', echo=FALSE}
knitr::include_graphics(path = decay_model_figs[5])
```

```{r decay-model-indiv-site-mg, fig.cap = '(ref:caption-decay-model-indiv-site-mg)', echo=FALSE}
knitr::include_graphics(path = decay_model_figs[6])
```

```{r decay-model-indiv-site-n, fig.cap = '(ref:caption-decay-model-indiv-site-n)', echo=FALSE}
knitr::include_graphics(path = decay_model_figs[7])
```

```{r decay-model-indiv-site-o, fig.cap = '(ref:caption-decay-model-indiv-site-o)', echo=FALSE}
knitr::include_graphics(path = decay_model_figs[8])
```

```{r decay-model-indiv-site-s, fig.cap = '(ref:caption-decay-model-indiv-site-s)', echo=FALSE}
knitr::include_graphics(path = decay_model_figs[9])
```

```{r decay-model-indiv-site-v, fig.cap = '(ref:caption-decay-model-indiv-site-v)', echo=FALSE}
knitr::include_graphics(path = decay_model_figs[10])
```

```{r decay-model-indiv-site-w, fig.cap = '(ref:caption-decay-model-indiv-site-w)', echo=FALSE}
knitr::include_graphics(path = decay_model_figs[11])
```
