---
title: "Figures"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r initialize}
source("scripts/0_start.R")
```

```{r basemaps}
source("")
```


```{r load-data}
# for use on cluster:
p_dat <- "/scratch/network/clc6/abandonment_trajectories/data_derived/"
p_dat_derived <- "/scratch/network/clc6/abandonment_trajectories/data_derived/"
p_output <- paste0("/scratch/network/clc6/abandonment_trajectories/output/")
list.files(p_dat_derived)


# Land use class codes:
#       1. Non-vegetated area (e.g. water, urban, barren land)
#       2. Woody vegetation
#       3. Cropland 
#       4. Herbaceous land (e.g. grassland)

# testers:
bs <- brick(paste0(p_dat, "Abandonment/belarus_small.tif"))
bt <- brick(paste0(p_dat_derived, "belarus_subset.tif"))
names(bs) <- paste0("y", 1987:2017)
names(bt) <- paste0("y", 1987:2017)


# -------------------------- rasters --------------------------- #
# raw rasters
s <- brick(paste0(p_dat, "Abandonment/shaanxi.tif"))
b <- brick(paste0(p_dat_derived, "belarus.tif")) # merged version

# age
s_age_r <- brick(paste0(p_dat_derived, "shaanxi_age.tif"))
b_age_r <- brick(paste0(p_dat_derived, "belarus_age.tif"))

# max_length
s_max_length_r <- brick(paste0(p_dat_derived, "shaanxi_max_length.tif"))
b_max_length_r <- brick(paste0(p_dat_derived, "belarus_max_length.tif"))

# update year names 1987 - 2017
names(s) <- paste0("y", 1987:2017)
names(b) <- paste0("y", 1987:2017)
names(s_age_r) <- paste0("y", 1987:2017)
names(b_age_r) <- paste0("y", 1987:2017)




# -------------------------- data.tables --------------------------- #
b_age <- fread(input = paste0(p_dat_derived, "belarus_age.csv"))
names(b_age)
s_age <- fread(input = paste0(p_dat_derived, "shaanxi_age.csv"))


b_length <- fread(input = paste0(p_dat_derived, "belarus_length.csv"))
s_length <- fread(input = paste0(p_dat_derived, "shaanxi_length.csv"))

b_max_length <- fread(input = paste0(p_dat_derived, "belarus_max_length.csv"))
s_max_length <- fread(input = paste0(p_dat_derived, "shaanxi_max_length.csv"))

# original data
s_dt <- fread(input = paste0(p_dat_derived, "shaanxi.csv"))
names(s_dt) <- gsub(pattern = "andcover", replacement = "y", names(s_dt))

b_dt <- fread(input = paste0(p_dat_derived, "belarus.csv")) # caution - huge file! 8.4 GB at least. 
```


```{r simple-plots}


# -------------------------- plot raw data --------------------------- #
plot(b$y1987, main = "Belarus 1987", breaks = c(0, plot_cols$breaks), col = plot_cols$color)
legend("bottomleft", cex = 0.6, inset = 0,
       legend = plot_cols$name, 
       fill = plot_cols$color)

plot(b$y2017, main = "Belarus 2017", breaks = c(0, plot_cols$breaks), col = plot_cols$color)
legend("bottomleft", cex = 0.6, inset = 0,
       legend = plot_cols$name, 
       fill = plot_cols$color)

# ---------------------- plot abandonment age ---------------------- #
plot(b_age_r$y2017, main = "Belarus Age of Abandonment 2017")
plot(b_age_r[[28:31]])



# -------------------------- animate --------------------------- #
# --------------
# https://www.rdocumentation.org/packages/raster/versions/3.1-5/topics/animate

animate(bt, pause = 0.5, zlim = c(1, 4), maxpixels=5000, n=1,
        breaks = c(0, plot_cols$breaks), col = plot_cols$color)

```

```{r exploratory-stats}
# explore some stats:
s_length
b_length
s_length[, .N, by = length]
b_length[, .N, by = length]

```
```{r distill-length-data}
# ------------------------------------------ #
# ----------------- mean length ------------ #
# ------------------------------------------ #
s_length[, site := "shaanxi"]
b_length[, site := "belarus"]

length_all <- rbindlist(list(s_length, b_length))
object_size(length_all)

dat_mean_length <- length_all[, .(mean_length = mean(length)), by = site]
dat2_mean_length <- length_all[length >= 5, .(mean_length_thr5 = mean(length)), by = site]
dat_mean_length <- merge(dat_mean_length, dat2_mean_length, by = "site", sort = FALSE)
dat_mean_length

# can also calculate the mean length from the distilled dat
sum((b_distill$length * b_distill$freq)) / sum(b_distill$freq)

# ------------------------------------------ #
# ----------------- distill ---------------- #
# ------------------------------------------ #

# to use with ggplot, first distill the data

# regular, no thresholds
b_length_distill <- b_length[, .(freq = .N), by = length]
b_length_distill[, site := "belarus"]
s_length_distill <- s_length[, .(freq = .N), by = length]
s_length_distill[, site := "shaanxi"]

length_distill <- rbind(b_length_distill, s_length_distill)

# blip1
b_length_blip1_distill <- b_length_blip1[, .(freq = .N), by = length]
b_length_blip1_distill[, site := "belarus"]
s_length_blip1_distill <- s_length_blip1[, .(freq = .N), by = length]
s_length_blip1_distill[, site := "shaanxi"]

length_blip1_distill <- rbind(b_length_blip1_distill, s_length_blip1_distill)

# max_length

b_max_length_distill <- b_max_length[, .(freq = .N), by = max_length]
b_max_length_distill[, site := "belarus"]
s_max_length_distill <- s_max_length[, .(freq = .N), by = max_length]
s_max_length_distill[, site := "shaanxi"]
max_length_distill <- rbind(b_max_length_distill, s_max_length_distill)


# ------------------------------------ #
# ----------- mean max length -------- #
# ------------------------------------ #
# max length, mean, etc.
s_length
s_max_length[, site := "shaanxi"]
b_max_length[, site := "belarus"]

max_length_all <- rbindlist(list(s_max_length, b_max_length))
object_size(max_length_all)

dat_mean_length_max <- max_length_all[, .(mean_length = mean(max_length)), by = site]
dat2_mean_length_max <- max_length_all[max_length >= 5, .(mean_length_thr5 = mean(max_length)), by = site]
dat_mean_length_max <- merge(
  dat_mean_length_max, 
  dat2_mean_length_max, by = "site", sort = FALSE)

dat_mean_length_max
dat_mean_length

# save and reload
save(dat_mean_length, dat_mean_length_max, 
     file = paste0(p_output, "mean_lengths.rds"))

load(file = paste0(p_output, "mean_lengths.rds"), 
     verbose = TRUE)
```

```{r histograms}
# plot histograms
# beware... because of the way the bins are determined, the default histogram automatically lumps 1 and 2 together. better to first distill the data and use ggplot 
hist(s_length[[1]], main = "Histogram of Length of Time Abandoned \n Shaanxi/Shanxi Provinces, China", xlab = "Time (years)")

hist(b_length[[1]])

hist(length_all[site == "shaanxi", length], main = "Histogram of Abandonment Period Lengths \n Shaanxi/Shanxi Provinces, China", xlab = "Time (years)")

hist(length_all[site == "belarus", length], main = "Histogram of Abandonment Period Lengths \n Belarus/Russia", xlab = "Time (years)")

hist(b_length[[1]], main = "Histogram of Abandonment Period Lengths \n Belarus/Russia", xlab = "Time (years)")
toc()

hist(b_length[[1]], main = "right = TRUE")
hist(b_length[[1]], right = FALSE, main = "right = FALSE")



# ggplots
# both site histograms
distill == length_distill
max_distill == max_length_distill


dat_mean_length

length_plot <- ggplot(data = length_distill) + 
  labs(title = "Histogram of time abandoned across all individual periods of abandonment") +
  xlab("Time abandoned (years)") + ylab(expression("Count  (10"^{6}*" pixels)")) +
  geom_col(mapping = aes(x = length, y = freq/(10^6)), fill = "gray50") +
  facet_grid(rows = vars(site), scales = "free") +
  geom_vline(xintercept = 5, linetype="dashed", 
             color = "red", size = 0.75) +
  # geom_vline(xintercept = dat_mean_length$mean_length, linetype="dashed", color = "pink", size = 0.75,
  #            show.legend = TRUE, le) +
  geom_vline(xintercept = 20, linetype="dashed", color = "forest green", size = 0.75) +
  theme_classic()

length_blip1_plot <- ggplot(data = length_blip1_distill) + 
  labs(title = "Histogram of time abandoned across all individual periods of abandonment",
       subtitle = "Counting only recultivation of 2 or more continuous years") +
  xlab("Time abandoned (years)") + ylab(expression("Count  (10"^{6}*" pixels)")) +
  geom_col(mapping = aes(x = length, y = freq/(10^6)), fill = "gray50") +
  facet_grid(rows = vars(site), scales = "free") +
  geom_vline(xintercept = 5, linetype="dashed", 
             color = "red", size = 0.75) +
  # geom_vline(xintercept = dat_mean_length$mean_length, linetype="dashed", color = "pink", size = 0.75,
  #            show.legend = TRUE, le) +
  geom_vline(xintercept = 20, linetype="dashed", color = "forest green", size = 0.75) +
  theme_classic()



class(max_length_distill)

max_length_distill[max_length > 0,]
# max_length
max_length_plot <- ggplot(data = max_length_distill[max_length > 0]) + 
  labs(title = "Histogram of maximum time abandoned per pixel") +
  xlab("Maximum time abandoned (years)") + ylab(expression("Count  (10"^{6}*" pixels)")) + 
  geom_col(mapping = aes(x = max_length, y = freq/(10^6)), fill = "gray50") +
  facet_grid(rows = vars(site), scales = "free") +
  geom_vline(xintercept=5, linetype="dashed", 
             color = "red", size = 0.75) +
  geom_vline(xintercept=20, linetype="dashed", color = "forest green", size = 0.75) +
  theme_classic()

max_length_distill

length_plot
max_length_plot

dat_mean_length



# just belarus
ggplot(data = b_distill) + 
  geom_col(mapping = aes(x = length, y = freq), fill = "black") +
  theme_classic()

ggplot(data = b_length, aes(length)) + 
  geom_histogram() +
  theme_classic() # took forever!! Beware...
```

```{r save-age-histograms}

# all lengths
png(filename = paste0(p_output, "plots/length_hist.png"), 
    width = 7, height = 5, units = "in", res = 400)
print(length_plot)
dev.off()


# all lengths, blip1
png(filename = paste0(p_output, "plots/length_hist_blip1.png"), 
    width = 7, height = 5, units = "in", res = 400)
print(length_blip1_plot)
dev.off()



# max lengths
png(filename = paste0(p_output, "plots/max_length_hist.png"), 
    width = 7, height = 5, units = "in", res = 400)
print(max_length_plot)
dev.off()

```

```{r lc-abn-area-over-time}
s_dt[, .N, by = .(y1987)] #
s_dt[, .N, by = .(y2017)] #

s_dt[, .N, by = .(y1987, y1988)] #
s_dt[, table(y1987)]

grep("x$|y$", names(s_dt), value = TRUE, invert = TRUE)

s_dt[, -c("x", "y")]
s_dt[, .N, by = c(paste0("y", 1987:2017))] #

s_dt[, .N, by = .(y1987)][order(get("y1987"))]
DT <- s_dt[, .N, by = .(y1987)][order(get("y1987"))] %>% 
  as_tibble()

DT
i <- "y1987"
rename(DT, "lc" = i, 
           eval(i) = "N")
# s_dt[, c("i", "freq") := NULL]


# ------------- calculate area raster ---------------- #
s_area <- raster::area(s$y2017) # area in km2
res(s_area)[1] * # resolution of the raster, in degrees (lat/long)
  100 * # ~100-110 km per degree 
  1000 # 1000 m/km = 26.95 m resolution

plot(s_area)

summary(getValues(s_area))
median(getValues(s_area)) # 0.0006972 km2. 
median(getValues(s_area)) * 100 / 1 # 100 ha/km2

# median pixel size is 697 m2, 0.0697 ha, or 0.000697 km2. 
median(getValues(s_area)) * # km2
  100 * # 100 ha per km2 
  10000 # m2 per ha

# the difference between minimum and maximum cell size, in m2
(max(getValues(s_area)) - 
    min(getValues(s_area))
  ) * # in km2
  1000^2 # m2 / km 2


# abandoned area over time
s_age_r
plot(s_age_r$y2017)
plot(s_age_r$y2017 > 0)
cellStats((s_age_r$y2017 > 0), "sum")

s_age[y2017 > 0, .N] # the total number of pixels with non-zero abandonment ages in the year 2017

s_age[, lapply(.SD, mean)] # mean age of abandonment over time.
s_age[y1988 > 0, .N] # count of "abandoned" cells in a particular year
s_age[get("y2017") > 0, .N]
s_age[y2017 > 0, .N]


# calculate areas for lc and abn manually
lc_area_s <- cc_total_area_per_lc(land_cover_dt = s_dt, area_raster = s_area)
abn_area_s <- cc_calc_abn_area(s_age, s_area)
area_s <- rbind(lc_area_s, abn_area_s)



# -------------------------------------------------------------- #
# -------------------------------------------------------------- #
# ------------- calculate total area per lc ---------------- #
area_s <- cc_calc_area_per_lc_abn(land_cover_dt = s_dt, 
                                  abn_age_dt = s_age, 
                                  land_cover_raster = s$y2017)

# ------------- plot ---------------- #
cc_save_plot_lc_abn_area(input_area_df = area_s, subtitle = "Shaanxi/Shanxi Provinces, China", 
                         outfile_label = "s",
                         width = 6, height = 4)

# manually
gg_lc_abn_area_s <- ggplot(data = area_s, aes(year, area_ha)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  labs(y = expression("Area  (10"^{6}*" ha)") , 
       x = "Year", 
       title = "Area by Land Cover, with Abandonment",
       subtitle = "Shaanxi/Shanxi Provinces, China",
       color = "Land Cover") + 
  geom_line(mapping = aes(x = year, y = area_ha / (10^6), # convert to millions of ha
                          group = lc, color = lc),
            size = 1.2)

gg_lc_abn_area_s

# filter to include only subsets
gg_lc_abn_area_s %+% filter(area_s, lc == "Abandoned") + labs(title = "Abandoned Area")
gg_lc_abn_area_s %+% filter(area_s, lc != "Abandoned")

gg_lc_abn_area_s
gg_abn_area_s

gg_lc_abn_area_s2
gg_lc_abn_area_s




```


```{r abandonment-persistence}
# testing
s_age[get(paste0("y", 1987:2017)[2]) > 0]
s_age[y1988 > 0]


# ----------------------- see functions in _util_dt_filter_functions ------------------------------------
# manual
persistence_count_long <- cc_calc_persistence(abn_age_dt = s_age, land_cover_raster = s$y2017, 
                                              stat_proportion = FALSE,
                                              NA_first = FALSE)

persistence_count_long2 <- cc_calc_persistence(abn_age_dt = s_age, land_cover_raster = s$y2017, 
                                              stat_proportion = FALSE, include_wide = TRUE,
                                              NA_first = FALSE)

# as a list

persistence_list_s <- cc_calc_persistence_all(abn_age_dt = s_age, land_cover_raster = s$y2017)


# ----------------------------------- plot ------------------------------------------------- #

# plot the count of pixels abandoned (or age 1) in each year. This shows that over time, a greater amount of land is abandoned at once.
ggplot(data = filter(persistence_list_s$count, time_abn == 1)) + 
  theme_classic() + 
  geom_point(mapping = aes(x = year_abn, y = area_ha, color = year_abn))


# save as a plot
cc_save_plot_abn_persistence(input_list = persistence_list_s, subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s")
```

```{r abn-gain-loss-area}
# calculate the abandonment area turnover
abn_area_change_s <- cc_calc_abn_area_diff(abn_age_dt = s_age, area_raster = s_area)

cc_save_plot_area_gain_loss(input_area_change_df = abn_area_change_s, 
                            subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s",
                            width = 6)


```

```{r abn-area-by-age-class}
area_s %>% filter(lc == "Abandoned")
persistence_list_s$count_na_first
persistence_list_s$count

# first plot
age_class0 <- ggplot(data = persistence_list_s$count_na_first) + 
  theme_classic() +
  geom_col(mapping = aes(x = year, y = area_ha / 10^3, group = year_abn, fill = year_abn)) + 
  labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Years since initial abandonment", 
         title = "Area of Abandoned Land, by Age Class",
         subtitle = "Shaanxi/Shanxi Province, China",
         fill = "Year Abandoned") + 
  scale_fill_distiller(palette = "Greens") + theme(legend.position = "bottom") + 
  scale_x_continuous(n.breaks = 10)

# trying some massaging
age_class_df <- persistence_list_s$count_na_first %>% 
  mutate(age = year - year_abn + 1) %>% 
  mutate(bins = ifelse(age > 0 & age <= 5, "1 to 5 years",
                       ifelse(age > 5 & age <= 10, "5 to 10 years",
                              ifelse(age > 10 & age <= 15, "10 to 15 years",
                                     ifelse(age > 15 & age <= 20, "15 to 20 years",
                                            ifelse(age > 20 & age <= 30, "20 to 30 years", NA)
                                            ))))) %>%
  mutate(bins = as_factor(bins))

# plot



# Function
cc_save_plot_area_by_age_class(input_list = persistence_list_s, 
                               subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s")

```






```{r save-rasters}
cc_save_map_pnv_hab_lc_abn(maxpixels = 3000000)

cc_save_map_lc_age_rasters(maxpixels = 3000000)

```



```{r master-functions}
# Shaanxi master functions
# 1. ------------- calculate total area per lc, with abandonment ---------------- #
area_s <- cc_calc_area_per_lc_abn(land_cover_dt = s_dt, 
                                  abn_age_dt = s_age, 
                                  land_cover_raster = s$y2017)

cc_save_plot_lc_abn_area(input_area_df = area_s, subtitle = "Shaanxi/Shanxi Provinces, China", 
                         outfile_label = "s",
                         width = 5, height = 4)

# 2. ------------------------ abandonment persistence --------------------------- #
persistence_list_s <- cc_calc_persistence_all(abn_age_dt = s_age, land_cover_raster = s$y2017)

cc_save_plot_abn_persistence(input_list = persistence_list_s, subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s")


# 3. -------------------- calculate the abandonment area turnover ------------------- #
abn_area_change_s <- cc_calc_abn_area_diff(abn_age_dt = s_age, area_raster = s_area)

cc_save_plot_area_gain_loss(input_area_change_df = abn_area_change_s, 
                            subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s",
                            width = 6)

# 4. -------------------- plot abandonment area by age class ------------------- #
cc_save_plot_area_by_age_class(input_list = persistence_list_s, 
                               subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s")




# mega function to save all four plot types
tic()
cc_save_area_persistence_plots(land_cover_dt = s_dt, 
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017,
  subtitle = "Shaanxi/Shanxi Provinces, China",
  outfile_label = "_s"
  )
toc()

load(file = paste0(p_output, "abn_dat_products_s.rds"), verbose = TRUE)

# how do i deal with different thresholds of abandonment?

```

```{r load-files}
load(file = paste0(p_output, "abn_dat_products_s.rds"), verbose = TRUE)
# caution, will have to rename them!
area_s <- area
persistence_list_s <- persistence_list
abn_area_change_s <- abn_area_change


load(file = paste0(p_output, "abn_dat_products_b.rds"), verbose = TRUE)
area_b <- area
persistence_list_b <- persistence_list
abn_area_change_b <- abn_area_change

```


```{r belarus-plots}
# Belarus:

tic()
cc_save_area_persistence_plots(land_cover_dt = b_dt, 
  abn_age_dt = b_age, 
  land_cover_raster = b$y2017,
  subtitle = "Eastern Belarus/Smolensk, Russia",
  outfile_label = "_b"
  )
toc()

# generate plots
cc_save_area_persistence_plots(subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s")

cc_save_area_persistence_plots(subtitle = "Shaanxi/Shanxi Provinces, China", input_site_label = "_s", 
                     outfile_label = "_s_all")

cc_save_area_persistence_plots(subtitle = "Eastern Belarus/Smolensk, Russia", input_site_label = "_b", 
                     outfile_label = "_b_all")



```

# Update to implement 5 year threshold
```{r n_lc_area}
# three files:
area_s
persistence_list_s
abn_area_change_s

# first, area

ggplot(data = area_s) +
    theme_classic() +
    # theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
    labs(y = expression("Area  (10"^{6}*" ha)") , 
         x = "Year", 
         title = "Area by Land Cover, with Abandonment",
         subtitle = subtitle,
         color = "Land Cover") + 
    geom_line(mapping = aes(x = year, y = area_ha / (10^6), # convert to millions of ha
                            group = lc, color = lc),
              size = 1.2) + 
    scale_x_continuous(n.breaks = 10)

abandonment_threshold <- 5

abandoned_area_df <- tibble(
    year = 1987:2017,
    lc = "Abandoned",
    count = sapply(1:31, function(i) {s_age[get(paste0("y", 1987:2017)[i]) >= abandonment_threshold, .N]}),
    count_all = sapply(1:31, function(i) {s_age[get(paste0("y", 1987:2017)[i]) > 0, .N]}),

    area_ha = count * median_cell_area_km2 * 100,
    area_all_ha = count_all * median_cell_area_km2 * 100
  )

s_age[y1992 >= 5, .N]

abandoned_area_df %>% print(n = 31)
filter(area, lc != "Abandoned")
n_area_s1 <- bind_rows(filter(area_s, lc != "Abandoned"), abandoned_area_df) %>% print(n = 155)

tic()
n_area_s <- cc_calc_area_per_lc_abn(land_cover_dt = s_dt,
                                    abn_age_dt = s_age, 
                                    land_cover_raster = s$y2017,
                                    abandonment_threshold = 5)
toc()
identical(n_area_s, n_area_s1)

# new updated plot
ggplot(data = n_area_s 
       %>% filter(lc != "Abandoned (all)") %>% 
         mutate(lc = recode(lc, "Abandoned (>5)" = "Abandoned"))
       ) +
  theme_classic() +
  # theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  labs(y = expression("Area  (10"^{6}*" ha)") , 
       x = "Year", 
       title = "Area by Land Cover, with Abandonment",
       subtitle = subtitle,
       color = "Land Cover") + 
  geom_line(mapping = aes(x = year, y = area_ha / (10^6), # convert to millions of ha
                          group = lc, color = lc),
            size = 1.2) + 
  scale_x_continuous(n.breaks = 10) #+
  # scale_color_discrete(name = "COVER", 
  #                      labels = c("Abandoned (>5)",
  #                                 "Abandoned (all)", 
  #                                 "Crop", "Grassland", 
  #                                 "Non-veg", "Woody veg"))

n_area_s %>% select(lc) %>% unique() %>% arrange(lc)

persistence_list_s
abn_area_change_s

```

```{r n_persistence}
persistence_list_s

s_age
s

persistence_list_s <- cc_calc_persistence_all(
  abn_age_dt = s_age, land_cover_raster = s$y2017)

# starting with i + 1 (i.e. 1988), count the number of cells that are of i age, then the next year, with age 2, then the next year with age 3, etc.
# the j represents each cohort of abandonment. I think I can just start with the fifth year for the counts.
stat_proportion <- FALSE
NA_first <- TRUE
pl1 <- persistence_list
pl2 <- persistence_list

pl1
pl2


names(persistence_list) <- paste0("y", 1988:2017)
pl2[[1]][-c(1:4)]
abandonment_threshold
c(abandonment_threshold:31) %>% length
pl2[[1]][c(abandonment_threshold:31)]
pl_na1 <- persistence_list
pl_na2 <- persistence_list

pl_na1[[1]]
pl_na2[[1]]
test1 <- pl_na1[[30]]
test2 <- pl_na2[[30]]
test2[c(1:4)] <- NA

n_pl_na1 <- persistence_list
n_pl_na2 <- persistence_list

temp_vector[c(1:31)]
pl_na1
n_pl_na1

pl_na2
n_pl_na2
for(i in 1:30) {print(length(persistence_list[[i]]))}

temp_vector[c()]

# remove cells that are below threshold
if (NA_first){
  temp_vector[c((1:(abandonment_threshold - 1)) + j)] <- NA
} else {
  temp_vector[c(1:(abandonment_threshold - 1))] <- NA
}

persistence_long %>% arrange(year_abn, time_abn)
pl2[-c(1:4)]

 temp_vector4 <- c(
      if (NA_first) {rep(NA, j)
        } else {rep(NA, 0)},
      sapply(1:(31 - j), function(i) {
        abn_age_dt[get(paste0("y", 1987:2017)[i + j]) == i, .N]
      }),
      if (NA_first) {rep(NA, 0)
      } else {rep(NA, j)}
    )
 
temp_vector %>% length
temp_vector1 %>% length
temp_vector2 %>% length
temp_vector3 %>% length
temp_vector4
abandonment_threshold:(31 - 27)
sapply(abandonment_threshold:(31 - 27), function(i) {
        abn_age_dt[get(paste0("y", 1987:2017)[i + 27]) == i, .N]
      })

abn_age_dt[get(paste0("y", 1987:2017)[i + j]) == i, .N]
abn_age_dt[get(paste0("y", 1987:2017)[i + j]) == i, .N]
abn_age_dt[y1994 == 7, ]

count_s <- cc_calc_persistence(abn_age_dt = s_age, 
                               land_cover_raster = s$y2017, 
                               stat_proportion = FALSE,
                               NA_first = FALSE, include_wide = FALSE)



proportion <- cc_calc_persistence(abn_age_dt, land_cover_raster, 
                                  stat_proportion = TRUE,
                                  NA_first = FALSE, include_wide = FALSE)

count_na_first <- cc_calc_persistence(abn_age_dt, land_cover_raster, 
                                      stat_proportion = FALSE,
                                      NA_first = TRUE, include_wide = FALSE)

proportion_na_first <- cc_calc_persistence(abn_age_dt, land_cover_raster, 
                                           stat_proportion = TRUE,
                                           NA_first = TRUE, include_wide = FALSE)




# try the new functions

n_persistence_list_s <- cc_calc_persistence_all(
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017, 
  include_wide = FALSE,
  abandonment_threshold = 5,
  include_all_abandonment = FALSE
)
n_persistence_list_s$na_last %>% select(proportion) %>% summary()
n_persistence_list_s$na_first %>% select(proportion) %>% summary()

n_persistence_list_s1 <- cc_calc_persistence_all(
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017, 
  include_wide = FALSE,
  abandonment_threshold = 1
)

n_persistence_list_s_all <- cc_calc_persistence_all(
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017, 
  include_wide = FALSE,
  abandonment_threshold = 5,
  include_all_abandonment = TRUE
)

n_persistence_list_s_wide <- cc_calc_persistence_all(
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017, 
  include_wide = TRUE,
  abandonment_threshold = 5,
  include_all_abandonment = TRUE
)

pl_test <- 
  cc_calc_persistence(
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017, 
  stat_proportion = TRUE, # doesn't work for true
  NA_first = TRUE, # works for false, and for true?
  include_wide = FALSE,
  abandonment_threshold = 5
)
j <- 27
# doesn't work for 
stat_proportion = TRUE
NA_first = FALSE
include_wide = FALSE

stat_proportion = TRUE
NA_first = FALSE
include_wide = FALSE
abandonment_threshold = 1
# doesn't work for the na_first

# for NA_first = FALSE, it works
# for NA_first = TRUE, it works
persistence_list[[30]]
if(sum(persistence_list[[30]], na.rm = TRUE) == 0) {print("yes")}

test <- persistence_list[[30]]/max(persistence_list[[30]], na.rm = TRUE)

temp_vector[c(1:(31 - (abandonment_threshold - 1)))]

temp_vector[c()]

temp_vector[c(abandonment_threshold + 1:27)]
# try plotting:
cc_save_plot_abn_persistence
cc_save_plot_area_by_age_class
```

```{r n_age-class}

persistence_list_s


ggplot(data = filter(persistence_list_s$count_na_first, age >= 5)) + 
  theme_classic() +
  labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
       x = "Year", 
       title = "Area of Abandoned Land, by Age Class",
       subtitle = subtitle,
       fill = "Age") + 
  #scale_x_continuous(n.breaks = 10) + 
  geom_col(mapping = aes(x = year, y = area_ha / 10^3, group = bins, fill = bins),
             position = position_stack(reverse = TRUE)
    ) +
  scale_fill_brewer(palette = "Greens", direction = 1) + 
  geom_line(data = filter(n_area_s, lc == "Abandoned (>5)"), mapping = aes(x = year, y = area_ha / (10^3)))
  


age_class_continuous <- age_class_base +
    geom_col(mapping = aes(x = year, y = area_ha / 10^3, group = age, fill = age),
             position = position_stack(reverse = TRUE)
    ) + 
    scale_fill_distiller(palette = "Greens", direction = 1)


  
  age_class_bins <- age_class_base +
    geom_col(mapping = aes(x = year, y = area_ha / 10^3, group = bins, fill = bins),
             position = position_stack(reverse = TRUE)
    ) +
    scale_fill_brewer(palette = "Greens", direction = 1) 
```


```{r n_abn_area_change}
abn_area_change_s

identical(s_age, abn_age_dt)
abn_age_dt

 # new. remove cells that are below threshold
    
abn_turnover_list
abn_turnover_list[[1]] %>% length()
abn_turnover_list[[1]]
i <- 1
j <- 3

# testing grounds:
temp_vector_diff <- c(
      rep(0, j),
      sapply(1:(31 - j), function(i) {
        abn_age_dt[get(paste0("y", 1987:2017)[i + j]) == i, .N]
      })
    )
# need to remove cells below abandonment threshold
temp_vector_diff[c(j + 1:(abandonment_threshold - 1))] <- 0

# trim to right length
if(length(temp_vector_diff) > 31){
  temp_vector_diff <- temp_vector_diff[c(1:31)]
  }

# calculate diff
temp_vector_diff <- diff(temp_vector_diff)

test <- cc_calc_abn_area_diff(abn_age_dt = s_age, 
                              land_cover_raster = s$y2017,
                              abandonment_threshold = 5)
cc_save_plot_area_gain_loss(
  input_area_change_df = test, 
  subtitle = "subtitle", 
  outfile_label = "test")
  

temp_vector_diff %>% length
abn_turnover_list[[30]] %>% length

abn_age_dt[get(paste0("y", 1987:2017)[i+1]) == i, .N]
abn_age_dt[get(paste0("y", 1987:2017)[i + j]) == i, .N]

    if (abandonment_threshold > 1) {
      if (NA_first){
        temp_vector[c((1:(abandonment_threshold - 1)) + j)] <- NA
      } else {
        temp_vector[c(1:(abandonment_threshold - 1))] <- NA
      }
      
      if(length(temp_vector) > 31){
        temp_vector <- temp_vector[c(1:31)]
      }
    }
```


```{r run-full-functions}

# ------------------------------------------ #
# ----------------- Shaanxi ---------------- #
# ------------------------------------------ #
tic()
cc_summarize_abn_dts(
  land_cover_dt = s_dt, 
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017,
  outfile_label = "_s",
  abandonment_threshold = 5,
  include_all = TRUE
  )
toc()

# load(file = paste0(p_output, "abn_dat_products_s.rds"), verbose = TRUE) # now happens inside the function


tic()
cc_save_area_persistence_plots(
  input_site_label = "_s", 
  blip_label = "_blip1",
  outfile_label = "_s_blip1",
  subtitle = "Shaanxi/Shanxi Provinces, China (recult. >= 2)", 
  subtitle_all = "Shaanxi/Shanxi Provinces, China, all abandonment (recult. >= 2)",
  save_all = TRUE
)
toc()


# ------------------------------------------ #
# ----------------- Belarus ---------------- #
# ------------------------------------------ #
tic()
cc_summarize_abn_dts(
  land_cover_dt = b_dt, 
  abn_age_dt = b_age, 
  land_cover_raster = b$y2017,
  outfile_label = "_b",
  abandonment_threshold = 5,
  include_all = TRUE
  )
toc()


load(file = paste0(p_output, "abn_dat_products_b.rds"), verbose = TRUE)

# 
tic()
cc_save_area_persistence_plots(
  input_site_label = "_b", 
  blip_label = "_blip1",
  outfile_label = "_b_blip1",
  subtitle = "Eastern Belarus/Smolensk, Russia (recult. >= 2)", 
  subtitle_all = "Eastern Belarus/Smolensk, Russia, all abandonment (recult. >= 2)", 
  save_all = TRUE
)
toc()


# ------------------------------------------ #
# ------------ Fragmentation --------------- #
# ------------------------------------------ #
cc_save_frag_plots(input = frag_dat, outfile_label = NULL)


```

```{r clean-up}

env_size(ls())

```

