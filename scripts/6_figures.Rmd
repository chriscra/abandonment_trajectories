---
title: "Figures"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r initialize}
source("scripts/0_start.R")
```

```{r basemaps}
source("")
```


```{r load-data}
# for use on cluster:
p_dat <- "/scratch/network/clc6/abandonment_trajectories/data_derived/"
p_dat_derived <- "/scratch/network/clc6/abandonment_trajectories/data_derived/"
p_output <- paste0("/scratch/network/clc6/abandonment_trajectories/output/")
list.files(p_dat_derived)

site_df <- read.csv(file = paste0(p_dat_derived, "site_df.csv"))


# Land use class codes:
#       1. Non-vegetated area (e.g. water, urban, barren land)
#       2. Woody vegetation
#       3. Cropland 
#       4. Herbaceous land (e.g. grassland)

# testers:
bs <- brick(paste0(p_dat, "Abandonment/belarus_small.tif"))
bt <- brick(paste0(p_dat_derived, "belarus_subset.tif"))
names(bs) <- paste0("y", 1987:2017)
names(bt) <- paste0("y", 1987:2017)


# -------------------------- rasters --------------------------- #
# raw rasters
s <- brick(paste0(p_dat_derived, "input_rasters/shaanxi.tif"))
b <- brick(paste0(p_dat_derived, "input_rasters/belarus.tif")) # merged version

# age
s_age_r <- brick(paste0(p_dat_derived, "shaanxi_age.tif"))
b_age_r <- brick(paste0(p_dat_derived, "belarus_age.tif"))

# max_length
s_max_length_r <- brick(paste0(p_dat_derived, "shaanxi_max_length.tif"))
b_max_length_r <- brick(paste0(p_dat_derived, "belarus_max_length.tif"))

# update year names 1987 - 2017
names(s) <- paste0("y", 1987:2017)
names(b) <- paste0("y", 1987:2017)
names(s_age_r) <- paste0("y", 1987:2017)
names(b_age_r) <- paste0("y", 1987:2017)


# prepared input rasters (derived by Chris)
site_input_raster_files <- list.files(paste0(p_dat_derived, "input_rasters"), full.names = TRUE) %>%
  grep(".tif", ., value = TRUE) #%>% grep("age", ., value = TRUE, invert = TRUE)

r <- lapply(seq_along(site_input_raster_files), function(i) {brick(site_input_raster_files[i])})
names(r) <- site_df$site

# rename raster layers:
for (i in 1:11) {
  if (names(r[i]) == "nebraska") {
    names(r[[i]]) <- paste0("y", 1986:2018)
  } else {
    if (names(r[i]) == "wisconsin") {
      names(r[[i]]) <- paste0("y", 1987:2018)
    } else {
      # everything else, just 1987:2017
      names(r[[i]]) <- paste0("y", 1987:2017)
    }}}


# abandonment age maps (produced by Chris)
age_files <- list.files(paste0(p_dat_derived, "age_rasters"), full.names = TRUE) %>%
  grep(".tif", ., value = TRUE) #%>% grep("age", ., value = TRUE, invert = FALSE)

age_r <- lapply(seq_along(age_files), function(i) {brick(age_files[i])})
names(age_r) <- site_df$site
for (i in seq_along(age_r)) {names(age_r[[i]]) <- paste0("y", 1987:2017)} # remember: these are just 1987:2017

# year of first abandonment maps (from He)
yoa_files <- list.files(paste0(p_dat, "Abandonment/year_of_abandonment/"))

# -------------------------- data.tables --------------------------- #
b_age <- fread(input = paste0(p_dat_derived, "belarus_age.csv"))
names(b_age)
s_age <- fread(input = paste0(p_dat_derived, "shaanxi_age.csv"))


b_length <- fread(input = paste0(p_dat_derived, "lengths/", "belarus_length_b1.csv"))
s_length <- fread(input = paste0(p_dat_derived, "lengths/", "shaanxi_length_b1.csv"))

b_max_length <- fread(input = paste0(p_dat_derived, "lengths/", "belarus_max_length_b1.csv"))
s_max_length <- fread(input = paste0(p_dat_derived, "lengths/", "shaanxi_max_length_b1.csv"))

# original data
s_dt <- fread(input = paste0(p_dat_derived, "shaanxi.csv"))
names(s_dt) <- gsub(pattern = "andcover", replacement = "y", names(s_dt))

b_dt <- fread(input = paste0(p_dat_derived, "belarus.csv")) # caution - huge file! 8.4 GB at least. 



# -------------------------- summarized data.frames --------------------------- #
indx <- 9
site <- site_df$site[indx] # set site:
site_label <- site_df$label[indx] # set label
blip_label <- "_b1"
load(file = paste0(p_output, "abn_dat_products", blip_label, site_label, ".rds"), verbose = TRUE)

# loads:
area_b1_s
persistence_list_b1_s
abn_area_change_b1_s



```

```{r simple-plots}

# -------------------------- plot raw data --------------------------- #
plot(b$y1987, main = "Belarus 1987", breaks = c(0, plot_cols$breaks), col = plot_cols$color)
legend("bottomleft", cex = 0.6, inset = 0,
       legend = plot_cols$name, 
       fill = plot_cols$color)

plot(b$y2017, main = "Belarus 2017", breaks = c(0, plot_cols$breaks), col = plot_cols$color)
legend("bottomleft", cex = 0.6, inset = 0,
       legend = plot_cols$name, 
       fill = plot_cols$color)

# ---------------------- plot abandonment age ---------------------- #
plot(b_age_r$y2017, main = "Belarus Age of Abandonment 2017")
plot(b_age_r[[28:31]])



# -------------------------- animate --------------------------- #
# --------------
# https://www.rdocumentation.org/packages/raster/versions/3.1-5/topics/animate

animate(bt, pause = 0.5, zlim = c(1, 4), maxpixels=5000, n=1,
        breaks = c(0, plot_cols$breaks), col = plot_cols$color)

```

```{r global-site-map}
r
plot(r$shaanxi$y1987)

r_extent <- lapply(r, raster::extent)
plot(r_extent$belarus)

site_sf <- lapply(r, FUN = function(x) {
  x %>% 
    extent() %>% 
    as(., 'SpatialPolygons') %>%
    st_as_sf()
  }) %>% 
  bind_rows() %>% 
  mutate(site = site_df$site, 
         label = gsub("_", "", site_df$label),
         lab_desc = paste0("(", label, ") ", site_df$description),
         desc = site_df$description)




plot(site_sf)

# basemap
world <- ne_countries(scale = "small", returnclass = "sf") # can set returnclass to sf or sp.

# set crs for site_sf 
st_crs(site_sf) <- st_crs(world$geometry)

# -------------------------------------------------------------------- #
# save site_sf
st_write(site_sf, dsn = paste0(p_dat_derived, "site_sf.shp"))

# load back in:
site_sf <- st_read(paste0(p_dat_derived, "site_sf.shp"))

# bind sf with df
left_join(site_sf, site_df, by = site)
site_sf$site[9] == site_df$site[9]

# -------------------------------------------------------------------- #
gg_globe <- ggplot() + 
  theme_classic() +
  geom_sf(data = world %>% filter(continent != "Antarctica"), fill = NA, color = "gray") +
  geom_sf(data = site_sf, mapping = aes(fill = desc)) + 
  labs(#subtitle = "Map projection: longlat", 
       x = NULL, y = NULL) +
  theme(legend.position = "bottom") + 
  geom_label_repel(data = site_sf,
                   aes(label = label, geometry = geometry),
                   stat = "sf_coordinates",
                   min.segment.length = 0.0, segment.alpha = 1,
                   point.padding = 0.2, box.padding = 0.2,
                   label.size = 0.3, color = "black")


gg_globe

proj_text <- "moll"
gg_globe1 <- gg_globe +
  coord_sf(expand = TRUE, crs = st_crs(paste0("+proj=", proj_text))) +
  labs(subtitle = paste0("Map projection: ", proj_text))


proj_text <- "eck4"
gg_globe2 <- gg_globe +
  coord_sf(expand = TRUE, crs = st_crs(paste0("+proj=", proj_text))) +
  labs(subtitle = paste0("Map projection: ", proj_text))

# use this one:
proj_text <- "eqearth"
gg_globe3 <- gg_globe +
  coord_sf(expand = TRUE, crs = st_crs(paste0("+proj=", proj_text))) +
  labs(subtitle = paste0("Map projection: ", proj_text))

proj_text <- "natearth2"
gg_globe4 <- gg_globe +
  coord_sf(expand = TRUE, crs = st_crs(paste0("+proj=", proj_text))) +
  labs(subtitle = paste0("Map projection: ", proj_text))


plot_grid(gg_globe, gg_globe1, gg_globe2, gg_globe3, gg_globe4)
warnings()
# -------------------------------------------------------------------- #
# save map
png(filename = paste0(p_output, "plots/site_locations_w_labels.png"), 
    width = 9, height = 6, units = "in", res = 400)
print(gg_globe4 + labs(subtitle = NULL))
dev.off()


# long labels:
png(filename = paste0(p_output, "plots/site_locations_w_labels_long.png"), 
    width = 9, height = 6, units = "in", res = 400)

ggplot() + 
  theme_classic() +
  geom_sf(data = world %>% filter(continent != "Antarctica"), fill = NA, color = "gray") +
  geom_sf(data = site_sf, mapping = aes(fill = lab_desc)) + 
  labs(x = NULL, y = NULL) +
  theme(legend.position = "bottom") + 
  geom_label_repel(data = site_sf,
                   aes(label = desc, geometry = geometry),
                   stat = "sf_coordinates",
                   min.segment.length = 0.0, segment.alpha = 1,
                   point.padding = 0.2, box.padding = 0.2,
                   label.size = 0.3, color = "black") +
  # labs(subtitle = paste0("Map projection: ", "natearth2")) + 
  coord_sf(expand = TRUE, crs = st_crs(paste0("+proj=", "natearth2")))

dev.off()

# just chinese sites
ggplot() + 
  # coord_sf(CRS = st_crs("+proj=eck4")) + 
  geom_sf(data = filter(world, name %in% c("China")), fill = NA, color = "gray") +
  geom_sf(data = site_sf %>% filter(site %in% c("shaanxi", "chongqing")), mapping = aes(fill = site)) + 
  geom_sf_label(data = site_sf, aes(label = site)) + 
  labs(subtitle = paste0("Map projection: ", proj_text)) +
    theme_classic() +
  theme(legend.position = "bottom")


```




```{r exploratory-stats}
# explore some stats:
s_length
b_length
s_length[, .N, by = length]
b_length[, .N, by = length]

```

```{r calc-mean-length}
# calculate mean length
# -------------------------------------------------------------------- #
# ----------------- use lapply() to calculate mean length ------------ #
# -------------------------------------------------------------------- #
s_max_length[, mean(max_length)]
s_max_length[max_length > 0, mean(max_length)]
s_length_distill


mean_length_df <- lapply(site_df$site, FUN = function(x){
  length <- fread(input = paste0(p_dat_derived, "lengths/", x, "_length_b1.csv"))
  max_length <- fread(input = paste0(p_dat_derived, "lengths/", x, "_max_length_b1.csv"), 
                      select = "max_length") # drop x and y, makes loading and calculating much faster

  df <- data.frame(site = x,
                   mean_length = length[, mean(length)], # mean of all lengths
                   mean_length_thr3 = length[length >= 3, mean(length)], # mean length, assuming abandonment threshold of 5
                   mean_length_thr5 = length[length >= 5, mean(length)], # mean length, assuming abandonment threshold of 5
                   mean_length_max = max_length[max_length > 0, mean(max_length)], # mean of all lengths
                   mean_length_max_thr3 = max_length[max_length >= 3, mean(max_length)], # mean length, assuming abandonment threshold of 5
                   mean_length_max_thr5 = max_length[max_length >= 5, mean(max_length)] # mean length, assuming abandonment threshold of 5
                   )
  
  df # return df
  }
  )

# bind rows
mean_length_df <- bind_rows(mean_length_df)

# save site_df
write_csv(mean_length_df, path = paste0(p_dat_derived, "mean_length_df.csv"))

# re load
mean_length_df <- read.csv(file = paste0(p_dat_derived, "mean_length_df.csv"))






# testing code, old:
# ------------------------------------------ #
# ----------------- mean length ------------ #
# ------------------------------------------ #
s_length[, site := "shaanxi"]
b_length[, site := "belarus"]

length_all <- rbindlist(list(s_length, b_length))
object_size(length_all)

dat_mean_length <- length_all[, .(mean_length = mean(length)), by = site]
dat2_mean_length <- length_all[length >= 5, .(mean_length_thr5 = mean(length)), by = site]
dat_mean_length <- merge(dat_mean_length, dat2_mean_length, by = "site", sort = FALSE)
dat_mean_length

# can also calculate the mean length from the distilled dat
sum((b_distill$length * b_distill$freq)) / sum(b_distill$freq)

# ------------------------------------ #
# ----------- mean max length -------- #
# ------------------------------------ #
# max length, mean, etc.
s_length
s_max_length[, site := "shaanxi"]
b_max_length[, site := "belarus"]

max_length_all <- rbindlist(list(s_max_length, b_max_length))
object_size(max_length_all)

dat_mean_length_max <- max_length_all[, .(mean_length = mean(max_length)), by = site]
dat2_mean_length_max <- max_length_all[max_length >= 5, .(mean_length_thr5 = mean(max_length)), by = site]
dat_mean_length_max <- merge(
  dat_mean_length_max, 
  dat2_mean_length_max, by = "site", sort = FALSE)

dat_mean_length_max
dat_mean_length

# save and reload
save(dat_mean_length, dat_mean_length_max, 
     file = paste0(p_output, "mean_lengths.rds"))

load(file = paste0(p_output, "mean_lengths.rds"), 
     verbose = TRUE)

dat_mean_length
dat_mean_length_max
```


```{r plot-mean-length}
# -------------------------------------------------------------------- #
# ----------------- plot mean length of time abandoned ---------------- #
# -------------------------------------------------------------------- #

mean_length_df <- read.csv(file = paste0(p_dat_derived, "mean_length_df.csv"))

# pivot, add columns specifying abn threshold, all vs. max, etc.
mean_length_df_pivot <- mean_length_df %>% 
  pivot_longer(cols = starts_with("mean"), names_to = "col_names", values_to = "mean_length") %>%
  mutate(length_type = ifelse(grepl("max", col_names), "max", "all"),
         abn_threshold = ifelse(grepl("thr5", col_names), "5", 
                                ifelse(grepl("thr3", col_names), "3",
                                       "1")))

# mean mean length
mean_mean_df <- mean_length_df_pivot %>% 
  group_by(abn_threshold, length_type) %>%
  summarise(count = n(),
            mean_mean = mean(mean_length, na.rm = TRUE))


gg_mean_length <- ggplot(data = mean_length_df_pivot) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  labs(title = "Mean length of abandonment",
       subtitle = "Counting only recultivation of 2 or more continuous years",
       linetype = NULL) +
  ylab("Mean length of time abandoned (years)") + xlab("Site") +
  geom_col(mapping = aes(x = site, y = mean_length), fill = "gray50", width = 0.75) + 
  facet_grid(vars(length_type), vars(abn_threshold),
             labeller = labeller(length_type = c(all = "all lengths", #old = "new",
                                                 max = "max length per pixel"),
                                 abn_threshold = c("1" = "abn threshold = 1",
                                                   "3" = "abn threshold = 3",
                                                   "5" = "abn threshold = 5"))) +
  geom_hline(data = mean_mean_df, aes(yintercept = mean_mean, linetype = "mean"),
             show.legend = TRUE,
             # alternatively, just yintercept = 12
             #linetype = "dashed",
             color = "red", size = 0.75) + 
  scale_linetype_manual(values = c("mean" = "dashed"))



# -------------------------------------------------------------------- #
# ----------------- save ---------------- #
# -------------------------------------------------------------------- #

png(filename = paste0(p_output, "plots/mean_lengths_grid_b1.png"), 
    width = 8.5, height = 5, units = "in", res = 400)
print(gg_mean_length)
dev.off()
```

```{r distill-length-data}
  
# -------------------------------------------------------------------- #
# ----------------- use lapply() to distill all sites ---------------- #
# -------------------------------------------------------------------- #
# now, using lapply to run for all sites
# 2. Distill the length data, for use in histograms
length_distill_df <- lapply(site_df$site, FUN = function(x){
  length <- fread(input = paste0(p_dat_derived, "lengths/", x, "_length_b1.csv"))
  max_length <- fread(input = paste0(p_dat_derived, "lengths/", x, "_max_length_b1.csv"),
                      select = "max_length") # drop x and y, makes loading and calculating much faster

  dt <- length[, .(freq = .N), by = length
               ][, ':='(site = x, length_type = "all")]
  dt_max <- max_length[, .(freq = .N), by = max_length
                       ][order(max_length), 
                         ][, ':='(site = x, length_type = "max")
                           ][, length := max_length
                             ][, max_length := NULL][]
  dt <- bind_rows(dt, dt_max) # return dt
  dt
  }
  )

# bind rows
length_distill_df <- bind_rows(length_distill_df) %>% as.data.frame()


length_distill_df

# save site_df
write_csv(length_distill_df, path = paste0(p_dat_derived, "length_distill_df.csv"))

# re load
length_distill_df <- read.csv(file = paste0(p_dat_derived, "length_distill_df.csv"))










# old:

# testing code # 

# to use with ggplot, first distill the data

# regular, no thresholds
b_length_distill <- b_length[, .(freq = .N), by = length]
b_length_distill[, site := "belarus"]
s_length_distill <- s_length[, .(freq = .N), by = length]
s_length_distill[, site := "shaanxi"]

length_distill <- rbind(b_length_distill, s_length_distill)

# blip1
b_length_blip1_distill <- b_length_blip1[, .(freq = .N), by = length]
b_length_blip1_distill[, site := "belarus"]
s_length_blip1_distill <- s_length_blip1[, .(freq = .N), by = length]
s_length_blip1_distill[, site := "shaanxi"]

length_blip1_distill <- rbind(b_length_blip1_distill, s_length_blip1_distill)

# max_length

b_max_length_distill <- b_max_length[, .(freq = .N), by = max_length]
b_max_length_distill[, site := "belarus"]
s_max_length_distill <- s_max_length[, .(freq = .N), by = max_length]
s_max_length_distill[order(max_length),]

s_max_length_distill[, site := "shaanxi"]
max_length_distill <- rbind(b_max_length_distill, s_max_length_distill)

t1 <- s_length_distill[, ':='(site = site, length_type = "all")]

t2 <- s_max_length_distill[order(max_length), 
                           ][, ':='(site = site, length_type = "max")
                             ][, length := max_length
                               ][, max_length := NULL][]
t1
t2
bind_rows(t1, t2)

```

```{r histograms}

length_distill_df <- read.csv(file = paste0(p_dat_derived, "length_distill_df.csv"))
length_distill_df

# -------------------------------------------------------------------- #
# ----------------- plot histograms ---------------- #
# -------------------------------------------------------------------- #

length_distill_df %>% head()


ggplot(data = filter(length_distill_df, site == site_df$site[9], length > 0)) + 
  theme_classic() + 
  labs(title = paste0(site_df$description[9], ": histogram of time abandoned"),
       caption = "Recultivation threshold >= 2 years",
       linetype = "") +
  xlab("Time abandoned (years)") + ylab(expression("Count  (10"^{6}*" pixels)")) +
  geom_col(mapping = aes(x = length, y = freq/(10^6)), fill = "gray50") +
  facet_grid(rows = vars(length_type), scales = "free",
             labeller = labeller(length_type = c(all = "all abn. periods", #old = "new",
                                                 max = "max. length per pixel"))) +
  geom_vline(data = filter(mean_length_df_pivot, 
                           site == site_df$site[9],
                           abn_threshold == 1), 
             aes(xintercept = mean_length, linetype = "mean"),
             show.legend = TRUE,
             color = "darkblue", size = 0.75) + 
  scale_linetype_manual(values = c("mean" = "dashed")) + 
  theme(legend.position = c(0.85, 0.95), plot.caption = element_text(face = "italic"))

# -------------------------------------------------------------------- #
# ----------------- function ---------------- #
# -------------------------------------------------------------------- #
for (i in 1:11) {
  gg_hist <- ggplot(data = filter(length_distill_df, site == site_df$site[i], length > 0)) + 
    theme_classic() +
    labs(title = paste0(site_df$description[i], ": histogram of time abandoned"),
         caption = "Recultivation threshold >= 2 years",
         linetype = "") +
    xlab("Time abandoned (years)") + ylab(expression("Count  (10"^{6}*" pixels)")) +
    geom_col(mapping = aes(x = length, y = freq/(10^6)), fill = "gray50") +
    facet_grid(rows = vars(length_type), scales = "free",
               labeller = labeller(length_type = c(all = "all abn. periods", #old = "new",
                                                   max = "max. length per pixel"))) +
    # geom_vline(xintercept = 5, linetype="dashed", color = "red", size = 0.75) +
    # geom_vline(xintercept = 20, linetype="dashed", color = "forest green", size = 0.75) +
    geom_vline(data = filter(mean_length_df_pivot,
                             site == site_df$site[i],
                             abn_threshold == 1), 
               aes(xintercept = mean_length, linetype = "mean"),
               show.legend = TRUE, color = "darkblue", size = 0.75) + 
    scale_linetype_manual(values = c("mean" = "dashed")) +
    theme(legend.position = c(0.85, 0.95), plot.caption = element_text(face = "italic"))
    
  
  # save
  png(filename = paste0(p_output, "plots/", "length_hist_b1", site_df$label[i], ".png"), 
      width = 7, height = 5, units = "in", res = 400)
  print(gg_hist)
  dev.off()
}




# -------------------------------------------------------------------- #
# both site histograms

gg_length_hist_all_b1 <- ggplot(data = length_distill_df %>%
                                  filter(site %in% c("belarus", "shaanxi"),
                                         length_type == "all")) + 
  labs(title = "Histogram of time abandoned across all individual periods of abandonment",
       subtitle = "Recultivation threshold >= 2 years") +
  xlab("Time abandoned (years)") + ylab(expression("Count  (10"^{6}*" pixels)")) +
  geom_col(mapping = aes(x = length, y = freq/(10^6)), fill = "gray50") +
  facet_grid(rows = vars(site), scales = "free") +
  geom_vline(xintercept = 5, linetype="dashed", 
             color = "red", size = 0.75) +
  # geom_vline(xintercept = dat_mean_length$mean_length, linetype="dashed", color = "pink", size = 0.75,
  #            show.legend = TRUE, le) +
  geom_vline(xintercept = 20, linetype="dashed", color = "forest green", size = 0.75) +
  theme_classic()



# max_length
gg_max_length_hist_all_b1 <- ggplot(data = length_distill_df %>%
                                  filter(site %in% c("belarus", "shaanxi"),
                                         length_type == "max",
                                         length > 0)) + 
  labs(title = "Histogram of maximum time abandoned per pixel",
       subtitle = "Recultivation threshold >= 2 years") +
  xlab("Maximum time abandoned (years)") + ylab(expression("Count  (10"^{6}*" pixels)")) + 
  geom_col(mapping = aes(x = length, y = freq/(10^6)), fill = "gray50") +
  facet_grid(rows = vars(site), scales = "free") +
  geom_vline(xintercept = 5, linetype="dashed", color = "red", size = 0.75) +
  geom_vline(xintercept = 20, linetype = "dashed", color = "forest green", size = 0.75) +
  theme_classic()

gg_length_hist_all_b1
gg_max_length_hist_all_b1

# save to file ---------------- #
# all lengths
png(filename = paste0(p_output, "plots/length_hist_all_b1.png"), 
    width = 7, height = 5, units = "in", res = 400)
print(gg_length_hist_all_b1)
dev.off()

# max lengths
png(filename = paste0(p_output, "plots/max_length_hist_b1.png"), 
    width = 7, height = 5, units = "in", res = 400)
print(gg_max_length_hist_all_b1)
dev.off()









# old histograms
# beware... because of the way the bins are determined, the default histogram automatically lumps 1 and 2 together. better to first distill the data and use ggplot 
hist(s_length[[1]], main = "Histogram of Length of Time Abandoned \n Shaanxi/Shanxi Provinces, China", xlab = "Time (years)")

hist(b_length[[1]])

hist(length_all[site == "shaanxi", length], main = "Histogram of Abandonment Period Lengths \n Shaanxi/Shanxi Provinces, China", xlab = "Time (years)")

hist(length_all[site == "belarus", length], main = "Histogram of Abandonment Period Lengths \n Belarus/Russia", xlab = "Time (years)")

hist(b_length[[1]], main = "Histogram of Abandonment Period Lengths \n Belarus/Russia", xlab = "Time (years)")
toc()

hist(b_length[[1]], main = "right = TRUE")
hist(b_length[[1]], right = FALSE, main = "right = FALSE")


# just belarus
ggplot(data = b_distill) + 
  geom_col(mapping = aes(x = length, y = freq), fill = "black") +
  theme_classic()

ggplot(data = b_length, aes(length)) + 
  geom_histogram() +
  theme_classic() # took forever!! Beware...


```

```{r site-area}
# see 2_data_processing.Rmd 
site_df_w_size
site_df

gg_site_area




```


```{r lc-abn-area-over-time}
s_dt[, .N, by = .(y1987)] #
s_dt[, .N, by = .(y2017)] #

s_dt[, .N, by = .(y1987, y1988)] #
s_dt[, table(y1987)]

grep("x$|y$", names(s_dt), value = TRUE, invert = TRUE)

s_dt[, -c("x", "y")]
s_dt[, .N, by = c(paste0("y", 1987:2017))] #

s_dt[, .N, by = .(y1987)][order(get("y1987"))]
DT <- s_dt[, .N, by = .(y1987)][order(get("y1987"))] %>% 
  as_tibble()

DT
i <- "y1987"
rename(DT, "lc" = i, 
           eval(i) = "N")
# s_dt[, c("i", "freq") := NULL]


# ------------- calculate area raster ---------------- #
s_area <- raster::area(s$y2017) # area in km2
res(s_area)[1] * # resolution of the raster, in degrees (lat/long)
  100 * # ~100-110 km per degree 
  1000 # 1000 m/km = 26.95 m resolution

plot(s_area)

summary(getValues(s_area))
median(getValues(s_area)) # 0.0006972 km2. 
median(getValues(s_area)) * 100 / 1 # 100 ha/km2

# median pixel size is 697 m2, 0.0697 ha, or 0.000697 km2. 
median(getValues(s_area)) * # km2
  100 * # 100 ha per km2 
  10000 # m2 per ha

# the difference between minimum and maximum cell size, in m2
(max(getValues(s_area)) - 
    min(getValues(s_area))
  ) * # in km2
  1000^2 # m2 / km 2


# abandoned area over time
s_age_r
plot(s_age_r$y2017)
plot(s_age_r$y2017 > 0)
cellStats((s_age_r$y2017 > 0), "sum")

s_age[y2017 > 0, .N] # the total number of pixels with non-zero abandonment ages in the year 2017

s_age[, lapply(.SD, mean)] # mean age of abandonment over time.
s_age[y1988 > 0, .N] # count of "abandoned" cells in a particular year
s_age[get("y2017") > 0, .N]
s_age[y2017 > 0, .N]


# calculate areas for lc and abn manually
lc_area_s <- cc_total_area_per_lc(land_cover_dt = s_dt, area_raster = s_area)
abn_area_s <- cc_calc_abn_area(s_age, s_area)
area_s <- rbind(lc_area_s, abn_area_s)



# -------------------------------------------------------------- #
# -------------------------------------------------------------- #
# ------------- calculate total area per lc ---------------- #
area_s <- cc_calc_area_per_lc_abn(land_cover_dt = s_dt, 
                                  abn_age_dt = s_age, 
                                  land_cover_raster = s$y2017)

# ------------- plot ---------------- #
cc_save_plot_lc_abn_area(input_area_df = area_s, subtitle = "Shaanxi/Shanxi Provinces, China", 
                         outfile_label = "s",
                         width = 6, height = 4)

# manually
gg_lc_abn_area_s <- ggplot(data = area_s, aes(year, area_ha)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  labs(y = expression("Area  (10"^{6}*" ha)") , 
       x = "Year", 
       title = "Area by Land Cover, with Abandonment",
       subtitle = "Shaanxi/Shanxi Provinces, China",
       color = "Land Cover") + 
  geom_line(mapping = aes(x = year, y = area_ha / (10^6), # convert to millions of ha
                          group = lc, color = lc),
            size = 1.2)

gg_lc_abn_area_s

# filter to include only subsets
gg_lc_abn_area_s %+% filter(area_s, lc == "Abandoned") + labs(title = "Abandoned Area")
gg_lc_abn_area_s %+% filter(area_s, lc != "Abandoned")

gg_lc_abn_area_s
gg_abn_area_s

gg_lc_abn_area_s2
gg_lc_abn_area_s




```


```{r abandonment-persistence}
# testing
s_age[get(paste0("y", 1987:2017)[2]) > 0]
s_age[y1988 > 0]


# ----------------------- see functions in _util_dt_filter_functions ------------------------------------
# manual
persistence_count_long <- cc_calc_persistence(abn_age_dt = s_age, land_cover_raster = s$y2017, 
                                              stat_proportion = FALSE,
                                              NA_first = FALSE)

persistence_count_long2 <- cc_calc_persistence(abn_age_dt = s_age, land_cover_raster = s$y2017, 
                                              stat_proportion = FALSE, include_wide = TRUE,
                                              NA_first = FALSE)

# as a list

persistence_list_s <- cc_calc_persistence_all(abn_age_dt = s_age, land_cover_raster = s$y2017)


# ----------------------------------- plot ------------------------------------------------- #

# plot the count of pixels abandoned (or age 1) in each year. This shows that over time, a greater amount of land is abandoned at once.
ggplot(data = filter(persistence_list_s$count, time_abn == 1)) + 
  theme_classic() + 
  geom_point(mapping = aes(x = year_abn, y = area_ha, color = year_abn))


# save as a plot
cc_save_plot_abn_persistence(input_list = persistence_list_s, subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s")
```

```{r half-life-lm}
#persistence_list_s <- cc_calc_persistence_all(abn_age_dt = s_age, land_cover_raster = s$y2017)
load()


# average proportion of abandoned land remaining, across time abandoned

df_av <- persistence_list_b1_s$na_last %>%
  mutate(year_abn = as_factor(year_abn)) %>%
  group_by(time_abn) %>%
  summarise(count = n(),
            sd = sd(proportion, na.rm = TRUE), 
            se = sd/sqrt(count),
            proportion = mean(proportion), 
            year_abn = as_factor("mean"))
df_av


# as percentage
base <- ggplot(data = persistence_list_b1_s$na_first) + 
    theme_classic() + 
    geom_line(mapping = aes(x = age, y = proportion,
                            group = year_abn, color = year_abn), 
              size = 1.25
    ) + 
    labs(y = "Proportion remaining abandoned", 
         x = "Years since initial abandonment", 
         title = "Persistence of Abandoned Land",
         subtitle = NULL, #subtitle,
         color = "Year Abandoned") + 
    scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
    # geom_hline(yintercept=0.5, linetype="dashed", 
    #          color = "red", size = 0.75) +
    theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0))

base + geom_line(data = df_av, mapping = aes(x = time_abn, y = proportion),
              size = 3)
base %+% test

# ----------------------------------- plot ------------------------------------------------- #
gg_half_life_s <- ggplot(data = persistence_list_b1_s$na_first) + 
  theme_classic() + 
  geom_hline(yintercept=0.5, linetype="dashed", 
             color = "red", size = 0.75) +
  geom_line(mapping = aes(x = age, y = proportion,
                           group = year_abn, color = year_abn), 
             size = 1) + 
  # geom_smooth(method = "lm", formula = y ~ poly(x, 2),
  #             mapping = aes(x = age, y = proportion),
  #             color = "dark blue", fill = "blue", size = 1.5) +
    
  geom_ribbon(data = df_av, aes(x = time_abn, ymin = proportion - 1.96*se, ymax=proportion + 1.96*se), 
              color = "gray", fill = "gray", alpha=0.5) + 
  geom_line(data = df_av, mapping = aes(x = time_abn, y = proportion),
              size = 2, color = "black") +

  labs(y = "Proportion remaining abandoned", 
         x = "Years since initial abandonment", 
         title = "Persistence of Abandoned Land",
         subtitle = NULL, #subtitle,
         color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + 
  theme(legend.position = "bottom",
        legend.text = element_text(angle = 320, vjust = 1, hjust = 0))

gg_half_life_s
df_av %>% filter(proportion <= 0.51)

poly(1:10, 2)

lm(proportion ~ poly(time_abn, 2), data = persistence_list_b1_s$na_last)

# save
png(filename = paste0(p_output, "plots/half_life_s.png"), 
    width = 7, height = 5, units = "in", res = 400)
print(gg_half_life_s)
dev.off()


# ------------------- additional models ------------------------------------------------- #
# y ~ log(x)
ggplot(data = persistence_list_b1_s$na_first) + 
    theme_classic() + 
    geom_point(mapping = aes(x = age, y = proportion,
                            group = year_abn, color = year_abn), 
              size = 1.25) + 
    labs(y = "Proportion remaining abandoned", 
         x = "Years since initial abandonment", 
         title = "Persistence of Abandoned Land",
         subtitle = NULL, #subtitle,
         color = "Year Abandoned") + 
    scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
    theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_smooth(method = "lm", formula = y ~ log(x),
              mapping = aes(x = age, y = proportion),
              color = "dark blue", fill = "blue", size = 1.5) + 
  geom_hline(yintercept=0.5, linetype="dashed", 
             color = "red", size = 0.75) + 
  geom_vline(xintercept = 24.16574)


# log(y) ~ x:
ggplot(data = persistence_list_b1_s$na_first) + 
    theme_classic() + 
  # note, needs to be log transformed
    geom_point(mapping = aes(x = age, y = log(proportion),
                            group = year_abn, color = year_abn), 
              size = 1.25) + 
    labs(y = "Proportion remaining abandoned", 
         x = "Years since initial abandonment", 
         title = "Persistence of Abandoned Land",
         subtitle = NULL, #subtitle,
         color = "Year Abandoned") + 
    scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
    theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  
  # log(y) ~ x
  geom_smooth(method = "lm", formula = log(y) ~ x,
              mapping = aes(x = age, y = proportion),
              color = "dark blue", fill = "blue", size = 1.5) + 
  geom_hline(yintercept=log(0.5), linetype="dashed", 
             color = "red", size = 0.75) + 
  geom_vline(xintercept = 23.1708)




# ------- linear models ------------------------------------------------- #
# model exponential decay
model <- lm(proportion ~ log(age), data = persistence_list_b1_s$na_first)
mod_decay_s <- lm(log(proportion) ~ age, data = persistence_list_b1_s$na_first)

model$coefficients
exp((0.5 - model$coefficients[1])/model$coefficients[2])

mod_decay_s
mod_decay_s$coefficients
summary(mod_decay_s)
confint(mod_decay_s)

(log(0.5)-mod_decay_s$coefficients[1])/mod_decay_s$coefficients[2] # = x 


# ------- plot half life with lm curve ------------------------------------------------- #


# ggplot half_life_base, for adding different models
half_life_base <- ggplot(data = persistence_list_b1_s$na_first) + 
  theme_classic() + 
  geom_point(mapping = aes(x = age, y = proportion,
                          group = year_abn, color = year_abn), 
            size = 1.25) + 
  labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land",
       subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
  theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_hline(yintercept = 0.5, linetype="dashed", 
             color = "red", size = 0.75)

# showing the exponential decay curve

gg_half_life_lm_s <- half_life_base + 
  # make and add confidence interval
  geom_ribbon(data = mutate(data.frame(x = 5:30),
                            lower = exp(confint(mod_decay_s)[2, 1]*x +
                                          confint(mod_decay_s)[1, 1]),
                            upper = exp(confint(mod_decay_s)[2, 2]*x +
                                          confint(mod_decay_s)[1, 2])),
              mapping = aes(ymin = lower, ymax = upper, x = x), 
              fill = "dark gray", alpha = 0.5, color = "dark gray", linetype = "solid") +
  stat_function(fun = function(x) {exp(mod_decay_s$coefficients[2]*x + 
                                         mod_decay_s$coefficients[1])},
                color = "dark blue", size = 1) + 
  annotate("text", x = 24, y = 0.8, label = "half-life = 23.17 years", fontface = "italic", angle = 90) + 
  geom_vline(xintercept = 23.16972)

# save
png(filename = paste0(p_output, "plots/half_life_lm_s.png"), 
    width = 5, height = 5, units = "in", res = 400)
print(gg_half_life_lm_s)
dev.off()




# other models, not appropriate....
half_life_base +
  # compared to y ~ log(x)
  geom_smooth(method = "lm", formula = y ~ log(x),
              mapping = aes(x = age, y = proportion),
              color = "blue", fill = "gray", size = 1.5)

half_life_base +
  geom_smooth(method = "lm", formula = y ~ exp(x),
              mapping = aes(x = age, y = proportion),
              color = "red", fill = "blue", size = 1.5)



# ------- check assumptions of the lm ------------------------------------------------- #

# !!!!!!!!!!!!!!!!!!!!
# assumptions to check:
# a. LINEAR RELATIONSHIP between the predictor (x) and the response (y); i.e., y = mx + C
# b. the data points are STATISTICALLY INDEPENDENT (study design issue)
# c. no outliers influence the relationship unduly (look at the Residuals vs Leverage plot; also the Normal Q-Q plot)
# d. CONSTANT, or EQUAL VARIANCE (fancily called HOMOSCEDASTICITY; look at the Residuals vs Fitted plot)
# e. ERRORS ARE NORMALLY DISTRIBUTED (look at the Normal Q-Q plot)

par(mfrow = c(2,2)) # create a plotting panel with two rows and two columns (allowing you to put 4 plots on the same plotting panel)
plot(mod_decay_s) # check for violations of model assumptions

# http://www.sthda.com/english/articles/39-regression-model-diagnostics/161-linear-regression-assumptions-and-diagnostics-in-r-essentials/
# 1. Residuals vs Fitted. Used to check the linear relationship assumptions. A horizontal line, without distinct patterns is an indication for a linear relationship, what is good.
# 2. Normal Q-Q. Used to examine whether the residuals are normally distributed. It’s good if residuals points follow the straight dashed line.
# 3. Scale-Location (or Spread-Location). Used to check the homogeneity of variance of the residuals (homoscedasticity). Horizontal line with equally spread points is a good indication of homoscedasticity. This is not the case in our example, where we have a heteroscedasticity problem.
# 4. Residuals vs Leverage. Used to identify influential cases, that is extreme values that might influence the regression results when included or excluded from the analysis. This plot will be described further in the next sections.


# !!!!!!
# The points are not independent. They belong to a particular cohort of abandoned land! 
# so, I should move to linear mixed effects models next
# !!!!!!

# lme4
lmer(log(proportion) ~ age + (1|year_abn), data = persistence_list_b1_s$na_first)

lmer(log(area_ha) ~ age + (initial_area|year_abn), data = persistence_list_b1_s$na_first)
# pull out the initial area abn...^^^

# other option: Bayesian hierarchical model. 
install.packages("brms") # Hamiltonian monte carlo.

```

```{r half-life-lm-all-sites}
# calculating the average proportion at each time_abn, across all sites.
# this replicated df_av, but for all sites

mean_persistence_df <- lapply(1:11, FUN = function(i) {
  load(file = paste0(p_output, "abn_dat_products", blip_label, site_df$label[i], ".rds"), verbose = TRUE)
# eval(parse(text = paste0("persistence_list", blip_label, site_label)))
  
  assign("persistence_list", eval(parse(text = paste0("persistence_list", blip_label, site_df$label[i]))))
  
  df_tmp <- persistence_list$na_last %>%
    mutate(year_abn = as_factor(year_abn)) %>%
    group_by(time_abn) %>%
    summarise(count = n(),
              sd = sd(proportion, na.rm = TRUE), 
              se = sd/sqrt(count),
              mean_proportion = mean(proportion), 
              year_abn = as_factor("mean")) %>%
    mutate(site = site_df$site[i])
  
  df_tmp
})

mean_persistence_df <- bind_rows(mean_persistence_df)

# save
write_csv(mean_persistence_df, path = paste0(p_dat_derived, "mean_persistence_df.csv"))

# re load
mean_persistence_df <- read.csv(file = paste0(p_dat_derived, "mean_persistence_df.csv"))




# plotting the average persistence over time
gg_mean_persistence_all <- ggplot(data = mean_persistence_df) +
  labs(title = "Mean persistence over time", x = "Time abandoned (years)", 
       y = "Mean proportion of abandoned land remaining abandoned") + 
  geom_line(mapping = aes(x = time_abn, y = mean_proportion, group = site, color = site), size = 1) + 
  theme_classic() + theme(legend.position = "right")

# save
png(filename = paste0(p_output, "plots/mean_persistence_all.png"), 
    width = 7, height = 5, units = "in", res = 400)
print(gg_mean_persistence_all)
dev.off()

mean_persistence_df %>% filter(mean_proportion < 0.52 & mean_proportion > 0.49) %>% select(site, time_abn, mean_proportion) %>% as.data.frame()



# ------- calc lm for each site ------------------------------------------------- #
# calculate exponential decay curve for each site:

decay_models <- lapply(1:11, FUN = function(i) {
  load(file = paste0(p_output, "abn_dat_products", blip_label, site_df$label[i], ".rds"), verbose = TRUE)
# eval(parse(text = paste0("persistence_list", blip_label, site_label)))
  
  assign("persistence_list", eval(parse(text = paste0("persistence_list", blip_label, site_df$label[i]))))
  
  model <- lm(log(proportion) ~ age, data = persistence_list$na_first)

})

names(decay_models) <- site_df$site
plot(decay_models$shaanxi)
broom::tidy(decay_models$shaanxi)
broom::tidy(mod_decay_s)


# make a data.frame of coefficients
decay_models_coeff <- lapply(decay_models, coefficients) %>% 
  bind_rows(.id = "site") %>%
  rename(int = "(Intercept)", coeff = age) %>% 
  mutate(half_life = (log(0.5) - int)/coeff)

# calculate confidence intervals
conf <- lapply(decay_models, FUN = function(i) {
  conf <- confint(i) %>% 
    as_tibble(rownames = "rownames") %>% 
    mutate(rownames = ifelse(rownames == "age", "coeff", "int")) %>%
    rename("lower" = "2.5 %", "upper" = "97.5 %") %>% 
    pivot_wider(names_from = rownames, values_from = c(lower, upper))
}) %>% bind_rows(.id = "site")

# join data.frames
decay_models_coeff <- left_join(decay_models_coeff, conf, by = "site") %>%
  mutate(half_life_lower = (log(0.5) - lower_int)/lower_coeff,
         half_life_upper = (log(0.5) - upper_int)/upper_coeff)


# plot
gg_half_life_all_sites <- ggplot(data = decay_models_coeff) + 
  theme_classic() + 
  geom_col(mapping = aes(x = site, y = half_life, fill = site)) + 
  geom_errorbar(mapping = aes(x = site, ymin = half_life_lower, ymax = half_life_upper, #color = site
                              ), width = 0.3) +
  labs(y = "Half-life (years)",
       x = "Site", 
       title = "Half-life of abandoned agricultural land",
       caption = "Error bars represent 95% confidence interval",
       fill = "Site") + 
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none", plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm"))




# save plots
# ----------------------------------- save ------------------------------------------------- #

png(filename = paste0(p_output, "plots/half_life_all_sites.png"), 
    width = 5, height = 5, units = "in", res = 400)
print(gg_half_life_all_sites)
dev.off()
```


```{r half-life-lm-bins}
# ----------------------------------------------------------------------------------- #
# plot persistence for bins of year abandoned
# bins for year_abn
test$year_abn %>% unique %>% length 
test <- persistence_list$na_first
test <- test %>% 
      mutate(year_abn_bins = ifelse(year_abn >= 1988 & year_abn <= 1993, "1988-1993",
                           ifelse(year_abn >= 1994 & year_abn <= 1998, "1994-1998",
                                  ifelse(year_abn >= 1999 & year_abn <= 2003, "1999-2003",
                                         ifelse(year_abn >= 2004 & year_abn <= 2008, "2004-2008",
                                                ifelse(year_abn >= 2009 & year_abn <= 2013, "2009-2013", NA)
                                         ))))) %>%
      mutate(year_abn_bins = as_factor(year_abn_bins))

year_abn_bins_av <- test %>% group_by(year_abn_bins, age) %>% summarise(mean_proportion = mean(proportion), count = n())


ggplot(data = year_abn_bins_av) + 
  theme_classic() + 
  labs(y = "Proportion remaining abandoned", #x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land", color = "Year Abandoned") + 
  # scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
  theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0),
        legend.position = "bottom") + 
  geom_line(size = 1.25,
            mapping = aes(x = age, 
                   # x = age, # (replicates the plot from na_last, which is called time_abn)
                   y = mean_proportion, group = year_abn_bins, color = year_abn_bins))



test_mod <- lm(log(proportion) ~ time_abn, data = persistence_list$na_last)

decay_models_s <- lapply(1:11, FUN = function(i) {
  load(file = paste0(p_output, "abn_dat_products", blip_label, site_df$label[i], ".rds"), verbose = TRUE)
# eval(parse(text = paste0("persistence_list", blip_label, site_label)))
  
  assign("persistence_list", eval(parse(text = paste0("persistence_list", blip_label, site_df$label[i]))))
  
  model <- lm(log(proportion) ~ time_abn, data = persistence_list$na_last)

})

names(decay_models) <- site_df$site
plot(decay_models$shaanxi)
coefficients(decay_models)

decay_models_coeff <- lapply(decay_models, coefficients) %>% 
  bind_rows(.id = "site") %>%
  rename(int = "(Intercept)", coeff = time_abn) %>% 
  mutate(half_life = (log(0.5) - int)/coeff)
```


```{r half-life-lm-indiv-cohorts}
# half-life for each individual cohort for a particular site
persistence_list$na_first$year_abn %>% unique() %>% length()

# load data set, assign to generic "persistence_list"
load(file = paste0(p_output, "abn_dat_products", blip_label, "_s", ".rds"), verbose = TRUE)
assign("persistence_list", eval(parse(text = paste0("persistence_list", blip_label, "_s"))))

  
mod_ind <- lapply(1988:2013, FUN = function(i) {
  model <- lm(log(proportion) ~ age, data = filter(persistence_list_b1_s$na_first, year_abn == i))
})

names(mod_ind) <- paste0("y", 1988:2013)

mod_ind_df <- lapply(mod_ind, coefficients) %>% bind_rows(.id = "cohort") %>%
  rename(int = "(Intercept)", coeff = age) %>% 
  mutate(half_life = (log(0.5) - int)/coeff,
         year_abn = gsub("y", "", cohort),
         year_abn = as.numeric(year_abn),
         mod = "lm")



gg_half_life_over_time_s <- ggplot(data = mod_ind_df) + theme_classic() +
  geom_smooth(method = "lm", formula = y ~ x,
              mapping = aes(x = year_abn, y = half_life),
              color = "blue", fill = "gray", size = 1.5, alpha = 0.5) + 
  geom_point(mapping = aes(x = year_abn, y = half_life)) + 
  labs(y = "Half life (years)", x = "Year Abandoned", 
       title = "Persistence of Abandoned Land", subtitle = site_df$description[9],
       color = "Year Abandoned")
  


ggplot(data = persistence_list_b1_s$na_first) + 
  theme_classic() + 
  geom_point(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn), size = 1.25) + 
  labs(y = "Proportion remaining abandoned", x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land", subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
  theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_hline(yintercept = 0.5, linetype="dashed", color = "red", size = 0.75) + 
  # make and add confidence interval
  geom_ribbon(data = mutate(data.frame(x = 5:30),
                            lower = exp(confint(mod_decay_s)[2, 1]*x + confint(mod_decay_s)[1, 1]),
                            upper = exp(confint(mod_decay_s)[2, 2]*x + confint(mod_decay_s)[1, 2])),
              mapping = aes(ymin = lower, ymax = upper, x = x), 
              fill = "dark gray", alpha = 0.5, color = "dark gray", linetype = "solid") +
  stat_function(fun = function(x) {exp(mod_decay_s$coefficients[2]*x + mod_decay_s$coefficients[1])}, color = "dark blue", size = 1) + 
  annotate("text", x = 24, y = 0.8, label = "half-life = 23.17 years", fontface = "italic", angle = 90) + 
  geom_vline(xintercept = 23.16972)

```


```{r lmer-persistence-model}
# !!!!!!
# The points are not independent. They belong to a particular cohort of abandoned land! 
# so, I should move to linear mixed effects models next
# !!!!!!
dat <- persistence_list_b1_s$na_first
str(dat)

dat <- left_join(dat, 
          dat %>% filter(age == 5) %>% select(year_abn, initial_area_abn = area_ha), 
          by = "year_abn") %>%
  
  # create bins of year_abn
  mutate(year_abn_bins = ifelse(year_abn >= 1988 & year_abn <= 1993, "1988-1993",
                           ifelse(year_abn >= 1994 & year_abn <= 1998, "1994-1998",
                                  ifelse(year_abn >= 1999 & year_abn <= 2003, "1999-2003",
                                         ifelse(year_abn >= 2004 & year_abn <= 2008, "2004-2008",
                                                ifelse(year_abn >= 2009 & year_abn <= 2013, "2009-2013", NA)
                                         ))))) %>%
  mutate(year_abn_bins = as_factor(year_abn_bins), # convert both to factors
         year_abn = as_factor(year_abn)) 


# variables:

dat$proportion # response variable: the proportion of originally abandoned land that remains in a given year. 
dat$year # the current year, allowing us to measure area abandoned in the current year, relative to the amount initially abandoned
dat$year_abn # cohort of land abandoned in a particular year, which is then followed year after year to track persistence
# ^ probably should be a factor
dat$count # number of pixels, from which area is determined
dat$area_ha # area abandoned, of a given cohort
dat$age # how long that land in that cohort has been abandoned for
dat$bins # bins of abandoned land of similar ages (5-10 years)
dat$year_abn_bins # bins of land abandoned during the same five to six year window
dat$initial_area_abn # the area (in ha) initially abandoned in a given year (cohort)


# lme4
library(lme4)
# the (1|)
# stand-alone variables are fixed effects

lmer_mod <- lmer(log(proportion) ~ 
       age + # fixed effect (i.e. what we're curious about)
       (1 + age|year_abn), # random effects (random values drawn from a common error distribution, i.e. differences that we want to control for). 
     # The 1 represents the random intercept, meaning that the initial starting point can vary for each cohort (year_abn). If this was all we wanted, but with the same relationship to age for each cohort, we'd just have (1|year_abn)
     # The "age|year_abn" term represents the random slopes, meaning that the relationship between proportion and age (the slope/coefficient) is allowed to vary across the cohorts. ()
     data = dat) 
?isSingular
isSingular(lmer_mod) # TRUE
summary(lmer_mod)
(log(0.5) - 0.028554)/-0.023854 # (log(0.5) - int)/coeff = 30.25
broom::tidy(lmer_mod)
predict(lmer_mod)

lmer_half_lives <- coefficients(lmer_mod)$year_abn %>%
  as_tibble(rownames = "year_abn") %>%
  rename(int = "(Intercept)", coeff = age) %>% 
  mutate(half_life = (log(0.5) - int)/coeff,
         year_abn = as.numeric(year_abn),
         mod = "lmer")


half_life_mod_comparison <- bind_rows(lmer_half_lives, select(mod_ind_df, !cohort)) %>% mutate(mod = as_factor(mod))

ggplot(data = half_life_mod_comparison) + theme_classic() +
  geom_smooth(method = "lm", formula = y ~ x,
              mapping = aes(x = year_abn, y = half_life, 
                            fill = mod, color = mod, group = mod),
              #color = "blue", fill = "gray", 
              size = 1.5, alpha = 0.25, show.legend = FALSE) +
  geom_point(mapping = aes(x = year_abn, y = half_life, color = mod)) + 
  labs(y = "Half life (years)", x = "Year Abandoned", 
       title = "Persistence of Abandoned Land", subtitle = site_df$description[9],
       color = "Model Type")


gg_half_life_over_time_s <- ggplot(data = mod_ind_df) + theme_classic() +
  geom_smooth(method = "lm", formula = y ~ x,
              mapping = aes(x = year_abn, y = half_life),
              color = "blue", fill = "gray", size = 1.5, alpha = 0.5) + 
  geom_point(mapping = aes(x = year_abn, y = half_life)) + 
  labs(y = "Half life (years)", x = "Year Abandoned", 
       title = "Persistence of Abandoned Land", subtitle = site_df$description[9],
       color = "Year Abandoned")
  
  








lmer_mod_area <- lmer(log(area_ha) ~ 
       age +
       (1 + age|year_abn), 
       data = dat)
lmer(log(area_ha) ~ age + (1 + initial_area|year_abn), data = persistence_list_b1_s$na_first)
# pull out the initial area abn...^^^

summary(lmer_mod_area)



```

```{r bayesian-persistence-model}
# other option: Bayesian hierarchical model. 
install.packages("brms") # Hamiltonian monte carlo.
library(brms)
```



```{r abn-gain-loss-area}
# calculate the abandonment area turnover
abn_area_change_s <- cc_calc_abn_area_diff(abn_age_dt = s_age, area_raster = s_area)

cc_save_plot_area_gain_loss(input_area_change_df = abn_area_change_s, 
                            subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s",
                            width = 6)


```

```{r abn-area-by-age-class}
area_s %>% filter(lc == "Abandoned")
persistence_list_s$count_na_first
persistence_list_s$count

# first plot
age_class0 <- ggplot(data = persistence_list_s$count_na_first) + 
  theme_classic() +
  geom_col(mapping = aes(x = year, y = area_ha / 10^3, group = year_abn, fill = year_abn)) + 
  labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Years since initial abandonment", 
         title = "Area of Abandoned Land, by Age Class",
         subtitle = "Shaanxi/Shanxi Province, China",
         fill = "Year Abandoned") + 
  scale_fill_distiller(palette = "Greens") + theme(legend.position = "bottom") + 
  scale_x_continuous(n.breaks = 10)

# trying some massaging
age_class_df <- persistence_list_s$count_na_first %>% 
  mutate(age = year - year_abn + 1) %>% 
  mutate(bins = ifelse(age > 0 & age <= 5, "1 to 5 years",
                       ifelse(age > 5 & age <= 10, "5 to 10 years",
                              ifelse(age > 10 & age <= 15, "10 to 15 years",
                                     ifelse(age > 15 & age <= 20, "15 to 20 years",
                                            ifelse(age > 20 & age <= 30, "20 to 30 years", NA)
                                            ))))) %>%
  mutate(bins = as_factor(bins))

# plot



# Function
cc_save_plot_area_by_age_class(input_list = persistence_list_s, 
                               subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s")

```






```{r save-rasters}
cc_save_map_pnv_hab_lc_abn(maxpixels = 3000000)

cc_save_map_lc_age_rasters(maxpixels = 3000000)

```






```{r master-functions}
# Shaanxi master functions
# 1. ------------- calculate total area per lc, with abandonment ---------------- #
area_s <- cc_calc_area_per_lc_abn(land_cover_dt = s_dt, 
                                  abn_age_dt = s_age, 
                                  land_cover_raster = s$y2017)

cc_save_plot_lc_abn_area(input_area_df = area_s, subtitle = "Shaanxi/Shanxi Provinces, China", 
                         outfile_label = "s",
                         width = 5, height = 4)

# 2. ------------------------ abandonment persistence --------------------------- #
persistence_list_s <- cc_calc_persistence_all(abn_age_dt = s_age, land_cover_raster = s$y2017)

cc_save_plot_abn_persistence(input_list = persistence_list_s, subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s")


# 3. -------------------- calculate the abandonment area turnover ------------------- #
abn_area_change_s <- cc_calc_abn_area_diff(abn_age_dt = s_age, area_raster = s_area)

cc_save_plot_area_gain_loss(input_area_change_df = abn_area_change_s, 
                            subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s",
                            width = 6)

# 4. -------------------- plot abandonment area by age class ------------------- #
cc_save_plot_area_by_age_class(input_list = persistence_list_s, 
                               subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s")




# mega function to save all four plot types
tic()
cc_save_area_persistence_plots(land_cover_dt = s_dt, 
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017,
  subtitle = "Shaanxi/Shanxi Provinces, China",
  outfile_label = "_s"
  )
toc()

load(file = paste0(p_output, "abn_dat_products_s.rds"), verbose = TRUE)

# how do i deal with different thresholds of abandonment?

```


```{r belarus-plots}
# Belarus:

tic()
cc_save_area_persistence_plots(land_cover_dt = b_dt, 
  abn_age_dt = b_age, 
  land_cover_raster = b$y2017,
  subtitle = "Eastern Belarus/Smolensk, Russia",
  outfile_label = "_b"
  )
toc()

# generate plots
cc_save_area_persistence_plots(subtitle = "Shaanxi/Shanxi Provinces, China", outfile_label = "_s")

cc_save_area_persistence_plots(subtitle = "Shaanxi/Shanxi Provinces, China", input_site_label = "_s", 
                     outfile_label = "_s_all")

cc_save_area_persistence_plots(subtitle = "Eastern Belarus/Smolensk, Russia", input_site_label = "_b", 
                     outfile_label = "_b_all")



```

# Update to implement 5 year threshold
```{r n_lc_area}
# three files:
area_s
persistence_list_s
abn_area_change_s

# first, area

ggplot(data = area_s) +
    theme_classic() +
    # theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
    labs(y = expression("Area  (10"^{6}*" ha)") , 
         x = "Year", 
         title = "Area by Land Cover, with Abandonment",
         subtitle = subtitle,
         color = "Land Cover") + 
    geom_line(mapping = aes(x = year, y = area_ha / (10^6), # convert to millions of ha
                            group = lc, color = lc),
              size = 1.2) + 
    scale_x_continuous(n.breaks = 10)

abandonment_threshold <- 5

abandoned_area_df <- tibble(
    year = 1987:2017,
    lc = "Abandoned",
    count = sapply(1:31, function(i) {s_age[get(paste0("y", 1987:2017)[i]) >= abandonment_threshold, .N]}),
    count_all = sapply(1:31, function(i) {s_age[get(paste0("y", 1987:2017)[i]) > 0, .N]}),

    area_ha = count * median_cell_area_km2 * 100,
    area_all_ha = count_all * median_cell_area_km2 * 100
  )

s_age[y1992 >= 5, .N]

abandoned_area_df %>% print(n = 31)
filter(area, lc != "Abandoned")
n_area_s1 <- bind_rows(filter(area_s, lc != "Abandoned"), abandoned_area_df) %>% print(n = 155)

tic()
n_area_s <- cc_calc_area_per_lc_abn(land_cover_dt = s_dt,
                                    abn_age_dt = s_age, 
                                    land_cover_raster = s$y2017,
                                    abandonment_threshold = 5)
toc()
identical(n_area_s, n_area_s1)

# new updated plot
ggplot(data = n_area_s 
       %>% filter(lc != "Abandoned (all)") %>% 
         mutate(lc = recode(lc, "Abandoned (>5)" = "Abandoned"))
       ) +
  theme_classic() +
  # theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  labs(y = expression("Area  (10"^{6}*" ha)") , 
       x = "Year", 
       title = "Area by Land Cover, with Abandonment",
       subtitle = subtitle,
       color = "Land Cover") + 
  geom_line(mapping = aes(x = year, y = area_ha / (10^6), # convert to millions of ha
                          group = lc, color = lc),
            size = 1.2) + 
  scale_x_continuous(n.breaks = 10) #+
  # scale_color_discrete(name = "COVER", 
  #                      labels = c("Abandoned (>5)",
  #                                 "Abandoned (all)", 
  #                                 "Crop", "Grassland", 
  #                                 "Non-veg", "Woody veg"))

n_area_s %>% select(lc) %>% unique() %>% arrange(lc)

persistence_list_s
abn_area_change_s

```

```{r n_persistence}
persistence_list_s

s_age
s

persistence_list_s <- cc_calc_persistence_all(
  abn_age_dt = s_age, land_cover_raster = s$y2017)

# starting with i + 1 (i.e. 1988), count the number of cells that are of i age, then the next year, with age 2, then the next year with age 3, etc.
# the j represents each cohort of abandonment. I think I can just start with the fifth year for the counts.
stat_proportion <- FALSE
NA_first <- TRUE
pl1 <- persistence_list
pl2 <- persistence_list

pl1
pl2


names(persistence_list) <- paste0("y", 1988:2017)
pl2[[1]][-c(1:4)]
abandonment_threshold
c(abandonment_threshold:31) %>% length
pl2[[1]][c(abandonment_threshold:31)]
pl_na1 <- persistence_list
pl_na2 <- persistence_list

pl_na1[[1]]
pl_na2[[1]]
test1 <- pl_na1[[30]]
test2 <- pl_na2[[30]]
test2[c(1:4)] <- NA

n_pl_na1 <- persistence_list
n_pl_na2 <- persistence_list

temp_vector[c(1:31)]
pl_na1
n_pl_na1

pl_na2
n_pl_na2
for(i in 1:30) {print(length(persistence_list[[i]]))}

temp_vector[c()]

# remove cells that are below threshold
if (NA_first){
  temp_vector[c((1:(abandonment_threshold - 1)) + j)] <- NA
} else {
  temp_vector[c(1:(abandonment_threshold - 1))] <- NA
}

persistence_long %>% arrange(year_abn, time_abn)
pl2[-c(1:4)]

 temp_vector4 <- c(
      if (NA_first) {rep(NA, j)
        } else {rep(NA, 0)},
      sapply(1:(31 - j), function(i) {
        abn_age_dt[get(paste0("y", 1987:2017)[i + j]) == i, .N]
      }),
      if (NA_first) {rep(NA, 0)
      } else {rep(NA, j)}
    )
 
temp_vector %>% length
temp_vector1 %>% length
temp_vector2 %>% length
temp_vector3 %>% length
temp_vector4
abandonment_threshold:(31 - 27)
sapply(abandonment_threshold:(31 - 27), function(i) {
        abn_age_dt[get(paste0("y", 1987:2017)[i + 27]) == i, .N]
      })

abn_age_dt[get(paste0("y", 1987:2017)[i + j]) == i, .N]
abn_age_dt[get(paste0("y", 1987:2017)[i + j]) == i, .N]
abn_age_dt[y1994 == 7, ]

count_s <- cc_calc_persistence(abn_age_dt = s_age, 
                               land_cover_raster = s$y2017, 
                               stat_proportion = FALSE,
                               NA_first = FALSE, include_wide = FALSE)



proportion <- cc_calc_persistence(abn_age_dt, land_cover_raster, 
                                  stat_proportion = TRUE,
                                  NA_first = FALSE, include_wide = FALSE)

count_na_first <- cc_calc_persistence(abn_age_dt, land_cover_raster, 
                                      stat_proportion = FALSE,
                                      NA_first = TRUE, include_wide = FALSE)

proportion_na_first <- cc_calc_persistence(abn_age_dt, land_cover_raster, 
                                           stat_proportion = TRUE,
                                           NA_first = TRUE, include_wide = FALSE)




# try the new functions

n_persistence_list_s <- cc_calc_persistence_all(
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017, 
  include_wide = FALSE,
  abandonment_threshold = 5,
  include_all_abandonment = FALSE
)
n_persistence_list_s$na_last %>% select(proportion) %>% summary()
n_persistence_list_s$na_first %>% select(proportion) %>% summary()

n_persistence_list_s1 <- cc_calc_persistence_all(
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017, 
  include_wide = FALSE,
  abandonment_threshold = 1
)

n_persistence_list_s_all <- cc_calc_persistence_all(
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017, 
  include_wide = FALSE,
  abandonment_threshold = 5,
  include_all_abandonment = TRUE
)

n_persistence_list_s_wide <- cc_calc_persistence_all(
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017, 
  include_wide = TRUE,
  abandonment_threshold = 5,
  include_all_abandonment = TRUE
)

pl_test <- 
  cc_calc_persistence(
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017, 
  stat_proportion = TRUE, # doesn't work for true
  NA_first = TRUE, # works for false, and for true?
  include_wide = FALSE,
  abandonment_threshold = 5
)
j <- 27
# doesn't work for 
stat_proportion = TRUE
NA_first = FALSE
include_wide = FALSE

stat_proportion = TRUE
NA_first = FALSE
include_wide = FALSE
abandonment_threshold = 1
# doesn't work for the na_first

# for NA_first = FALSE, it works
# for NA_first = TRUE, it works
persistence_list[[30]]
if(sum(persistence_list[[30]], na.rm = TRUE) == 0) {print("yes")}

test <- persistence_list[[30]]/max(persistence_list[[30]], na.rm = TRUE)

temp_vector[c(1:(31 - (abandonment_threshold - 1)))]

temp_vector[c()]

temp_vector[c(abandonment_threshold + 1:27)]
# try plotting:
cc_save_plot_abn_persistence
cc_save_plot_area_by_age_class
```

```{r n_age-class}

persistence_list_s


ggplot(data = filter(persistence_list_s$count_na_first, age >= 5)) + 
  theme_classic() +
  labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
       x = "Year", 
       title = "Area of Abandoned Land, by Age Class",
       subtitle = subtitle,
       fill = "Age") + 
  #scale_x_continuous(n.breaks = 10) + 
  geom_col(mapping = aes(x = year, y = area_ha / 10^3, group = bins, fill = bins),
             position = position_stack(reverse = TRUE)
    ) +
  scale_fill_brewer(palette = "Greens", direction = 1) + 
  geom_line(data = filter(n_area_s, lc == "Abandoned (>5)"), mapping = aes(x = year, y = area_ha / (10^3)))
  


age_class_continuous <- age_class_base +
    geom_col(mapping = aes(x = year, y = area_ha / 10^3, group = age, fill = age),
             position = position_stack(reverse = TRUE)
    ) + 
    scale_fill_distiller(palette = "Greens", direction = 1)


  
  age_class_bins <- age_class_base +
    geom_col(mapping = aes(x = year, y = area_ha / 10^3, group = bins, fill = bins),
             position = position_stack(reverse = TRUE)
    ) +
    scale_fill_brewer(palette = "Greens", direction = 1) 
```


```{r n_abn_area_change}
abn_area_change_s

identical(s_age, abn_age_dt)
abn_age_dt

 # new. remove cells that are below threshold
    
abn_turnover_list
abn_turnover_list[[1]] %>% length()
abn_turnover_list[[1]]
i <- 1
j <- 3

# testing grounds:
temp_vector_diff <- c(
      rep(0, j),
      sapply(1:(31 - j), function(i) {
        abn_age_dt[get(paste0("y", 1987:2017)[i + j]) == i, .N]
      })
    )
# need to remove cells below abandonment threshold
temp_vector_diff[c(j + 1:(abandonment_threshold - 1))] <- 0

# trim to right length
if(length(temp_vector_diff) > 31){
  temp_vector_diff <- temp_vector_diff[c(1:31)]
  }

# calculate diff
temp_vector_diff <- diff(temp_vector_diff)

test <- cc_calc_abn_area_diff(abn_age_dt = s_age, 
                              land_cover_raster = s$y2017,
                              abandonment_threshold = 5)
cc_save_plot_area_gain_loss(
  input_area_change_df = test, 
  subtitle = "subtitle", 
  outfile_label = "test")
  

temp_vector_diff %>% length
abn_turnover_list[[30]] %>% length

abn_age_dt[get(paste0("y", 1987:2017)[i+1]) == i, .N]
abn_age_dt[get(paste0("y", 1987:2017)[i + j]) == i, .N]

    if (abandonment_threshold > 1) {
      if (NA_first){
        temp_vector[c((1:(abandonment_threshold - 1)) + j)] <- NA
      } else {
        temp_vector[c(1:(abandonment_threshold - 1))] <- NA
      }
      
      if(length(temp_vector) > 31){
        temp_vector <- temp_vector[c(1:31)]
      }
    }
```


```{r run-full-functions}

# ------------------------------------------ #
# ----------------- Shaanxi ---------------- #
# ------------------------------------------ #
tic()
cc_summarize_abn_dts(
  land_cover_dt = s_dt, 
  abn_age_dt = s_age, 
  land_cover_raster = s$y2017,
  outfile_label = "_s",
  abandonment_threshold = 5,
  include_all = TRUE
  )
toc()

# load(file = paste0(p_output, "abn_dat_products_s.rds"), verbose = TRUE) # now happens inside the function


tic()
cc_save_area_persistence_plots(
  input_path = p_output, 
  output_path = paste0(p_output, "test/"),
  site_label = "_s", 
  blip_label = "_blip1",
  outfile_label = "_s_blip1",
  subtitle = "Shaanxi/Shanxi Provinces, China (recult. >= 2)", 
  subtitle_all = "Shaanxi/Shanxi Provinces, China, all abandonment (recult. >= 2)",
  save_all = TRUE
)
toc()


# ------------------------------------------ #
# ----------------- Belarus ---------------- #
# ------------------------------------------ #
tic()
cc_summarize_abn_dts(
  land_cover_dt = b_dt, 
  abn_age_dt = b_age, 
  land_cover_raster = b$y2017,
  outfile_label = "_b",
  abandonment_threshold = 5,
  include_all = TRUE
  )
toc()


load(file = paste0(p_output, "abn_dat_products_b.rds"), verbose = TRUE)

# 
tic()
cc_save_area_persistence_plots(
  input_site_label = "_b", 
  blip_label = "_blip1",
  outfile_label = "_b_blip1",
  subtitle = "Eastern Belarus/Smolensk, Russia (recult. >= 2)", 
  subtitle_all = "Eastern Belarus/Smolensk, Russia, all abandonment (recult. >= 2)", 
  save_all = TRUE
)
toc()


# ------------------------------------------ #
# ------------ Fragmentation --------------- #
# ------------------------------------------ #
cc_save_frag_plots(input = frag_dat, outfile_label = NULL)


```

```{r save-plots-loop}

# see data.frame of all sites
site_df


i <- 2
site_df$description[i]

for (i in 1:11) {
  blip_label <- "_b1"

  cc_save_area_persistence_plots(
    input_path = p_output, 
    output_path = paste0(p_output, "plots_loop/"),
    site_label = site_df$label[i], 
    blip_label = blip_label,
    outfile_label = paste0(blip_label, site_df$label[i]),
    subtitle = paste0(site_df$description[i], ", (recult. >= 2)"), 
    subtitle_all = paste0(site_df$description[i], ", all abandonment (recult. >= 2)"),
    save_all = FALSE
  )
}



for (i in c(1, 9)) {
  blip_label <- "_blip1"
  cc_save_area_persistence_plots(
    input_path = p_output, 
    output_path = paste0(p_output, "plots_loop1/"),
    site_label = site_df$label[i], 
    blip_label = blip_label,
    outfile_label = paste0(blip_label, site_df$label[i]),
    subtitle = paste0(site_df$description[i], ", (recult. >= 2)"), 
    subtitle_all = paste0(site_df$description[i], ", all abandonment (recult. >= 2)"),
    save_all = FALSE
  )
}

site_df$description

```


```{r abandonment-rate}
# two ways to calculate this:

# 
# 1. Amount of additional land abandoned in that year (the net gain in abandoned land) / the total amount of agricultural land at the start of the time series
# 2. Amount of additional land abandoned in that year (the net gain in abandoned land) / the amount of agricultural land in the time step immediately preceding that year
blip_label <- "_b1"
site_label <- site_df$label[9]
load(file = paste0(p_output, "abn_dat_products", blip_label, site_label, ".rds"), verbose = TRUE)


# area in agriculture, at the start of the time series
area_b1_s %>% filter(year == "1987", lc == "Cropland") %>% select(area_ha) %>% unlist(use.names = F)

# area in agriculture, in the immediately preceding year
rate_year <- 1992 # starting with 1992

area_b1_s %>% filter(year == c(rate_year - 1), lc == "Cropland") %>% select(area_ha) %>% unlist(use.names = F)


# area abandoned, net
abn_area_change_b1_s %>% filter(year == rate_year, direction == "net") %>% select(area_ha) %>% unlist(use.names = F)

# area abandoned, gross
abn_area_change_b1_s %>% filter(year == rate_year, direction == "gain") %>% select(area_ha) %>% unlist(use.names = F)


# make a data.frame - development
site_df


df1 <- abn_area_change_b1_s %>% 
  filter(direction == "net") %>% 
  mutate(area_abn_yr = area_ha) %>%
  select(year, area_abn_yr)

abn_area_change_b1_s %>% 
  filter(direction == "net") %>% 
  select(year, area_abn_yr = area_ha)

filter(area_b1_s, year == "1987", lc == "Cropland")$area_ha
filter(area_b1_s, lc == "Cropland")$area_ha[1:30]

abn_area_change_b1_s

# develop method to calculate the right data.frame
# abn_rate_df <- abn_area_change_b1_s %>% 
#   filter(direction == "net") %>% 
#   select(year, area_abn_yr = area_ha) %>% 
#   mutate(site = site_df$site[9],
#          cropland_start = filter(area_b1_s, year == "1987", lc == "Cropland")$area_ha,
#          cropland_yr_before = filter(area_b1_s, lc == "Cropland")$area_ha[1:30],
#          abn_rate_start = area_abn_yr/cropland_start,
#          abn_rate = area_abn_yr/cropland_yr_before)


# ------------------------------------------------------------------------------------ #
# write for loop to create rate_df and bind rows
# ------------------------------------------------------------------------------------ #

abn_rate_l <- vector(mode = "list", length = length(site_df$site))
names(abn_rate_l) <- site_df$site

for (i in 2:11) {
  load(file = paste0(p_output, "abn_dat_products", blip_label, site_df$label[i], ".rds"), verbose = TRUE)

  abn_rate_l[[i]] <- eval(parse(text = paste0("abn_area_change_b1", site_df$label[i]))) %>% 
  filter(direction == "net") %>% 
  select(year, area_abn_yr = area_ha) %>% 
  mutate(site = site_df$site[i],
         cropland_start = filter(eval(parse(text = paste0("area_b1", site_df$label[i]))), year == "1987", lc == "Cropland")$area_ha,
         cropland_yr_before = filter(eval(parse(text = paste0("area_b1", site_df$label[i]))), lc == "Cropland")$area_ha[1:30],
         abn_rate_start = area_abn_yr/cropland_start,
         abn_rate = area_abn_yr/cropland_yr_before)
}


# Add Belarus
load(file = paste0(p_output, "abn_dat_products", "_blip1", site_df$label[1], ".rds"), verbose = TRUE)

abn_rate_l[[1]] <- eval(parse(text = paste0("abn_area_change_blip1", site_df$label[1]))) %>% 
  filter(direction == "net") %>% 
  select(year, area_abn_yr = area_ha) %>% 
  mutate(site = site_df$site[1],
         cropland_start = filter(eval(parse(text = paste0("area_blip1", site_df$label[1]))), year == "1987", lc == "Cropland")$area_ha,
         cropland_yr_before = filter(eval(parse(text = paste0("area_blip1", site_df$label[1]))), lc == "Cropland")$area_ha[1:30],
         abn_rate_start = area_abn_yr/cropland_start,
         abn_rate = area_abn_yr/cropland_yr_before)

# condense list into a data.frame
abn_rate_df <- bind_rows(abn_rate_l)

# save the new data.frame
write.csv(abn_rate_df, file = paste0(p_dat_derived, "abn_rate_df.csv"))

# ------------------------------------------------------------------------------------ #
# plot results
# ------------------------------------------------------------------------------------ #

ggplot(data = filter(abn_rate_df, site == "shaanxi")) + 
  theme_classic() +
  geom_point(mapping = aes(x = year, y = abn_rate_start*100), col = "red") + 
  geom_point(mapping = aes(x = year, y = abn_rate*100), col = "blue") + 
  labs(title = "Abandonment Rate", subtitle = , x = "Year", y = "Abandonment Rate (%)" )


# make groups
abn_rate_df <- abn_rate_df %>% mutate(cluster = ifelse(site %in% site_df$site[1:3], "a",
                                        ifelse(site %in% site_df$site[4:6], "b",
                                               ifelse(site %in% site_df$site[7:9], "c", 
                                                      ifelse(site %in% site_df$site[10:11], "d", NA
                                        )))))


gg_abn_rate <- ggplot(data = abn_rate_df) + 
  theme_classic() +
  geom_line(mapping = aes(x = year, y = abn_rate*100, group = site, color = site), #position = position_dodge(0.5), 
            size = 1.25) + 
  labs(title = "Abandonment Rate", subtitle = "Percent of cropland in prior year abandoned the following year", x = "Year", y = "Abandonment Rate (%)") + 
  facet_wrap(vars(cluster)) + theme(strip.background = element_blank(), strip.text = element_blank())

gg_abn_rate_start <- ggplot(data = abn_rate_df) + 
  theme_classic() +
  geom_line(mapping = aes(x = year, y = abn_rate_start*100, group = site, color = site), #position = position_dodge(0.5), 
            size = 1.25) + 
  labs(title = "Abandonment Rate", subtitle = "Percent of total cropland in 1987 abandoned each year", x = "Year", y = "Abandonment Rate (%)") + 
  facet_wrap(vars(cluster)) + theme(strip.background = element_blank(), strip.text = element_blank())


gg_abn_rate
gg_abn_rate_start

# save png
png(filename = paste0(p_output, "plots/abn_rate.png"), 
    width = 8.5, height = 5, units = "in", res = 400)
print(gg_abn_rate)
dev.off()


# save png
png(filename = paste0(p_output, "plots/abn_rate_start.png"), 
    width = 8.5, height = 5, units = "in", res = 400)
print(gg_abn_rate_start)
dev.off()


persistence_list_b1_s

# Rate, method 1


```




```{r clean-up}

env_size(ls())

```

