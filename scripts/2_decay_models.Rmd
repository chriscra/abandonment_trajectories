---
title: "Analysis: Abandonment Decay Models"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
```{r initialize}
source("/Users/christophercrawford/work/projects/abandonment_trajectories/scripts/0_start.R")
```

# Assessing the persistence of abandonment by modeling recultivation ("decay")

This R markdown document includes the primary code for developing linear models of the decay of abandoned cropland, or the process through which abandoned land is recultivated over time following initial abandonment. 
(See: https://github.com/chriscra/abandonment_trajectories).

This document is loosely organized as follows:  
1. Loading the derived abandonment length, persistence, and turnover data.
2. Running linear models of decay, with a range of specifications. The final form of these models was linear-log-linear: `stats::lm(formula = I(proportion - 1)  ~ 0 + log(time + 1):cohort + I(time):cohort, ...)`
  a. Assessing model fit, checking assumptions, diagnostic plots for SI
3. Producing figures 
  a. for the main text of the manuscript (including Figure 4), 
  b. exploratory data analysis, 
  c. linear model coefficients (including average decay trajectories at each site, Figure 3),
  d. alternative model specifications, and 
  e. basic plots for presentations.
4. Calculating the rate of change of half-lives at each site over time.
5. Projecting abandonment into the future through two versions of an Extrapolation

## Context
Our main questions were: (1) How long does abandoned cropland stay abandoned on average (i.e., duration of abandonment), and how does this vary geographically? (2) How quickly is abandoned cropland recultivated (i.e., persistence of abandonment), and do recultivation (or “decay”) rates vary through time? (3) If abandonment and recultivation continue at current rates, what will ultimately be the mean age of abandoned croplands?

This script is oriented towards answering questions 2 and 3, which involved fitting linear models, and comparing mean site trajectories across sites. 

These linear models involve grouping abandoned land into "cohorts" based on the year of initial abandonment.
We then track the proportion of each cohort of abandoned land that remains abandoned through time following initial abandonment. 
We defined cropland as abandoned when it has not been cultivated for at least five years in a row;
in other words, when a pixel that was at one point classified as cropland has been classified as non-cropland (either woody or grassy vegetation) for five or more consecutive years.
We begin counting the time (in years) a cropland has been abandoned starting from the last year it was classified as cropland.
We then track the recultivation of each cohort starting in the fifth year following abandonment, when it crosses our five-year threshold for being abandoned. 
For example, for the cropland first abandoned in the year 2001, this means it was last classified as cropland in the year 2000.
It has been abandoned for 5 years in the year 2005. 
We begin modeling recultivation from here, and therefore set the proportion of that cohort of abandoned cropland that remains abandoned to 1.

Question 2 led to a series of additional questions:  
- What is the half-life of abandoned agricultural land? 
- How does the half-life vary over time?
- How does the average half-life and the rate of change of the half-life differ across sites?

To provide a simple answer to this, I first calculated the half-life for each cohort at each of my sites, then look at how the half-life evolves over time at each of the sites.



# Load prepped datasets

```{r load-datasets}
run_label # check. See "_util_main.R"

site_df <- read_csv(file = paste0(p_dat_derived, "site_df.csv"))
site_df_w_size <- read_csv(file = paste0(p_dat_derived, "site_df_w_size.csv"))


# -------------------------- load summarized data.frames --------------------------- #
# load data, produced from the following functions:
# cc_calc_persistence() # which is called within
# cc_calc_persistence_all() # which is called within
# cc_summarize_abn_dts(), which is the meta function called
# within the cluster script, "2_analyze_abn.R."

# load combined persistence, area, and turnover datasets (see "1_summary_stats.Rmd"):

area_dat <- read_csv(file = paste0(p_derived2, "area_dat", run_label, ".csv"))
turnover_dat <- read_csv(file = paste0(p_derived2, "turnover_dat", run_label, ".csv"))

# ------------------------------------------ #
# when reloading, must restructure factors:
persistence_dat <- read_csv(file = paste0(p_derived2, "persistence_dat", run_label, ".csv")) %>%
  mutate(site = as.factor(site),
         bins = as.factor(bins),
         year_abn_bins = as.factor(year_abn_bins),
         cohort = as.factor(cohort))

# when is the first year abandonment can take place?
persistence_dat %>% filter(area_ha > 0) %>% group_by(site) %>% summarise(first_year = min(year_abn))



# ---------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------- #
# variables of interest
# ---------------------------------------------------------------------------- #
# ---------------------------------------------------------------------------- #
persistence_dat$proportion # response variable: the proportion of originally abandoned land that remains in a given year. 
persistence_dat$year # the current year, allowing us to measure area abandoned in the current year, relative to the amount initially abandoned
persistence_dat$year_abn # cohort of land abandoned in a particular year, which is then followed year after year to track persistence.
persistence_dat$cohort # a factor equivalent of "year_abn" to be used for cohort 
persistence_dat$area_ha # area abandoned (in hectares) for a given cohort in that specific year.
persistence_dat$age # the number of years the land in a cohort has been abandoned for.

persistence_dat$time # age - 5; adjusted time abandoned beyond the initial abandonment threshold. So, 0 corresponds to an abandonment age of 5, 1 -> 6, 2 -> 7 etc.

persistence_dat$time_1 # age - 4 (i.e. time + 1). This is so that time starts from 1, to avoid issues with taking the log of 0. 

persistence_dat$bins # bins of abandoned land of similar ages (5-10 years)
persistence_dat$year_abn_bins # bins of land abandoned during the same five to six year window
persistence_dat$initial_area_abn # the area (in ha) initially abandoned in a given year (cohort)

```

```{r dat-shaanxi}
# subset data set for small scale testing for just Shaanxi
dat <- filter(persistence_dat, site == "shaanxi")
```

```{r cohort-range}
cohort_range <- persistence_dat$year_abn %>% unique()
new_dat <- tibble(time = rep(0:(length(cohort_range) - 1), time = length(cohort_range)),
                  cohort = as_factor(rep(cohort_range, each = length(cohort_range))))
# 
# # replace 
# tibble(time = rep(0:25, time = 26), cohort = as_factor(rep(1988:2013, each = 26))) # with
# new_dat

```

# Run decay models


```{r run-mega-lm}
# These "mega" lms just mean that the lm() function is performed on the full "persistence_dat" dataset, using site as a fixed effect in addition to cohort. 

# log-log model, with cohort fixed effects
lm_mega_log2_l <- lm(log(proportion) ~ 0 + log(time + 1):cohort:site, data = persistence_dat)


# log-log-lin model, with cohort fixed effects
# note, time needs to be adjusted to time + 1 in order for the log term to work
lm_mega_log2_lin_l <- lm(log(proportion) ~ 0 + log(time + 1):cohort:site + I(time):cohort:site,  
               data = persistence_dat)

  
# linear - log
lm_mega_lin_log_l <- lm(I(proportion - 1) ~ 0 + log(time + 1):cohort:site,  
               data = persistence_dat)

# linear - log - linear
lm_mega_lin_log_lin_l <- lm(I(proportion - 1) ~ 0 + log(time + 1):cohort:site + I(time):cohort:site,  
               data = persistence_dat)

# linear-log-linear model, with year_abn (continuous) rather than the categorical cohort fixed effects
lm_mega_l3_cont <- lm(I(proportion - 1)  ~ 0 + log(time + 1):year_abn:site + I(time):year_abn:site,  
               data = mutate(persistence_dat, 
                             year_abn = year_abn - 1987 # must rescale to start at 1
                             ))


# linear - log - linear, without cohort fixed effects:
lm_mega_l3_no_cohort_l <- lm(I(proportion - 1)  ~ 0 + log(time + 1):site + I(time):site,  
               data = persistence_dat)

# log-log model, without cohort fixed effects
lm_mega_log2_no_cohort_l <- lm(log(proportion) ~ 0 + log(time + 1):site,  
               data = persistence_dat)

# log-log model, with year_abn (continuous) rather than the categorical cohort
lm_mega_log2_year_abn_l <- lm(log(proportion) ~ 0  + log(time + 1):site + log(time + 1):year_abn:site,  
               data = persistence_dat)


# log-linear (exp. decay)
lm_mega_log_lin_l <- lm(log(proportion) ~ 0 + time:cohort:site,  
               data = persistence_dat)


lm_mega_log_lin_no_cohort_l <- lm(log(proportion) ~ 0 + time:site,  
               data = persistence_dat)

# linear:cohort
lm_mega_lin_cohort_l <- 
  lm(log(proportion) ~ 0 + time:cohort:site,  
               data = persistence_dat)


# linear
lm_mega_0_l <- lm(log(proportion) ~ 0 + time,  
               data = persistence_dat)

```


## Test model fit without low n cohorts

```{r trim-small-cohorts}

# Filter persistence dataset to exclude cohorts with < 5 observations (i.e., cohorts 2010, '11, '12, '13)
dat_trim <- persistence_dat %>% 
  filter(year_abn < 2010)

# see AIC chunk above, list: mod_ll_mega
# update all lm calls in the list to run on the trimmed dataset:
mod_ll_mega_trim <- lapply(mod_ll_mega, FUN = function(i) update(i, data = dat_trim))
names(mod_ll_mega_trim)


# Calculate AIC
mod_AIC_mega_trim <- lapply(mod_ll_mega_trim, function(x) glance(x)) %>% 
  bind_rows(.id = "mod") %>%
  select(mod, AIC, everything()) %>% 
  arrange(AIC)


# view results
mod_AIC_mega_trim %>% 
  arrange(AIC) %>% 
  select(AIC, mod, adj.r.squared) %>% print(n = 150)



# mega AIC figure
gg_AIC_mega_trim <-
  ggplot(data = mod_AIC_mega_trim,
       mapping = aes(y = fct_reorder(mod, AIC), x = AIC, 
                     group = fct_reorder(mod, AIC), fill = fct_reorder(mod, AIC))) + 
  theme_classic() +
  geom_col(position = position_dodge(0.9)) +
  # theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  labs(y = "Model Specification", x = "AIC Value", fill = "Model") +
  theme(legend.position = "none",
        plot.margin = margin(4, 20, 4, 4, "pt"))

gg_AIC_mega_trim

ggsave(plot = gg_AIC_mega_trim, 
       filename = paste0(p_plots, run_label, "/decay/", "trimmed_data_mod_AIC", run_label, ".png"), 
    width = 5, height = 4, units = "in")

```

```{r coef-trim}

# extract the coefficients for the lin-log-lin model, run on only those cohorts with >=5 observations
# ----------------------------------------------------------------------- #
coef_l3_mega_trim <- 
  mod_ll_mega_trim[[4]] %>% # this corresponds to the lin-log-lin model
  tidy(conf.int = TRUE) %>%
  mutate(site = gsub("site", "", str_extract(term, "site[a-z,_]*")),
         year_abn = as.integer(str_extract(term, "[1-2][0-9][0-9][0-9]")),
         cohort = as.factor(year_abn),
         coef_term = ifelse(grepl("log", term), "log", "lin"),
         uncertainty_range = conf.high - conf.low,
         mod = "l3_trim") %>%
  left_join(dat_trim %>%
              group_by(site, year_abn) %>%
              summarise(obs = n()) %>% 
              ungroup()
            ) %>%
  select(mod, site, year_abn, cohort, coef_term, estimate, conf.low, conf.high, uncertainty_range, obs, everything())

# ----------------------------------------------------------------------- #
# calculate mean coefficients and their confidence intervals
mean_coef_l3_mega_trim <- coef_l3_mega_trim %>%
  group_by(site, coef_term) %>% # group by site and coef_term
  # use a linear regression to calculate mean and confidence intervals
  summarise(tidy(lm(estimate ~ 1), conf.int = TRUE, conf.level = 0.95)) %>% 
  ungroup()



# plot coefs with uncertainty

gg_coef_uncertainty_mega +
  geom_point(data = coef_l3_mega_trim, mapping = aes(x = year_abn, y = estimate, color = coef_term),
           position = position_dodge(dodge_width), alpha = 0.3, # size = 1,
           color = "red"
             ) + 
  geom_errorbar(data = coef_l3_mega_trim,
                mapping = aes(ymin = conf.low, ymax = conf.high),
                color = "red",
                width = 0.5, position = position_dodge(dodge_width),
                alpha = 0.3)

gg_coef_uncertainty_mega %+% coef_l3_mega_trim

```

## Extract coefficients

```{r coef-mega}
# ----------------------------------------------------------------------- #
coef_l3_mega <- tidy(lm_mega_lin_log_lin_l, conf.int = TRUE) %>%
  mutate(site = gsub("site", "", str_extract(term, "site[a-z,_]*")),
         year_abn = as.integer(str_extract(term, "[1-2][0-9][0-9][0-9]")),
         coef_term = ifelse(grepl("log", term), "log", "lin"),
         cohort = as.factor(year_abn),
         uncertainty_range = conf.high - conf.low,
         mod = "l3") %>%
  left_join(persistence_dat %>%
              group_by(site, year_abn) %>%
              summarise(obs = n()) %>% 
              ungroup()
            ) %>%
  select(mod, site, year_abn, cohort, coef_term, estimate, conf.low, conf.high, uncertainty_range, obs, everything())

coef_l3_mega

coef_l3_mega %>% filter(is.na(year_abn)) %>% print(n = 22)
coef_l3_mega %>% filter(site == "belarus", coef_term == "log")

# ----------------------------------------------------------------------- #
# calculate mean coefficients and their confidence intervals
mean_coef_l3_mega <- coef_l3_mega %>%
  group_by(site, coef_term) %>% # group by site and coef_term
  # use a linear regression to calculate mean and confidence intervals
  summarise(tidy(lm(estimate ~ 1), conf.int = TRUE, conf.level = 0.95)) %>% 
  ungroup()


# calculate half-lives:
half_lives_all_cohorts_l3 <- 
  coef_l3_mega %>%
  pivot_wider(id_cols = c(mod, site, coef_term, cohort, year_abn), names_from = coef_term, values_from = estimate) %>% 
  mutate(time_to_0.5 = ((log * lambertW0((lin * exp(lin/log + 0.5/log - 1/log))/log))/lin) + 4)

half_life_mean_coefs_l3 <- 
  coef_l3_mega %>%
  group_by(mod, site, coef_term) %>% # group by site and coef_term
  # use a linear regression to calculate mean and confidence intervals
  summarise(tidy(lm(estimate ~ 1), conf.int = TRUE, conf.level = 0.95)) %>% 
  ungroup() %>%
  pivot_wider(id_cols = c(mod, site, coef_term), 
              names_from = coef_term, 
              # values_from = c(estimate, conf.low, conf.high)
              values_from = estimate
              ) %>% 
  mutate(mean_time_to_0.5 = ((log * lambertW0((lin * exp(lin/log + 0.5/log - 1/log))/log))/lin) + 4)



# extract coefficients for other model specifications
# ----------------------------------------------------------------------- #
coef_l3_no_cohort_mega <- tidy(lm_mega_l3_no_cohort_l, conf.int = TRUE) %>%
  mutate(site = gsub("site", "", str_extract(term, "site[a-z,_]*")),
         coef_term = ifelse(grepl("log", term), "log", "lin"),
         mod = "l3_no_cohort") %>%
  select(site, coef_term, mod, estimate, conf.low, conf.high, everything())

coef_lin_log_mega <- tidy(lm_mega_lin_log_l, conf.int = TRUE) %>%
  mutate(site = gsub("site", "", str_extract(term, "site[a-z,_]*")),
         year_abn = as.integer(str_extract(term, "[1-2][0-9][0-9][0-9]")),
         coef_term = ifelse(grepl("log", term), "log", "lin"),
         cohort = as.factor(year_abn),
         uncertainty_range = conf.high - conf.low,
         mod = "lin_log") %>%
  left_join(persistence_dat %>%
              group_by(site, year_abn) %>%
              summarise(obs = n()) %>% 
              ungroup()
            ) %>%
  select(mod, site, year_abn, cohort, coef_term, estimate, conf.low, conf.high, uncertainty_range, obs, everything())

coef_log2_lin_mega <- 
  tidy(lm_mega_log2_lin_l, conf.int = TRUE) %>%
  mutate(site = gsub("site", "", str_extract(term, "site[a-z,_]*")),
         year_abn = as.integer(str_extract(term, "[1-2][0-9][0-9][0-9]")),
         coef_term = ifelse(grepl("log", term), "log", "lin"),
         cohort = as.factor(year_abn),
         uncertainty_range = conf.high - conf.low,
         mod = "log2_lin") %>%
  left_join(persistence_dat %>%
              group_by(site, year_abn) %>%
              summarise(obs = n()) %>% 
              ungroup()
            ) %>%
  select(mod, site, year_abn, cohort, coef_term, estimate, conf.low, conf.high, uncertainty_range, obs, everything())



# ----------------------------------------------------------------------------------- #
# combine the coef dfs and calculate means: 
# calculate mean coefficients and their confidence intervals
combo_mean_coefs <- 
  bind_rows(coef_l3_mega,
            coef_l3_mega_trim,
            coef_lin_log_mega,
            coef_log2_lin_mega) %>%
  group_by(mod, site, coef_term) %>% # group by site and coef_term
  # use a linear regression to calculate mean and confidence intervals
  summarise(tidy(lm(estimate ~ 1), conf.int = TRUE, conf.level = 0.95)) %>% 
  ungroup()




# extras:


mean_coef_l3_mega
coef_l3_no_cohort_mega
coef_lin_log_mega
coef_log2_lin_mega

coefs_l3_mega <- bind_rows(
  mean_coef_l3_mega %>% mutate(mod = "l3"), 
  coef_l3_no_cohort_mega) %>%
  mutate(mod = as_factor(mod))

fitted <- bind_rows(
  tibble(age = 5:30,
         mod = "l3",
         a = filter(coefs_l3_mega, mod == "l3", coef_term == "log")$estimate,
         b = filter(coefs_l3_mega, mod == "l3", coef_term == "lin")$estimate),
  tibble(age = 5:30,
         mod = "l3_no_cohort",
         a = filter(coefs_l3_mega, mod == "l3_no_cohort", coef_term == "log")$estimate,
         b = filter(coefs_l3_mega, mod == "l3_no_cohort", coef_term == "lin")$estimate)) %>%
    mutate(proportion = a * log(age-4) + b * ((age-4) - 1) + 1)



fitted_l3_mega <- lapply(1:11, function(i) {
    bind_rows(
      tibble(age = 5:30,
           site = site_df$site[i],
           mod = "l3",
           a = filter(coefs_l3_mega, mod == "l3", site == site_df$site[i], coef_term == "log")$estimate,
           b = filter(coefs_l3_mega, mod == "l3", site == site_df$site[i], coef_term == "lin")$estimate),
      tibble(age = 5:30,
           site = site_df$site[i],
           mod = "l3_no_cohort",
           a = filter(coefs_l3_mega, mod == "l3_no_cohort", site == site_df$site[i], coef_term == "log")$estimate,
           b = filter(coefs_l3_mega, mod == "l3_no_cohort", site == site_df$site[i], coef_term == "lin")$estimate) 
      ) %>%
      mutate(proportion = a * log(age-4) + b * ((age-4) - 1) + 1)
}) %>% bind_rows()

fitted_l3_mega
coefs_l3_mega$mod %>% unique()


View(fitted_l3_mega)
View(coef_l3_mega)

head(fitted_l3_mega)
tidy(lm_lin_log_lin_l$belarus) %>% 
  mutate(coef_term = sub(":*cohort....:*", "", term)) %>% 
  group_by(coef_term) %>%
  summarise(mean_coef = mean(estimate, na.rm = TRUE))





# Calculating the time to specific proportions (including half-life):

```



```{r mega-lm-exploration}
# note: it shouldn't make a difference whether you run the model for each site individually or as one mega model. For simplicity, I'm going to continue with the site specific models, since that is how I've largely coded things so far. However, note that the confidence intervals on the individual models will be different from the CIs for the full model including all sites.

# constructing a model of all sites, with cohort and site fixed effects
str(persistence_dat)

# ------------------------------------------------ #
# linear - log - linear, with cohort and site fixed effects
# ------------------------------------------------ #
lm_mega_l3_cohort_site_l <- lm(
  I(proportion - 1)  ~ 0 + log(time + 1):cohort:site + I(time):cohort:site 
  # + log(time + 1):site + I(time):site
  ,  
  data = persistence_dat #filter(persistence_dat, year_abn < 2011)#, #year_abn < 2011))
  )


lm_mega_l3_site_l <- lm(
  I(proportion - 1)  ~ 0 + log(time + 1):site + I(time):site,  
  data = filter(persistence_dat)#, #year_abn < 2011))
  )


# ------------------------------------------------ #
# log-log model, with cohort and site fixed effects
# ------------------------------------------------ #
lm_log2_cohort_site <- lm(log(proportion) ~ 0 + log(time + 1):cohort:site, data = persistence_dat)

tidy(lm_log2_cohort_site) %>% mutate(site = sub(".*:site", "", term),
                                     year_abn = as.integer(gsub(".*:cohort|:site.*", "", term)),
                                     cohort = as.factor(year_abn)) %>%
  filter(site == "belarus")

# note: the coefficients seem to be (almost) exactly the same as the individual sites:
test <- tidy(lm_log2_cohort_site) %>% 
  mutate(site = sub(".*:site", "", term),
         year_abn = as.integer(gsub(".*:cohort|:site.*", "", term)),
         cohort = as.factor(year_abn))

left_join(coef_df, test, by = c("site", "cohort")) %>%
  mutate(diff = estimate.x - estimate.y) %>% filter(diff > 0) %>% .$diff #%>% print(n = 50)



# ---------- mega lm, with just site fixed effects, akin to lm_log2_no_cohort_l --------- #
lm_log2_site <- lm(log(proportion) ~ 0 + log(time + 1):site, data = persistence_dat)


lm(log(proportion) ~ 0 + log(time + 1):cohort:site, data = persistence_dat)

persistence_dat[2092, ]
augment(lm_log2_cohort_site) %>% filter(.hat < 1) %>% arrange(desc(.hat))

persistence_dat[-2092, ]
plot(lm_log2_cohort_site, 1)

plot(lm_log2_site, 1)
plot(lm_log2_l$shaanxi, 1)
dev.off()

lm_log2_no_cohort_l$shaanxi



# ------------------------------------------------ #
# diagnostic plots
# ------------------------------------------------ #
png(filename = paste0(p_plots, run_label, "/decay/", "resid_fitted_mega_lm", run_label, ".png"), 
    width = 5, height = 5, units = "in", res = 400)
# without the outlier:
plot(lm(log(proportion) ~ 0 + log(time + 1):cohort:site, data = persistence_dat[-2092, ]), 1, main = "Model with all sites, all cohorts")
dev.off()

png(filename = paste0(p_plots, run_label, "/decay/", "mega_lm_diag_plots", run_label, ".png"), 
    width = 7, height = 7, units = "in", res = 400)
par(mfrow = c(2,2))
plot(lm(log(proportion) ~ 0 + log(time + 1):cohort:site, data = persistence_dat[-2092, ]), main = "Model with all sites, all cohorts")
dev.off()

# need to run again without the values that it drops
car::qqPlot(lm(log(proportion) ~ 0 + log(time + 1):cohort:site, 
               data = filter(persistence_dat[-2092, ], year_abn < 2013)))

```



## Check Assumptions

```{r AIC-mega}
# at all sites, the lin-log-lin cohort model has the lowest AIC (i.e. best performance).

mod_ll_mega <- list(
  "log(p) ~ 0 + log(time + 1):cohort:site" = lm_mega_log2_l,
  "log(p) ~ 0 + log(time + 1):cohort:site + \ntime:cohort:site" = lm_mega_log2_lin_l,
  "p - 1 ~ 0 + log(time + 1):cohort:site" = lm_mega_lin_log_l,
  "p - 1 ~ 0 + log(time + 1):cohort:site + \ntime:cohort:site" = lm_mega_lin_log_lin_l,
  "p - 1 ~ 0 + log(time + 1):site + \ntime:site" = lm_mega_l3_no_cohort_l,
  "log(p) ~ 0 + log(time + 1):site" = lm_mega_log2_no_cohort_l,
  "log(p) ~ 0 + log(time + 1):site + \nlog(time + 1):year_abn:site" = lm_mega_log2_year_abn_l,
  "log(p) ~ 0 + time:cohort:site" = lm_mega_log_lin_l,
  "log(p) ~ 0 + time:site" = lm_mega_log_lin_no_cohort_l,
  # "log(p) ~ 0 + time:cohort:site" = lm_mega_lin_cohort_l, # identical to lm_mega_log_lin_l
  "log(p) ~ 0 + time" = lm_mega_0_l,
  "p - 1 ~ 0 + log(time + 1):year_abn:site + \ntime:year_abn:site" = lm_mega_l3_cont)



# Calculate AIC

mod_AIC_mega <- lapply(mod_ll_mega, function(x) glance(x)) %>% 
  bind_rows(.id = "mod") %>%
  select(mod, AIC, everything()) %>% 
  arrange(AIC)


# save mod_AIC
write_csv(mod_AIC_mega, file = paste0(p_derived2, "mod_AIC_mega", run_label, ".csv"))
# 
# # re load
# mod_AIC_mega <- read.csv(file = paste0(p_derived2, "mod_AIC_mega", run_label,".csv"))

# view results
mod_AIC_mega %>% 
  arrange(AIC) %>% select(AIC, mod, adj.r.squared) %>% print(n = 150)


# mega AIC figure
gg_AIC_mega <-
  ggplot(data = mod_AIC_mega,
       mapping = aes(y = fct_reorder(mod, AIC), x = AIC, 
                     group = fct_reorder(mod, AIC), fill = fct_reorder(mod, AIC))) + 
  theme_classic() +
  geom_col(position = position_dodge(0.9)) +
  # theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  labs(y = "Model Specification", x = "AIC Value", fill = "Model") +
  theme(legend.position = "none",
        plot.margin = margin(4, 20, 4, 4, "pt"))

gg_AIC_mega

ggsave(plot = gg_AIC_mega, 
       filename = paste0(p_plots, run_label, "/decay/", "mod_AIC_mega_plot", run_label, ".png"), 
    width = 5, height = 4, units = "in")



# at all sites, the lin-log-lin cohort model has the lowest AIC (i.e. best performance).

```

```{r mega-diag}

plot(lm_mega_lin_log_lin_l)

qqnorm(residuals(lm_mega_lin_log_lin_l), main = paste0("QQ: mega"))

car::qqPlot(update(lm_mega_lin_log_lin_trim, data = dat_trim[-c(2014, 2036),]),
       ylab = "Sample Quantiles",
       main = paste0("QQ: mega"))


# save diagnostic plots
# mega lm
dev.off()

png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_diag_combo", run_label, ".png"), 
    width = 8, height = 5, units = "in", res = 400)
par(mfrow = c(1, 2))
plot(lm_mega_lin_log_lin_l, 1:2)
dev.off()

persistence_dat[c(324, 349), ]

```

```{r residuals-v-covariates}
# calculate augment() for each model in the mega list:
mega_aug_df <- lapply(mod_ll_mega, augment) %>% 
  bind_rows(.id = "model")

mega_aug_df <-
  mega_aug_df %>%
  mutate(time = ifelse(is.na(time), `I(time)`, time),
         time = ifelse(is.na(time), round(exp(`log(time + 1)`), digits = 0) - 1, time),
         age = time + 5,
         year_abn = ifelse(is.na(year_abn), 
                           ifelse(!is.na(cohort), as.numeric(levels(cohort))[cohort], year_abn), 
                           year_abn),
         year_abn = ifelse(year_abn < 1900, year_abn + 1987, year_abn))

# plot
gg_resid_vs_time <-
  ggplot(data = mega_aug_df %>% 
         filter(.std.resid > -10, 
                site != "mato_grosso", 
                # !is.na(year_abn)
                ), 
       mapping = aes(x = time, y = .std.resid, color = year_abn)) + 
    geom_point(alpha = 0.8, position = position_jitter()) + 
    scale_color_distiller(palette = "Greens") + 
    labs(y = "Residuals", x = "Time Past Abandonment Threshold (Years)",
         caption = "Excluding Mato Grosso") +
  facet_wrap(facets = vars(model)) + 
  theme(legend.position = c(0.85, 0.17))

# save
ggsave(gg_resid_vs_time,
  filename = paste0(p_plots, run_label, "/decay/", "resid_vs_time", run_label, ".pdf"), 
    width = 10, height = 10, units = "in")




# old:
# save figure of residuals vs. time:

# ------ #  put together df of residuals:

# all sites individually, combined
resid_df_log2 <- lapply(lm_log2_l, augment) %>% bind_rows(.id = "site") %>%
  bind_cols(., persistence_dat) %>% mutate(mod = "log_log")
resid_df_l3 <- lapply(lm_lin_log_lin_l, augment) %>% bind_rows(.id = "site") %>%
  bind_cols(., persistence_dat) %>% mutate(mod = "lin_log_lin")
resid_df_lin_log <- lapply(lm_lin_log_l, augment) %>% bind_rows(.id = "site") %>%
  bind_cols(., persistence_dat) %>% mutate(mod = "lin_log")

mega_resid_df <- bind_rows(resid_df_log2, resid_df_l3, resid_df_lin_log)


# save multiple model diagnostics plots ---------------- #

png(filename = paste0(p_plots, run_label, "/decay/", "resid_time_multi", run_label, ".png"), 
    width = 10, height = 5, units = "in", res = 400)
print(
  ggplot(data = mega_resid_df %>% filter(.std.resid > -10)
         , aes(x = time, y = .std.resid, color = year_abn)) + 
    geom_point(alpha = 0.8, position = position_jitter()) + 
    scale_color_distiller(palette = "Greens") + 
    labs(y = "Residuals", x = "Time Past Abandonment Threshold") + 
    facet_wrap(facets = vars(mod))
)
dev.off()


# -------------------------------------------------------------- #

mega_lm_mod_l3 <- augment(lm_mega_lin_log_lin_l) %>% 
  mutate(time = round(exp(`log(time + 1)`), digits = 0) - 1,
         age = time + 5,
         # proportion = .fitted + 1,
         year_abn = as.numeric(levels(cohort))[cohort]) %>%
  left_join(., persistence_dat, by = c("site", "year_abn", "cohort", "time", "age"))

names(mega_lm_mod_l3)

names(persistence_dat)

plot(lm_mega_lin_log_lin_l)
hist(mega_lm_mod_l3$.std.resid)
arrange(mega_lm_mod_l3, .std.resid)

ggplot(data = mega_lm_mod_l3 %>% filter(.std.resid > -10, site != "mato_grosso")
         , aes(x = time, y = .std.resid, color = year_abn)) + 
    geom_point(alpha = 0.8, position = position_jitter()) + 
    scale_color_distiller(palette = "Greens") + 
    labs(y = "Residuals", x = "Time Past Abandonment Threshold (Years)",
         caption = "Excluding Mato Grosso")



mega_aug_df %>%
  filter(year_abn < 1900) %>%
  select(model) %>% unique()



# q-q
ggplot(data = mega_lm_mod_l3 %>% filter(.std.resid > -10, site != "mato_grosso"), 
       aes(sample = .std.resid)) +
  stat_qq() +
  stat_qq_line()

car::qqPlot(mega_lm_mod_l3$.std.resid)
car::qqPlot(lm_mega_lin_log_lin_l)

par(mfrow = c(2,2))
plot(lm_mega_lin_log_lin_l)
dev.off()






# ------------------------------ old -------------------------------- #

lm_mod_log2_cohort

plot(lm_mod_log2_cohort)
augment(lm_mod_log2_cohort) %>% arrange(desc(.hat))

# just one site
resid_df1 <-  bind_cols(augment(lm_mod_log2_cohort), # with the tester model from above
                        filter(persistence_dat, site == "shaanxi"))


# residuals from the full model including all sites
resid_df_all <- bind_cols(persistence_dat, 
                          augment(lm_log2_cohort_all_site))



lapply(list(#"lm_log2_lin_l" = lm_log2_lin_l,
            #"lm_log2_lin_l_not0" = lm_log2_lin_l_not0,
            #"lm_lin_log_lin_l_not0" = lm_lin_log_lin_l_not0,
            #"lm_log2_no_cohort_l" = lm_log2_no_cohort_l,
            #"lm_log2_year_abn_l" = lm_log2_year_abn_l,
            #"lm_0_l" = lm_0_l,
            #"lm_log_lin_l" = lm_log_lin_l,
            "lm_log2_l" = lm_log2_l,
            "lm_lin_log_l" = lm_lin_log_l,
            "lm_lin_log_lin_l" = lm_lin_log_lin_l
            ), 
       FUN = function(x){lapply(x, augment) %>% bind_rows(.id = "site")}) %>% bind_cols(., .id = "mod", persistence_dat)




# resid_df <- bind_cols(select(dat, year, year_abn, initial_area_abn, 
#                              area_ha, age, proportion, time, time + 1, 
#                              cohort1 = cohort),
#                       augment(lm_mod_log2_cohort))

resid_df_all <- bind_cols(select(persistence_dat, year, year_abn, initial_area_abn, 
                             area_ha, age, proportion, time, time + 1, 
                             cohort1 = cohort),
                      augment(lm_log2_cohort_site))

gg_resid_1 <- ggplot(data = resid_df, aes(x = time, y = .std.resid, color = year_abn)) + 
  geom_point(alpha = 0.8, position = position_jitter()) + scale_color_distiller(palette = "Greens") + labs(y = "Residuals", x = "Time Past Abandonment Threshold")


resid_df <- bind_rows()

gg_resid_1
gg_resid_1 %+% resid_df_lin_log[-2092, ]
gg_resid_1 %+% resid_df_log2[-2092, ]
gg_resid_1 %+% resid_df_l3[-2092, ]

ggplot(data = resid_df_lin_log[-2092, ], aes(x = time, y = .std.resid, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + labs(y = "Residuals", x = "Time Past Abandonment Threshold")

ggplot(data = resid_df_log2,#[-2092, ], 
       aes(x = time, y = .std.resid, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + labs(y = "Residuals", x = "Time Past Abandonment Threshold")

ggplot(data = resid_df_l3,#[-2092, ], 
       aes(x = time, y = .std.resid, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + labs(y = "Residuals", x = "Time Past Abandonment Threshold")




mega_resid_df %>% mutate(index = 1:nrow(.)) %>% select(index, everything()) %>% arrange(.std.resid) # mato_grosso


gg_resid_1 + facet_wrap(facets = vars(site...10))


gg_resid_2 <- ggplot(data = resid_df, aes(x = initial_area_abn, y = .std.resid, color = year_abn)) + 
  geom_point(position = position_jitter(width = 20)) + scale_color_distiller(palette = "Greens") + 
  labs(y = "Residuals", x = "Initial Area Abandoned") + theme(legend.position = "none")


# save, shaanxi
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_resid", run_label, "_s.png"), 
    width = 10, height = 5, units = "in", res = 400)
plot_grid(gg_resid_1, gg_resid_2, rel_widths = c(1.2, 1))
dev.off()


# save
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_resid", run_label, "_all.png"), 
    width = 10, height = 5, units = "in", res = 400)
plot_grid(gg_resid_1 %+% resid_df_all[-2092, ],
          gg_resid_2 %+% resid_df_all[-2092, ], 
          rel_widths = c(1.2, 1))
dev.off()



# --------------------------------------------------------------------- #
par(mfrow = c(2,2))
plot(lm_mod_log2_cohort)
augment(lm_mod_log2_cohort) %>% arrange(desc(.hat))





# plot for just shaanxi
str(resid_df)
gg_resid_time <- ggplot(data = resid_df, 
                        aes(x = time, y = .std.resid, color = year_abn)) + 
  geom_point() + 
  scale_color_distiller(palette = "Greens") + 
  labs(y = "Residuals", x = "Time Past Abandonment Threshold")

gg_resid_area <- ggplot(data = resid_df, 
                        aes(x = initial_area_abn, y = .std.resid, color = year_abn)) + 
  geom_point(position = position_jitter(width = 20)) + 
  scale_color_distiller(palette = "Greens") + 
  labs(y = "Residuals", x = "Initial Area Abandoned") + 
  theme(legend.position = "none")



#install.packages("cowplot")
library(cowplot)
# all sites
cowplot::plot_grid(gg_resid_time, gg_resid_area, rel_widths = c(1.2, 1))


# all sites
cowplot::plot_grid(
  gg_resid_time %+% resid_df[-2092, ], # without outlier
  gg_resid_area %+% resid_df[-2092, ], # without outlier
  rel_widths = c(1.2, 1))


# residuals from the model with all sites: 
cowplot::plot_grid(
  gg_resid_time %+% resid_df_all[-2092, ], # without outlier
  gg_resid_area %+% resid_df_all[-2092, ], # without outlier
  rel_widths = c(1.2, 1))



# to plot specific sites:
cowplot::plot_grid(
  gg_resid_time %+% filter(resid_df[-2092, ], site...1 == "shaanxi"), # without outlier
  gg_resid_area %+% filter(resid_df[-2092, ], site...1 == "shaanxi"), # without outlier
  rel_widths = c(1.2, 1))

```

## Individual models per site:

Running a range of linear models `stats::lm()` with different specifications.

```{r run-lm-all-sites}
# run lms for each site individually, store in lists.

# log-log model, with cohort fixed effects
lm_log2_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + log(time + 1):cohort,  
               data = filter(persistence_dat, site == site_df$site[i]))
})

# log-log-lin model, with cohort fixed effects
# note, time needs to be adjusted to time + 1 in order for the log term to work
lm_log2_lin_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + log(time + 1):cohort + I(time):cohort,  
               data = filter(persistence_dat, site == site_df$site[i]))
})

  
# linear - log
lm_lin_log_l <- lapply(1:11, FUN = function(i) {
  lm(I(proportion - 1)  ~ 0 + log(time + 1):cohort,  
               data = filter(persistence_dat, site == site_df$site[i]))
})


# The final model specification
# linear - log - linear
lm_lin_log_lin_l <- lapply(1:11, FUN = function(i) {
  lm(I(proportion - 1)  ~ 0 + log(time + 1):cohort + I(time):cohort,  
               data = filter(persistence_dat, #year_abn < 2011, 
                             site == site_df$site[i]))
})


# linear - log - linear, without cohort fixed effects:
lm_l3_no_cohort_l <- lapply(1:11, FUN = function(i) {
  lm(I(proportion - 1)  ~ 0 + log(time + 1) + I(time),  
               data = filter(persistence_dat, #year_abn < 2011, 
                             site == site_df$site[i]))
})

# log-log model, without cohort fixed effects
lm_log2_no_cohort_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + log(time + 1),  
               data = filter(persistence_dat, site == site_df$site[i]))
})

# log-log model, with year_abn (continuous) rather than the categorical cohort
lm_log2_year_abn_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0  + log(time + 1) + log(time + 1):year_abn,  
               data = filter(persistence_dat, site == site_df$site[i]))
})

# log-linear (exp. decay)
lm_log_lin_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + time:cohort,  
               data = filter(persistence_dat, site == site_df$site[i]))
})

# linear:cohort
lm_lin_cohort_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + time:cohort,  
               data = filter(persistence_dat, site == site_df$site[i]))
})

# linear
lm_0_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + time,  
               data = filter(persistence_dat, site == site_df$site[i]))
})

names(lm_log2_l) <- site_df$site
names(lm_log2_lin_l) <- site_df$site
names(lm_lin_log_l) <- site_df$site
names(lm_lin_log_lin_l) <- site_df$site
names(lm_l3_no_cohort_l) <- site_df$site
names(lm_log2_no_cohort_l) <- site_df$site
names(lm_log2_year_abn_l) <- site_df$site
names(lm_log_lin_l) <- site_df$site
names(lm_lin_cohort_l) <- site_df$site
names(lm_0_l) <- site_df$site

```

```{r coef-all-sites-l3}
# extract coefficients for log-lin-log-cohort model for all sites

coef_df_l3 <- lapply(lm_lin_log_lin_l, FUN = function(x) {
  tidy(x, conf.int = TRUE) %>% 
    mutate(coef_term = sub(":*cohort....:*", "", term),
         year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
         year_abn = as.numeric(year_abn),
         cohort = as.factor(year_abn))
}) %>% bind_rows(.id = "site") %>%
    mutate(term_long = term,
           term = as_factor(ifelse(coef_term == "I(time)", "lin", "log"))) %>%
  select(site, cohort, term, estimate, coef_term, everything())


# calculate mean coefficients per site, for both lin and log terms
mean_coef_df_l3 <- coef_df_l3 %>% 
  group_by(site, coef_term, term) %>% # group by site, term and coef_term (though you only need one of these)
  summarise(mean = mean(estimate, na.rm = TRUE),
            mean_low = mean(conf.low, na.rm = TRUE),
            mean_high = mean(conf.high, na.rm = TRUE),
            se = se(estimate)) %>% ungroup()


# pivot wider, for use below in the calculation of projections
mean_coef_df_wide_l3 <- mean_coef_df_l3 %>%
  pivot_wider(id_cols = c(site, term), 
              names_from = term,
              names_glue = "{term}_{.value}",
              values_from = c(mean, mean_low, mean_high)) %>%  
  
  # calculate the time_to_0.5
  mutate(time_to_0.5 = ((log_mean * lambertW0((lin_mean * exp(lin_mean/log_mean + 0.5/log_mean - 1/log_mean))/log_mean))/lin_mean) + 4,
         time_to_0.5_low = ((log_mean_low * lambertW0((lin_mean_low * exp(lin_mean_low/log_mean_low + 0.5/log_mean_low - 1/log_mean_low))/log_mean_low))/lin_mean_low) + 4,
         time_to_0.5_high = ((log_mean_high * lambertW0((lin_mean_high * exp(lin_mean_high/log_mean_high + 0.5/log_mean_high - 1/log_mean_high))/log_mean_high))/lin_mean_high) + 4
         )



# join to all coef df
coef_df_l3 <- left_join(coef_df_l3, 
                        mean_coef_df_l3 %>% select(-term),
                        by = c("site","coef_term"))# %>% filter(site == "belarus") %>% print(n = 30) # for testing purposes



# pivot coef_df_wide_l3
coef_df_wide_l3 <- 
  coef_df_l3 %>%
  pivot_wider(id_cols = c(site, cohort, year_abn, term), 
              names_from = term,
              names_glue = "{term}_{.value}",
              values_from = estimate) %>%
  mutate(time_to_0.5 = ((log_estimate * lambertW0((lin_estimate * exp(lin_estimate/log_estimate + 0.5/log_estimate - 1/log_estimate))/log_estimate))/lin_estimate) + 4)


# join mean half time to coef_df_wide_l3
coef_df_wide_l3 <- left_join(coef_df_wide_l3,
                             mean_coef_df_wide_l3 %>% select(site, lin_mean, log_mean, mean_time_to_0.5 = time_to_0.5),
                             by = c("site"))
  


# calculate the proportion remaining at various times, projection
mean_coef_proj_l3 <- bind_rows(mean_coef_df_wide_l3, 
                          
                          # time + 1 = i + 4 (since time is age - 5)
                          lapply(c(0, 5, 10, 15, 20, 25, 35, 45), FUN = function(x) {
                            mean_coef_df_wide_l3 %>%
                             # need to update this to reflect the new formula:
                              #{mean_coef_tmp$mean_est[2]*log(x-4) + mean_coef_tmp$mean_est[1]*((x-4) - 1) + 1}
                              # mean*log(x) + mean*(x - 1) + 1
                               mutate(mean = log_mean*log(x + 1) + lin_mean*(x) + 1,
                                     mean_low = log_mean_low*log(x + 1) + lin_mean_low*(x) + 1,
                                     mean_high = log_mean_high*log(x + 1) + lin_mean_high*(x) + 1,
                                     term = paste0("yr_", x + 5))
                            }))



seq(from = 0.1, to = 0.5, by = 0.1)
select(mean_coef_df_wide_l3, -contains("half_"))



# calculate time to various proportions:
time_to_l3 <- bind_rows(#select(mean_coef_df_wide_l3, -contains("half_")), 
                          
                          # time = i + 4 (since time_1 is age - 4)
                          lapply(seq(from = 0, to = 1,# 0.9, 
                                     by = 0.1), FUN = function(x) {
                            select(mean_coef_df_wide_l3, -contains("half_")) %>%
                                         
                                         # solve a log(u) + b(u-1) + 1 - p = 0 for u : 
                                         # (in this case, u = t + 1, so we're solving for t + 1. 
                                         # Remember that age = t + 5 = u + 4)
                                         
                                         # age = (a * lambertW0((b * exp((b + p - 1)/a))/a))/b + 4
                                           
                              # where p is the proportion, a is the log coef, and b is the linear coef.
                               mutate(
                                 time_to_value = ((log_mean * lambertW0((lin_mean * exp((lin_mean + x - 1)/log_mean)) / 
                                                                        log_mean)) / lin_mean) + 4,
                                 time_to_value_low = ((log_mean_low * 
                                                         lambertW0((lin_mean_low * exp((lin_mean_low + x - 1)/log_mean_low)) / 
                                                                     log_mean_low)) / lin_mean_low) + 4,
                                 time_to_value_high = ((log_mean_high * 
                                                          lambertW0((lin_mean_high * exp((lin_mean_high + x - 1)/log_mean_high)) /
                                                                      log_mean_high)) / lin_mean_high) + 4,
                                     proportion = paste0("p_", x),
                                 p = x)
                            }))


# save dfs:
coef_df_l3
coef_df_wide_l3
mean_coef_df_l3
mean_coef_df_wide_l3
mean_coef_proj_l3
time_to_l3



# ------------------------------------------------------------------------ #
# save coef data.frames
# ------------------------------------------------------------------------ #
save(coef_df_l3, 
     coef_df_wide_l3, 
     mean_coef_df_l3, 
     mean_coef_df_wide_l3, 
     mean_coef_proj_l3, 
     time_to_l3,
     file = paste0(p_dat_derived, run_label, "/derived_data", "/decay_mod_coef_dfs", run_label, ".rds"))


load(file = paste0(p_dat_derived, run_label, "/derived_data", "/decay_mod_coef_dfs", run_label, ".rds"),
     verbose = TRUE)
```



```{r AIC}
# at all sites, the lin-log-lin cohort model has the lowest AIC (i.e. best performance).

mod_ll <- list("log(p) ~ 0 + log(time + 1):cohort" = lm_log2_l,
               "log(p) ~ 0 + log(time + 1):cohort + time:cohort" = lm_log2_lin_l,
               #"lm_log2_lin_l_not0" = lm_log2_lin_l_not0,
               "p - 1 ~ 0 + log(time + 1):cohort" = lm_lin_log_l,
               "p - 1 ~ 0 + log(time + 1):cohort + time:cohort" = lm_lin_log_lin_l,
               "p - 1 ~ 0 + log(time + 1) + time" = lm_l3_no_cohort_l,
               #"lm_lin_log_lin_l_not0" = lm_lin_log_lin_l_not0,
               # "lm_log2_no_cohort_l" = lm_log2_no_cohort_l,
               # "lm_log2_year_abn_l" = lm_log2_year_abn_l,
               #"lm_0_l" = lm_0_l,
               "log(p) ~ 0 + time:cohort" = lm_log_lin_l
               )



# Calculate AIC
mod_AIC <- lapply(mod_ll, 
  FUN = function(x) {
    lapply(x, FUN = function(y) {glance(y)}) %>% bind_rows(.id = "site")
    }
  ) %>% 
  bind_rows(.id = "mod") %>% 
  select(site, AIC, mod, everything()) %>% 
  arrange(site, AIC)

# save mod_AIC
write_csv(mod_AIC, file = paste0(p_dat_derived, "mod_AIC", run_label, ".csv"))
# 
# # re load
# mod_AIC <- read.csv(file = paste0(p_dat_derived, "mod_AIC.csv"))

# view results
mod_AIC %>% 
  arrange(site, AIC) %>% select(site, AIC, mod, adj.r.squared) %>% print(n = 150)

gg_AIC <-
  ggplot(data = mod_AIC,
       mapping = aes(x = fct_reorder(site, desc(AIC)), y = AIC, 
                     # group = fct_reorder(mod, AIC), 
                     fill = fct_reorder(mod, AIC))) + 
  theme_classic() +
  geom_col(position = position_dodge(0.9)) +
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  labs(x = "Site", y = "AIC Value", fill = "Model Specification") +
    facet_wrap(vars(site), scales = "free", labeller = as_labeller(cap_update_labels)) + 
    theme(legend.position = "bottom", 
          axis.text.x = element_blank(), 
          axis.title.x = element_blank(), 
          axis.ticks.x = element_blank()) + 
    guides(fill = guide_legend(ncol = 2, byrow = FALSE))


# Save png
# png(filename = paste0(p_plots, run_label, "/decay/", "mod_AIC_plot", run_label, ".png"), 
#     width = 10, height = 5, units = "in", res = 400)
# print(gg_AIC)
# dev.off()
ggsave(plot = gg_AIC, 
       filename = paste0(p_plots, run_label, "/decay/", "mod_AIC_plot", run_label, ".pdf"), 
    width = 7.5, height = 6, units = "in")

# at all sites, the lin-log-lin cohort model has the lowest AIC (i.e. best performance).

```


```{r save-diag-plots}
# -------------------------------------------------------------------------------------------------- #
# --------------------------------- lin-log-lin diagnostics plots ---------------------------------- #
# -------------------------------------------------------------------------------------------------- #

# ----------------------- fitted vs. residuals diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_diag_resid_v_fitted", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) plot(lm_lin_log_lin_l[[i]], 1, main = site_df$site[i])
dev.off()


# ----------------------- QQ diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_diag_qq", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) {qqnorm(residuals(lm_lin_log_lin_l[[i]]), main = paste0("QQ: ", site_df$site[i]))}
dev.off()


# using car, but with a subset of the data, year_abn < 2011
# Use these diagnostic plots for the SI >>

library(car)
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_diag_qq_subset", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) {
  car::qqPlot(lm(formula = I(proportion - 1) ~ 0 + log(time + 1):cohort + I(time):cohort, 
        data = filter(persistence_dat, year_abn < 2011, site == site_df$site[i])),
       ylab = "Sample Quantiles",
       main = paste0("QQ: ", site_df$site[i]))
}
dev.off()
```




```{r save-alt-model-spec-diag-plots}
# -------------------------------------------------------------------------------------------------- #
# ------------------------------------- log-log diagnostics plots ---------------------------------- #
# -------------------------------------------------------------------------------------------------- #

# ----------------------- diagnostics plot, shaanxi ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_diag", run_label, "_s.png"), 
    width = 8, height = 8, units = "in", res = 400)
par(mfrow = c(2,2))
plot(lm_mod_log2_cohort)
plot(lm_log2_l[[9]])
dev.off()

tidy(lm_log2_l[[9]])


# ----------------------- diagnostics plot, all sites in sequence ----------------------- #
lapply(1:11, FUN = function(i) {
  
  png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_diag", run_label, site_df$label[i],".png"), 
    width = 8, height = 8, units = "in", res = 400)
  par(mfrow = c(2,2))
  plot(lm_log2_l[[i]], 1, main = site_df$site[i])
  plot(lm_log2_l[[i]], 2)
  plot(lm_log2_l[[i]], 3)
  plot(lm_log2_l[[i]], 4)

  dev.off()
  
})

# ----------------------- fitted vs. residuals diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_diag_resid_v_fitted", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) plot(lm_log2_l[[i]], 1, main = site_df$site[i])
dev.off()


# ----------------------- QQ diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_diag_qq", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) plot(lm_log2_l[[i]], 2, main = site_df$site[i])
dev.off()




# -------------------------------------------------------------------------------------------------- #
# ------------------------------------- lin-log diagnostics plots ---------------------------------- #
# -------------------------------------------------------------------------------------------------- #

# ----------------------- fitted vs. residuals diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "lin-log_cohort_diag_resid_v_fitted", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) plot(lm_lin_log_l[[i]], 1, main = site_df$site[i])
dev.off()


# ----------------------- QQ diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "lin-log_cohort_diag_qq", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) {qqnorm(residuals(lm_lin_log_l[[i]]), main = paste0("QQ: ", site_df$site[i]))}
dev.off()







car::qqPlot(lm_lin_log_lin_l[[i]])
qqnorm(residuals(lm_lin_log_lin_l[[i]]))
abline(0, 1, col = 'red')
qqline(residuals(lm_lin_log_lin_l[[i]]))
qqline(lm_lin_log_lin_l$belarus$residuals)

# why doesn't the QQ plot work for the lms that start with a linear term?
lm_log2_l
lm_lin_log_lin_l

lm_log2_l[[1]]
lm_lin_log_lin_l[[1]]
lm_log2_lin_l[[1]]

i <- 1
dev.off()
par(mfrow = c(3, 4))
plot(lm(formula = log(proportion) ~ 0 + log(time + 1):cohort + I(time):cohort, 
        data = filter(persistence_dat, site == site_names[i])))

plot(lm(formula = I(proportion - 1) ~ 0 + log(time + 1):cohort + I(time):cohort, 
        data = filter(persistence_dat, year_abn < 2012, site == site_names[i])))

dev.off()
par(mfrow = c(3, 4))
for (i in 1:11) {plot(lm_lin_log_lin_l[[i]], 2, main = site_df$site[i])}
```



```{r check-assumptions}

# ------- check assumptions of the lm ------------------------------------------------- #
lm_mod
par(mfrow = c(2,2))
plot(mod_l[[9]])
residuals(lm_mod)
broom::augment(lm_mod)

# plot model diagnostics:
par(mfrow = c(2,2)) # create a plotting panel with two rows and two columns (allowing you to put 4 plots on the same plotting panel)
plot(lm_mod) # check for violations of model assumptions

dev.off()

# description of the four diagnostic plots from: http://www.sthda.com/english/articles/39-regression-model-diagnostics/161-linear-regression-assumptions-and-diagnostics-in-r-essentials/
# 1. Residuals vs Fitted. Used to check the linear relationship assumptions. A horizontal line, without distinct patterns is an indication for a linear relationship, which is good.
# 2. Normal Q-Q. Used to examine whether the residuals are normally distributed. Good if residuals points follow the straight dashed line.
# 3. Scale-Location (or Spread-Location). Used to check the homogeneity of variance of the residuals (homoscedasticity). Horizontal line with equally spread points is a good indication of homoscedasticity.
# 4. Residuals vs Leverage. Used to identify influential cases, that is extreme values that might influence the regression results when included or excluded from the analysis. 



# ------------------------------------- Umesh's notes on assumptions ------------------------------------------------ #
# assumptions to check:
# a. LINEAR RELATIONSHIP between the predictor (x) and the response (y); i.e., y = mx + C
# b. the data points are STATISTICALLY INDEPENDENT (study design issue)
# c. no outliers influence the relationship unduly (look at the Residuals vs Leverage plot; also the Normal Q-Q plot)
# d. CONSTANT, or EQUAL VARIANCE (fancily called HOMOSCEDASTICITY; look at the Residuals vs Fitted plot)
# e. ERRORS ARE NORMALLY DISTRIBUTED (look at the Normal Q-Q plot)

# ------------------ a. Linear relationship plot to check.
ggplot(data = dat, mapping = aes(x = age, y = log(proportion), group = year_abn, color = year_abn)) + 
  theme_classic() + 
  geom_point(size = 1.25) + 
  labs(title = "Persistence of Abandoned Land") + 
  scale_color_distiller(palette = "Greens") + 
  theme(legend.position = "bottom", legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_smooth(method = "lm", se = FALSE) + 
  geom_smooth(method = "lm", aes(x = age, y = log(proportion)), se = FALSE, inherit.aes = FALSE, color = "blue") + 
  geom_hline(yintercept = log(0.5), linetype = "dashed", color = "red", size = 0.75)
# yes?

# ------------------ b. Statistically independent? I don't think the points are independent. Each cohort of abandoned land (i.e. land that was all initially abandoned in a give year) can constitute a group. This is especially the case if I'm looking at area, rather than proportion.
pairs(dat)
plot(proportion ~ year_abn, data = dat)
plot(area_ha ~ initial_area_abn, data = dat)
plot(proportion ~ initial_area_abn, data = dat)

# If the points are not independent, and they belong to a particular cohort of abandoned land, I have two options: 
# add cohorts as a categorical fixed effect, calculating either unique intercepts, unique slopes, or both depending on the identity of the cohort. 
# Or, I could model these cohort groups as random effects (meaning that we expect the behavior or each cohort group to be drawn from a normal distribution with a particular mean and standard deviation), and move to a linear mixed effects model next. 


# continuing with Umesh's diagnostics:
# ------------------ c.
# c. no outliers influence the relationship unduly (look at the Residuals vs Leverage plot; also the Normal Q-Q plot)
# the residuals should lie along the dotted line in the QQ plot, and the leverage plot should look straight as well.


# ------------------ d.
# d. CONSTANT, or EQUAL VARIANCE (fancily called HOMOSCEDASTICITY; look at the Residuals vs Fitted plot)
# this first plot should have a pretty horizontal line across it, with good horizontal spread, and vertical spread. An even distribution along the x axis (fitted values) across values of y indicates a lack of *bias*. An even spread across the y axis across values of x shows homoscedasticity. Constant variance among residuals.  

# ------------------ e.
# e. Error ARE NORMALLY DISTRIBUTED (look at the Normal Q-Q plot)
# looks good

plot(lm_mod, 2)

# check normality of residuals
hist(residuals(lm_mod)) # or
ggplot(data = data.frame(.resid = residuals(lm_mod)), aes(x = .resid)) + geom_histogram() # looks normal to me?


ggplot(data = augment(lmer_mod_offset), aes(x = .resid)) + geom_histogram() # looks normal to me?
ggplot(data = augment(lmer_mod_offset), aes(x = `log(proportion)`)) + geom_histogram() # looks normal to me?


plot(lmer_mod)
qqnorm(residuals(lmer_mod))

plot(lmer_mod_offset)
qqnorm(residuals(lmer_mod_offset))
```


```{r car-diagnostics}
# resource from Oscar: https://dss.princeton.edu/training/Regression101R.pdf
library(car)

lm_log2_l$shaanxi # # run first for shaanxi only
lm_log2_l # then the whole list of sites
lm_log2_cohort_site # finally, for the mega model

# 1. Residuals vs. fitted values ------------------------- # 
# plot model diagnostics: 
par(mfrow = c(2,2)) # create a plotting panel with two rows and two columns (allowing you to put 4 plots on the same plotting panel)
plot(lm_log2_l[[9]]) # check for violations of model assumptions
dev.off()

# Now, with car
residualPlots(lm_log2_l[[9]])
plot(lm_log2_l[[9]], 1)
residualPlots(lm_log2_l[[9]], ~ cohort, fitted=FALSE)

# all sites at once:
par(mfrow = c(3, 4))
for (i in 1:11) residualPlots(lm_log2_l[[i]])

# 2. Added variable plots - Influential variables ------------------------- # 
avPlots(lm_log2_l[[9]])


# 3. Outliers - QQ-Plots -------------------------------------------------- # 
# qqnorm
qqnorm(residuals(lm_log2_l[[9]]))
plot(lm_log2_l[[9]], 2)
car::qqPlot(lm_log2_l[[9]], id.n = 3)
car::qqPlot(lm_log2_l[[9]], simulate = T, envelope = 0.9)
dev.off()

tidy(lm_log2_l[[9]]) %>% tail()


# bonferonni test:
outlierTest(lm_log2_l$shaanxi)

lm_log2_l$shaanxi$model
plot(lm(formula = log(proportion) ~ 0 + log(time + 1):cohort, 
   data = filter(persistence_dat, site == site_df$site[9])[-19, ]))


influenceIndexPlot(lm_log2_l$shaanxi, id.n=3)

par(mfrow=c(1,1))
influencePlot(lm_log2_l$shaanxi)
outlier_list <- influencePlot(lm_log2_l$shaanxi) %>% rownames() %>% as.numeric()

influencePlot(lm(formula = log(proportion) ~ 0 + log(time + 1):cohort, 
   data = filter(persistence_dat, site == site_df$site[9])[-c(outlier_list), ]))

influencePlot(lm(formula = log(proportion) ~ 0 + log(time + 1):cohort, 
   data = filter(persistence_dat, site == site_df$site[9])[-349, ]))

par(mfrow=c(2,2))
plot(lm(formula = log(proportion) ~ 0 + log(time + 1):cohort, 
   data = filter(persistence_dat, site == site_df$site[9])[-349, ]))
warnings()
car::update()

car::qqPlot(lm_log2_no_out$shaanxi, #line = "robust",
	envelope=.99)
car::qqPlot(lm_log2_no_out$shaanxi)

class(lm_log2_l$shaanxi)

lm_out <- lm(log(proportion) ~ 0 + log(time + 1):cohort,  
               data = dat %>% filter(year_abn < 2012) %>% .[-c(134, 150), ])
car::qqPlot(lm_out)
par(mfrow = c(2,2)); plot(lm_out)

```

```{r plot-without-outliers}
dat_no_outliers <- persistence_dat %>%
  filter(year_abn < 2012)

lm_log2_no_out <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + log(time + 1):cohort,  
               data = filter(dat_no_outliers, 
                             site == site_df$site[i]))
})
names(lm_log2_no_out) <- site_df$site



ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = filter(persistence_dat, site == "shaanxi")) + 
  scale_color_distiller(palette = "Greens") + scale_x_continuous(n.breaks = 30) + 
  labs(title = "Decay of abandoned land over time", #subtitle = site_df$description[indx], 
       caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
       x = "Time since initial abandonment (years)", y = "Proportion of abandoned land remaining",
       color = "Cohort (Year \nFirst Abandoned)") + 
  geom_line(data = mutate(augment(lm_log2_l[[9]], 
                                  newdata = filter(persistence_dat, site == "shaanxi") %>% 
                                    select(time, cohort, site, year_abn, age)),
                          proportion = exp(.fitted))) + 
  
  # add the mean coefficient (needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[9]]), na.rm = TRUE))},
                mapping = aes(linetype = "Mean Decay Rate"),
                color = "blue", size = 1, #linetype = "dashed", 
                inherit.aes = FALSE) +
  scale_linetype(name = "")


cc_add_mod_results <- function(mod, site_name = "shaanxi", input_dat) {
  gg_temp <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = filter(input_dat, site == site_name)) + 
  scale_color_distiller(palette = "Greens") + scale_x_continuous(n.breaks = 30) + 
  labs(title = "Decay of abandoned land over time", subtitle = site_name, 
       caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
       x = "Time since initial abandonment (years)", y = "Proportion of abandoned land remaining",
       color = "Cohort (Year \nFirst Abandoned)") + 
    
  geom_line(data = mutate(augment(mod, 
                                  newdata = filter(input_dat, site == site_name) %>% 
                                    select(time, cohort, site, year_abn, age)),
                          proportion = exp(.fitted))) + 
  
  # add the mean coefficient (needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) { (x-4) ^ (mean(coef(mod), na.rm = TRUE))},
                mapping = aes(linetype = "Mean Decay Rate"),
                color = "blue", size = 1, #linetype = "dashed", 
                inherit.aes = FALSE) +
  scale_linetype(name = "")
  
  print(gg_temp)
}

cc_add_mod_results(mod = lm_log2_l$shaanxi, site_name = "shaanxi", input_dat = persistence_dat)

cc_add_mod_results(mod = lm_log2_no_out$shaanxi, site_name = "shaanxi", input_dat = dat_no_outliers)

plot(lm_log2_no_out$shaanxi)

```

# Extract fitted values


```{r weighted-means}
# combine coefficient data.frames and calculate weighted means: 
# 1) by # of observations, and 2) by uncertainty range

combo_mean_coefs_w <-
  # coef_l3_mega %>% 
  bind_rows(coef_l3_mega,
            coef_l3_mega_trim,
            coef_lin_log_mega,
            coef_log2_lin_mega) %>% 
  # filter(!is.na(estimate)) %>%
  group_by(mod, site, coef_term) %>% 
  summarise(
    # mean = mean(estimate, na.rm = TRUE),
    mean_w_obs = sum(estimate * obs, na.rm = TRUE) / sum(obs, na.rm = TRUE),
    mean_w_unc = sum(estimate * (uncertainty_range)^-1, na.rm = TRUE) / sum((uncertainty_range)^-1, na.rm = TRUE)
    ) %>% 
    ungroup() %>%
  
  # join to mean coefficient (estimated with lm() so as to include conf. intervals) 
  left_join(combo_mean_coefs, by = c("mod", "site", "coef_term"))

```

```{r fitted-combo}
# ------------------------------------------------------- #
# calculate fitted values for the mean trajectories:

# Calculate and combine fitted values for lin-log-lin models, l3_no_cohort, lin_log, and log2_lin models
coef_l3_no_cohort_mega %>% names
mean_coef_l3_mega_trim %>% names


fitted_combo <-
  combo_mean_coefs_w %>% 
  rename(mean = estimate) %>%
  bind_rows(coef_l3_no_cohort_mega) %>%
  # bind_rows(mean_coef_l3_mega_trim) %>%
  select(mod, site, coef_term, estimate, mean, mean_w_obs, mean_w_unc, conf.low, conf.high) %>%
  pivot_longer(cols = c(estimate:conf.high), values_to = "value", names_to = "type") %>%
  pivot_wider(id_cols = c(mod, site, type), names_from = coef_term, values_from = "value") %>%
  mutate(type = ifelse(type == "mean_w_obs", "w_obs", type),
         type = ifelse(type == "mean_w_unc", "w_uncertainty", type)) %>%
  
  # can modify age range here
  left_join(tibble(age = 5:150), by = character()) %>%
  mutate(
    proportion = case_when(
      mod == "l3"           ~ log * log(age-4) + lin * ((age-4) - 1) + 1,
      mod == "l3_trim"      ~ log * log(age-4) + lin * ((age-4) - 1) + 1,
      mod == "l3_no_cohort" ~ log * log(age-4) + lin * ((age-4) - 1) + 1,
      mod == "lin_log"      ~ log * log(age-4) + 1,
      mod == "log2_lin"     ~ ((age-4) ^ log ) * exp(1) ^ (lin * (age - 5))
      ),
    proportion = ifelse(proportion >= 0, proportion, 0)) %>%
    filter(!is.na(proportion))
  

fitted_combo %>% select(mod, type) %>% unique()
```

```{r time-to-combo}
fitted_combo

# ------------------------------------------------------------------------- #
time_to_combo <- 
  combo_mean_coefs_w %>% 
  rename(mean = estimate) %>%
  bind_rows(coef_l3_no_cohort_mega) %>%
  select(mod, site, coef_term, estimate, mean, mean_w_obs, mean_w_unc, conf.low, conf.high) %>%
  pivot_longer(cols = c(estimate:conf.high), values_to = "value", names_to = "type") %>%
  pivot_wider(id_cols = c(mod, site, type), names_from = coef_term, values_from = "value") %>%
  mutate(type = ifelse(type == "mean_w_obs", "w_obs", type),
         type = ifelse(type == "mean_w_unc", "w_uncertainty", type)) %>%
  filter(!(mod != "l3_no_cohort" & type == "estimate")) %>%
  
  left_join(tibble(proportion = seq(from = 0, to = 1, by = 0.1)), by = character()) %>%
  
  mutate(time_to = case_when(
      mod %in% c("l3", 
                 "l3_trim",
                 "l3_no_cohort") ~ ((log * lambertW0((lin * exp((lin + proportion - 1) / log)) / 
                                              log)) / lin) + 4
      # mod == "lin_log"      ~ log * log(age-4) + 1,
      # mod == "log2_lin"     ~ ((age-4) ^ log ) * exp(1) ^ (lin * (age - 5))
      ))
           


# view:
time_to_combo %>%        
  filter(proportion == 0.5, !is.na(time_to), type == "mean", 
         !grepl("conf", type), mod %in% c("l3", "l3_trim")) %>%
  left_join(time_to_combo %>%
              filter(grepl("conf", type), proportion == 0.5, 
                     !is.na(time_to), mod %in% c("l3", "l3_trim")) %>%
              pivot_wider(id_cols = c(mod, site), names_from = type, 
                          values_from = "time_to") %>%
              mutate(type = "mean")) %>%
  arrange(site, mod) %>%
  select(mod, site, proportion, time_to) %>%
  pivot_wider(id_cols = c(mod, site), names_from = mod, 
              values_from = "time_to") %>%
  mutate(diff = l3_trim - l3) %>%
  arrange(desc(diff)) %>%
  print(n = 30)
  




# ------------------------------------------------------------------------- #
# plot 
# ------------------------------------------------------------------------- #
gg_half_life <-
  time_to_combo %>% 
      filter(proportion == 0.5, !is.na(time_to),
             type == "mean",
             !grepl("conf", type), 
             # mod == "l3"
             mod %in% c("l3", "l3_trim")
             ) %>%
  # arrange(site, type, time_to)
  left_join(
    time_to_combo %>%
      filter(grepl("conf", type),
             proportion == 0.5, 
             !is.na(time_to), 
             # mod == "l3"
             mod %in% c("l3", "l3_trim")
             ) %>%
      pivot_wider(id_cols = c(mod, site), names_from = type, 
                  values_from = "time_to") %>%
      mutate(type = "mean")
    ) %>%
  ggplot(data = .,
         mapping = aes(x = time_to, xmin = conf.low, xmax = conf.high,
                       y = fct_reorder(site, time_to),
                       # shape = mod,
                       shape = type,
                       # color = as_factor(type)
                       color = as_factor(mod)
                       )
         ) +
  geom_errorbar(width = 0.5, position = position_dodge(0.7),
                alpha = 0.8) + 
  geom_point(position = position_dodge(0.7), size = 1.7) + 
  scale_x_continuous(breaks = seq(from = 10, to = 190, by = 10)) +
  scale_y_discrete(labels = fancy_labels) + 
  scale_shape_discrete(labels = c("mean" = "Mean coefs.\n (unweighted)",
                                "w_obs"= "Mean weighted \n by # obs.",
                                "w_uncertainty"= "Mean weighted\n by inverse uncertainty"),
                       name = "Mean Method") +
    scale_color_discrete(labels = 
                           c("l3" = "Including all cohorts",
                             "l3_trim"= "Excluding cohorts\nwith < 5 obs.\n(2010, '11, '12, '13)"),
                         name = "Model Spec.") + 
  # facet_wrap(vars(mod)) + 
  theme_classic() +
  labs(x = "Half-life", y = "Site", 
       caption = "Error bars represent 95% Confidence Intervals (where possible)") + 
  theme(legend.position = c(0.75, 0.5),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))


# ------------------------------------------------------------------------- #
# save
# ------------------------------------------------------------------------- #
ggsave(plot = gg_half_life, 
       filename = paste0(p_plots, run_label, "/decay/", "half_lives", run_label, ".pdf"), 
       width = 6, height = 5, units = "in")








time_to_combo %>% 
      filter(proportion == 0.5, !is.na(time_to),
             !grepl("conf", type), 
             grepl("l3", mod), !grepl("no_cohort", mod)) %>%
  pivot_wider(id_cols = c(mod, site), names_from = c(mod, type), 
                  values_from = "time_to") %>%
  pivot_longer(cols = c(!site), 
               values_to = "time_to", names_to = "type")

# ------------------------------------------------------------------------- #
# plot multiple mean methods
# ------------------------------------------------------------------------- #
gg_half_life_multi <-
  time_to_combo %>% 
      filter(proportion == 0.5, !is.na(time_to),
             # type == "mean",
             !grepl("conf", type), 
             grepl("l3", mod), !grepl("no_cohort", mod)) %>%
  # arrange(site, type, time_to)
  left_join(
    time_to_combo %>%
      filter(grepl("conf", type), grepl("l3", mod), !grepl("no_cohort", mod),
             proportion == 0.5, 
             !is.na(time_to)) %>%
      pivot_wider(id_cols = c(mod, site), names_from = type, 
                  values_from = "time_to") %>%
      mutate(type = "mean")
    ) %>%
  ggplot(data = .,
         mapping = aes(x = time_to, xmin = conf.low, xmax = conf.high,
                       y = fct_reorder(site, time_to), 
                       shape = mod,
                       color = as_factor(type))) +
  geom_errorbar(width = 0.5, position = position_dodge(0.7),
                alpha = 0.8) + 
  geom_point(position = position_dodge(0.7), size = 1.7) + 
  scale_x_continuous(breaks = seq(from = 10, to = 190, by = 10)) +
  scale_y_discrete(labels = fancy_labels) + 
  scale_color_discrete(labels = c("mean" = "Mean coefs.\n (unweighted)",
                                "w_obs"= "Mean weighted \n by # obs.",
                                "w_uncertainty"= "Mean weighted\n by inverse uncertainty")) +  scale_shape_discrete(labels = c("l3" = "Including all cohorts",
                                "l3_trim"= "Excluding cohorts\nwith < 5 obs.\n(2010, '11, '12, '13)"
                                )) +
  # facet_wrap(vars(mod)) + 
  theme_classic() +
  labs(x = "Half-life", y = "Site", 
       color = "Mean Method", shape = "Model spec.",
       caption = "Error bars represent 95% Confidence Intervals (where possible)") + 
  theme(
    legend.position = c(0.75, 0.6),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))


# ------------------------------------------------------------------------- #
# save
# ------------------------------------------------------------------------- #
ggsave(plot = gg_half_life_multi, 
       filename = paste0(p_plots, run_label, "/decay/", "half_lives_multi_method+", run_label, ".pdf"), 
       width = 9, height = 6, units = "in")
```

```{r new-indiv-half-lives}

gg_all_half_lives <-
  half_lives_all_cohorts_l3 %>%
  left_join(., select(half_life_mean_coefs_l3, mod, site, mean_time_to_0.5)) %>%

  ggplot(data = ., 
       mapping = aes(x = time_to_0.5, y = fct_reorder(site, mean_time_to_0.5, .desc = FALSE),
                     color = year_abn, group = year_abn)) + 
  geom_point(position = position_dodge(0.7), size = 1.7) + 
  scale_x_continuous(breaks = seq(from = 0, to = 340, by = 25)) +
  scale_y_discrete(labels = fancy_labels) + 
  scale_color_viridis(direction = -1) +
  theme_classic() +
  labs(x = "Half-life (Years)", y = "Site", color = "Cohort", linetype = NULL) +
  theme(legend.position = c(0.8, 0.75),
        legend.background = element_blank(),
        # legend.direction = "horizontal",
          legend.spacing = unit(-4, units = "mm"), 
        legend.box.background = element_rect(colour = "black")
        ) +
  
  geom_point(data = . %>%
               filter(year_abn < 2012, is.na(time_to_0.5)) %>%
               mutate(time_to_0.5 = case_when(year_abn < 2012 & is.na(time_to_0.5) ~ 330)),
             shape = 17, size = 2, show.legend = T, aes(linetype = "NA values"))


# ------------------------------------------------------------------------- #
# save
# ------------------------------------------------------------------------- #
ggsave(plot = gg_all_half_lives,
       filename = paste0(p_plots, run_label, "/decay/", "half_lives_full_model", run_label, ".pdf"), 
       width = 8, height = 5, units = "in")

```

# Revision additions

## Common end points

### Grouping cohorts by number of observations

The first interpretation of this is to run the model for groups of cohorts with similar numbers of observations, making these cohorts more reasonable to compare.
This involves running linear models for groups of cohorts with similar numbers of observations (i.e., cohorts with 21-26, 16-20, 11-15, 6-10, and 1-5 observations).
These linear models take the same form as the previous models, except including a "common" grouping variable as a fixed effect in place of "cohort."

```{r common-groupings-by-obs}
persistence_dat %>%
  filter(year_abn < 2010) %>%
  group_by(site, cohort) %>%
  summarise(obs = n()) %>% 
  ungroup() %>%
  filter(site == "shaanxi") %>% tail

common_dat <- persistence_dat %>% 
  left_join(persistence_dat %>%
              group_by(site, year_abn) %>%
              summarise(obs = n()) %>% 
              ungroup()
            ) %>%
  mutate(common = cut(obs, breaks = c(1, 5, 10, 15, 20, 26), include.lowest = TRUE, right = TRUE))

ggplot(data = common_dat, 
       mapping = aes(x = age, y = proportion, 
                       group = site, color = site)) + 
    theme_classic() + 
    # scale_color_distiller(palette = "Greens") + scale_fill_distiller(palette = "Greens") +
    # scale_color_viridis() + scale_fill_viridis() +
    scale_color_discrete(labels = cap_update_labels) +
    geom_point(alpha = 0.7) +

    facet_wrap(.~common, scales = "free_x", #space = "free_x"
               )

# run a single lm, with only site fixed effects:
lm_l3_common <- lm(I(proportion - 1)  ~ 0 + log(time + 1):common:site + I(time):common:site,  
               data = common_dat)


coef_l3_common <- 
  tidy(lm_l3_common, conf.int = TRUE) %>%
  mutate(site = str_extract(term, "site[a-z,_]*") %>% gsub("site", "", .),
         common = str_extract(term, ".[0-9]+.[0-9]+."),
         coef_term = ifelse(grepl("log", term), "log", "lin"))

# ----------------------------------------------------------------------- #
# calculate mean coefficients and their confidence intervals

fitted_common <-
# mean_coef_l3_mega <- 
coef_l3_common %>%
  group_by(site, coef_term) %>% # group by site and coef_term
  # use a linear regression to calculate mean and confidence intervals
  summarise(tidy(lm(estimate ~ 1), conf.int = TRUE, conf.level = 0.95)) %>% 
  ungroup() %>%
  pivot_wider(id_cols = c(site, coef_term), names_from = coef_term, values_from = estimate) %>% 
  mutate(common = "mean") %>%
  bind_rows(coef_l3_common %>%
              pivot_wider(id_cols = c(site, common, coef_term), 
                          names_from = coef_term, 
                          values_from = estimate)) %>%
  left_join(tibble(age = 5:150), by = character()) %>%
  mutate(proportion = log * log(age-4) + lin * ((age-4) - 1) + 1,
         proportion = ifelse(proportion >= 0, proportion, 0)) # fitted proportion can't be less than 0!

```


```{r plot-common-groups}
# Plot the trends for each grouping of similar numbers of observations:
gg_common_group_obs <- ggplot(data = common_dat, 
       mapping = aes(x = age, y = proportion, 
                       group = site, color = site)) + 
    theme_classic() + 
    # scale_color_viridis(discrete = TRUE) + 
    scale_color_discrete(labels = cap_update_labels) +
    geom_hline(yintercept = 0.5, linetype = "dashed") +

    # geom_point(alpha = 0.7) + 
  
  geom_line(
    data = augment(lm_l3_common, interval = "confidence") %>%
      mutate(time = round(exp(`log(time + 1)`), digits = 0) - 1,
             age = time + 5,
             proportion = .fitted + 1),
    size = 1.2) + 
  facet_grid(.~common, scales = "free_x", space = "free_x"
               ) + 
  scale_x_continuous(breaks = c(5, 10, 15, 20, 25, 30)) +
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site",
       linetype = "")

ggsave(gg_common_group_obs,
  filename = paste0(p_plots, run_label, "/decay/", "common_group_obs", run_label, ".pdf"), 
    width = 10, height = 4, units = "in"
  )

# with CIs
ggsave(gg_common_group_obs + 
         geom_ribbon(data = 
                augment(lm_l3_common, interval = "confidence") %>%
                mutate(time = round(exp(`log(time + 1)`), digits = 0) - 1,
                       age = time + 5,
                       proportion = .fitted + 1),
              mapping = aes(x = age, y = proportion, 
                            ymin = .lower + 1, ymax = .upper + 1,
                            group = site, color = site, fill = site),
              alpha = 0.3, show.legend = FALSE),
  filename = paste0(p_plots, run_label, "/decay/", "common_group_obs_CI", run_label, ".pdf"), 
    width = 10, height = 4, units = "in"
  )




# Showing each site alone:
gg_common_group_obs_by_site <-
  ggplot(data = common_dat, 
       mapping = aes(x = age, y = proportion, 
                     group = fct_relevel(common, rev), color = fct_relevel(common, rev))) + 
    theme_classic() + 
    scale_color_viridis(discrete = TRUE) +
    geom_hline(yintercept = 0.5, linetype = "dashed") +
    # geom_point(alpha = 0.7) + 
  geom_line(
    data = augment(lm_l3_common) %>%
      mutate(time = round(exp(`log(time + 1)`), digits = 0) - 1,
             age = time + 5,
             proportion = .fitted + 1),
    size = 1.2) +
  facet_wrap(vars(site), labeller = as_labeller(fancy_labels)) + 
  scale_x_continuous(breaks = c(5, 10, 15, 20, 25, 30)) +
  # scale_y_continuous(limits = c(0.3, 1)) +
    coord_cartesian(ylim = c(0.3, 1)) +

  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Cohorts grouped \nby # observations",
       linetype = "") + 
    theme(legend.position = c(0.9, 0.15),
          legend.spacing = unit(2, units = "mm"), 
          legend.background = element_blank(),
          legend.margin = margin(t = 0, r = 0, b = 0, l = 0))

ggsave(gg_common_group_obs_by_site,
  filename = paste0(p_plots, run_label, "/decay/", "common_group_obs_by_site", run_label, ".pdf"), 
    width = 7, height = 7, units = "in"
  )


# save with mean trajectory:
ggsave(
  gg_common_group_obs_by_site + 
  new_scale_color() +
  geom_line(data = fitted_common %>% filter(age < 30, common == "mean"), 
            aes(x = age, y = proportion, color = common),
            inherit.aes = FALSE) + 
  scale_color_discrete(labels = c("mean" = "Mean trajectory"),
                       name = NULL),
  filename = paste0(p_plots, run_label, "/decay/", "common_group_obs_by_site+", run_label, ".pdf"), 
    width = 7, height = 7, units = "in"
  )


# ------------------------------------------------------------------------- #
# extrapolating the mean trajectory to 150 years:
# ------------------------------------------------------------------------- #
gg_common_group_obs_150 <-
  ggplot(data = fitted_common, 
       mapping = aes(x = age, y = proportion, 
                     color = site)) + 
    theme_classic() + 
    scale_color_discrete(label = fancy_labels) +
  geom_line(size = 1.1) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  # scale_y_continuous(limits = c(0,1)) + 
    coord_cartesian(ylim = c(0, 1)) +

  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site") + 
  facet_wrap(vars(as_factor(common)))


ggsave(plot = gg_common_group_obs_150,
       filename = paste0(p_plots, run_label, "/decay/", 
                         "common_group_obs_150", run_label, ".pdf"), 
       width = 13, height = 7.5, units = "in")

```

### Averaging across cohorts within smaller groups, with similar numbers of observations

Similar in concept to the previous approach, but still calculating coefficients for each individual cohort.

```{r}

```

### Modeling through common end points

An alternative interpretation is to run individual models for different subsets of cohorts with

Or, this could mean running a model comparing cohorts for common end points (all 10 years post abandonment, all 15 years post abandonment, etc.).

```{r common-end-points}
persistence_dat$age %>% unique() %>% sort()

persistence_dat %>%
  filter(age == 10) %>%
  .$year_abn %>% unique()


# linear - log - linear
# lm_mega_lin_log_lin_l <- lm(I(proportion - 1) ~ 0 + log(time + 1):cohort:site + I(time):cohort:site,  
#                data = persistence_dat)


# ------------------------------------------------------------------------------------------ #
# produce a list of new, subset datasets with which to update the model predictions
persistence_dat %>%
  filter(age <= 20, 
         year_abn %in% unique(filter(persistence_dat, age == 20)$year_abn))

common_endpoint_dat_l <- lapply(7:29, function(i) {
  persistence_dat %>%
  filter(age <= i, 
         year_abn %in% unique(filter(persistence_dat, age == i)$year_abn))
})
names(common_endpoint_dat_l) <- paste0("age_", 7:29)


# bind tibbles in list together
common_endpoint_dat <- 
  common_endpoint_dat_l %>% 
  bind_rows(.id = "endpoint") %>% 
  mutate(endpoint = gsub("age_", "", endpoint) %>% as.numeric())


endpoint_n <- lapply(common_endpoint_dat_l, function(i) {
  tmp <- i %>%
  group_by(site, year_abn) %>%
  summarise(obs = n()) %>% 
  ungroup()
  
  tibble(n_obs = unique(tmp$obs),
         n_cohorts = length(unique(tmp$year_abn)),
         total_obs = n_obs * n_cohorts,
         cohorts = paste0(unique(tmp$year_abn), collapse = ", "))
  }) %>% 
  bind_rows(.id = "endpoint") %>%
  mutate(endpoint = gsub("age_", "", endpoint) %>% as.numeric())

endpoint_n %>%
  pivot_longer(cols = c(n_obs, n_cohorts, total_obs), values_to = "value", names_to = "type") %>%
  ggplot(mapping = aes(x = endpoint, y = value, color = type)) + 
  geom_point()
  

# ---------- #
# update the model predictions
# ---------- #
lm_l3_endpoint <- lapply(common_endpoint_dat_l, function(i) {update(lm_mega_lin_log_lin_l, data = i)})


# ---------- #
# extract coefs and fitted:
# ---------- #
coef_l3_endpoints <- lapply(lm_l3_endpoint, function(i) {
  tidy(i, conf.int = TRUE) %>%
  mutate(site = gsub("site", "", str_extract(term, "site[a-z,_]*")),
         year_abn = as.integer(str_extract(term, "[1-2][0-9][0-9][0-9]")),
         coef_term = ifelse(grepl("log", term), "log", "lin"),
         cohort = as.factor(year_abn),
         uncertainty_range = conf.high - conf.low,
         mod = "l3") %>%
  select(mod, site, year_abn, cohort, coef_term, estimate, conf.low, conf.high, uncertainty_range, everything())

}) %>% bind_rows(.id = "endpoint")


# augment:
augment_endpoints <- 
  lapply(lm_l3_endpoint, function(i) augment(i, se_fit = TRUE)) %>%
  bind_rows(.id = "endpoint") %>% 
  mutate(endpoint = gsub("age_", "", endpoint) %>% as.numeric(),
         time = round(exp(`log(time + 1)`), digits = 0) - 1,
         age = time + 5,
         proportion = .fitted + 1,
         year_abn = as.numeric(levels(cohort))[cohort])

# ----------------------------------------------------------------------- #
# calculate mean coefficients and their confidence intervals

fitted_endpoints <-
  coef_l3_endpoints %>%
  group_by(site, endpoint, coef_term) %>% # group by site and coef_term
  # use a linear regression to calculate mean and confidence intervals
  summarise(tidy(lm(estimate ~ 1), conf.int = TRUE, conf.level = 0.95)) %>% 
  ungroup() %>%
  pivot_wider(id_cols = c(site, endpoint, coef_term), names_from = coef_term, values_from = estimate) %>% 
  left_join(tibble(age = 5:150), by = character()) %>%
  mutate(proportion = log * log(age-4) + lin * ((age-4) - 1) + 1,
         proportion = ifelse(proportion >= 0, proportion, 0), # fitted proportion can't be less than 0!
         endpoint = gsub("age_", "", endpoint) %>% as.numeric())

# fitted_endpoints %>% select(endpoint) %>% unique() %>% print(n = 50)
```


```{r plot-by-site-common-end-points}
# ------------------------------------------------------------------------------------------ #
# explore plots
# ------------------------------------------------------------------------------------------ #
persistence_dat %>%
  filter(age <= 20, 
         year_abn %in% unique(filter(persistence_dat, age == 20)$year_abn)) %>%
ggplot(mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
  theme_classic() + 
  geom_point(size = 0.8) + 
  scale_color_viridis(discrete = FALSE, name = "Cohort (Year Abandoned)") +
  facet_wrap(vars(site), nrow = 3, scales = "free",
             labeller = as_labeller(cap_update_labels)) +
  scale_x_continuous(n.breaks = 6) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining") + 
  theme(
    # legend.position = c(0.87, 0.14),
    # legend.spacing = unit(2, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1))


# ---------------------------------------------------------------------------- #
# decay_mod_grid
# ---------------------------------------------------------------------------- #
common_endpoint_dat_l[["age_25"]]
lm_l3_endpoint %>% names()
coef_l3_endpoints %>% select(endpoint) %>% unique()
fitted_endpoints %>% select(endpoint) %>% unique()


for(i in 7:29) {

endpoint_tmp <- i
# endpoint_tmp <- 7

mean_traj_labels <- c(paste0("Endpoint: ", endpoint_tmp, " years"))
names(mean_traj_labels) <- paste0("age_", endpoint_tmp)

gg_endpoints_by_site_tmp <- ggplot(data = common_endpoint_dat_l[[paste0("age_", endpoint_tmp)]],
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
  theme_classic() + 
  geom_point(size = 0.8) + 
  scale_color_viridis(discrete = FALSE, name = "Cohort (Year Abandoned)") +
  facet_wrap(vars(site), nrow = 3, scales = "free",
             labeller = as_labeller(cap_update_labels)) +
  # scale_x_continuous(n.breaks = 6) +
  scale_x_continuous(breaks = c(5, 10, 15, 20, 25, 30),
                     limits = c(5, 30)) +

  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining") + 
  theme(
    legend.position = c(0.9, 0.15),
    # legend.spacing = unit(2, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +

# fitted lines
    geom_line(data = 
                lm_l3_endpoint[[paste0("age_", endpoint_tmp)]] %>% 
                augment(se_fit = TRUE) %>%
                mutate(time = round(exp(`log(time + 1)`), digits = 0) - 1,
                       age = time + 5,
                       proportion = .fitted + 1,
                       year_abn = as.numeric(levels(cohort))[cohort]),
              linetype = 5, #5, #"longdash"
              aes(alpha = "Fitted")) +
      scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2,
                       override.aes = list(
                         # size = 0.5,
                         # linetype = 6, size = 1.15 #
                         # color = brewer_pal(palette = "Greens")(6)[6]
                       ))) +

# add mean trajectories
  new_scale_color() +
  geom_line(data = fitted_endpoints %>% filter(endpoint == paste0("age_", endpoint_tmp),
                                               age <= endpoint_tmp
                                               ), 
            mapping = aes(x = age, y = proportion, 
                          color = endpoint),
              size = 1, inherit.aes = FALSE) +
  scale_color_discrete(labels = mean_traj_labels,
                       name = "Site mean decay rates"
                       # value = "red"
                     )
# gg_endpoints_by_site_tmp
ggsave(gg_endpoints_by_site_tmp,
  filename = paste0(p_plots, run_label, "/decay/common_endpoints/", "common_endpoints_by_site_fixed", run_label, "_age_", endpoint_tmp, ".pdf"), 
    width = 10, height = 8.5, units = "in"
  )

}
```

```{r endpoint-by-site}
endpoint_tmp <- i
# endpoint_tmp <- 7

mean_traj_labels <- c(paste0("Endpoint: ", endpoint_tmp, " years"))
names(mean_traj_labels) <- paste0("age_", endpoint_tmp)

sites_tmp_switch <- "b"

for(i in c("a", "b"#, "all"
           )
    # c("b")
    ){
  sites_tmp_switch <- i
  sites_tmp <- if(sites_tmp_switch == "a") {site_df$site[1:6]
    } else {if(sites_tmp_switch == "b") {site_df$site[c(7:11)]} else {site_df$site}}


gg_endpoints_by_site_5_25 <-
  ggplot(data = common_endpoint_dat %>% 
           filter(endpoint %in% c(10, 15, 20, 25), 
                  # site == "shaanxi",
                  site %in% sites_tmp
                  ),
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
  theme_classic() + 
  geom_point(size = 0.8) +
  scale_color_viridis(discrete = FALSE, name = "Cohort\n(Year\nAbandoned)") +
  facet_grid(site~endpoint,# nrow = 3,
             labeller = as_labeller(cap_update_labels),
             scales = "free_x", space = "free") +
  # scale_x_continuous(n.breaks = 6) +
  scale_x_continuous(breaks = c(5, 10, 15, 20, 25, 30)#,
                     # limits = c(5, 30)
                     ) +

  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining") + 
  theme(
    # legend.position = c(0.9, 0.15),
    # legend.spacing = unit(2, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  # coord_cartesian(ylim = c(0.3, 1)) +

# fitted lines
    geom_line(data = augment_endpoints %>% 
                filter(endpoint %in% c(10, 15, 20, 25), 
                       # site == "shaanxi",
                       site %in% sites_tmp
                       ),
              linetype = 5,
              aes(alpha = "Fitted"), show.legend = TRUE) +
      scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2)) +

# add mean trajectories
  new_scale_color() +
  geom_line(data = lapply(10:29, function(i) {filter(fitted_endpoints, endpoint == i, age <= i)}) %>%
              bind_rows() %>% 
              filter(endpoint %in% c(10, 15, 20, 25), 
                     # site == "shaanxi",
                     site %in% sites_tmp
                     ), 
            mapping = aes(x = age, y = proportion, 
                          color = site
                          ),
                          color = "red",
              size = 1, inherit.aes = FALSE) + 
  scale_color_discrete(name = "Mean trajectory", labels = fancy_labels)
  

ggsave(gg_endpoints_by_site_5_25,
  filename = paste0(p_plots, run_label, "/decay/common_endpoints/",
                    "endpoints_by_site_5_25",
                    sites_tmp_switch, run_label, ".pdf"), 
  width = ifelse(sites_tmp_switch == "a|b", 7, 7),
  height = ifelse(sites_tmp_switch %in% c("a", "b"), 
                  ifelse(sites_tmp_switch == "a", 9.5, 8), 
                  10), 
  units = "in"
  )
}


```


```{r make-gif}
library(magick)
paste0(p_plots, run_label, "/decay/common_endpoints/", "common_endpoints_by_site_fixed", run_label, "_age_", endpoint_tmp, ".pdf")
endpoint_pdfs <-
  list.files(paste0(p_plots, run_label, "/decay/common_endpoints"), full.names = TRUE) %>%
    grep("fixed",., value = T) %>%
    grep("combo",., value = T, invert = T)

library(pdftools)
# install.packages("pdftools")

endpoint_pdfs_animated <- lapply(endpoint_pdfs, function(i) {
  magick::image_read_pdf(i)
  }) %>%
  image_join() %>%
  image_animate(fps = 2)

endpoint_pdfs_animated

## save to disk
image_write(image = endpoint_pdfs_animated,
            path = paste0(p_plots, run_label, "/decay/common_endpoints/", "common_endpoints_by_site_fixed", run_label, "_age_combo.gif"))
```


```{r plot-mean-traj-common-end-points}
# ---------------------------------------------------------------------------- #
# mean trajectory only, by site
# ---------------------------------------------------------------------------- #
common_endpoint_dat_l[["age_25"]]
lm_l3_endpoint %>% names()
coef_l3_endpoints %>% select(endpoint) %>% unique()
fitted_endpoints %>% select(endpoint) %>% unique()


mean_traj_labels_all <- c(paste0("Endpoint: ", 10:29, " years"))
names(mean_traj_labels_all) <- paste0("age_", 10:29)

gg_endpoints_mean_traj_all <-
  ggplot(data = fitted_endpoints %>% 
           mutate(endpoint = gsub("age_", "", endpoint) %>% as.numeric()) %>%
           filter(
             # endpoint == paste0("age_", endpoint_tmp), 
             # age <= endpoint_tmp
             # age < 30
             ), 
         mapping = aes(x = age, y = proportion, 
                       color = endpoint, group = endpoint)) + 
  theme_classic() + 
  geom_line() + 
  scale_color_viridis(discrete = FALSE, name = "Mean Trajectory Derived\nFrom Common Endpoint (Years)", direction = -1) +
  facet_wrap(vars(site), nrow = 3, scales = "free",
             labeller = as_labeller(cap_update_labels)) +
  scale_x_continuous(n.breaks = 6) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining") + 
  theme(
    legend.position = c(0.87, 0.18),
    # legend.spacing = unit(2, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(#ylim = c(0.3, 1)
    )

ggsave(gg_endpoints_mean_traj_all,
  filename = paste0(p_plots, run_label, "/decay/common_endpoints/", "common_endpoints_mean_traj_all", run_label, ".pdf"), 
    width = 10, height = 8.5, units = "in"
  )


# add the mean trajectory from l3, straight mean, with high and low (has option to add in weighted means)
ggsave(plot = 
         gg_endpoints_mean_traj_all + 
         new_scale_color() +
         geom_line(data = fitted_combo %>% filter(mod == "l3", !grepl("w_", type)), 
                   mapping = aes(x = age, y = proportion, color = type),
                   size = 1, inherit.aes = FALSE) +
         scale_color_discrete(labels = c("mean" = "Mean coef.",
                                         "w_obs"= "Mean weighted \nby # obs.",
                                         "w_uncertainty"= "Mean weighted\nby inverse uncertainty"),
                              name = "Site mean decay rates") + 
         theme(legend.position = c(0.885, 0.14),
               legend.spacing = unit(2, units = "mm")),
       filename = paste0(p_plots, run_label, "/decay/common_endpoints/", 
                         "common_endpoints_mean_traj_all+", run_label, ".pdf"), 
       width = 10, height = 8.5, units = "in"
       )

# ---------------------
# add Confidence Intervals:
ggsave(plot = 
         gg_endpoints_mean_traj_all + 
         new_scale_color() +
         geom_ribbon(data = 
                       fitted_combo %>% 
                       filter(mod == "l3", !grepl("w_", type)) %>%
                       pivot_wider(id_cols = c(mod, site, age), 
                                   names_from = type, 
                                   values_from = "proportion"),
                     mapping = aes(x = age, y = mean, 
                                   ymin = conf.low, ymax = conf.high),
                   alpha = 0.15, #size = 1,
                   color = "red", fill = "red", inherit.aes = FALSE) +
         geom_line(data = 
                       fitted_combo %>% 
                       filter(mod == "l3", !grepl("w_", type)) %>%
                       pivot_wider(id_cols = c(mod, site, age), 
                                   names_from = type, 
                                   values_from = "proportion"),
                     mapping = aes(x = age, y = mean),
              color = "red", size = 1,
              inherit.aes = FALSE) +
         
         scale_color_discrete(labels = c("mean" = "Mean coef."),
                              name = "Site mean decay rates") + 
         theme(legend.position = c(0.885, 0.14),
               legend.spacing = unit(2, units = "mm")) + 
         coord_cartesian(ylim = c(0, 1)),
       filename = paste0(p_plots, run_label, "/decay/common_endpoints/", 
                         "common_endpoints_mean_traj_all_CI", run_label, ".pdf"), 
       width = 10, height = 8.5, units = "in"
       )


# crop to just first 30 years

ggsave(gg_endpoints_mean_traj_all %+% 
         mutate(filter(fitted_endpoints, age < 30), endpoint = gsub("age_", "", endpoint) %>% as.numeric()) +
         coord_cartesian(ylim = c(0.3, 1)),
  filename = paste0(p_plots, run_label, "/decay/common_endpoints/", "common_endpoints_mean_traj_all_30", run_label, ".pdf"), 
    width = 10, height = 8.5, units = "in"
  )



# ---------------------------------------------------------------------------- #
# mean trajectory only, by common endpoint
# ---------------------------------------------------------------------------- #
gg_endpoints_mean_traj_by_endpoint <-
  ggplot(data = fitted_endpoints %>%
           mutate(endpoint_cont = gsub("age_", "", endpoint) %>% as.numeric(),
                  ) %>%
           filter(endpoint_cont %in% c(10, 15, 20, 25)), 
       mapping = aes(x = age, y = proportion, 
                     group = site, color = site)) + 
    theme_classic() + 
    scale_color_viridis(discrete = TRUE, labels = cap_update_labels) +
    geom_hline(yintercept = 0.5, linetype = "dashed") +
    geom_line(size = 1.2) + 
  facet_grid(vars(endpoint), scales = "free_x", 
             # space = "free_x",
             labeller = as_labeller(mean_traj_labels_all)
               ) + 
  # scale_x_continuous(breaks = c(5, 10, 15, 20, 25, 30)) +
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site",
       linetype = "")

ggsave(gg_endpoints_mean_traj_by_endpoint + 
         facet_grid(vars(endpoint), scales = "free_x", 
             # space = "free_x",
             labeller = as_labeller(mean_traj_labels_all)
               ),
  filename = paste0(p_plots, run_label, "/decay/common_endpoints/", "common_endpoints_mean_traj_by_endpoint_tall", run_label, ".pdf"), 
    width = 8, height = 10, units = "in"
  )

ggsave(plot = gg_endpoints_mean_traj_by_endpoint + 
  facet_wrap(vars(endpoint), scales = "free_x", 
             # space = "free_x",
             labeller = as_labeller(mean_traj_labels_all)
               ),
  filename = paste0(p_plots, run_label, "/decay/common_endpoints/", "common_endpoints_mean_traj_by_endpoint_wide", run_label, ".pdf"), 
    width = 10, height = 6, units = "in"
  )

```

```{r *half-lives-by-endpoint}
time_to_endpoints <-
  coef_l3_endpoints %>%
  group_by(site, endpoint, coef_term) %>% # group by site and coef_term
  # use a linear regression to calculate mean and confidence intervals
  summarise(tidy(lm(estimate ~ 1), conf.int = TRUE, conf.level = 0.95)) %>% 
  ungroup() %>%
  select(site, endpoint, coef_term, mean = estimate, conf.low, conf.high) %>%
  pivot_longer(cols = c(mean, conf.low, conf.high), values_to = "value", names_to = "type") %>%
  pivot_wider(id_cols = c(site, endpoint, type, coef_term), names_from = coef_term, values_from = value) %>%

  left_join(tibble(proportion = seq(from = 0, to = 1, by = 0.1)), by = character()) %>%
  
  mutate(time_to = ((log * lambertW0((lin * exp((lin + proportion - 1) / log)) / 
                                              log)) / lin) + 4
         )


# mutate to a format easier to plot:
endpoint_half_lives <- time_to_endpoints %>% 
  filter(proportion == 0.5) %>%
  pivot_wider(id_cols = c(site, endpoint), names_from = type, values_from = "time_to") %>%
  mutate(endpoint = gsub("age_", "", endpoint) %>% as.numeric()) %>%
  left_join(endpoint_n, by = "endpoint")


# exploratory plot
endpoint_n %>%
  filter(endpoint %in% c(10:25)) %>%
  pivot_longer(cols = c(n_obs, n_cohorts, total_obs), values_to = "value", names_to = "type") %>%
  ggplot(mapping = aes(x = endpoint, y = value, color = type)) + 
  geom_point()

endpoint_half_lives

# ------------------------------------------------------------------------- #
# plot 
# ------------------------------------------------------------------------- #
gg_half_life_endpoints <-
  ggplot(data = endpoint_half_lives,
         mapping = aes(x = mean,
                       y = fct_reorder(site, mean),
                       color = endpoint, group = endpoint)
         ) +
  geom_point(position = position_dodge(0.7), size = 1.7) + 
  scale_x_continuous(breaks = seq(from = 10, to = 210, by = 10)) +
  scale_y_discrete(labels = fancy_labels) + 
  scale_color_viridis(direction = -1) +
  theme_classic() +
  labs(x = "Half-life (Years)", y = "Site", color = "Endpoint (years)") +
  theme(legend.position = c(0.75, 0.4),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))


# ------------------------------------------------------------------------- #
# save
# ------------------------------------------------------------------------- #
ggsave(plot = gg_half_life_endpoints,
       filename = paste0(p_plots, run_label, "/decay/", "half_lives_endpoints", run_label, ".pdf"), 
       width = 8, height = 5, units = "in")



# ------------------------------------------------------------------------- #
# display the half-lives with size as a function of number of observations:
# ------------------------------------------------------------------------- #
endpoint_half_lives$total_obs %>% unique() %>% sort()


gg_half_life_endpoints_by_obs <-
  ggplot(data = endpoint_half_lives %>% 
           filter(
             # endpoint %in% c(10:25)
             ), 
       mapping = aes(x = mean, y = fct_reorder(site, mean), 
                     color = endpoint, group = endpoint, 
                     fill = n_cohorts, size = total_obs)) +
  geom_point(position = position_dodge(0.7), alpha = 0.7) + 
  scale_color_viridis(direction = -1) +
  
  # add another fill scale geom with number of cohorts, to get a corresponding color bar into the legend
  scale_fill_viridis(breaks = c(6, 11, 16, 21)) +
  scale_size_continuous(range = c(2, 6)#, breaks = seq(from = 50, to = 200, by = 50)
                        ) + 
  scale_x_continuous(breaks = seq(from = 10, to = 240, by = 20)) +
  scale_y_discrete(labels = fancy_labels) + 
  labs(x = "Half-life (Years)", y = "Site", 
       color = "Endpoint\n(Years)", size = "Observations\n(n)",
       fill = "Cohorts\n(n)",) +
  
  theme_classic() +
  theme(legend.position = c(0.725, 0.2),
        legend.spacing = unit(1, units = "mm"),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"),
        legend.box = "horizontal"
        ) + 
  guides(color = guide_colorbar(order = 1), 
         size = guide_legend(order = 3#, override.aes = list(alpha = 1)
                             ),
         fill = guide_colorbar(order = 2, reverse = TRUE)) #+ 
  # annotate("text", x = 81.5, y = 5, label = "Model specifications")
  
  
ggsave(plot = gg_half_life_endpoints_by_obs,
       filename = paste0(p_plots, run_label, "/decay/", "half_lives_endpoints_by_obs", run_label, ".pdf"), 
       width = 7, height = 6, units = "in")


ggsave(plot = gg_half_life_endpoints_by_obs %+% 
         filter(endpoint_half_lives, endpoint %in% c(10:25)),
       filename = paste0(p_plots, run_label, "/decay/", "half_lives_endpoints_by_obs_trim", run_label, ".pdf"), 
       width = 7, height = 6, units = "in")


ggsave(plot = gg_half_life_endpoints_by_obs %+% 
         filter(endpoint_half_lives, endpoint %in% c(10, 15, 20, 25)),
       filename = paste0(p_plots, run_label, "/decay/", "half_lives_endpoints_by_obs_10_25", run_label, ".pdf"), 
       width = 7, height = 6, units = "in")




# ------------------------------------------------------------------------- #
# add the straight means from l3 model
# ------------------------------------------------------------------------- #
ggsave(plot = 
         gg_half_life_endpoints_by_obs + 
         new_scale_color() +
         geom_errorbar(
           data = time_to_combo %>% 
             filter(proportion == 0.5, !is.na(time_to), type == "mean",
                 !grepl("conf", type), mod %in% c("l3", "l3_trim")) %>%
           left_join(time_to_combo %>%
                       filter(grepl("conf", type), proportion == 0.5, 
                              !is.na(time_to), mod %in% c("l3", "l3_trim")) %>%
                       pivot_wider(id_cols = c(mod, site), names_from = type, values_from = "time_to") %>%
                       mutate(type = "mean")),
           mapping = aes(x = time_to, xmin = conf.low, xmax = conf.high,
                         y = fct_reorder(site, time_to),
                         color = as_factor(mod)),
           width = 0.5, position = position_dodge(0.7), alpha = 0.7, inherit.aes = FALSE) + 
         geom_point(data = time_to_combo %>%        
                      filter(proportion == 0.5, !is.na(time_to), type == "mean", 
                             !grepl("conf", type), mod %in% c("l3", "l3_trim")) %>%
                      left_join(time_to_combo %>%
                                  filter(grepl("conf", type), proportion == 0.5, 
                                         !is.na(time_to), mod %in% c("l3", "l3_trim")) %>%
                                  pivot_wider(id_cols = c(mod, site), names_from = type, 
                                              values_from = "time_to") %>%
                                  mutate(type = "mean")),
                    mapping = aes(x = time_to, y = fct_reorder(site, time_to),
                                  color = as_factor(mod)),
                    position = position_dodge(0.7), size = 1.7, alpha = 0.7, inherit.aes = FALSE,
                    show.legend = T) + 
  
    scale_color_discrete(labels = c("l3" = "Including all cohorts",
                             "l3_trim"= "Excluding cohorts\nwith < 5 obs.\n(2010, '11, '12, '13)"),
                         name = "Full Model Mean") + 
      theme(legend.position = c(0.78, 0.55)) #+ coord_cartesian(xlim = c(10, 60))
    ,
    filename = paste0(p_plots, run_label, "/decay/", "half_lives_endpoints+_crop", run_label, ".pdf"), 
       width = 8, height = 5, units = "in")


# ------------------------------------------------------------------- #
# exclude very short and very long endpoints:
gg_half_life_endpoints_trim <-
  ggplot(data = endpoint_half_lives %>% filter(endpoint >= 10, endpoint <= 25),
         mapping = aes(x = mean,
                       y = fct_reorder(site, mean),
                       color = endpoint, group = endpoint)
         ) +
  geom_point(position = position_dodge(0.7), size = 1.7) + 
  scale_x_continuous(breaks = seq(from = 10, to = 170, by = 10)) +
  scale_y_discrete(labels = fancy_labels) + 
  scale_color_viridis(direction = -1) +
  theme_minimal() +
  labs(x = "Half-life (Years)", y = "Site", color = "Endpoint (years)") +
  
# add the straight means from l3 model
  new_scale_color() +
         geom_errorbar(
           data = time_to_combo %>% 
             filter(proportion == 0.5, !is.na(time_to), type == "mean",
                 !grepl("conf", type), mod %in% c("l3", "l3_trim")) %>%
           left_join(time_to_combo %>%
                       filter(grepl("conf", type), proportion == 0.5, 
                              !is.na(time_to), mod %in% c("l3", "l3_trim")) %>%
                       pivot_wider(id_cols = c(mod, site), names_from = type, values_from = "time_to") %>%
                       mutate(type = "mean")),
           mapping = aes(x = time_to, xmin = conf.low, xmax = conf.high,
                         y = fct_reorder(site, time_to),
                         color = as_factor(mod)),
           width = 0.5, position = position_dodge(0.7), alpha = 0.7, inherit.aes = FALSE) + 
         geom_point(data = time_to_combo %>%        
                      filter(proportion == 0.5, !is.na(time_to), type == "mean", 
                             !grepl("conf", type), mod %in% c("l3", "l3_trim")) %>%
                      left_join(time_to_combo %>%
                                  filter(grepl("conf", type), proportion == 0.5, 
                                         !is.na(time_to), mod %in% c("l3", "l3_trim")) %>%
                                  pivot_wider(id_cols = c(mod, site), names_from = type, 
                                              values_from = "time_to") %>%
                                  mutate(type = "mean")),
                    mapping = aes(x = time_to, y = fct_reorder(site, time_to),
                                  color = as_factor(mod)),
                    position = position_dodge(0.7), size = 1.7, alpha = 0.7, inherit.aes = FALSE) + 
  
    scale_color_discrete(labels = c("l3" = "Including all cohorts",
                             "l3_trim"= "Excluding cohorts\nwith < 5 obs.\n(2010, '11, '12, '13)"),
                         name = "Full Model Mean") + 
  theme(legend.position = c(0.8, 0.35),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black")) #+ 
  # coord_cartesian(xlim = c(10, 120))


ggsave(plot = gg_half_life_endpoints_trim,
    filename = paste0(p_plots, run_label, "/decay/", "half_lives_endpoints+_trim", run_label, ".pdf"), 
       width = 8, height = 5, units = "in")

# ------------------------------------------------------------------------- #
# with confidence intervals:
# ------------------------------------------------------------------------- #
gg_half_life_endpoints_ci <-
  ggplot(data = endpoint_half_lives,
         mapping = aes(x = mean, xmin = conf.low, xmax = conf.high,
                       y = fct_reorder(site, mean),
                       color = endpoint, group = endpoint)
         ) +
  geom_errorbar(width = 0.5, position = position_dodge(0.7), alpha = 0.8) + 
  geom_point(position = position_dodge(0.7), size = 1.7) + 

  scale_x_continuous(breaks = seq(from = 10, to = 210, by = 10)) +
  scale_y_discrete(labels = fancy_labels) + 
    scale_color_viridis(direction = -1) +
    
  # facet_wrap(vars(mod)) + 
  theme_classic() +
  labs(x = "Half-life", y = "Site", color = "Endpoint (Years)",
       caption = "Error bars represent 95% Confidence Intervals (where possible)") + 
  theme(legend.position = c(0.75, 0.4),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black")) + 
    
    coord_cartesian(xlim = c(10, 130))


ggsave(plot = gg_half_life_endpoints_ci,
       filename = paste0(p_plots, run_label, "/decay/", "half_lives_endpoints_ci", run_label, ".pdf"), 
       width = 8, height = 5, units = "in")




endpoint_half_lives %>% 
  filter(endpoint %in% c(10:25)) %>%
  select(endpoint, n_cohorts) %>% unique() %>%
  arrange(endpoint)



```

```{r example-panel}
gg_endpoints_example_panel_s <-
  ggplot(data = common_endpoint_dat %>% 
           filter(endpoint %in% c(10, 15, 20, 25), 
                  site == "shaanxi",
                  site %in% sites_tmp
                  ) %>%
           mutate(endpoint = as_factor(endpoint)) %>%
           bind_rows(persistence_dat %>% 
                       filter(site == "shaanxi") %>% 
                       mutate(endpoint = "full model", endpoint = as_factor(endpoint))),
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
  theme_classic() + 
  geom_point(size = 0.8) +
  scale_color_viridis(discrete = FALSE, name = "Cohort\n(Year\nAbandoned)") +
  facet_grid(site~endpoint,# nrow = 3,
             labeller = as_labeller(cap_update_labels),
             scales = "free_x", space = "free") +
  # scale_x_continuous(n.breaks = 6) +
  scale_x_continuous(breaks = c(5, 10, 15, 20, 25, 30)#,
                     # limits = c(5, 30)
                     ) +

  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining") + 
  theme(legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +

# fitted lines
    geom_line(data = augment_endpoints %>% 
                filter(endpoint %in% c(10, 15, 20, 25), 
                       site == "shaanxi",
                       site %in% sites_tmp
                       ) %>% 
                mutate(endpoint = as_factor(endpoint)) %>%
                bind_rows(
                  augment(lm_mega_lin_log_lin_l, se_fit = TRUE) %>%
                    mutate(time = round(exp(`log(time + 1)`), digits = 0) - 1,
                           age = time + 5,
                           proportion = .fitted + 1,
                           year_abn = as.numeric(levels(cohort))[cohort]) %>%
                    filter(site == "shaanxi") %>% 
                    mutate(endpoint = "full model", endpoint = as_factor(endpoint))),
              linetype = 5,
              aes(alpha = "Fitted"), show.legend = TRUE) +
      scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2)) +

# add mean trajectories
  new_scale_color() +
  geom_line(data = lapply(10:29, function(i) {filter(fitted_endpoints, endpoint == i, age <= i)}) %>%
              bind_rows() %>% 
              filter(endpoint %in% c(10, 15, 20, 25), 
                     site == "shaanxi",
                     site %in% sites_tmp
                     ), 
            mapping = aes(x = age, y = proportion, 
                          color = site
                          ),
                          color = "red",
              size = 1, inherit.aes = FALSE) + 
  scale_color_discrete(name = "Mean trajectory", labels = fancy_labels)



# save the figure:
ggsave(gg_endpoints_example_panel_s,
  filename = paste0(p_plots, run_label, "/decay/", "endpoints_example_panel_s", run_label, ".pdf"), 
    width = 11, height = 4, units = "in"
  )

```



## Comparing pooled vs. single site models
```{r compare-pooled}
# pooled model
lm_mega_lin_log_lin_l

tidy(lm_mega_lin_log_lin_l) %>% tail() 
coef_l3_mega

pooled_coef <- tidy(lm_mega_lin_log_lin_l) %>%
  mutate(site = gsub("site", "", str_extract(term, "site[a-z,_]*")),
         year_abn = as.integer(str_extract(term, "[1-2][0-9][0-9][0-9]")),
         coef_term = ifelse(grepl("log", term), "log", "lin"))

pooled_coef %>% filter(is.na(estimate)) %>% 
  arrange(site, year_abn) %>% 
  print(n = 100)

pooled_coef %>% filter(year_abn == 2012, !is.na(estimate)) %>% 
  arrange(site, year_abn) %>% 
  print(n = 100)

pooled_coef %>% 
  select(site, year_abn, coef_term, pooled_est = estimate) %>% 
  # filter(site == site_df$site[9]) %>%
  left_join(coef_df_l3 %>% 
              select(site, year_abn, coef_term = term, single_est = estimate) #%>% 
              # filter(site == site_df$site[9])
            ) %>%
  mutate(equal = !all.equal(pooled_est, single_est)) %>% .$equal %>% sum()



coef_df_l3 %>% 
  select(site, year_abn, coef_term = term, single_est = estimate) %>% 
  filter(site == site_df$site[9])


# single site models:
lm_lin_log_lin_l

coef_df_l3
mean_coef_df_l3


single_site_mean_coef_s <- 
  tidy(lm_lin_log_lin_l[[9]]) %>% 
  mutate(site = site_df$site[9],
         coef_term = sub(":*cohort....:*", "", term),
         year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term),
                           parse_number(term)),
         cohort = as.factor(year_abn)) %>% 
  group_by(coef_term) %>%
  summarise(mean_est = mean(estimate, na.rm = TRUE)) %>% 
  arrange(coef_term)


# plot

ggplot(data = filter(persistence_dat, 
                     site == site_df$site[9],
                     year_abn > 2009
                     ),
         mapping = aes(x = age, y = proportion, 
                       color = cohort
                       )) + 
  theme_classic() + 
  
  # observed points
  geom_point() + 
  geom_line(data = mutate(augment(lm_lin_log_lin_l[[9]]),
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          age = time + 5,
                          proportion = .fitted + 1,
                          year_abn = as.numeric(levels(cohort))[cohort]) %>%
              filter(year_abn > 2009),
            linetype = 5) 



ggplot(data = filter(persistence_dat, site == site_df$site[9]),
         mapping = aes(x = age, y = proportion, 
                       group = year_abn, 
                       color = cut(year_abn, 
                                   breaks = c(1988, 1990, 1995, 2000, 2005, 2010, 2013),
                                   labels = c("1988-1990", "1991-1995", "1996-2000",
                                              "2001-2005", "2006-2010", "2011-2013"),
                                   include.lowest = TRUE)
                       )) + 
  theme_classic() + 
  
    # mean decay trend
  geom_function(fun = function(x) {
    mean_coef_tmp_l3_s$mean_est[2]*log(x-4) + mean_coef_tmp_l3_s$mean_est[1]*((x-4) - 1) + 1},
    mapping = aes(linetype = "Mean Decay\nRate"),
    color = "black", size = 1.25, inherit.aes = FALSE) + 
  
  # observed points
  geom_point() + 
  
# fitted points
  geom_line(data = mutate(augment(lm_lin_log_lin_l[[9]]),
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          age = time + 5,
                          proportion = .fitted + 1,
                          year_abn = as.numeric(levels(cohort))[cohort]),
            linetype = 5, #"longdash",# size = 2
            aes(alpha = "Fitted"),
            ) + 
  scale_color_brewer(palette = "Greens", direction = -1) +
  scale_x_continuous(n.breaks = 6) +
  # geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Cohort (Year\nFirst Abandoned)\n",
       linetype = NULL) + 
  
  guides(color = guide_legend(order = 1,
                              override.aes = list(size = 4, linetype = NULL))) +
  scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2,
                       override.aes = list(
                         # size = 0.5, 
                         # linetype = 6, size = 1.15, #
                         color = brewer_pal(palette = "Greens")(6)[6]
                       ))) 
```








```{r add-intercept}

# linear - log - linear
lm_pools <- lm(I(proportion - 1) ~ 0 + log(time + 1):cohort:site + I(time):cohort:site,  
               data = filter(persistence_dat, site == "shaanxi"))

lm_pool <- lm(I(proportion - 1) ~ 0 + log(time + 1):cohort:site + I(time):cohort:site,  
               data = persistence_dat)

tidy(lm_lin_log_lin_l[[9]])



# coef_df_l3 <- 
  lapply(lm_lin_log_lin_l, FUN = function(x) {
  tidy(x, conf.int = TRUE) %>% 
    mutate(coef_term = sub(":*cohort....:*", "", term),
         year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
         year_abn = as.numeric(year_abn),
         cohort = as.factor(year_abn))
}) %>% bind_rows(.id = "site") %>%
    mutate(term_long = term,
           term = as_factor(ifelse(coef_term == "I(time)", "lin", "log"))) %>%
  select(site, cohort, term, estimate, coef_term, everything())

coef_df_l3 %>% filter(site == "shaanxi")

# calculate mean coefficients per site, for both lin and log terms
# mean_coef_df_l3 <- 
  coef_df_l3 %>% #filter(site == "shaanxi") %>% 
  group_by(site, coef_term, term) %>% # group by site, term and coef_term (though you only need one of these)
  summarise(mean = mean(estimate, na.rm = TRUE),
            mean_low = mean(conf.low, na.rm = TRUE),
            mean_high = mean(conf.high, na.rm = TRUE)) %>% ungroup()


augment()
 




# simple plots
ggplot(data = filter(persistence_dat, 
                     site == site_df$site[9],
                     # year_abn > 2009
                     ),
         mapping = aes(x = age, y = proportion, 
                       color = cohort
                       )) + 
  theme_classic() + 
  
  # observed points
  geom_point() + 
  geom_line(data = mutate(augment(lm_lin_log_lin_l[[9]]),
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          age = time + 5,
                          proportion = .fitted + 1,
                          year_abn = as.numeric(levels(cohort))[cohort]) #%>%
              # filter(year_abn > 2009)
              ,
            linetype = 5)
```



## Uncertainty

There are a few different aspects of uncertainty
- plot uncertainty around the individual coefficient estimates (2 model coefficients)
- attempt to develop an estimate of the uncertainty estimate around the "half-life" estimation. One method would be to calculate a range of half-lives based on the range of coefficient values.
- plot the trajectories with the 95% confidence intervals as a polygon around them.
- 

```{r plot-coef-uncertainty}
# library(dotwhisker)
# dotwhisker::dwplot(lm_lin_log_lin_l$shaanxi, effects="fixed") + 
#   geom_vline(xintercept = 0, lty = 2) + 
#   theme_classic()
# for future reference...
  
# ------------------------------------------------------------------ #
# uncertainty with pooled, mega model
dodge_width <- 0.5

gg_coef_uncertainty_mega <-
  ggplot(data = coef_l3_mega %>% filter(year_abn < 2013),
       mapping = aes(x = year_abn, y = estimate, color = coef_term)) + 
  geom_point(position = position_dodge(dodge_width), alpha = 0.8#, size = 1
             ) + 
  geom_errorbar(mapping = aes(ymin = conf.low, ymax = conf.high),
                width = 0.5, position = position_dodge(dodge_width),
                alpha = 0.8) +
  facet_wrap(vars(site), scales = "free", nrow = 4,
             labeller = as_labeller(cap_update_labels)) + 
  geom_hline(yintercept = 0) + # horizontal orientation
  theme_classic() +
  # theme_linedraw() +
  # theme_minimal_vgrid() +
  labs(x = "Cohort (Year Abandoned)", y = "Model Coefficient Estimate", 
       # title = "Coefficient estimates and uncertainty: pooled model",
       # caption = "Error bars represent 95% Confidence Intervals around coefficient estimate",
       color = "Coefficient term") + 
  theme(legend.position = c(0.8, 0.15)) + 
    # scale_color_manual(values = brewer.pal(9, "PiYG")[c(1,9)],
                       # labels = c("log" = "Log", "lin" = "Linear"))
  scale_color_manual(values = met.brewer(name="Hokusai3", n=2, type="discrete"),
                     labels = c("log" = "Log", "lin" = "Linear")) 

gg_coef_uncertainty_mega

ggsave(#data = coef_l3_mega, 
       plot = gg_coef_uncertainty_mega, 
       filename = paste0(p_plots, run_label, "/decay/", "mod_coef_uncertainty_mega", run_label, ".pdf"), 
    width = 9, height = 9, units = "in")




# alternative: simply plot the uncertainty window:

gg_uncertainty_window <- 
  ggplot(data = coef_l3_mega %>% 
         mutate(uncertainty_range = ifelse(coef_term == "lin", -1*uncertainty_range, uncertainty_range)),
       mapping = aes(x = year_abn, y = uncertainty_range,
                       group = coef_term, fill = coef_term)) + 
  geom_col() + 
  facet_wrap(vars(site), scales = "free", labeller = as_labeller(cap_update_labels)) + 
  theme_classic() + 
  scale_fill_manual(values = met.brewer(name="Hokusai3", n=2, type="discrete"),
                     labels = c("log" = "Log", "lin" = "Linear")) +
  labs(x = "Cohort (Year Abandoned)", y = "Model Coefficient Uncertainty Window (absolute value)", 
       fill = "Coefficient\nTerm") + 
  theme(legend.position = c(0.88, 0.19))


ggsave(plot = gg_uncertainty_window, 
       filename = paste0(p_plots, run_label, "/decay/", "mod_coef_uncertainty_window", run_label, ".pdf"), 
    width = 8, height = 6, units = "in")







# extras:

# ------------------------------------------------------------- #
# pooled model uncertainty, with log and linear term coefficients plotted separately.
ggplot(data = filter(coef_l3_mega, 
                     site %in% site_df$site[c(3,9)]
                     ),
       mapping = aes(y = year_abn, x = estimate, color = coef_term)) + 
  geom_point(
    # position = position_dodge(0.7)
             ) + 
  geom_errorbar(mapping = aes(xmin = conf.low, xmax = conf.high), width = 0.3,
                position = position_dodge(0.7)) +
  facet_wrap(vars(site, coef_term), scales = "free", #nrow = 4,
             labeller = as_labeller(cap_update_labels)) + 
  geom_vline(xintercept = 0) + 
  theme_classic() + 
    # theme(legend.position = c(0.9, 0.13)) +
# coord_cartesian(ylim = c(-0.01, 0.01)) +
  labs(x = "Cohort (Year Abandoned)", y = "Model Coefficient Estimate", 
       title = "Coefficient estimates and uncertainty: pooled model",
       caption = "Error bars represent 95% Confidence Intervals around coefficient estimate")



# ----------------------------------------------------------------- #
# plot whether the coefficients have p values <= 0.05.
ggplot(data = filter(coef_l3_mega, !is.na(estimate)),
       mapping = aes(x = year_abn, y = p.value <= 0.05, color = coef_term)) + 
  geom_point() +
  facet_grid(vars(site), scales = "free", #nrow = 4,
             labeller = as_labeller(cap_update_labels)) + 
  theme_classic() + 
  labs(x = "Cohort (Year Abandoned)", y = "Coef. with p value <= 0.05")



# ----------------------------------------------------------------- #
# individual models

gg_coef_uncertainty <- ggplot(data = coef_df_l3,
       mapping = aes(x = year_abn, y = estimate, color = term)) + 
  geom_point(position = position_dodge(0.7)) + 
  geom_errorbar(mapping = aes(ymin = conf.low, ymax = conf.high), width = 0.3,
                position = position_dodge(0.7)) +
  facet_wrap(vars(site), scales = "free", nrow = 4,
             labeller = as_labeller(cap_update_labels)) + 
  geom_hline(yintercept = 0) + 
  theme_classic() + 
  labs(x = "Cohort (Year Abandoned)", y = "Model Coefficient Estimate", 
       title = "Coefficient estimates and uncertainty: individual models",
       caption = "Error bars represent 95% Confidence Intervals around coefficient estimate") + 
  theme(legend.position = c(0.9, 0.13))
gg_coef_uncertainty

ggsave(plot = gg_coef_uncertainty, 
       filename = paste0(p_plots, run_label, "/decay/", "mod_coef_uncertainty", run_label, ".pdf"), 
    width = 9, height = 10, units = "in")



# using the built in stat functions:

# mean values:
ggplot(data = coef_l3_mega %>% filter(year_abn < 2013, 
                                      # site == "shaanxi"
                                      ),
       mapping = aes(x = site, y = estimate, color = coef_term)) + 
  # geom_point(position = position_dodge(0.7)) + 
  # geom_errorbar(mapping = aes(ymin = conf.low, ymax = conf.high),
                # width = 0.3, position = position_dodge(0.7)) +
  # facet_wrap(vars(site), scales = "free", nrow = 4,
  #            labeller = as_labeller(cap_update_labels)) + 
  # geom_hline(yintercept = 0) + # horizontal orientation
  theme_classic() +
  # theme_linedraw() +
  # theme_minimal_vgrid() +
  labs(x = "Cohort (Year Abandoned)", y = "Model Coefficient Estimate", 
       # title = "Coefficient estimates and uncertainty: pooled model",
       # caption = "Error bars represent 95% Confidence Intervals around coefficient estimate",
       color = "Coefficient term") + 
  theme(legend.position = c(0.86, 0.23)) + 
    scale_color_manual(values = brewer.pal(9, "PiYG")[c(1,9)],
                       labels = c("log" = "Log", "lin" = "Linear")
                       ) + 
  stat_summary(fun.data = "mean_cl_boot", mapping = aes(group = coef_term, color = coef_term),
               # geom = "errorbar",
               # width = 0.2,         
               # inherit.aes = TRUE,
               # colour = "red", 
               size = 1
               ) + 
    stat_summary(fun = "mean", mapping = aes(group = coef_term, color = coef_term),
                 site = 0.5, color = "black")

```

```{r mean-coef-w-se}
library(MetBrewer)
show_col(met.brewer(name="VanGogh3", n=2, type="discrete"))
show_col(met.brewer(name="Derain", n=2, type="discrete"))
show_col(met.brewer(name="Cassatt2", n=4, type="discrete"))
show_col(met.brewer(name="Hokusai3", n=2, type="discrete"))
show_col(met.brewer(name="Isfahan1", n=2, type="discrete"))

# see coef-mega
# plot mean coefficients and their confidence intervals
# note, these confidence intervals are calculated using lm(estimate ~ 1) (see code chunk above: "coef-mega")

gg_mean_coef_w_ci <-
  mean_coef_l3_mega %>% 
  ggplot(mapping = aes(x = estimate, y = site, color = coef_term)) + 
    geom_vline(xintercept = 0, linetype = "dashed") + 
  geom_point(position = position_dodge(0.4), size = 2) + 
  geom_errorbar(mapping = aes(xmin = conf.low, xmax = conf.high), width = 0.3,
                position = position_dodge(0.4)) +
  scale_y_discrete(labels = fancy_labels) + 
    theme_classic() +
    labs(y = "Site", x = "Mean Coefficient Estimate (95% Confidence Interval)",
         color = "Coefficient\nTerm") + 
    scale_color_manual(
      values = met.brewer(name="Hokusai3", n=2, type="discrete"),
      labels = c("log" = "Log", "lin" = "Linear"))

# gg_mean_coef_w_ci

# cvd_grid(gg_mean_coef_w_ci)

ggsave(plot = gg_mean_coef_w_ci, 
       filename = paste0(p_plots, run_label, "/decay/", "mean_coef_ci", run_label, ".pdf"), 
    width = 5.5, height = 4.5, units = "in")








# comparing the different confidence interval estimates:

coef_l3_mega %>% 
  group_by(site, coef_term) %>% # group by site, term and coef_term (though you only need one of these)
  summarise(mean = mean(estimate, na.rm = TRUE),
            mean_low = mean(conf.low, na.rm = TRUE),
            mean_high = mean(conf.high, na.rm = TRUE),
            se = se(estimate),
            ci.low = mean - 1.96*se,
            ci.high = mean + 1.96*se,
            tidy(lm(estimate ~ 1), conf.int = TRUE, conf.level = 0.95)) %>%
  ungroup() %>%
  ggplot(mapping = aes(y = site, color = coef_term)) + 
  geom_point(mapping = aes(x = estimate, shape = coef_term),
             position = position_dodge(0.5)) + 
  geom_errorbar(mapping = aes(xmin = conf.low, xmax = conf.high), width = 0.3,
                position = position_dodge(0.5)) + 
  geom_errorbar(mapping = aes(xmin = ci.low, xmax = ci.high), width = 0.3,
                position = position_dodge(0.5),
                color = "black")



```




```{r weight-by-uncertainty}
# develop a "weight" associated with the uncertainty with each coefficient estimate.
combo_mean_coefs <- 
  bind_rows(coef_l3_mega,
            coef_lin_log_mega,
            coef_log2_lin_mega) %>%
  group_by(mod, site, coef_term) %>% # group by site and coef_term
  # use a linear regression to calculate mean and confidence intervals
  summarise(tidy(lm(estimate ~ 1), conf.int = TRUE, conf.level = 0.95)) %>% 
  ungroup()





c
  # filter(!is.na(estimate)) %>%
  group_by(site, coef_term) %>% 
  summarise(
    # mean = mean(estimate, na.rm = TRUE),
    weighted_mean = sum(estimate * weight, na.rm = TRUE) / sum(weight, na.rm = TRUE)) %>%
  mutate(mod = "w_mean") %>%
  rename(coef_term = term, estimate = weighted_mean) %>% ungroup()





mean_traj_w_uncertainty <-
  mean_coef_l3_mega %>%
  # mean_coef_l3_mega_trim %>%
  # filter(site == "shaanxi") %>%
  select(site, coef_term, estimate, conf.low, conf.high) %>%
  pivot_longer(cols = c(estimate, conf.low, conf.high), values_to = "value") %>%
  pivot_wider(id_cols = c(site, name), names_from = coef_term, values_from = "value") %>%
  left_join(
    tibble(  
      site = rep(site_df$site, each = length(time_span)),
      age = rep(time_span, length(site_df$site))), 
    by = "site") %>%
  mutate(proportion = log * log(age-4) + lin * ((age-4) - 1) + 1) %>%
    select(site, age, name, proportion) %>%
    pivot_wider(id_cols = c(site, age), names_from = name, values_from = "proportion")


mean_traj_ci_trim <- 
  mean_coef_l3_mega_trim %>%
  select(site, coef_term, estimate, conf.low, conf.high) %>%
  pivot_longer(cols = c(estimate, conf.low, conf.high), values_to = "value") %>%
  pivot_wider(id_cols = c(site, name), names_from = coef_term, values_from = "value") %>%
  left_join(
    tibble(  
      site = rep(site_df$site, each = length(time_span)),
      age = rep(time_span, length(site_df$site))), 
    by = "site") %>%
  mutate(proportion = log * log(age-4) + lin * ((age-4) - 1) + 1) %>%
    select(site, age, name, proportion) %>%
    pivot_wider(id_cols = c(site, age), names_from = name, values_from = "proportion")





# ---------------------------------------------------------------------------- #
# First, plot the full decay model grid with the mean trajectory as a confidence interval (based on the confidence interval around the mean value estimated by the linear regression above)
# ---------------------------------------------------------------------------- #

gg_decay_grid_w_mean_traj_ci_base <- 
  ggplot(data = persistence_dat, 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Cohort \n(Year Abandoned)",
       caption = "Including all cohorts, irrespective of number of observations.") + 
   geom_point(size = 1) + # raw data
    scale_color_viridis(discrete = FALSE) +
    facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels)) + 
  
   # fitted lines
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort]),
              linetype = 5, #show.legend = FALSE,
              aes(alpha = "Fitted")) +
      scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2
                       )) +

    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") +
  
  theme(
    legend.position = c(0.9, 0.13),
    legend.spacing = unit(0, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1))


# untrimmed version
gg_decay_grid_w_mean_traj_ci <- 
  gg_decay_grid_w_mean_traj_ci_base +
  # add mean trajectories
  geom_line(data = mean_traj_ci %>% filter(age < 31), 
            mapping = aes(x = age, y = estimate),
              color = "red",
              size = 1, inherit.aes = FALSE) +
  
  # add 95% confidence intervals
  geom_ribbon(data = mean_traj_ci %>% filter(age < 31),
                mapping = aes(x = age, 
                              y = estimate, 
                              ymin = conf.low,
                              ymax = conf.high),
              color = "red", fill = "red",
                alpha = 0.1, inherit.aes = FALSE)

# save:
ggsave(plot = gg_decay_grid_w_mean_traj_ci,
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_w_mean_traj_ci", run_label, ".pdf"),
    width = 11, height = 9, units = "in")



# now, plot the trimmed version (no. observations >= 5):
rm(gg_decay_grid_w_mean_traj_ci_trim2)
gg_decay_grid_w_mean_traj_ci_trim <- 
  
  ggplot(data = persistence_dat %>% filter(year_abn < 2010), 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
  labs(x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
       caption = "Restricted to cohorts with >= 5 observations (excluding 2010, '11, '12, '13)") + 
   geom_point(size = 1) + # raw data
    scale_color_viridis(discrete = FALSE) +
    facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels)) + 
  
   # fitted lines
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort]) %>%
                filter(year_abn < 2010),
              linetype = 5, #show.legend = FALSE,
              aes(alpha = "Fitted")) +
      scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2
                       )) +

    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") +
  
  theme(
    legend.position = c(0.9, 0.13),
    legend.spacing = unit(0, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +
  
  # add mean trajectories
  geom_line(data = mean_traj_ci_trim %>% filter(age < 31), 
            mapping = aes(x = age, y = estimate),
              color = "red",
              size = 1, inherit.aes = FALSE) +
  
  # add 95% confidence intervals
  geom_ribbon(data = mean_traj_ci_trim %>% filter(age < 31),
                mapping = aes(x = age, 
                              y = estimate, 
                              ymin = conf.low,
                              ymax = conf.high),
              color = "red", fill = "red",
                alpha = 0.1, inherit.aes = FALSE)

# save:
ggsave(plot = gg_decay_grid_w_mean_traj_ci_trim,
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_w_mean_traj_ci_trim", run_label, ".pdf"),
    width = 11, height = 9, units = "in")



```


## Cohort as a random effect

```{r random-effect}
# Since each cohort of abandoned land represents a particular group, with related values, I will model each cohort as a random effect, with random intercept and random slopes.
# Resource on fixed effects vs. random effects: https://stats.stackexchange.com/questions/4700/what-is-the-difference-between-fixed-effect-random-effect-and-mixed-effect-mode

# Essentially, 


# lmer_mod <- lmer(
#   log(proportion) ~  # response variable
#        age + # fixed effect (i.e. what we're curious about)
#        (1 + age|cohort), # random effects (modeling coefficients as random values drawn from a common error distribution, i.e. essentially random differences that we want to control for). 
#      # The 1 represents the random intercept, meaning that the initial starting point can vary for each cohort (year_abn). If this was all we wanted, but with the same relationship to age for each cohort, we'd just have (1|year_abn)
#      # The "age|year_abn" term represents the random slopes, meaning that the relationship between proportion and age (the slope/coefficient) is allowed to vary across the cohorts.
#      data = dat) 

# random slopes, constant intercept

lmer_mod_slope <- lmer(log(proportion) ~ age + (0 + age|cohort), 
                       data = filter(persistence_dat, site == "shaanxi"))
lmer(log(proportion) ~ age + (0 + age|cohort), 
     data = filter(persistence_dat, site == "shaanxi")) %>% tidy()


tidy(lm_mega_lin_log_lin_l) %>% tail() 
coef_l3_mega
formula(lm_mega_lin_log_lin_l)

lmer_l3_random_s <- lmer(
  formula = I(proportion - 1) ~ 0 + 
    # log(time + 1) +
    (0 + log(time + 1)|cohort) + # predictor (log term of time) and random slope for each cohort
    # I(time) +
    (0 + I(time)|cohort), # predictor (linear term of time) and random slope for each cohort
  data = filter(persistence_dat, site == "shaanxi", year_abn < 2013))

lmer_l3_random <- lmer(
  formula = I(proportion - 1) ~ 0 + 
    # log(time + 1) +
    (0 + log(time + 1):site|cohort) + # predictor (log term of time) and random slope for each cohort
    # I(time) +
    (0 + I(time):site|cohort), # predictor (linear term of time) and random slope for each cohort
  data = filter(persistence_dat, year_abn < 2013))

lmer_l3_random
lmer_l3_random %>% tidy() %>% print(n = 100)
lmer_l3_random %>% coef()
lmer_l3_random %>% glance()
lmer_l3_random %>% augment()

coef(lmer_l3_random)[[1]] %>% as_tibble(rownames = "cohort") %>%
  pivot_longer(cols = !cohort,
               names_to = "term",
               values_to = "estimate") %>%
  mutate(site = gsub("site", "", str_extract(term, "site[a-z,_]*")),
         year_abn = as.integer(cohort),
         coef_term = ifelse(grepl("log", term), "log", "lin")) %>%
  pivot_wider(id_cols = c(site, cohort), values_from = estimate, names_from = coef_term)

# now, plot.

plot(lmer_l3_random)
confint(lmer_l3_random)
ranef(lmer_l3_random)


# simple plots:
gg0 <- ggplot(data = filter(persistence_dat, 
                     site == site_df$site[9],
                     # year_abn > 2009
                     ),
         mapping = aes(x = age, y = proportion, 
                       color = cohort, 
                       group = cohort
                       )) + 
  theme_classic() + 
  
  # observed points
  geom_point() 

gg0 + 
  geom_line(data = mutate(augment(lmer_l3_random),
                          # time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          time = `I(time)`,
                          age = time + 5,
                          proportion = .fitted + 1,
                          year_abn = as.numeric(levels(cohort))[cohort]) #%>% filter(year_abn > 2009)
            # , linetype = 5
            ) + 
  labs(title = "random effects")

gg0 + 
  geom_line(data = mutate(augment(lm_lin_log_lin_l[[9]]),
                          # time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          time = `I(time)`,
                          age = time + 5,
                          proportion = .fitted + 1,
                          year_abn = as.numeric(levels(cohort))[cohort]) #%>% filter(year_abn > 2009)
            # , linetype = 5
            ) + 
  labs(title = "fixed effects")

plot_grid(
  gg0 + 
  geom_line(data = mutate(augment(lmer_l3_random),
                          # time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          time = `I(time)`,
                          age = time + 5,
                          proportion = .fitted + 1,
                          year_abn = as.numeric(levels(cohort))[cohort]) #%>% filter(year_abn > 2009)
            # , linetype = 5
            ) + 
  labs(title = "random effects"),
  
  gg0 + 
    geom_line(data = mutate(augment(lm_lin_log_lin_l[[9]]),
                          # time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          time = `I(time)`,
                          age = time + 5,
                          proportion = .fitted + 1,
                          year_abn = as.numeric(levels(cohort))[cohort]) #%>% filter(year_abn > 2009)
            # , linetype = 5
            ) + 
    labs(title = "fixed effects"),
  nrow = 2
)


tidy(lmer_l3_random)#, conf.int = TRUE)


```



# Figures

## Manuscript figures

```{r *fig4-model-shaanxi}
# ------------------------------------------------ #
# for the manuscript main text: shaanxi, lin-log-lin
# ------------------------------------------------ #
mean_coef_tmp_l3_s <- tidy(lm_lin_log_lin_l[[9]]) %>% 
  mutate(site = site_df$site[9],
         coef_term = sub(":*cohort....:*", "", term),
         year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
         cohort = as.factor(year_abn)) %>% 
  group_by(coef_term) %>%
  summarise(mean_est = mean(estimate, na.rm = TRUE)) %>% arrange(coef_term)


# categorical color scheme
gg_fig4 <-
  ggplot(data = filter(persistence_dat, site == site_df$site[9]),
         mapping = aes(x = age, y = proportion, 
                       group = year_abn, 
                       color = cut(year_abn, 
                                   breaks = c(1988, 1990, 1995, 2000, 2005, 2010, 2013),
                                   labels = c("1988-1990", "1991-1995", "1996-2000",
                                              "2001-2005", "2006-2010", "2011-2013"),
                                   include.lowest = TRUE)
                       )) + 
  theme_classic() + 
  
    # mean decay trend
  geom_function(fun = function(x) {
    mean_coef_tmp_l3_s$mean_est[2]*log(x-4) + mean_coef_tmp_l3_s$mean_est[1]*((x-4) - 1) + 1},
    mapping = aes(linetype = "Mean Decay\nRate"),
    color = "black", size = 1.25, inherit.aes = FALSE) + 
  
  # observed points
  geom_point() + 
  
# fitted points
  geom_line(data = mutate(augment(lm_lin_log_lin_l[[9]]),
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          age = time + 5,
                          proportion = .fitted + 1,
                          year_abn = as.numeric(levels(cohort))[cohort]),
            linetype = 5, #"longdash",# size = 2
            aes(alpha = "Fitted"),
            ) + 
  scale_color_brewer(palette = "Greens", direction = -1) +
  scale_x_continuous(n.breaks = 6) +
  # geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Cohort (Year\nFirst Abandoned)\n",
       linetype = NULL) + 
  
  guides(color = guide_legend(order = 1,
                              override.aes = list(size = 4, linetype = NULL))) +
  scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2,
                       override.aes = list(
                         # size = 0.5, 
                         # linetype = 6, size = 1.15, #
                         color = brewer_pal(palette = "Greens")(6)[6]
                       ))) + 
    theme(legend.position = c(0.87, 0.7),
        legend.background = element_rect(fill = "transparent"),
        # legend.box.background = element_rect(fill = "transparent"),
        # legend.key.size = unit(8, 'mm'),
        legend.spacing.y = unit(-2, "mm")
        )

ggsave(plot = gg_fig4 + 
         scale_color_viridis(discrete = TRUE) + 
        # labs(color = "Cohort (Year First Abandoned)") + 
         theme(legend.title.align = 0, legend.title = element_text(size = 10)
               ), 
       filename = paste0(p_plots, "fig4", run_label, ".pdf"), 
       width = 4.49, height = 4.25, 
       # width = 3.42, height = 3.4, 
       units = "in")

gg_fig4

show_col(colours = brewer_pal(palette = "Greens")(6))
show_col(colours = brewer_pal(palette = "Greens")(6)[6])


ggsave(plot = gg_fig4, filename = paste0(p_plots, "fig4_green", run_label, ".pdf"), 
       width = 5, height = 4.5, units = "in")




# -------------------------------------------------------- #
# continous color scheme:
# -------------------------------------------------------- #
gg_lin_log_lin_cohort_tmp_s <-
  ggplot(data = filter(persistence_dat, site == site_df$site[9]),
         mapping = aes(x = age, y = proportion, 
                       group = year_abn, color = year_abn)) + 
  theme_classic() + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  scale_x_continuous(n.breaks = 6) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(# title = "Decay of abandoned land over time", 
       # subtitle = site_df$description[9], 
       # caption = "stats::lm() formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Cohort \n(Year First \nAbandoned)",
       linetype = NULL) + 

  geom_line(data = mutate(augment(lm_lin_log_lin_l[[9]]),
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          age = time + 5,
                          proportion = .fitted + 1,
                          year_abn = as.numeric(levels(cohort))[cohort]),
            linetype = "longdash") + 
  
  # site mean coefficients: (note, needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) {
    mean_coef_tmp_l3_s$mean_est[2]*log(x-4) + mean_coef_tmp_l3_s$mean_est[1]*((x-4) - 1) + 1},
    mapping = aes(linetype = "Mean \nDecay \nRate"),
    color = "black", size = 1.25, inherit.aes = FALSE) + 
  theme(legend.position = c(0.9, 0.68),
        legend.background = element_rect(fill = "transparent") #,
        # legend.box.background = element_rect(fill = "transparent"),
        )

  # show_col(colours = viridis(n = 9)[2])

# save ------------- #
  
# pdf
ggsave(plot = gg_lin_log_lin_cohort_tmp_s, 
       filename = paste0(p_plots, "fig4_cont", run_label, ".pdf"
                         # old path name
                         # run_label, "/decay/", "ms_fig_l3_cohort", run_label, "_s.pdf"
                         ), 
  width = 5, height = 4.5, units = "in")




# viridis

ggsave(plot = gg_fig4 + scale_color_viridis(discrete = TRUE),
       filename = paste0(p_plots, "fig4_viridis", run_label, ".pdf"), 
  width = 5, height = 4.5, units = "in")


ggsave(plot = gg_lin_log_lin_cohort_tmp_s +
         scale_color_viridis(), 
       filename = paste0(p_plots, "fig4_viridis_cont", run_label, ".pdf"), 
  width = 5, height = 4.5, units = "in")

cvd_grid(gg_lin_log_lin_cohort_tmp_s)
cvd_grid(gg_lin_log_lin_cohort_tmp_s +
         scale_color_viridis())
```

```{r decay-mod-facet-grid}
# plots ------------------------------------------------ #
# ------------------------------------------------------ #
# for SI
persistence_dat$age %>% unique() %>% sort()

gg_decay_mega <-
  ggplot(data = persistence_dat, 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, 
                     # color = year_abn
                     color = cut(year_abn, 
                                   breaks = c(1988, 1990, 1995, 2000, 2005, 2010, 2013),
                                   labels = c("1988-1990", "1991-1995", "1996-2000",
                                              "2001-2005", "2006-2010", "2011-2013"),
                                   include.lowest = TRUE))) + 
    theme_classic() + 
  
    # mean trajectory
  geom_line(
    data = fitted_combo %>% 
      filter(mod == "l3", 
             type %in% c("mean"#, "conf.low", "conf.high"
                         ),
             age < 31),
    # data = fitted_l3_mega %>% filter(mod == "l3"), 
            mapping = aes(x = age, y = proportion, 
                          # linetype = mod
                          linetype = type
                          ),
              # color = brewer_pal(palette = "PiYG")(11)[2], # dark pink
              color = "black",
              size = 1, inherit.aes = FALSE) +
  
  scale_linetype_discrete(label = c("mean" = "Mean Decay Rate\n(Across Cohorts)",
                                    "l3" = "Mean Decay Rate\n(Across Cohorts)",
                                      "l3_no_cohort" = "Decay Rate (No F.E.)")) + 
  
    geom_point(size = 0.8) + 
    scale_color_viridis(discrete = TRUE) +
    # scale_color_distiller(palette = "Greens", discrete = TRUE) + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
         linetype = "") + 
  
    # fitted lines
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort]),
              linetype = 5, #5, #"longdash"
              aes(alpha = "Fitted")) +
      scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2,
                       override.aes = list(
                         # size = 0.5, 
                         # linetype = 6, size = 1.15, #
                         # color = brewer_pal(palette = "Greens")(6)[6]
                       ))) +

  theme(legend.position = c(0.9, 0.13),
        legend.spacing = unit(-2, units = "mm"), legend.background = element_blank(),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +
  facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels)) + 
  guides(color = guide_legend(order = 1,
                              override.aes = list(size = 5, linetype = NULL)))


ggsave(plot = gg_decay_mega, 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid", run_label, ".pdf"), 
    width = 8, height = 8, units = "in")



ggsave(plot = gg_decay_mega + scale_color_viridis(discrete = FALSE), 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid_cont", run_label, ".pdf"), 
    width = 8, height = 8, units = "in")


# --------------------------------------------------------------- #
# Unused: same decay plot facet grid, but shown with site level mean
# decay trajectories with and without cohort fixed effects
# --------------------------------------------------------------- #
# gg_decay_mega_plus <-
  ggplot(data = persistence_dat, 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, 
                     color = year_abn)) + 
    theme_classic() + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
         linetype = "") + 
  
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort])) +

  geom_line(data = fitted_l3_mega, 
            mapping = aes(x = age, y = proportion, linetype = mod),
              # color = brewer_pal(palette = "PiYG")(11)[2], # dark pink
              color = "black",
              size = 1, inherit.aes = FALSE) +
  scale_linetype_discrete(label = c("l3" = "Mean Decay Rate\n(Across F.E.)",
                                      "l3_no_cohort" = "Decay Rate (No F.E.)")) + 
  theme(legend.position = c(0.9, 0.12), 
        legend.spacing = unit(2, units = "mm"), 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) + 
  coord_cartesian(ylim = c(0.3, 1)) +
  facet_wrap(vars(site))

ggsave(plot = gg_decay_mega_plus, 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid_plus", run_label, ".pdf"), 
    width = 8, height = 8, units = "in")






# ----------------------------------------------------------------------------- #
# decay mod grid with trend lines that extend to year 30 regardless of how long the cohort is.
# ----------------------------------------------------------------------------- #



persistence_dat %>% filter(site == "shaanxi", year_abn > 2010) %>% arrange(year_abn)
```

```{r decay-mod-plus}
# now, add to a facet grid plot:
fitted_combo %>% select(mod, type) %>% unique()

gg_decay_alt_means <-
  ggplot(data = persistence_dat, 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)
       ) + 
    theme_classic() + 
   geom_point(size = 0.8) + 
    scale_color_viridis(discrete = FALSE, name = "Cohort (Year Abandoned)") +
    facet_wrap(vars(site), nrow = 3, scales = "free",
             labeller = as_labeller(cap_update_labels)) +
  
   # fitted lines
    # geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
    #                         time = round(exp(`log(time + 1)`), digits = 0) - 1,
    #                         age = time + 5,
    #                         proportion = .fitted + 1,
    #                         year_abn = as.numeric(levels(cohort))[cohort]),
    #           linetype = 5, #5, #"longdash"
    #           aes(alpha = "Fitted")) +
    #   scale_alpha_manual(name = NULL,
    #                  values = c(1), # breaks = c(0, "Fitted"),
    #                  guide = guide_legend(
    #                    order = 2,
    #                    override.aes = list(
    #                      # size = 0.5, 
    #                      # linetype = 6, size = 1.15 #
    #                      # color = brewer_pal(palette = "Greens")(6)[6]
    #                    ))) +
  
    # add mean trajectories
  new_scale_color() +
  geom_line(data = fitted_combo %>% filter(age < 31, mod == "l3"), 
            mapping = aes(x = age, y = proportion, 
                          # linetype = mod,
                          color = type),
              size = 1, inherit.aes = FALSE) +
  scale_color_discrete(labels = c("mean" = "Mean coef.",
                                "w_obs"= "Mean weighted \nby # obs.",
                                "w_uncertainty"= "Mean weighted\nby inverse uncertainty"),
                       name = "Site mean decay rates"
                     ) + 

  # scale_linetype_manual(
  #   name = "Model spec.",
  #   labels = c("l3" = "p-1 ~ a*log(t+1) + b*t",
  #              "lin_log" = "p-1 ~ a*log(t+1)",
  #              "log2-lin" = "log(p) ~ a*log(t+1) + b*t"
  #              # "l3_no_cohort" = "Decay Rate Without\nCohort Fixed Effects",
  #              # "w_mean" = "Weighted Mean\nAcross Cohorts"
  #              ),
  #   values = c(1, 2, 3)) +
  
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining") + 

  theme(
    legend.position = c(0.87, 0.14),
    # legend.spacing = unit(2, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1))


ggsave(plot = gg_decay_alt_means, 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid_alt_means", run_label, ".pdf"), 
    width = 11, height = 9, units = "in")





# ------------------------------------------------------------------------- #
# original "decay_mod_grid_plus"

gg_decay_mega_plus_w <-
  ggplot(data = persistence_dat, 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, 
                     # color = year_abn
                     color = cut(year_abn, 
                                   breaks = c(1988, 1990, 1995, 2000, 2005, 2010, 2013),
                                   labels = c("1988-1990", "1991-1995", "1996-2000",
                                              "2001-2005", "2006-2010", "2011-2012"),
                                   include.lowest = TRUE))) + 
    theme_classic() + 
   geom_point(size = 0.8) + 
    scale_color_viridis(discrete = TRUE) +
    facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels)) +
  
   # fitted lines
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort]),
              linetype = 5, #5, #"longdash"
              aes(alpha = "Fitted")) +
      scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2,
                       override.aes = list(
                         # size = 0.5, 
                         # linetype = 6, size = 1.15 #
                         # color = brewer_pal(palette = "Greens")(6)[6]
                       ))) +
  
    # add mean trajectories
  geom_line(data = fitted_l3_mega_update, 
            mapping = aes(x = age, y = proportion, 
                          linetype = mod),
              color = "red",
              size = 1, inherit.aes = FALSE) +
  
  scale_linetype_manual(labels = c("l3" = "Mean Across Cohorts",
                                    "l3_no_cohort" = "Decay Rate Without\nCohort Fixed Effects",
                                    "w_mean" = "Weighted Mean\nAcross Cohorts"),
                          values = c(1, 2, 3)) + 
  
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
      # caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         # linetype = "Site Mean \nDecay Rate",
         linetype = NULL,
         color = "Cohort \n(Year Abandoned)"
         ) + 


  theme(
    legend.position = c(0.9, 0.13),
    legend.spacing = unit(-2, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) + 
  guides(color = guide_legend(order = 1,
                              override.aes = list(size = 5, linetype = NULL)))


ggsave(plot = gg_decay_mega_plus_w, 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid", run_label, "_plus_w.pdf"), 
    width = 11, height = 9, units = "in")
```

## Panel figure showing trajectories by cohorts, across sites

```{r decay-panel-by-cohort}
# five cohorts
seq(from = 1988, to = 2013, by = 5)[1:5]


gg_decay_grid_by_cohort <-
  ggplot(data = filter(persistence_dat, 
                       # site %in% site_df$site[c(2, 8)],
                       year_abn %in% seq(from = 1988, to = 2013, by = 5)[1:5]), 
         mapping = aes(x = age, y = proportion, 
                       group = site, color = site)) + 
    theme_classic() + 
    # scale_color_distiller(palette = "Greens") + scale_fill_distiller(palette = "Greens") +
    # scale_color_viridis() + scale_fill_viridis() +
    scale_color_discrete(labels = cap_update_labels) +

    scale_x_continuous(#n.breaks = 6
      breaks = c(5, 10, 15, 20, 25, 30)
                       ) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
      # title = "Decay of abandoned land over time", 
         # subtitle = site_df$description[i], 
         # caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Site",
         linetype = "") + 
  
    geom_ribbon(data = mega_aug %>%
                  mutate(#augment(lm_lin_log_lin_l[[i]], se_fit = TRUE, interval = "confidence"),
                    time = round(exp(`log(time + 1)`), digits = 0) - 1,
                    age = time + 5,
                    proportion = .fitted + 1,
                    year_abn = as.numeric(levels(cohort))[cohort]) %>%
                  filter(
                    # site %in% site_df$site[c(2, 8)],
                    year_abn %in% seq(from = 1988, to = 2013, by = 5)[1:5]
                         ),
                mapping = aes(x = age, y = proportion, 
                              ymin = .lower + 1, #proportion - .se.fit, 
                              ymax = .upper + 1, #proportion + .se.fit, 
                              group = site, color = site, fill = site),
                alpha = 0.5,
                show.legend = FALSE,
                inherit.aes = FALSE) + 
    geom_point(alpha = 0.7) +
    facet_grid(.~cohort, scales = "free_x", space = "free_x") +  # see _util_misc.R
    
  theme(
    # legend.position = c(0.9, 0.13),
    legend.spacing = unit(-2, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) + 
  guides(color = guide_legend(order = 1, override.aes = list(size = 5, linetype = NULL, alpha = 1)))

gg_decay_grid_by_cohort

ggsave(plot = gg_decay_grid_by_cohort, 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid", run_label, "_by_cohort.pdf"), 
    width = 10, height = 6, units = "in")


ggsave(gg_decay_grid_by_cohort + 
  facet_grid(site~cohort, scales = "free_x", space = "free_x", labeller = as_labeller(cap_update_labels)) +
  theme(legend.position = "none"),
  filename = paste0(p_plots, run_label, "/decay/", "decay_by_five_cohorts", run_label, ".pdf"), 
    width = 10, height = 12, units = "in"
  )


gg_decay_grid_by_cohort + facet_wrap(vars(cohort), scales = "free") + 
  theme(legend.position = c(0.9, 0.13))

ggsave(gg_decay_grid_by_cohort + 
         facet_wrap(vars(cohort), scales = "free") + 
         theme(legend.position = c(0.8, 0.25)),
  filename = paste0(p_plots, run_label, "/decay/", "decay_by_cohorts_wrap", run_label, ".pdf"), 
    width = 10, height = 7, units = "in"
  )
```

```{r decay-panel-by-site-5cohorts}

# now, redo the plot so that it's faceted by site, but with just the five cohorts:

gg_decay_grid_5c <-
  ggplot(data = filter(persistence_dat, 
                       # site %in% site_df$site[c(2, 8)],
                       year_abn %in% seq(from = 1988, to = 2013, by = 5)[1:5]), 
         mapping = aes(x = age, y = proportion, 
                       group = cohort, color = cohort)) + 
    theme_classic() + 
    # scale_color_distiller(palette = "Greens") + scale_fill_distiller(palette = "Greens") +
    scale_color_viridis(discrete = TRUE) + scale_fill_viridis(discrete = TRUE) +
    # scale_color_discrete(labels = cap_update_labels) +

    scale_x_continuous(#n.breaks = 6
      breaks = c(5, 10, 15, 20, 25, 30)
                       ) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
      # title = "Decay of abandoned land over time", 
         # subtitle = site_df$description[i], 
         # caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort",
         linetype = "") + 
  
    geom_ribbon(data = mega_aug %>%
                  mutate(#augment(lm_lin_log_lin_l[[i]], se_fit = TRUE, interval = "confidence"),
                    time = round(exp(`log(time + 1)`), digits = 0) - 1,
                    age = time + 5,
                    proportion = .fitted + 1,
                    year_abn = as.numeric(levels(cohort))[cohort]) %>%
                  filter(
                    # site %in% site_df$site[c(2, 8)],
                    year_abn %in% seq(from = 1988, to = 2013, by = 5)[1:5]
                         ),
                mapping = aes(x = age, y = proportion, 
                              ymin = .lower + 1, #proportion - .se.fit, 
                              ymax = .upper + 1, #proportion + .se.fit, 
                              group = cohort, color = cohort, fill = cohort),
                alpha = 0.5,
                show.legend = FALSE,
                inherit.aes = FALSE) + 
    geom_point(alpha = 0.7) +
    facet_wrap(vars(site), #scales = "free_x", #space = "free_x",
               # row = 3,
               labeller = as_labeller(cap_update_labels))  +
  theme(
    legend.position = c(0.9, 0.13),
    legend.spacing = unit(-2, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) + 
    guides(color = guide_legend(order = 1,
                              override.aes = list(size = 5, linetype = NULL, alpha = 1)))

gg_decay_grid_5c

ggsave(plot = gg_decay_grid_5c, 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid_5_cohorts", run_label, ".pdf"), 
    width = 11, height = 9, units = "in")


```

```{r decay-panel-with-any-model}
# mod_ll_mega_trim
names(mod_ll_mega)

# cohort cut-off:
# cohort_cut_off <- 2010
cohort_cut_off <- 2014
mod_index <- 8
formula(mod_ll_mega[[mod_index]])

gg_decay_grid0 <-
  ggplot(data = persistence_dat %>% filter(year_abn < cohort_cut_off), 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
  
    geom_point(size = 1) + 
    scale_color_viridis() +
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
         linetype = "") + 

  theme(legend.position = c(0.9, 0.13),
        legend.spacing = unit(-2, units = "mm"), legend.background = element_blank(),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +
  facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels))
```

```{r 1-2}
names(mod_ll_mega)
mod_index <- 1

for(mod_index in c(1, 2)) {
# mod_index <- 11
# model fits:
augment_tmp <- augment(
  mod_ll_mega[[mod_index]], 
  # mod_ll_mega_trim[[mod_index]], 
  se_fit = TRUE,
  interval = "confidence",
  conf.level = 0.95) %>% 
  mutate(
    time = round(exp(`log(time + 1)`), digits = 0) - 1,
    age = time + 5,
    # proportion = .fitted + 1,
    year_abn = as.numeric(levels(cohort))[cohort]
    ) %>%
  filter(year_abn < cohort_cut_off)

# mean trajectory:
# fitted_tmp <- fitted_l3_mega %>% filter(mod == "l3")

# add model fits:
gg_mod_tmp_fits <- 
  gg_decay_grid0 +   
    # fitted lines
    geom_line(data = augment_tmp,
              linetype = 5, #5, #"longdash"
              aes(alpha = "Fitted", y = exp(.fitted))) +
     scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2)) + 
  labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))

# add confidence intervals:
gg_mod_tmp_ci <- 
  gg_decay_grid0 + 
  geom_ribbon(data = augment_tmp,
              mapping = aes(x = age, 
                            y = exp(.fitted), 
                            ymin = exp(.lower), 
                            ymax = exp(.upper),
                            group = year_abn, color = year_abn, fill = year_abn
                              ),
                alpha = 0.2,
                show.legend = FALSE, inherit.aes = FALSE) + 
      scale_fill_viridis() + 
    labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))


ggsave(plot = gg_mod_tmp_fits,
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid",
                         run_label,
                         "_mod_", mod_index, "_fits.pdf"), 
       width = 8, height = 8, units = "in")

ggsave(plot = gg_mod_tmp_ci, 
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid",
                         run_label, 
                         "_mod_", mod_index, "_ci.pdf"), 
       width = 8, height = 8, units = "in")
}
```
```{r 3-4}
for(mod_index in c(3, 4)) {
# mod_index <- 11
# model fits:
augment_tmp <- augment(
  mod_ll_mega[[mod_index]], 
  # mod_ll_mega_trim[[mod_index]], 
  se_fit = TRUE,
  interval = "confidence",
  conf.level = 0.95) %>% 
  mutate(
    time = round(exp(`log(time + 1)`), digits = 0) - 1,
    age = time + 5,
    proportion = .fitted + 1,
    year_abn = as.numeric(levels(cohort))[cohort]
    ) %>%
  filter(year_abn < cohort_cut_off)

# mean trajectory:
# fitted_tmp <- fitted_l3_mega %>% filter(mod == "l3")

# add model fits:
gg_mod_tmp_fits <- 
  gg_decay_grid0 +   
    # fitted lines
    geom_line(data = augment_tmp,
              linetype = 5, #5, #"longdash"
              aes(alpha = "Fitted")) +
     scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2)) + 
  labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))

# add confidence intervals:
gg_mod_tmp_ci <- 
  gg_decay_grid0 + 
  geom_ribbon(data = augment_tmp,
              mapping = aes(x = age, y = proportion, 
                            ymin = .lower + 1, #proportion - .se.fit, 
                            ymax = .upper + 1, #proportion + .se.fit, 
                            group = year_abn, color = year_abn, fill = year_abn
                              ),
                alpha = 0.2,
                show.legend = FALSE, inherit.aes = FALSE) + 
      scale_fill_viridis() + 
    labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))


  
# gg_decay_grid0 +
#   # mean trajectory
#   geom_line(data = fitted_tmp, 
#             mapping = aes(x = age, y = proportion, linetype = mod),
#               # color = brewer_pal(palette = "PiYG")(11)[2], # dark pink
#               color = "black",
#               size = 1, inherit.aes = FALSE)


ggsave(plot = gg_mod_tmp_fits,
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label,
                         "_mod_", mod_index, "_fits.pdf"), 
       width = 8, height = 8, units = "in")

ggsave(plot = gg_mod_tmp_ci, 
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label, 
                         "_mod_", mod_index, "_ci.pdf"), 
       width = 8, height = 8, units = "in")
}


names(mod_ll_mega)


# exponential decay (mod #8)
```

```{r 5}
names(mod_ll_mega)

for(mod_index in c(5)) {
# mod_index <- 5
# model fits:
augment_tmp <- augment(
  mod_ll_mega[[mod_index]], 
  # mod_ll_mega_trim[[mod_index]], 
  se_fit = TRUE,
  interval = "confidence",
  conf.level = 0.95) %>% 
  mutate(
    time = round(exp(`log(time + 1)`), digits = 0) - 1,
    age = time + 5,
    proportion = .fitted + 1,
    # year_abn = as.numeric(levels(cohort))[cohort]
    ) %>%
  filter(
    # year_abn < cohort_cut_off
         )

# mean trajectory:
# fitted_tmp <- fitted_l3_mega %>% filter(mod == "l3")

gg_decay_grid_tmp0 <-
  ggplot(data = persistence_dat %>% filter(year_abn < cohort_cut_off), 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
  
    geom_point(size = 1) + 
    scale_color_viridis() +
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
         linetype = "") + 

  theme(legend.position = c(0.9, 0.13),
        legend.spacing = unit(-2, units = "mm"), legend.background = element_blank(),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +
  facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels))

# add model fits:
gg_mod_tmp_fits <- 
  gg_decay_grid_tmp0 +   
    # fitted lines
    geom_line(data = augment_tmp,
              linetype = 5, #5, #"longdash"
              aes(alpha = "Fitted",
                  x = age, y = proportion),
              inherit.aes = FALSE,
              color = "red"
              ) +
     scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2)) + 
  labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))

# add confidence intervals:
gg_mod_tmp_ci <- 
  gg_decay_grid_tmp0 + 
  geom_ribbon(data = augment_tmp,
              mapping = aes(x = age, 
                            y = proportion, 
                            ymin = .lower + 1, 
                            ymax = .upper + 1,
                            # group = year_abn, color = year_abn, fill = year_abn
                              ),
                alpha = 0.5,
              color = "red", fill = "red",
                show.legend = FALSE, inherit.aes = FALSE) + 
      scale_fill_viridis() + 
    labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))


ggsave(plot = gg_mod_tmp_fits,
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label,
                         "_mod_", mod_index, "_fits.pdf"), 
       width = 8, height = 8, units = "in")

ggsave(plot = gg_mod_tmp_ci, 
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label, 
                         "_mod_", mod_index, "_ci.pdf"), 
       width = 8, height = 8, units = "in")
}
```

```{r 6}
names(mod_ll_mega)

for(mod_index in c(6)) {
# mod_index <- 6
# model fits:
augment_tmp <- augment(
  mod_ll_mega[[mod_index]], 
  # mod_ll_mega_trim[[mod_index]], 
  se_fit = TRUE,
  interval = "confidence",
  conf.level = 0.95) %>% 
  mutate(
    time = round(exp(`log(time + 1)`), digits = 0) - 1,
    age = time + 5,
    # proportion = .fitted + 1,
    # year_abn = as.numeric(levels(cohort))[cohort]
    ) %>%
  filter(
    # year_abn < cohort_cut_off
         )

# mean trajectory:
# fitted_tmp <- fitted_l3_mega %>% filter(mod == "l3")

gg_decay_grid_tmp0 <-
  ggplot(data = persistence_dat %>% filter(year_abn < cohort_cut_off), 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
  
    geom_point(size = 1) + 
    scale_color_viridis() +
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
         linetype = "") + 

  theme(legend.position = c(0.9, 0.13),
        legend.spacing = unit(-2, units = "mm"), legend.background = element_blank(),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +
  facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels))

# add model fits:
gg_mod_tmp_fits <- 
  gg_decay_grid_tmp0 +   
    # fitted lines
    geom_line(data = augment_tmp,
              linetype = 5, #5, #"longdash"
              aes(alpha = "Fitted", 
                  x = age,
                  y = exp(.fitted)),
              inherit.aes = FALSE,
               color = "red",) +
     scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2)) + 
  labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))

# add confidence intervals:
gg_mod_tmp_ci <- 
  gg_decay_grid_tmp0 + 
  geom_ribbon(data = augment_tmp,
              mapping = aes(x = age, 
                            y = exp(.fitted), 
                            ymin = exp(.lower), 
                            ymax = exp(.upper),
                            # group = year_abn, color = year_abn, fill = year_abn
                              ),
                alpha = 0.5,
              color = "red", fill = "red",
                show.legend = FALSE, inherit.aes = FALSE) + 
      scale_fill_viridis() + 
    labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))


ggsave(plot = gg_mod_tmp_fits,
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label,
                         "_mod_", mod_index, "_fits.pdf"), 
       width = 8, height = 8, units = "in")

ggsave(plot = gg_mod_tmp_ci, 
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label, 
                         "_mod_", mod_index, "_ci.pdf"), 
       width = 8, height = 8, units = "in")
}
```
```{r 7}
names(mod_ll_mega)

for(mod_index in c(7)) {
# mod_index <- 7
# model fits:
augment_tmp <- augment(
  mod_ll_mega[[mod_index]], 
  # mod_ll_mega_trim[[mod_index]], 
  se_fit = TRUE,
  interval = "confidence",
  conf.level = 0.95) %>% 
  mutate(
    time = round(exp(`log(time + 1)`), digits = 0) - 1,
    age = time + 5,
    # proportion = .fitted + 1,
    # year_abn = as.numeric(levels(cohort))[cohort]
    ) %>%
  filter(
    year_abn < cohort_cut_off
         )

# mean trajectory:
# fitted_tmp <- fitted_l3_mega %>% filter(mod == "l3")

gg_decay_grid_tmp0 <-
  ggplot(data = persistence_dat %>% filter(year_abn < cohort_cut_off), 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
  
    geom_point(size = 1) + 
    scale_color_viridis() +
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
         linetype = "") + 

  theme(legend.position = c(0.9, 0.13),
        legend.spacing = unit(-2, units = "mm"), legend.background = element_blank(),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +
  facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels))

# add model fits:
gg_mod_tmp_fits <- 
  gg_decay_grid_tmp0 +   
    # fitted lines
    geom_line(data = augment_tmp,
              linetype = 5, #5, #"longdash"
              aes(alpha = "Fitted", 
                  y = exp(.fitted)),
              # inherit.aes = FALSE,
              ) +
     scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2)) + 
  labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))

# add confidence intervals:
gg_mod_tmp_ci <- 
  gg_decay_grid_tmp0 + 
  geom_ribbon(data = augment_tmp,
              mapping = aes(x = age, 
                            y = exp(.fitted), 
                            ymin = exp(.lower), 
                            ymax = exp(.upper),
                            group = year_abn, color = year_abn, fill = year_abn
                              ),
                alpha = 0.5,
              # color = "red", fill = "red",
                show.legend = FALSE, inherit.aes = FALSE) + 
      scale_fill_viridis() + 
    labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))


ggsave(plot = gg_mod_tmp_fits,
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label,
                         "_mod_", mod_index, "_fits.pdf"), 
       width = 8, height = 8, units = "in")

ggsave(plot = gg_mod_tmp_ci, 
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label, 
                         "_mod_", mod_index, "_ci.pdf"), 
       width = 8, height = 8, units = "in")
}
```

```{r 8-decay-panel-exp-decay}
names(mod_ll_mega)
cohort_cut_off <- 2014

gg_decay_grid0 <-
  ggplot(data = persistence_dat %>% filter(year_abn < cohort_cut_off), 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
  
    geom_point(size = 1) + 
    scale_color_viridis() +
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
         linetype = "") + 

  theme(legend.position = c(0.9, 0.13),
        legend.spacing = unit(-2, units = "mm"), legend.background = element_blank(),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +
  facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels))


mod_index <- 8


# model fits:
augment_tmp <- augment(mod_ll_mega[[mod_index]], se_fit = TRUE,
                       interval = "confidence",
                       conf.level = 0.95) %>% 
  mutate(
    # time = round(exp(`log(time + 1)`), digits = 0) - 1,
         age = time + 5,
         proportion = exp(.fitted),
         p = exp(`log(proportion)`),
         year_abn = as.numeric(levels(cohort))[cohort]
    ) %>%
  filter(year_abn < cohort_cut_off)

# mean trajectory:
# fitted_tmp <- fitted_l3_mega %>% filter(mod == "l3")

# add model fits:
gg_mod_tmp_fits <-
  gg_decay_grid0 +   
    # fitted lines
    geom_line(data = augment_tmp,
              linetype = 5, #5, #"longdash"
              aes(alpha = "Fitted")) +
     scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2)) + 
  labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))

# add confidence intervals:
gg_mod_tmp_ci <-
  gg_decay_grid0 + 
  geom_ribbon(data = augment_tmp,
              mapping = aes(x = age, 
                            y = exp(.fitted),
                            ymin = exp(.lower), #proportion - .se.fit, 
                            ymax = exp(.upper), #proportion + .se.fit, 
                            group = year_abn, color = year_abn, fill = year_abn
                              ),
                alpha = 0.2,
                show.legend = FALSE, inherit.aes = FALSE) + 
      scale_fill_viridis() + 
    labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))


  
# gg_decay_grid0 +
#   # mean trajectory
#   geom_line(data = fitted_tmp, 
#             mapping = aes(x = age, y = proportion, linetype = mod),
#               # color = brewer_pal(palette = "PiYG")(11)[2], # dark pink
#               color = "black",
#               size = 1, inherit.aes = FALSE)


ggsave(plot = gg_mod_tmp_fits,
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label,
                         "_mod_", mod_index, "_fits.pdf"), 
       width = 8, height = 8, units = "in")

ggsave(plot = gg_mod_tmp_ci, 
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label, 
                         "_mod_", mod_index, "_ci.pdf"), 
       width = 8, height = 8, units = "in")


```

```{r 11-decay-panel-l3-continuous}
names(mod_ll_mega)

# linear-log-linear model, with year_abn (continuous) rather than the categorical cohort fixed effects
lm_mega_l3_cont <- lm(I(proportion - 1)  ~ 0 + log(time + 1):year_abn:site + I(time):year_abn:site,  
               data = mutate(persistence_dat, 
                             year_abn = year_abn - 1987
                             ))

tidy(lm_mega_l3_cont) %>% print(n = 50)

# continuous lin-log-lin model:
mod_index <- 11

# model fits:
augment_tmp <- augment(lm_mega_l3_cont, se_fit = TRUE,
                       interval = "confidence",
                       conf.level = 0.95) %>% 
  mutate(
    time = round(exp(`log(time + 1)`), digits = 0) - 1,
         age = time + 5,
         proportion = .fitted + 1,
         #year_abn = as.numeric(levels(cohort))[cohort],
    # year_abn = year_abn + 1987,
    cohort = as_factor(year_abn) 
    ) %>%
  filter(year_abn < cohort_cut_off)

# mean trajectory:
# fitted_tmp <- fitted_l3_mega %>% filter(mod == "l3")

gg_decay_grid0_cont <- ggplot(data = persistence_dat %>% filter(year_abn < cohort_cut_off), 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
  
    geom_point(size = 1) + 
    scale_color_viridis() +
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
         linetype = "") + 

  theme(legend.position = c(0.9, 0.13),
        legend.spacing = unit(-2, units = "mm"), legend.background = element_blank(),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +
  facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels))

# add model fits:
gg_mod_tmp_fits <-
  gg_decay_grid0_cont +
    # fitted lines
    geom_line(data = augment_tmp,
              linetype = 5, #5, #"longdash"
              aes(alpha = "Fitted")) +
     scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2)) + 
  labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))


# add confidence intervals:
gg_mod_tmp_ci <- 
  gg_decay_grid0_cont + 
  geom_ribbon(data = augment_tmp,
              mapping = aes(x = age, y = proportion, 
                            ymin = .lower + 1, #proportion - .se.fit, 
                            ymax = .upper + 1, #proportion + .se.fit, 
                            group = year_abn, color = year_abn, fill = year_abn
                              ),
                alpha = 0.2,
                show.legend = FALSE, inherit.aes = FALSE) + 
      scale_fill_viridis() + 
    labs(subtitle = names(mod_ll_mega_trim[mod_index]) %>% gsub("\n", "", .))

ggsave(plot = gg_mod_tmp_fits,
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label,
                         "_mod_", mod_index, "_fits.pdf"), 
       width = 8, height = 8, units = "in")

ggsave(plot = gg_mod_tmp_ci, 
       filename = paste0(p_plots, run_label, "/decay/decay_grids_by_mod/", "decay_grid", run_label, 
                         "_mod_", mod_index, "_ci.pdf"), 
       width = 8, height = 8, units = "in")
# 

```


## Basic decay model plots

```{r save-lin-log-lin-basic-model-plots}
# ------------------------------------------------ #
# linear-log-linear model, with cohort fixed effects
# ------------------------------------------------ #

# create directory, if it doesn't exist for this run yet:

if(!dir.exists(paste0(p_plots, run_label, "/decay/"))) {
  dir.create(paste0(p_plots, run_label,  "/decay/"))
}

i <- 9

# function
cc_save_decay_model_plots()

# save plots
lapply(1:11, function(i) cc_save_decay_model_plots(site_index = i, add_no_cohort = FALSE))

lapply(1:11, function(i) cc_save_decay_model_plots(site_index = i, add_no_cohort = TRUE))
```

```{r plots-w-CI}
add_no_cohort <- FALSE
i <- 9

mega_aug <- augment(lm_mega_lin_log_lin_l, se_fit = TRUE, interval = "confidence",
                    conf.level = 0.95)
mega_aug

gg_decay_grid_w_ci <-
  ggplot(data = filter(persistence_dat, 
                       # site %in% site_df$site[c(2, 8)],
                       year_abn < 2013
                       ), 
         mapping = aes(x = age, y = proportion, 
                       group = year_abn, color = year_abn)) + 
    theme_classic() + 
    # scale_color_distiller(palette = "Greens") + scale_fill_distiller(palette = "Greens") +
    scale_color_viridis() + scale_fill_viridis() +

    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
      # title = "Decay of abandoned land over time", 
         # subtitle = site_df$description[i], 
         # caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year First \nAbandoned)",
         linetype = "") + 
  
    geom_ribbon(data = mega_aug %>%
                  mutate(#augment(lm_lin_log_lin_l[[i]], se_fit = TRUE, interval = "confidence"),
                    time = round(exp(`log(time + 1)`), digits = 0) - 1,
                    age = time + 5,
                    proportion = .fitted + 1,
                    year_abn = as.numeric(levels(cohort))[cohort]) %>%
                  filter(
                    # site %in% site_df$site[c(2, 8)],
                    year_abn < 2013
                         ),
                mapping = aes(x = age, y = proportion, 
                              ymin = .lower + 1, #proportion - .se.fit, 
                              ymax = .upper + 1, #proportion + .se.fit, 
                              group = year_abn, color = year_abn, fill = year_abn),
                alpha = 0.5,
                show.legend = FALSE,
                inherit.aes = FALSE) + 
    geom_point(alpha = 0.7) +
    facet_wrap(vars(site),
               labeller = as_labeller(cap_update_labels)) +  # see _util_misc.R
  theme(
    legend.position = c(0.9, 0.13),
    legend.spacing = unit(-2, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0))



# if wanted, add the mean trajectories, etc.    
    # site mean coefficients:
  #   geom_line(data = filter(fitted_l3_mega_update, site == site_df$site[i], mod == "l3"), 
  #             mapping = aes(x = age, y = proportion, linetype = mod),
  #             # color = brewer_pal(palette = "PiYG")(11)[2], # dark pink
  #             color = "blue",
  #             size = 1, inherit.aes = FALSE) +
  # 
  # geom_ribbon(data = augment(lm_l3_no_cohort_l[[i]],
  #                              newdata = tibble(time = 5:30 - 5),
  #                              interval = "confidence") %>%
  #               mutate(age = time + 5,
  #                      proportion = .fitted + 1,
  #                      CI_upper = .upper + 1,        
  #                      CI_lower = .lower + 1),
  #             mapping = aes(x = age, ymax = CI_upper, ymin = CI_lower), 
  #             inherit.aes = FALSE,
  #             alpha = 0.3) + 
  #   
  #   scale_linetype_discrete(label = c("l3" = ifelse(add_no_cohort, "\nMean Decay Rate\n",
  #                                                   "Mean \nDecay \nRate"),
  #                                     "l3_no_cohort" = "Decay Rate \n(No fixed effects)"))

# save plot to file

ggsave(plot = gg_decay_grid_w_ci, 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid", run_label, "_w_CI.pdf"), 
    width = 12, height = 10, units = "in")




```

```{r plot-decay-model-fits-for-30-years}
# plot trajectory of each cohort out 30 years in full:

# plot log2
ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
    geom_point(data = filter(persistence_dat, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) + 
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_log2_l[[i]],
                                    newdata = new_dat),
                            age = time + 5,
                            proportion = exp(.fitted),
                            year_abn = as.numeric(levels(cohort))[cohort])) + 
    geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[i]]), na.rm = TRUE))},
                  mapping = aes(linetype = "Mean Decay Rate"),
                  color = "blue", size = 1, inherit.aes = FALSE)



# plot lin-log-lin
i <- 8
mean_coef_tmp <- tidy(lm_lin_log_lin_l[[i]]) %>% 
    mutate(site = site_df$site[i],
           coef_term = sub(":*cohort....:*", "", term),
           year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
           cohort = as.factor(year_abn)) %>% 
    group_by(coef_term) %>%
    summarise(mean_est = mean(estimate, na.rm = TRUE)) %>% arrange(coef_term)


ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
    geom_point(data = filter(persistence_dat, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
  scale_color_viridis() +
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_lin_log_lin_l[[i]],
                                    newdata = new_dat),
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort])) + 
  geom_function(fun = function(x) {
      mean_coef_tmp$mean_est[2]*log(x-4) + mean_coef_tmp$mean_est[1]*((x-4) - 1) + 1},
      mapping = aes(linetype = "Mean Decay Rate"),
      color = "blue", size = 1, inherit.aes = FALSE)



# ------------------------------------------------ #
# save both log-log and linear-log-linear models, with full extrapolation
# ------------------------------------------------ #
# save plots:
for (i in 1:11) {
  # calculate and extract mean coef estimates:
  mean_coef_tmp <- tidy(lm_lin_log_lin_l[[i]]) %>% 
    mutate(site = site_df$site[i],
           coef_term = sub(":*cohort....:*", "", term),
           year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
           cohort = as.factor(year_abn)) %>% 
    group_by(coef_term) %>%
    summarise(mean_est = mean(estimate, na.rm = TRUE)) %>% arrange(coef_term)
    
  # plot
  gg_lin_log_lin_cohort_tmp <- ggplot(data = filter(persistence_dat, site == site_df$site[i]), 
                                      mapping = aes(x = age, y = proportion, 
                                                    group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log():cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
  
    geom_line(data = mutate(augment(lm_lin_log_lin_l[[i]], 
                                    newdata = new_dat),
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort])) + 
    geom_function(fun = function(x) {
      mean_coef_tmp$mean_est[2]*log(x-4) + mean_coef_tmp$mean_est[1]*((x-4) - 1) + 1},
      mapping = aes(linetype = "Mean Decay Rate"),
      color = "blue", size = 1, inherit.aes = FALSE)
  
  
  # log-log
  gg_log2_cohort_tmp <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point(data = filter(persistence_dat, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) + 
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_log2_l[[i]], 
                                    newdata = new_dat), 
                            age = time + 5,
                            proportion = exp(.fitted),
                            year_abn = as.numeric(levels(cohort))[cohort])) + 
    geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[i]]), na.rm = TRUE))},
                  mapping = aes(linetype = "Mean Decay Rate"),
                  color = "blue", size = 1, inherit.aes = FALSE)
  
  
  y_ranges <- c(ggplot_build(gg_log2_cohort_tmp)$layout$panel_params[[1]]$y.range, 
                ggplot_build(gg_lin_log_lin_cohort_tmp)$layout$panel_params[[1]]$y.range)
  
  png(filename = paste0(p_plots, run_label, "/decay/", "l3_log2_combo_extrapolation", run_label, site_df$label[i], ".png"), 
    width = 13, height = 7.5, units = "in", res = 400)
  
  print(plot_grid(
    gg_log2_cohort_tmp + theme(legend.position = "none") + coord_cartesian(ylim = y_ranges[1:2]), 
    gg_lin_log_lin_cohort_tmp + coord_cartesian(ylim = y_ranges[1:2]),
    ncol = 2, rel_widths = c(1, 1.3), align = "v", axis = "l")
    )
  
  # print(
  #   plot_grid(gg_log2_cohort_tmp + theme(legend.position = "none") + 
  #               scale_y_continuous(lim = c(min(y_ranges), max(y_ranges)),
  #                                  breaks = seq(from = round(min(y_ranges), digits = 1), 
  #                                               to = round(max(y_ranges), digits = 1),
  #                                               by = 0.1)), 
  #             gg_lin_log_lin_cohort_tmp +
  #               scale_y_continuous(lim = c(min(y_ranges), max(y_ranges)),
  #                                  breaks = seq(from = round(min(y_ranges), digits = 1), 
  #                                               to = round(max(y_ranges), digits = 1),
  #                                               by = 0.1)), 
  #             ncol = 2, rel_widths = c(1, 1.3), align = "v", axis = "l")
  #   )
  # 
  dev.off()
}
```


## Model Coef. Plots (lin-log-lin)

```{r plot-mean-coef-per-site-l3}

# quasi half-lives
# lapply(lm_log2_l, FUN = function(i) cc_half_life(i, confint = TRUE)) %>% bind_rows(.id = "site")

mean_coef_df_l3

gg_mean_coef_site_l3 <- 
  ggplot(data = mutate(mean_coef_df_l3, term = fct_relevel(term, c("log", "lin"))),
                            mapping = aes(x = mean, y = fct_reorder2(site, desc(term), desc(mean)))) + 
  theme_classic() +
  geom_point() + 
  geom_errorbar(mapping = aes(xmin = mean_low, xmax = mean_high), width = 0.3) +
  labs(x = "Mean Coefficients", y = NULL, 
       title = "Mean Decay Rates By Site",
       subtitle = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       caption = "Error bars represent the mean of high and low 95% confidence interval coefficient estimates") + 
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme(plot.caption = element_text(face = "italic")) + 
  facet_grid(cols = vars(term), switch = "y",
             labeller = labeller(term = c(#old = "new",
               log = "Log term coefficient", #  {log(time):cohort}
               lin = "Linear term coefficient")), # {(time - 1):cohort}
             scales = "free")

# save
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_coefs_by_site", run_label, ".png"), 
    width = 7, height = 5, units = "in", res = 400)
print(gg_mean_coef_site_l3)
dev.off()

mean_coef_proj_l3$term %>% unique()
View(mean_coef_proj_l3)
View(time_to_l3)
gg_example_proportions_by_site_l3 <-
  ggplot(data = mean_coef_proj_l3 %>% filter(!is.na(term), #term != "p5"
                                             term %in% c("yr_10", "yr_15", "yr_20", "yr_25", "yr_30")
                                             ),
                              mapping = aes(y = mean, x = fct_reorder2(site, desc(term),
                                                                       mean),
                                            ymin = mean_low, ymax = mean_high, #col = site, 
                                            group = term, color = fct_reorder(term, desc(mean)))) + 
  theme_classic() +
  coord_cartesian(ylim = c(0, 1)) +
  # ylim(0, 1) +
  geom_point(position = position_dodge(0.7), size = 1.75) + 
  geom_errorbar(#mapping = aes(ymin = mean_low, ymax = mean_high), 
                width = 0.7, position = position_dodge(0.7)) +
  labs(y = "Proportion of abandoned land remaining", 
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       #caption = "Error bars represent the mean of 95% confidence interval coefficient estimates",
       #title = "Decay rates by site",
       x = "Site" 
       ) + 
  theme(plot.caption = element_text(face = "italic"),
        axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0),
        legend.position = "right"#, plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")
        ) + 
  scale_color_discrete(name = "Proportion \nremaining \nafter: ", 
                      labels = c(yr_5 = "5 years", yr_10 = "10 years", #old = "new",
                                 yr_15 = "15 years", yr_20 = "20 years", 
                                 yr_25 = "25 years", yr_30 = "30 years",
                                 yr_40 = "40 years", yr_50 = "50 years")) #+ 
  # guides(col = guide_legend(ncol = 2, byrow = TRUE))


# save
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_decay_proportions_by_site", run_label, ".png"), 
    width = 8, height = 4.5, units = "in", res = 400)
print(gg_example_proportions_by_site_l3)
dev.off()


```

```{r fitted_df_l3}
mean_coef_df_wide_l3
mean_coef_df_l3
lm_lin_log_lin_l$shaanxi
persistence_dat

mean_coef_l3_mega %>% filter

# make a data.frame with fitted values for the mean coefs for each site's mean decay trend
fitted_df_l3 <- lapply(site_df$site, FUN = function(x) {
  data.frame(site = x,
             time = 1:150 - 1,
             lin_mean = filter(mean_coef_df_wide_l3, site == x)$lin_mean,
             log_mean = filter(mean_coef_df_wide_l3, site == x)$log_mean) %>%
    mutate(fitted = log_mean*log(time + 1) + lin_mean*(time) + 1,
           fitted = ifelse(fitted >= 0, fitted, 0), # fitted proportion can't be less than 0!
           time_to_0.5 = ((log_mean * lambertW0((lin_mean * exp(lin_mean/log_mean + 0.5/log_mean - 1/log_mean))/log_mean))/lin_mean) + 4,
           age = time + 5)
}) %>% bind_rows() %>% as_tibble()



# save fitted_df_l3

write_csv(fitted_df_l3, file = paste0(p_dat_derived, run_label, "/decay_mod_fitted_df_l3", run_label, ".csv"))
# fitted_df_l3 <- read_csv(file = paste0(p_dat_derived, run_label, "/decay_mod_fitted_df_l3", run_label, ".csv"))

fitted_df_l3 %>% group_by(site) %>% summarise(n = n())
```

```{r *fig3-mean-trend-by-site-l3}

time_to_combo %>% 
  filter(proportion == 0.5, mod == "l3", type == "mean") %>%
  select(mod:type, time_to_0.5 = time_to)


# MS Figure 3

gg_model_curves_by_site_l3 <-
  ggplot(
    # data = filter(fitted_df_l3, time < 140),
    data = 
      fitted_combo %>% 
      filter(age < 140, mod == "l3", type == "mean") %>% 
      left_join(time_to_combo %>% 
                  filter(proportion == 0.5, mod == "l3", type == "mean") %>%
                  select(mod:type, time_to_0.5 = time_to)),
    mapping = aes(x = age, y = proportion, color = fct_reorder(site, time_to_0.5))) +
  theme_classic() +
  geom_line(size = 1.1) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +
  geom_hline(yintercept = 0, linetype = "dashed") +

  labs(#title = "Decay of abandoned land over time", 
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site") + 
  # theme(legend.background = element_blank()) + 
  scale_color_discrete(labels = fancy_labels) + 
  guides(col = guide_legend(reverse = FALSE, ncol = 2))


gg_model_curves_by_site_l3 %+% filter(fitted_df_l3, time < 50)
# gg_model_curves_by_site_l3 + geom_vline(xintercept = 25.4)
gg_model_curves_by_site_l3 + 
  geom_vline(xintercept = 20) + 
  geom_hline(yintercept = 0.0746) +
  coord_cartesian(xlim = c(15, 25))



gg_model_curves_by_site_l3 + 
         labs(caption = NULL) +
         scale_x_continuous(n.breaks = 15) + 
         theme(legend.position = c(0.875, 0.65)) +
  # scale_color_viridis(discrete = TRUE)
  scale_color_manual(values = c( "light blue" , "orange" , "light yellow" , "pink" , "light cyan",  "mint" , 'pear' , "olive" , "pale grey"))

# -------------------------------------------------------------------------------- #
# Save Figure 3 for Manuscript
# -------------------------------------------------------------------------------- #
ggsave(plot =
         gg_model_curves_by_site_l3 + 
         labs(caption = NULL) +
         scale_x_continuous(n.breaks = 15) + 
         theme(legend.position = c(0.76, 0.76),
               # legend.spacing.y = unit(4, 'mm')
               # legend.key.size = unit(7, 'mm')
               legend.background = element_blank()
               ),
       filename = paste0(p_plots, "/fig3_tall", run_label, ".pdf"),
         # old path name
         # paste0(p_plots, run_label, "/decay/", "mean_decay_curves", run_label, ".pdf"), 
       width = 7, height = 4, units = "in", dpi = 400)

ggsave(plot =
         gg_model_curves_by_site_l3 + 
         labs(caption = NULL) +
         scale_x_continuous(n.breaks = 15) + 
         theme(legend.position = c(0.76, 0.70)),
       filename = paste0(p_plots, "/fig3", run_label, ".pdf"),
       width = 7, height = 3.5, units = "in", dpi = 400)



# extras 
# cropped:
png(filename = paste0(p_plots, run_label, "/decay/", "model_decay_curves_by_site_l3", run_label, ".png"), 
    width = 7, height = 6, units = "in", res = 400)
print(gg_model_curves_by_site_l3 %+% 
        filter(fitted_df_l3, time < 50)
      )
dev.off()


# save wide
png(filename = paste0(p_plots, run_label, "/decay/", "model_decay_curves_by_site_l3_wide", run_label, ".png"), 
    width = 10, height = 5, units = "in", res = 400)
print(gg_model_curves_by_site_l3 + 
        scale_x_continuous(n.breaks = 15) + 
        theme(legend.position = c(0.9, 0.65)))
dev.off()

# combo
png(filename = paste0(p_plots, run_label, "/decay/", "model_decay_curves_by_site_l3_combo", run_label, ".png"), 
    width = 10.5, height = 6, units = "in", res = 400)
print(plot_grid(gg_model_curves_by_site_l3 + theme(legend.position = "none") + labs(caption = ""),
                gg_model_curves_by_site_l3 %+% 
                  filter(fitted_df_l3, time < 50) + 
                  theme(legend.position = "none"),
                cowplot::get_legend(gg_model_curves_by_site_l3),
                ncol = 3, rel_widths = c(1, 1, 0.4)))
dev.off()




gg_model_curves_by_site_l3 + coord_cartesian(xlim = c(4.9, 5.1), ylim = c(0.9, 1.1))



# could also manually reorder the factors like so:
coef_level_order <- mean_coef_proj %>% 
  filter(term == "coef") %>% 
  arrange(desc(mean)) %>% 
  select(site) %>% 
  unlist(use.names = FALSE)

mean_coef_df %>% mutate(site = fct_relevel(site, coef_level_order)) %>% .$site
```

```{r fig3-w-ci}
ci_tmp <- 
  # mean_traj_ci %>%
  mean_traj_ci_trim %>%
  # update proportions to 0 if less than 0.
  mutate(estimate = ifelse(estimate >= 0, estimate, 0),
         conf.low = ifelse(conf.low >= 0, conf.low, 0),
         conf.high = ifelse(conf.high >= 0, conf.high, 0)
         ) %>%
  filter(age < 140)

time_to_combo

# plot
gg_model_curves_by_site_w_ci <-
# gg_model_curves_by_site_w_ci_trim <-
  ggplot(
    data = 
      mean_traj_ci %>%
      # mean_traj_ci_trim %>%
      # update proportions to 0 if less than 0.
      mutate(estimate = ifelse(estimate >= 0, estimate, 0),
             conf.low = ifelse(conf.low >= 0, conf.low, 0),
             conf.high = ifelse(conf.high >= 0, conf.high, 0)) %>%
      filter(age < 140) %>%
      left_join(time_to_combo %>% 
                  filter(proportion == 0.5, mod == "l3", type == "mean") %>% 
                  select(site, time_to)),
       mapping = aes(x = age, y = estimate, 
                     ymin = conf.low, ymax = conf.high, 
                     color = fct_reorder(site, time_to), 
                     group = fct_reorder(site, time_to), 
                     fill = fct_reorder(site, time_to)
                     )) +
  theme_classic() +
  coord_cartesian(ylim = c(0, 1)) +
  # add 95% confidence intervals
  geom_ribbon(alpha = 0.1, show.legend = FALSE, size = 0) +
  
  # add mean trajectories
  geom_line(size = 1.1) +
  
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +
  geom_hline(yintercept = 0, linetype = "dashed") +

  labs(#title = "Decay of abandoned land over time", 
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site") + 
  # theme(legend.background = element_blank()) +
  scale_color_discrete(labels = fancy_labels) + 
  guides(color = guide_legend(reverse = FALSE, ncol = 2,
                              override.aes = list(size = 4)))
  

# save figure
  
ggsave(plot =
         gg_model_curves_by_site_w_ci + 
         labs(caption = NULL) +
         scale_x_continuous(n.breaks = 15) + 
         theme(legend.position = c(0.76, 0.70)),
       filename = paste0(p_plots, "/fig3_ci", run_label, ".pdf"),
       width = 7, height = 3.5, units = "in", dpi = 400)

ggsave(plot =
         gg_model_curves_by_site_w_ci_trim + 
         labs(caption = NULL) +
         scale_x_continuous(n.breaks = 15) + 
         theme(legend.position = c(0.76, 0.70)),
       filename = paste0(p_plots, "/fig3_ci_trim", run_label, ".pdf"),
       width = 7, height = 3.5, units = "in", dpi = 400)


  
```

```{r plot-multiple-mean-trajectories}

# just individual trajectories:
gg_mean_decay_by_mod <-
  ggplot(
    # data = fitted_df_l3 %>% filter(age < 140),
    # mapping = aes(x = age, y = fitted, color = fct_reorder(site, time_to_0.5))

    data = fitted_combo %>% filter(age < 140, #mod == "l3", 
                                   !type %in% c("no_cohort", "w_obs")),
    mapping = aes(x = age, y = proportion, color = site, linetype = type)
    ) +
  theme_classic() +
  geom_line(size = 1.1) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site") + 
  scale_color_discrete(labels = fancy_labels) + 
  scale_linetype_discrete(labels = c("mean" = "Mean coef.",
                                "w_obs"= "Mean weighted \nby # obs.",
                                "w_uncertainty"= "Mean weighted\nby inverse uncertainty"),
                       name = "Site mean decay rates"
                     ) + 
  guides(col = guide_legend(reverse = FALSE, ncol = 1)) + 
         scale_x_continuous(n.breaks = 15) + 
  # theme(legend.position = c(0.76, 0.70)) + 
  facet_grid(mod ~ type)

# -------------------------------------------------------------------------------- #
# Save composite figure
# -------------------------------------------------------------------------------- #

ggsave(plot =
         gg_mean_decay_by_mod,
       filename = paste0(p_plots, run_label, "/decay/", "mean_decay_by_mod", run_label, ".pdf"),
       width = 10, height = 8, units = "in", dpi = 400)

# -------


gg_decay_alt_means <-
  ggplot(data = persistence_dat, 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)
       ) + 
    theme_classic() + 
   geom_point(size = 0.8) + 
    scale_color_viridis(discrete = FALSE, name = "Cohort (Year Abandoned)") +
    facet_wrap(vars(site), nrow = 3, scales = "free",
             labeller = as_labeller(cap_update_labels)) +
  
   # fitted lines
    # geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
    #                         time = round(exp(`log(time + 1)`), digits = 0) - 1,
    #                         age = time + 5,
    #                         proportion = .fitted + 1,
    #                         year_abn = as.numeric(levels(cohort))[cohort]),
    #           linetype = 5, #5, #"longdash"
    #           aes(alpha = "Fitted")) +
    #   scale_alpha_manual(name = NULL,
    #                  values = c(1), # breaks = c(0, "Fitted"),
    #                  guide = guide_legend(
    #                    order = 2,
    #                    override.aes = list(
    #                      # size = 0.5, 
    #                      # linetype = 6, size = 1.15 #
    #                      # color = brewer_pal(palette = "Greens")(6)[6]
    #                    ))) +
  
    # add mean trajectories
  new_scale_color() +
  geom_line(data = fitted_combo %>% filter(age < 31, mod == "l3", 
                                           type != "no_cohort"
                                           ), 
            mapping = aes(x = age, y = proportion, 
                          # linetype = mod,
                          color = type),
              size = 1, inherit.aes = FALSE) +
  scale_color_discrete(labels = c("mean" = "Mean coef.",
                                "w_obs"= "Mean weighted \nby # obs.",
                                "w_uncertainty"= "Mean weighted\nby inverse uncertainty"),
                       name = "Site mean decay rates"
                     ) + 

  # scale_linetype_manual(
  #   name = "Model spec.",
  #   labels = c("l3" = "p-1 ~ a*log(t+1) + b*t",
  #              "lin_log" = "p-1 ~ a*log(t+1)",
  #              "log2-lin" = "log(p) ~ a*log(t+1) + b*t"
  #              # "l3_no_cohort" = "Decay Rate Without\nCohort Fixed Effects",
  #              # "w_mean" = "Weighted Mean\nAcross Cohorts"
  #              ),
  #   values = c(1, 2, 3)) +
  
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining") + 

  theme(
    legend.position = c(0.87, 0.14),
    # legend.spacing = unit(2, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1))


ggsave(plot = gg_decay_alt_means, 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid_alt_means", run_label, ".pdf"), 
    width = 11, height = 9, units = "in")

```

```{r mean-trajectory-ci}
mean_coef_l3_mega
# ---------------------------------------------------------------------------- #
# Based on the mean coefficient value (and it's confidence intervals), 
# calculate the mean trajectory, and upper and lower limit for plotting.
# ---------------------------------------------------------------------------- #
fitted_df_l3$age %>% unique()
time_span <- 5:154 # 5:30

mean_traj_ci <-
  mean_coef_l3_mega %>%
  # mean_coef_l3_mega_trim %>%
  # filter(site == "shaanxi") %>%
  select(site, coef_term, estimate, conf.low, conf.high) %>%
  pivot_longer(cols = c(estimate, conf.low, conf.high), values_to = "value") %>%
  pivot_wider(id_cols = c(site, name), names_from = coef_term, values_from = "value") %>%
  left_join(
    tibble(  
      site = rep(site_df$site, each = length(time_span)),
      age = rep(time_span, length(site_df$site))), 
    by = "site") %>%
  mutate(proportion = log * log(age-4) + lin * ((age-4) - 1) + 1) %>%
    select(site, age, name, proportion) %>%
    pivot_wider(id_cols = c(site, age), names_from = name, values_from = "proportion")


mean_traj_ci_trim <- 
  mean_coef_l3_mega_trim %>%
  select(site, coef_term, estimate, conf.low, conf.high) %>%
  pivot_longer(cols = c(estimate, conf.low, conf.high), values_to = "value") %>%
  pivot_wider(id_cols = c(site, name), names_from = coef_term, values_from = "value") %>%
  left_join(
    tibble(  
      site = rep(site_df$site, each = length(time_span)),
      age = rep(time_span, length(site_df$site))), 
    by = "site") %>%
  mutate(proportion = log * log(age-4) + lin * ((age-4) - 1) + 1) %>%
    select(site, age, name, proportion) %>%
    pivot_wider(id_cols = c(site, age), names_from = name, values_from = "proportion")


  


# ---------------------------------------------------------------------------- #
# First, plot the full decay model grid with the mean trajectory as a confidence interval (based on the confidence interval around the mean value estimated by the linear regression above)
# ---------------------------------------------------------------------------- #

gg_decay_grid_w_mean_traj_ci_base <- 
  ggplot(data = persistence_dat, 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
  labs(x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Cohort \n(Year Abandoned)",
       caption = "Including all cohorts, irrespective of number of observations.") + 
   geom_point(size = 1) + # raw data
    scale_color_viridis(discrete = FALSE) +
    facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels)) + 
  
   # fitted lines
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort]),
              linetype = 5, #show.legend = FALSE,
              aes(alpha = "Fitted")) +
      scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2
                       )) +

    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") +
  
  theme(
    legend.position = c(0.9, 0.13),
    legend.spacing = unit(0, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1))


# untrimmed version
gg_decay_grid_w_mean_traj_ci <- 
  gg_decay_grid_w_mean_traj_ci_base +
  # add mean trajectories
  geom_line(data = mean_traj_ci %>% filter(age < 31), 
            mapping = aes(x = age, y = estimate),
              color = "red",
              size = 1, inherit.aes = FALSE) +
  
  # add 95% confidence intervals
  geom_ribbon(data = mean_traj_ci %>% filter(age < 31),
                mapping = aes(x = age, 
                              y = estimate, 
                              ymin = conf.low,
                              ymax = conf.high),
              color = "red", fill = "red",
                alpha = 0.1, inherit.aes = FALSE)

# save:
ggsave(plot = gg_decay_grid_w_mean_traj_ci,
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_w_mean_traj_ci", run_label, ".pdf"),
    width = 11, height = 9, units = "in")



# now, plot the trimmed version (no. observations >= 5):
rm(gg_decay_grid_w_mean_traj_ci_trim2)
gg_decay_grid_w_mean_traj_ci_trim <- 
  
  ggplot(data = persistence_dat %>% filter(year_abn < 2010), 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
  labs(x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
       caption = "Restricted to cohorts with >= 5 observations (excluding 2010, '11, '12, '13)") + 
   geom_point(size = 1) + # raw data
    scale_color_viridis(discrete = FALSE) +
    facet_wrap(vars(site), nrow = 3,
             labeller = as_labeller(cap_update_labels)) + 
  
   # fitted lines
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort]) %>%
                filter(year_abn < 2010),
              linetype = 5, #show.legend = FALSE,
              aes(alpha = "Fitted")) +
      scale_alpha_manual(name = NULL,
                     values = c(1), # breaks = c(0, "Fitted"),
                     guide = guide_legend(
                       order = 2
                       )) +

    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") +
  
  theme(
    legend.position = c(0.9, 0.13),
    legend.spacing = unit(0, units = "mm"), 
    legend.background = element_blank(),
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +
  
  # add mean trajectories
  geom_line(data = mean_traj_ci_trim %>% filter(age < 31), 
            mapping = aes(x = age, y = estimate),
              color = "red",
              size = 1, inherit.aes = FALSE) +
  
  # add 95% confidence intervals
  geom_ribbon(data = mean_traj_ci_trim %>% filter(age < 31),
                mapping = aes(x = age, 
                              y = estimate, 
                              ymin = conf.low,
                              ymax = conf.high),
              color = "red", fill = "red",
                alpha = 0.1, inherit.aes = FALSE)

# save:
ggsave(plot = gg_decay_grid_w_mean_traj_ci_trim,
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_w_mean_traj_ci_trim", run_label, ".pdf"),
    width = 11, height = 9, units = "in")


```

## Alternative model specs

```{r save-lin-log-basic-model-plots}
# ------------------------------------------------ #
# lin-log model, with cohort fixed effects
# ------------------------------------------------ #
# save plots:
for (i in 1:11) {
  
  gg_lin_log_cohort_tmp <- 
    ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
        theme_classic() +
    geom_point(data = filter(persistence_dat, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) + 
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_lin_log_l[[i]]), 
                          year_abn = as.numeric(levels(cohort))[cohort],
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          age = time + 1 + 4,
                          proportion = .fitted + 1)) + 
    
    # average (needs to be transformed 4 to the right, so that plotting works)
    geom_function(fun = function(x) {(mean(coef(lm_lin_log_l[[i]]), na.rm = TRUE))*log(x-4) + 1},
                  mapping = aes(linetype = "Mean Decay Rate"),
                  color = "blue", size = 1, inherit.aes = FALSE)
  
  png(filename = paste0(p_plots, run_label, "/decay/", "lin-log_cohort", run_label, site_df$label[i], ".png"), 
    width = 8, height = 6, units = "in", res = 400)
  print(gg_lin_log_cohort_tmp)
  dev.off()
  
}
```

```{r save-log-log-basic-model-plots}
# ------------------------------------------------ #
# log-log model, with cohort fixed effects
# ------------------------------------------------ #
# save plots:
for (i in 1:11) {
  
  gg_log2_cohort_tmp <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
        theme_classic() + 
    geom_point(data = filter(persistence_dat, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) + 
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_log2_l[[i]]), 
                          year_abn = as.numeric(levels(cohort))[cohort]),
            aes(x = exp(`log(time + 1)`) + 4, y = exp(.fitted))) + 
    
    # average (needs to be transformed 4 to the right, so that plotting works)
    geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[i]]), na.rm = TRUE))},
                  mapping = aes(linetype = "Mean Decay Rate"),
                  color = "blue", size = 1, inherit.aes = FALSE)
  
  png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort", run_label, site_df$label[i], ".png"), 
    width = 8, height = 6, units = "in", res = 400)
  print(gg_log2_cohort_tmp)
  dev.off()
  
}
```

```{r save-combo-basic-model-plots}
# ------------------------------------------------ #
# both log-log and linear-log-linear models, together
# ------------------------------------------------ #
# save plots:

for (i in 1:11) {
  
  # log-log
  gg_log2_cohort_tmp <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
        theme_classic() + 
    geom_point(data = filter(persistence_dat, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) + 
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(subtitle = "log-log model", 
         title = site_df$description[i], 
         caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_log2_l[[i]]), 
                          year_abn = as.numeric(levels(cohort))[cohort],
                          age = exp(`log(time + 1)`) + 4,
                          proportion = exp(.fitted))) + 
    geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[i]]), na.rm = TRUE))},
                  mapping = aes(linetype = "Mean Decay Rate"),
                  color = "blue", size = 1, inherit.aes = FALSE)
  
  # calculate and extract mean coef estimates:
  mean_coef_tmp <- tidy(lm_lin_log_lin_l[[i]]) %>% 
    mutate(site = site_df$site[i],
           coef_term = sub(":*cohort....:*", "", term),
           year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
           cohort = as.factor(year_abn)) %>% 
    group_by(coef_term) %>%
    summarise(mean_est = mean(estimate, na.rm = TRUE)) %>% arrange(coef_term)
    
  # plot
  gg_lin_log_lin_cohort_tmp <- ggplot(data = filter(persistence_dat, site == site_df$site[i]), 
                                      mapping = aes(x = age, y = proportion, 
                                                    group = year_abn, color = year_abn)) + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(subtitle = "lin-log-lin model", 
         title = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
  
    geom_line(data = mutate(augment(lm_lin_log_lin_l[[i]]),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 1 + 4,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort])) + 
    geom_function(fun = function(x) {
      mean_coef_tmp$mean_est[2]*log(x-4) + mean_coef_tmp$mean_est[1]*((x-4) - 1) + 1},
      mapping = aes(linetype = "Mean Decay Rate"),
      color = "blue", size = 1, inherit.aes = FALSE) + 
    theme(legend.position = "none")

  
  
  y_ranges <- c(ggplot_build(gg_log2_cohort_tmp)$layout$panel_params[[1]]$y.range, 
                ggplot_build(gg_lin_log_lin_cohort_tmp)$layout$panel_params[[1]]$y.range)
  
  png(filename = paste0(p_plots, run_label, "/decay/", "l3_log2_combo", run_label, site_df$label[i], "_2.png"), 
    width = 11, height = 6, units = "in", res = 400)
  
  print(
    plot_grid(gg_log2_cohort_tmp + theme(legend.position = "none") +
                scale_y_continuous(lim = c(min(y_ranges), max(y_ranges)),
                                   breaks = seq(from = round(min(y_ranges), digits = 1), 
                                                to = round(max(y_ranges), digits = 1),
                                                by = 0.1)), 
              gg_lin_log_lin_cohort_tmp +
                scale_y_continuous(lim = c(min(y_ranges), max(y_ranges)),
                                   breaks = seq(from = round(min(y_ranges), digits = 1), 
                                                to = round(max(y_ranges), digits = 1),
                                                by = 0.1)), 
              cowplot::get_legend(gg_log2_cohort_tmp),
                ncol = 3, rel_widths = c(1, 1, 0.25))
    )
  dev.off()
}

```

```{r l3-no-cohort-fixed-effects-basic plots}
lm_l3_no_cohort_l

mean_coef_tmp
i <- 9
for (i in 1:11) {
  # calculate and extract mean coef estimates:
  mean_coef_tmp_no_cohort <- 
    tidy(lm_l3_no_cohort_l[[i]]) %>% 
    rename(coef_term = term) %>%
    mutate(site = site_df$site[i],
           term = ifelse(grepl("log", coef_term), "log", "lin"))
    
  # plot
  gg_l3_no_cohort_tmp <-
    ggplot(data = filter(persistence_dat, site == site_df$site[i]), 
                                      mapping = aes(x = age, y = proportion, 
                                                    group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year First \nAbandoned)",
         linetype = "") + 
  
    geom_line(data = mutate(augment(lm_l3_no_cohort_l[[i]]),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1
                            # ,
                            # year_abn = as.numeric(levels(cohort))[cohort]
                            ), 
              mapping = aes(x = age, y = proportion), 
              inherit.aes = FALSE) + 
    
  
    # site mean coefficients: (note, needs to be transformed 4 to the right, so that plotting works)
    geom_function(fun = function(x) {
        filter(mean_coef_tmp_no_cohort, term == "log")$estimate * log(x-4) +
          filter(mean_coef_tmp_no_cohort, term == "lin")$estimate * ((x-4) - 1) + 1},
      mapping = aes(linetype = "Mean Decay Rate \n(No fixed effects)"),
      color = "blue", size = 1, inherit.aes = FALSE) #+ theme(legend.position = c(0.9, 0.82))
  
  
  png(filename = paste0(p_plots, run_label, "/decay/", "l3_no_cohort", run_label, site_df$label[i], ".png"), 
    # width = 6.5, height = 6, 
    width = 7, height = 6, 
    units = "in", res = 400)
  print(gg_l3_no_cohort_tmp)
  dev.off()
}

```

```{r plot-nebraska-log2-v-log-lin}
dat %>% select(-proportion)

gg_nebraska_log2 <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = filter(persistence_dat, site == "nebraska")) + scale_color_distiller(palette = "Greens") + 
  #scale_x_continuous(n.breaks = 30) + 
  scale_y_continuous(limits = c(0.4, 1)) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(title = "Decay of abandoned land over time", subtitle = site_df$description[7], 
       caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
       x = "Time since initial abandonment (years)", y = "Proportion of abandoned land remaining",
       color = "Cohort (Year \nFirst Abandoned)") + 
  
  # log-log
  geom_line(data = mutate(augment(lm_log2_l$nebraska, 
                                  newdata = filter(persistence_dat, site == "nebraska") %>% select(-proportion)),
                          proportion = exp(.fitted))) + 
  
  # average (needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l$nebraska), na.rm = TRUE))},
                mapping = aes(linetype = "Mean Decay Rate"),
                color = "blue", size = 1, #linetype = "dashed", 
                inherit.aes = FALSE) + 
  scale_linetype(name = "")
  

gg_nebraska_log_lin <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = filter(persistence_dat, site == "nebraska")) + scale_color_distiller(palette = "Greens") + 
  #scale_x_continuous(n.breaks = 30) + 
  scale_y_continuous(limits = c(0.4, 1)) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(title = "Decay of abandoned land over time", subtitle = site_df$description[7], 
       caption = "lm formula: log(proportion) ~ 0 + time:cohort",
       x = "Time since initial abandonment (years)", y = "Proportion of abandoned land remaining",
       color = "Cohort (Year \nFirst Abandoned)") + 
  
  # log-lin
  geom_line(data = mutate(augment(lm_log_lin_l$nebraska, 
                                  newdata = filter(persistence_dat, site == "nebraska") %>% select(-proportion)),
                          proportion = exp(.fitted))) + 
  
  # average (needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) {exp( mean(coef(lm_log_lin_l$nebraska), na.rm = TRUE)* (x - 5))},
                mapping = aes(linetype = "Mean Decay Rate"),
                color = "blue", size = 1, #linetype = "dashed", 
                inherit.aes = FALSE) + 
  scale_linetype(name = "")


# save the plot
png(filename = paste0(p_plots, run_label, "/decay/", "nebraska_log2_log_lin", run_label, ".png"), 
    width = 10, height = 5, units = "in", res = 400)
print(plot_grid(gg_nebraska_log2, gg_nebraska_log_lin + theme(legend.position = "none"),
                rel_widths = c(1.4, 1)))
dev.off()


```




## Presentation figures

```{r shaanxi-basic-plots}
# ---------------------------------------------------- #
# just Shaanxi

gg_shaanxi_decay_base <- 
  ggplot(data = persistence_dat %>% filter(site == "shaanxi"), 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    # scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort\n(Year Abandoned)",
         linetype = "") + 
  scale_x_continuous(breaks = seq(5, 30, by = 5)) +
  theme(legend.position = c(0.87, 0.75),
        legend.spacing = unit(2, units = "mm"),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0))

gg_shaanxi_decay_trends <-
  gg_shaanxi_decay_base + 
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort]) %>% 
               filter(site == "shaanxi"))

gg_shaanxi_decay_trends_w_mean <-
  gg_shaanxi_decay_trends +
  geom_line(data = fitted_l3_mega %>% filter(mod == "l3") %>% filter(site == "shaanxi"), 
            mapping = aes(x = age, y = proportion, linetype = mod),
              # color = brewer_pal(palette = "PiYG")(11)[2], # dark pink
              color = "blue",
              size = 1, inherit.aes = FALSE) +
  scale_linetype_discrete(label = c("l3" = "Mean Decay Rate\n(Across Cohorts)",
                                      "l3_no_cohort" = "Decay Rate (No F.E.)")) # + 
  # theme(legend.position = c(0.85, 0.75),
  #       legend.spacing = unit(2, units = "mm"),
  #       legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  # coord_cartesian(ylim = c(0.5, 1)) #+
  #facet_wrap(vars(site), nrow = 2)


# ---------------------------------------------------------- #
# just shaanxi, for presentation:
# ---------------------------------------------------------- #

# just the data points:
ggsave(plot = gg_shaanxi_decay_base, 
       filename = paste0(p_plots, run_label, "/presentation/", "decay_mod_example_shaanxi_points", run_label, ".pdf"), 
    width = 6.25, height = 5, units = "in")

# with trends:
ggsave(plot = gg_shaanxi_decay_trends, 
       filename = paste0(p_plots, run_label, "/presentation/", "decay_mod_example_shaanxi_trends", run_label, ".pdf"), 
    width = 6.25, height = 5, units = "in")

# with trends, and mean:
ggsave(plot = gg_shaanxi_decay_trends_w_mean, 
       filename = paste0(p_plots, run_label, "/presentation/", "decay_mod_example_shaanxi_trends_w_mean", run_label, ".pdf"), 
    width = 6.25, height = 5, units = "in")
```


```{r decay-plot-simple}
# super simplified version:
gg_decay_simple <-
  ggplot() + 
    theme_classic() + 
    geom_hline(yintercept = 0.5, linetype = "dashed") +
    labs(x = "t", 
         y = expression(P[y])) + 
  scale_x_continuous(breaks = seq(5, 30, by = 5)) +
  geom_line(data = fitted_l3_mega %>% filter(mod == "l3") %>% filter(site == "mato_grosso"), 
            mapping = aes(x = age, y = proportion, linetype = mod),
              color = brewer_pal(palette = "Greens")(9)[7], 
              size = 1, inherit.aes = FALSE) + 
    theme(legend.position = "none")

ggsave(plot = gg_decay_simple, 
       filename = paste0(p_plots, run_label, "/presentation/", "decay_simple_example", run_label, ".pdf"), 
    width = 2, height = 2, units = "in")
```

# Rate of change of half-lives through time

```{r calculate-half-life-l3}
# how long does it take for each site to reach p = 0.5?
# In order to find the "half-life," we need to put the linear model equation in terms of time (t).
# The linear model equation is 
# "I(proportion - 1)  ~ 0 + log(time + 1):cohort:site + I(time):cohort:site", 
# which I simplify to:
# p - 1 = a log(u) + b(u-1)
# where p = proportion, u = time + 1,
# a is the coefficient on log(time + 1), and 
# b is the coefficient on the linear term of time (or time + 1 - 1)

# Solve this equation for the time term, u: 
# solve a log(u) + b(u-1) + 1 - p = 0 for u

# WolframAlpha yields the following:
# u = (a W((b e^(b/a + p/a - 1/a))/a))/b
# where W(z) # is the product log function, also known as the Lambert W function:
# https://en.wikipedia.org/wiki/Lambert_W_function

# In our case, u = t + 1, so we're really solving for t + 1
# In order to calculate the age of abandonment, we do the following:
# t = u - 1; age = t + 5;
# age = u - 1 + 5 = u + 4

# u = (a W((b e^(b/a + p/a - 1/a))/a))/b >>>
# age = (a W((b e^(b/a + p/a - 1/a))/a))/b + 4


# install.packages("lamW")
library(lamW)
lambertW0()


# print half-lives for each site:
for (i in 1:11) {
  a <- filter(mean_coef_df_wide_l3, site == site_df$site[i])$log_mean # log coef
  b <- filter(mean_coef_df_wide_l3, site == site_df$site[i])$lin_mean # lin coef
  p <- 0.5 # proportion of interest 
  
  print(site_df$site[i])
  print((a * lambertW0((b * exp((b + p - 1)/a))/a))/b + 4)
}



# plot mean half times for each site:
gg_time_to_0.5_l3 <- ggplot(data = mean_coef_df_wide_l3,
                          mapping = aes(x = fct_reorder(site, desc(time_to_0.5)), 
                                        y = time_to_0.5, color = site)) + 
  theme_classic() +
  geom_point(size = 2) + 
  # geom_errorbar(mapping = aes(ymin = time_to_0.5_low, ymax = time_to_0.5_high), width = 0.3) +
  labs(y = "Mean Time to Half (Years)", x = "Site", 
       title = "Time required for abandoned land to decay by half",
       # caption = "Error bars represent the mean of high and low cofficients from 95% confidence interval",
       subtitle = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort"
       ) + 
  # geom_vline(xintercept = 0, linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none", plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm"))

# save
png(filename = paste0(p_plots, run_label, "/decay/", "time_to_0.5_l3", run_label, ".png"), 
    width = 6, height = 5, units = "in", res = 400)
print(gg_time_to_0.5_l3)
dev.off()

coef_df_wide_l3 %>% select(site, mean_time_to_0.5) %>% unique() %>% arrange(mean_time_to_0.5)




# time to various proportions...
time_to_l3 %>% select(time_to_0.5, time_to_value, proportion) %>% print(n=55)

time_to_l3 %>% select(-contains(c("low", "high")))


# --------------------------------------------------------- #
# alternative visualization of how quickly things decay
# time from 1 to 0.5
# --------------------------------------------------------- #

gg_time_to_range_l3 <-
  ggplot(data = time_to_l3 %>% filter(p >= 0.5),
       mapping = aes(y = fct_reorder(site, desc(time_to_0.5)), 
                     x = time_to_value, group = site, fill = p)) + 
  theme_classic() +
  geom_point(size = 4, pch = 21) + 
  labs(x = "Decay time to proportion (Years)", y = NULL, # "Site", 
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       fill = "Proportion \nremaining:") +
  scale_fill_distiller(palette = "Greens", direction = 1) + 
  theme(legend.position = c(0.9, 0.70)) + 
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_x_continuous(breaks = seq(from = 5, to = 50, by = 5))

# save
png(filename = paste0(p_plots, run_label, "/decay/", "time_to_range_l3", run_label, ".png"), 
    width = 5, height = 4, units = "in", res = 400)
print(gg_time_to_range_l3)
dev.off()


# --------------------------------------------------------- #
# time to go from 1 to 0
# --------------------------------------------------------- #
gg_time_to_range_all_l3 <-
  ggplot(data = time_to_combo %>% filter(mod == "l3", type == "mean"),
       mapping = aes(y = fct_reorder(site, desc(time_to)), 
                     x = time_to, group = site, fill = proportion)) + 
  theme_classic() +
  geom_point(size = 4, pch = 21) + 
  labs(x = "Full decay time (Years)", y = NULL, # "Site", 
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       fill = "Proportion \nremaining:") +
  scale_fill_distiller(palette = "Greens", direction = 1) + 
  theme(legend.position = c(0.9, 0.70)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_x_continuous(breaks = seq(from = 0, to = 140, by = 10))

# save
pdf(file = paste0(p_plots, run_label, "/decay/", "time_to_range_all_l3", run_label, ".pdf"), 
    width = 7, height = 4#, units = "in", res = 400
    )
print(gg_time_to_range_all_l3)
dev.off()
```

```{r plot-coef-all-sites-l3}

# plot all cohort coefficients with linear trend, on a facet_grid by site
gg_cohort_coefs_grid <-
  ggplot(data = 
           half_lives_all_cohorts_l3 %>%
           left_join(., select(lincom_ci, site, rate_of_change = estimate), by = "site"),
       mapping = aes(x = year_abn, y = time_to_0.5#, group = site, color = site
                     )) + 
  theme_classic() +
  geom_point(position = position_jitter()) + 
  labs(y = "Half-life (time for 50% recultivation, in years)",
       x = "Year of initial abandonment", 
       color = "Site") + 
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "bottom",
        plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  geom_smooth(method = "lm", se = TRUE) +
  # facet_wrap(vars(site), scales = "free_y") #+
  facet_wrap(vars(fct_reorder(site, rate_of_change)), 
             nrow = 4, ncol = 3,
             scales = "free_y",
             labeller = as_labeller(cap_update_labels))  # see _util_misc.R



# with quadrants:
coef_df_l3 %>% group_by(site, term) %>% summarise(count = n())

coef_df_wide_l3 %>% select(site, mean_time_to_0.5) %>% unique() %>% arrange(mean_time_to_0.5)

gg_l3_cohort_coef_all <-
  ggplot(data = coef_df_wide_l3 %>% 
           arrange(mean_time_to_0.5) %>%
           mutate(site_reorder = rep(1:11, each = length(cohort_range)),
                  cluster = cut(site_reorder, breaks = c(1, 3, 6, 9, 11),
                                labels = c("a", "b", "c", "d"), 
                                include.lowest = TRUE),
                  time_to_0.5_breaks = cut(mean_time_to_0.5, breaks = 4)),
         mapping = aes(x = year_abn, y = time_to_0.5, color = fct_reorder(site, mean_time_to_0.5))) +
  theme_classic() +
  geom_point(size = 2) + 
  labs(y = "Time for half of cohort to be recultivated (years)",
       x = "Cohort (Year of Initial Abandonment)", 
       # title = "Model Coefficients", 
       # caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       color = "Site") + 
  theme(legend.position = "right", 
        plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  geom_smooth(method = "lm", se = FALSE)  + 
  facet_wrap(~ cluster, scales = "free_y",
             labeller = labeller(cluster = c(#old = "new",
               a = "Q1, mean half time \n(fastest recultivation)",
               b = "Q2, mean half time",
               c = "Q3, mean half time",
               d = "Q4, mean half time \n(slowest recultivation)")))



# ------------------------------------------------------------- #
# save:
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_coefs_all", run_label, ".png"), 
    width = 9, height = 7, units = "in", res = 400)
print(gg_l3_cohort_coef_all)
dev.off()
# ------------------------------------------------------------- #

ggplot(data = coef_df_wide_l3 %>% filter(site == "belarus"),
       mapping = aes(x = year_abn, y = time_to_0.5)) + 
  theme_classic() +
  geom_point(position = position_jitter()) + 
  # geom_errorbar(mapping = aes(ymin = conf.low, ymax = conf.high), width = 0.3) +
  labs(y = "Time for 50% recultivation (in years)",
       x = "Year of initial abandonment", 
       # title = "Half Times",
       # subtitle = "lin-log-lin model",
       # caption = "Error bars represent 95% confidence interval",
       color = "Site") + 
  theme(#axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "bottom",
        plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  geom_smooth(method = "lm", se = TRUE) #+
  
  geom_function(fun = function(x) {exp(coef(lm_mod)[2]*x + coef(lm_mod)[1])},
                color = "blue", size = 1)
coef_df2_l3
```

```{r l3-rate-of-change}
# --------------------------------------------------------------------------- #
# calculate linear model for time to half for each cohort, full model including all sites:

lm_coef_l3 <- lm(time_to_0.5 ~ year_abn * site - 1, data = filter(half_lives_all_cohorts_l3, !is.na(time_to_0.5)))
half_lives_all_cohorts_l3

# diagnostic plots

plot(lm_coef_l3, 1)
plot(lm_coef_l3, 2)


png(filename = paste0(p_plots, run_label, "/decay/", "rate_of_change_l3_diag_full_mod", run_label, ".png"), 
    width = 8, height = 5, units = "in", res = 400)
par(mfrow = c(1, 2))
plot(lm_coef_l3, 1:2)
dev.off()

```

```{r *l3-roc-lincom}
# Following discussion with Oscar, May 18, 2021
# Oscar's recommendation was to do the linear combination of model coefficients 
# I ended up using multcomp, rather than car

# car::linearHypothesis(lm_coef_l3, c("year_abn + year_abn:sitewisconsin = 0"))

install.packages("multcomp")
library(multcomp)

coef_sites <- names(coef(lm_coef_l3)) %>% #Extract the coefficient names, tidy(lm_coef_l3)$term also works
  grep("abn", ., value = TRUE)

lm_coef_l3 %>%
  glht(., linfct = paste0("year_abn + ", coef_sites[2], " = 0")) %>%
  confint() %>% tidy()

lincom_ci <- lapply(2:11, function(i) {
  lm_coef_l3 %>%
    glht(., linfct = paste0("year_abn + ", coef_sites[i], " = 0")) %>%
    confint() %>% tidy() %>% mutate(site = site_df$site[i])
}) %>% bind_rows() %>% rename(term = contrast)

# now, add Belarus back on
lincom_ci <- 
  tidy(lm_coef_l3, conf.int = TRUE) %>% filter(term == "year_abn") %>% 
  mutate(site = site_df$site[1]) %>%
  select(term, estimate, conf.low, conf.high, site) %>%
  bind_rows(., lincom_ci)

lincom_ci %>% arrange(conf.high)



# new coefficient plots with new, linear combination confidence intervals
gg_roc_lincom <-
  lincom_ci %>%
  ggplot(data = .,
         aes(y = fct_reorder(site, desc(estimate)), 
             x = estimate)) + 
  theme_classic() +
  geom_point() + 
  geom_errorbar(mapping = aes(xmin = conf.low, xmax = conf.high), width = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed") + 
  scale_y_discrete(labels = cap_update_labels) + 
  labs(y = NULL, #"Site", 
       x = "Change in half-life over time\n(in terms of years per year)") + 
  theme(legend.position = "none",
        plot.margin = unit(c(0.4, 0.6, 0.2, 0.2), "cm"))


# all half-lives grid, ordered by rate of change:



  
# for SI ------------------------- #
ggsave(plot = plot_grid(gg_cohort_coefs_grid,
                        gg_roc_lincom,
                        ncol = 2, rel_widths = c(1, 0.6), align = "h", axis = "b"),
       filename = paste0(p_plots, run_label, "/decay/", "rate_of_change_recultivation_speed_combo", 
                         "_lincom", run_label, ".pdf"), 
       width = 8.5, height = 6.5, units = "in")





# combo quadrant with coefs:

ggsave(plot = plot_grid(gg_l3_cohort_coef_all + theme(legend.position = "bottom"),
                        gg_roc_lincom,
                        ncol = 2, rel_widths = c(1, 0.6), align = "h", axis = "b"),
       filename = paste0(p_plots, run_label, "/presentation/", "rate_of_change_recultivation_speed", 
                         "_lincom", run_label, ".pdf"), 
       width = 11, height = 6, units = "in")





# extras:
# ---------------------------------------------------------------- #
# calculate the CIs directly, using the variance-covariance matrix
# ---------------------------------------------------------------- #
vcov(lm_coef_l3) %>% colnames()
mat <- vcov(lm_coef_l3)
mat %>% as_tibble()

test_se <- sqrt(
  mat["year_abn", "year_abn"] + 
    mat["year_abn:sitebosnia_herzegovina", "year_abn:sitebosnia_herzegovina"] + 
    2 * mat["year_abn", "year_abn:sitebosnia_herzegovina"]
)

# see:
# https://stats.stackexchange.com/questions/446676/measuring-standard-error-of-two-or-more-coefficients-combined 

coef(lm_coef_l3)["year_abn"] + coef(lm_coef_l3)["year_abn:sitebosnia_herzegovina"] - 1.9705*test_se
coef(lm_coef_l3)["year_abn"] + coef(lm_coef_l3)["year_abn:sitebosnia_herzegovina"] + 1.9705*test_se

glht(lm_coef_l3, linfct = c("year_abn + year_abn:sitebosnia_herzegovina = 0")) %>%
  confint() %>% tidy()
```

```{r l3-roc-indiv}

# create list of linear models for each site individually
lm_rate_of_change_ind <- lapply(1:11, function(i) {
  lm(time_to_0.5 ~ year_abn, data = filter(coef_df_wide_l3, site == site_df$site[i], !is.na(time_to_0.5)))
})

names(lm_rate_of_change_ind) <- site_df$site

# create tidied data.frame, for plotting
dt_recult_rate <- lapply(lm_rate_of_change_ind, function(i) {
  tidy(i, conf.int = TRUE) 
}) %>% bind_rows(.id = "site") 

# are the coefficient estimates exactly the same? Yes.
all.equal(
  dt_recult_rate %>% filter(term == "year_abn") %>% select(site, estimate),
  lincom_ci %>% select(site, estimate)
)


# ---------------------------------------------------------------- #
# plot the new coefficient range:
# ---------------------------------------------------------------- #

gg_roc_indiv <-
  dt_recult_rate %>% filter(term == "year_abn") %>%
  ggplot(data = .,
         aes(y = fct_reorder(site, desc(estimate)), 
             x = estimate)) + 
  theme_classic() +
  geom_point() + 
  geom_errorbar(mapping = aes(xmin = conf.low, xmax = conf.high), width = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed") + 
  labs(y = NULL, #"Site", 
       x = "Rate of change of recultivation speed \n(slope of time to 50% recultivation, \nin terms of years per year)") + 
  theme(legend.position = "none",
        plot.margin = unit(c(0.4, 0.6, 0.2, 0.2), "cm")) + 
  scale_y_discrete(expand = c(0.02, 0),
                   labels = c("belarus" = "Vitebsk, Belarus /\nSmolensk, Russia",
                              "bosnia_herzegovina" = "Bosnia &\n Herzegovina",
                              "chongqing" = "Chongqing, China",
                              "goias" = "Goiás, Brazil",
                              "iraq" = "Iraq",
                              "mato_grosso" = "Mato Grosso,\nBrazil",
                              "nebraska" = "Nebraska /\nWyoming, USA",
                              "orenburg" = "Orenburg, Russia /\nUralsk, Kazakhstan",
                              "shaanxi" = "Shaanxi/Shanxi,\nChina",
                              "volgograd" = "Volgograd, Russia",
                              "wisconsin" = "Wisconsin, USA"))
  

gg_roc_lincom
gg_roc_indiv
gg_coef_rate_change_by_site_l3_vert # old, to compare



# for SI ------------------------- #
ggsave(plot = plot_grid(gg_cohort_coefs_grid,
                        gg_roc_indiv,
                        ncol = 2, rel_widths = c(1, 0.6), align = "h", axis = "b",
                        labels = "auto"),
       filename = paste0(p_plots, run_label, "/decay/", "rate_of_change_recultivation_speed_combo", 
                         "_indiv", run_label, ".pdf"), 
       width = 11, height = 6, units = "in")


# combo quadrant with coefs:

ggsave(plot = plot_grid(gg_l3_cohort_coef_all + theme(legend.position = "bottom"),
                        gg_roc_indiv,
                        ncol = 2, rel_widths = c(1, 0.6), align = "h", axis = "b"),
       filename = paste0(p_plots, run_label, "/presentation/", "rate_of_change_recultivation_speed", 
                         "_indiv", run_label, ".pdf"), 
       width = 11, height = 6, units = "in")








# -------------------------------------------------------------------------- #
# diagnostic plots for individual site models:
# -------------------------------------------------------------------------- #
plot(lm_rate_of_change_ind[[1]], 1)

# ----------------------- fitted vs. residuals diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "rate_of_change_l3_diag_ind_resid_v_fitted", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) plot(lm_rate_of_change_ind[[i]], 1, main = site_df$site %>% gsub("_", " ", .) %>% capwords() %>% .[i])
dev.off()

# ----------------------- QQ diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "rate_of_change_l3_diag_ind_qq_car", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) {
  # plot(lm_rate_of_change_ind[[i]], 2, main = site_df$site %>% gsub("_", " ", .) %>% capwords() %>% .[i])
  car::qqPlot(lm_rate_of_change_ind[[i]], main = site_df$site %>% gsub("_", " ", .) %>% capwords() %>% .[i],
         ylab = "Standardized Residuals", xlab = "Theoretical Quantiles")
}
dev.off()

```

```{r l3-roc-full-mod-old}
# --------------------------------------------------------------------------- #
# OLD - these coefficient estimates have a confidence window that is too broad
# --------------------------------------------------------------------------- #

lm_coef_l3

# create table of regression coefficients for the rate of change of the "time to half" 
 
coef_df2_l3 <- tidy(lm_coef_l3, conf.int = TRUE) %>%
  mutate(termm = ifelse(grepl("year_abn", term), "slope", "int"),
         site = gsub("site|year_abn:", "", term)) %>% 
  pivot_wider(id_cols = c(site, termm), names_from = termm, values_from = c(estimate, conf.low, conf.high)) %>% 
  mutate(
    estimate_slope = ifelse(site == "belarus", 0, estimate_slope),
    conf.low_slope = ifelse(site == "belarus", 0, conf.low_slope),
    conf.high_slope = ifelse(site == "belarus", 0, conf.high_slope),
    estimate_slope = estimate_slope + as.numeric(tidy(lm_coef_l3, conf.int = TRUE)[1, "estimate"]),
    conf.low_slope = conf.low_slope + as.numeric(tidy(lm_coef_l3, conf.int = TRUE)[1, "conf.low"]),
    conf.high_slope = conf.high_slope + as.numeric(tidy(lm_coef_l3, conf.int = TRUE)[1, "conf.high"])
    ) %>% 
  filter(site != "year_abn")


# plot right on:
# ------------------------ use this one ---------------------------- #
gg_coef_rate_change_by_site_l3_horiz <-
  ggplot(data = left_join(coef_df2_l3, mean_coef_df_wide_l3, by = "site"),
         aes(x = fct_reorder(site, estimate_slope), 
             y = estimate_slope, 
             color = fct_reorder(site, time_to_0.5), 
             fill = fct_reorder(site, time_to_0.5))) + 
  theme_classic() +
  geom_col() + 
  geom_errorbar(mapping = aes(ymin = conf.low_slope, ymax = conf.high_slope), width = 0.2) +
  geom_hline(yintercept = 0) + 
  labs(title = "Changes in Half Time over time, by site", 
       x = "Site", y = "Rate of Change of Half Time (years per year)") + 
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none",
        plot.margin = unit(c(0.4, 0.6, 0.2, 0.2), "cm"))


# vertical
gg_coef_rate_change_by_site_l3_vert <-
  ggplot(data = left_join(coef_df2_l3, mean_coef_df_wide_l3, by = "site"),
         aes(y = fct_reorder(site, estimate_slope), 
             x = estimate_slope)) + 
  theme_classic() +
  geom_point() + 
  geom_errorbar(mapping = aes(xmin = conf.low_slope, xmax = conf.high_slope), width = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed") + 
  labs(y = NULL, #"Site", 
       x = "Rate of change of recultivation speed \n(time to recultivate half of area, \nyears per year)") + 
  theme(legend.position = "none",
        plot.margin = unit(c(0.4, 0.6, 0.2, 0.2), "cm"))


gg_coef_rate_change_by_site_l3_horiz
gg_coef_rate_change_by_site_l3_vert

# save

png(filename = paste0(p_plots, run_label, "/decay/", 
                      "l3_cohort_coefs_rate_of_change_h", run_label, ".png"), 
    width = 5, height = 5, units = "in", res = 400)
print(gg_coef_rate_change_by_site_l3_horiz)
dev.off()

png(filename = paste0(p_plots, run_label, "/decay/", 
                      "l3_cohort_coefs_rate_of_change_v", run_label, ".png"), 
    width = 5.5, height = 3.5, units = "in", res = 400)
print(gg_coef_rate_change_by_site_l3_vert)
dev.off()



# -------------- for presentation ------------------- #
# combo quadrant with coefs:

ggsave(plot = plot_grid(gg_l3_cohort_coef_all + theme(legend.position = "bottom"),
                        gg_coef_rate_change_by_site_l3_vert,
                        ncol = 2, rel_widths = c(1, 0.6), align = "h", axis = "b"),
       filename = paste0(p_plots, run_label, "/presentation/", "rate_of_change_recultivation_speed",
                         "_old", run_label, ".pdf"), 
       width = 11, height = 6, units = "in")


# for SI ------------------------- #
ggsave(plot = plot_grid(gg_cohort_coefs_grid,
                        gg_coef_rate_change_by_site_l3_vert,
                        ncol = 2, rel_widths = c(1, 0.6), align = "h", axis = "b"),
       filename = paste0(p_plots, run_label, "/decay/", "rate_of_change_recultivation_speed_combo",
                         "_old", run_label, ".pdf"), 
       width = 11, height = 6, units = "in")


```


# Projecting (extrapolating) abandonment into the future

My main question: if decay rates remain about the same at each site, and a similar and constant area of cropland is newly abandoned each year, how does the persistence of abandoned cropland change into the future?

Specific questions:
Q1. At what value does the mean abandonment duration plateau?
Q2. How long does it take for the mean abandonment duration to plateau?
Q3. What proportion of abandonment cropland lasts beyond 30 years?

## Extrapolation 1: Assumptions

We make two simple assumptions in our extrapolation of abandonment and recultivation: specifically, that 
1) recultivation rates remain the same (based on mean recultivation trends at each site), and that; 
2) a constant amount of cropland is newly abandoned each year, based on the mean annual gain in abandonment at each site.

However, this second assumption is almost certainly unrealistic, so we tested a second alternative:
2.2) that the amount of abandoned land each year would be more likely to gradually decline, so that less and less land is abandoned each year. 
(Extrapolation 2.) Specifically, a linear decline in area abandoned over 30 years, so that 0 ha are abandoned in 2050.

We also tested a second altern
2.3) Limit how much total area can be abandoned, based on the maximum extent of cropland at each site. (Extrapolation 3.) In this scenario, there is a constant amount of newly abandoned land each year, based on the same assumption (mean annual gain in abandonment at each site), but the amount of abandoned cropland can never exceed the maximum extent of cropland over the course of the time series. 
Once the amount of abandoned land reaches the maximum extent of cropland at that site, the new annual gain in abandonment is set to equal the amount that is recultivated each year, based on the recultivation rates. 
However, the total area abandoned in Extrapolation 1 never exceeds the total cropland extent, rendering the third extrapolation irrelevant. 

```{r mean-initial-area-abn}
# see "2_summary_stats.rmd" >>
area_summary_df <- read_csv(file = paste0(p_dat_derived, run_label, "/", "area_summary_df", run_label, ".csv"))

# ----------------------------------------------------------------------- #
# Average area initially abandoned at each site, in a data.frame
# ----------------------------------------------------------------------- #
mean_initial_area_abn <- persistence_dat %>% filter(age == 5) %>%
  select(site, year_abn, initial_area_abn = area_ha) %>%
  group_by(site) %>%
  summarise(mean_area_abn = mean(initial_area_abn))

mean_initial_area_abn
area_summary_df %>% names

select(site_df_w_size, site, area_ha)

mean_initial_area_abn <- 
  mean_initial_area_abn %>% 
  left_join(., 
            area_summary_df %>% select(site, total_site_area_ha_2017, total_crop_extent_ha)
            # or # select(site_df_w_size, site, area_ha)
            ) %>%
  mutate(percent_of_total = 100 * mean_area_abn / total_site_area_ha_2017,
         percent_of_total_crop_extent = 100 * mean_area_abn / total_crop_extent_ha)

mean_initial_area_abn %>% 
left_join(., filter(area_dat, lc == "Cropland", year == 1987) %>% 
                        select(site, cropland_area_1987 = area_ha),
                      by = c("site"))

area_summary_df
area_dat %>% 
  filter(lc %in% c("Cropland"), year == 1987)

# ----------------------------------------------------------------------- #
# plot the average initial area abandoned for each site
# ----------------------------------------------------------------------- #
gg_mean_area_by_site <- ggplot(data = mean_initial_area_abn, 
       mapping = aes(y = fct_reorder(site, desc(mean_area_abn)), x = mean_area_abn)) + 
  geom_col() + theme_classic() +
  labs(x = "Additional area abandoned in each year, on average", y = "Site",
       title = "Additional area abandoned each year, on average")




# as a percentage of the total area of each site
ggplot(data = mean_initial_area_abn, 
       mapping = aes(y = fct_reorder(site, desc(mean_area_abn)), x = 100*mean_area_abn/area_ha)) + 
  geom_col() + theme_classic() +
  labs(x = "Additional area abandoned in each year, on averag", y = "Site",
       title = "Additional area abandoned each year, on average",
       subtitle = "As a percent of total area in site")

# as a percentage of the amount of cropland in the previous year:
ggplot(data = mean_initial_area_abn, 
       mapping = aes(y = fct_reorder(site, desc(mean_area_abn)), x = 100*mean_area_abn/area_ha)) + 
  geom_col() + theme_classic() +
  labs(x = "Additional area abandoned in each year, on averag", y = "Site",
       title = "Additional area abandoned each year, on average",
       subtitle = "As a percent of total area in site")


# ----------------------------------------------------------------------- #
# Plot the initial area abandoned in each year:
# note, this matches the gains in the panel figure showing the turnover. 
# ----------------------------------------------------------------------- #
ggplot(data = persistence_dat %>% 
         group_by(site, year_abn) %>% 
         summarise(initial_area_abn = unique(initial_area_abn)), # %>% filter(site== "belarus"),
       mapping = aes(x = year_abn, y = initial_area_abn)) +
  theme_classic() + 
  geom_col() + labs(y = "Initial Area Abandoned", x = "Year Abandoned") + 
  facet_wrap(~ site, nrow = 3, ncol = 4, scales = "free")
```

```{r trend-in-annual-gain-area-abn}

turnover_dat %>% left_join(., select(mean_initial_area_abn, site, mean_area_abn), by = "site")

gg_trend_in_new_abn <-
  ggplot(data = turnover_dat %>% 
           left_join(., select(mean_initial_area_abn, site, mean_area_abn), by = "site") %>%
           filter(change == "gain") %>% 
           mutate(site = fct_reorder(site, desc(mean_area_abn))), 
       mapping = aes(x = year, y = area_ha / (1e3))) + 
  theme_classic() +
    geom_col() + 
  labs(y = expression("Annual area abandoned (10"^{3}*" ha)"),
       x = "Year",
       # title = "Trend in newly abandoned cropland each year"
       ) +
  geom_smooth(method = "lm", se = 0.95) + 
  facet_wrap(vars(site), scales = "free_y", labeller = as_labeller(cap_update_labels))

# Save: 
ggsave(plot = gg_trend_in_new_abn,
       filename = paste0(p_plots, run_label, "/decay/trend_in_new_abn", run_label, ".pdf"),
       width = 7, height = 5, units = "in", dpi = 400)


# add the mean abandonment each year on the side
gg_mean_area_by_site <- ggplot(data = mean_initial_area_abn, 
       mapping = aes(y = fct_reorder(site, mean_area_abn), x = mean_area_abn / (1e3))) + 
  geom_point(size = 2) + theme_classic() +
  labs(x = expression("Mean area abandoned annually (10"^{3}*" ha)            "),
       y = NULL,
       # title = "Additional area abandoned each year, on average"
       ) + 
  theme(legend.position = "none",
        plot.margin = unit(c(0.4, 0.6, 0.2, 0.4), "cm")) + 
  scale_y_discrete(expand = c(0.02, 0),
                   labels = c("belarus" = "Vitebsk, Belarus /\nSmolensk, Russia",
                              "bosnia_herzegovina" = "Bosnia &\n Herzegovina",
                              "chongqing" = "Chongqing, China",
                              "goias" = "Goiás, Brazil",
                              "iraq" = "Iraq",
                              "mato_grosso" = "Mato Grosso,\nBrazil",
                              "nebraska" = "Nebraska /\nWyoming, USA",
                              "orenburg" = "Orenburg, Russia /\nUralsk, Kazakhstan",
                              "shaanxi" = "Shaanxi/Shanxi,\nChina",
                              "volgograd" = "Volgograd, Russia",
                              "wisconsin" = "Wisconsin, USA"))


# save figure for SI ------------------------- #
ggsave(plot = plot_grid(gg_trend_in_new_abn,
                        gg_mean_area_by_site,
                        ncol = 2, rel_widths = c(1, 0.5), align = "h", axis = "b",
                        labels = "auto"),
       filename = paste0(p_plots, run_label, "/decay/", "annual_gain_trend", run_label, ".pdf"), 
       width = 10, height = 5, units = "in")

```



```{r extrapolate-future-df}
# fitted_df_l3 <- read_csv(file = paste0(p_dat_derived, run_label, "/decay_mod_fitted_df_l3", run_label, ".csv"))

# ----------------------------------------------------------------------- #
# produce future extrapolation data.frame
# ----------------------------------------------------------------------- #
future_df_l3 <- 
  lapply(site_df$site, function(y) {
    lapply(1987:2150, function(x) {
      cc_extrapolate_abn(extrapolate_to_year = x,
                              summarize_area = FALSE,
                              fitted_values_df = fitted_df_l3,
                              site_ = y)
      }) %>% 
      bind_rows() %>% filter(!is.na(exp_proportion))
    }) %>% 
  bind_rows() %>%
  filter(exp_area_ha > 0)

future_df_l3 %>% filter(site == "shaanxi") %>% arrange(desc(year), desc(year_abn))

# save future_df_l3
write_csv(future_df_l3, file = paste0(p_dat_derived, run_label, "/future_df_l3", run_label, ".csv"))
# future_df_l3 <- read_csv(file = paste0(p_dat_derived, run_label, "/future_df_l3", run_label, ".csv"))



# ----------------------- #
# calculate the mean age
# ----------------------- #
extrapolate_df_l3$year %>% unique() %>% sort()

extrapolate_df_l3 <- future_df_l3 %>% 
  group_by(site, year) %>%
  summarise(exp_total_area_abn = sum(exp_area_ha, na.rm = TRUE),
            mean_age = 
              sum(age*exp_area_ha, na.rm = TRUE) /
              sum(exp_area_ha, na.rm = TRUE)
            )

extrapolate_df_l3 <- bind_rows(extrapolate_df_l3, tibble(site = site_df$site,
       year = 1991, 
       exp_total_area_abn = 0,
       mean_age = NA))

# max mean age:
extrapolate_df_l3 <- extrapolate_df_l3 %>% 
  group_by(site) %>% 
  mutate(max_mean_age = max(mean_age, na.rm = T)) %>%
  arrange(max_mean_age)

# save extrapolate_df_l3
write_csv(extrapolate_df_l3, file = paste0(p_dat_derived, run_label, "/extrapolate_df_l3", run_label, ".csv"))
```

```{r plot-extrapolations-main-figs}
extrapolate_df_l3 <- read_csv(file = paste0(p_dat_derived, run_label, "/extrapolate_df_l3", run_label, ".csv"))

max_age_extrapolation <- future_df_l3 %>% 
  filter(exp_area_ha > 0) %>% 
  group_by(site) %>%
  summarise(max_age = max(age, na.rm = TRUE)) %>%
  arrange(max_age)


exp_area_in_2150_a1 <- extrapolate_df_l3 %>% 
           left_join(., filter(extrapolate_df_l3, year == 2150) %>%
                       select(site, exp_area_in_2150 = exp_total_area_abn), 
                   by = c("site")) %>%
  select(site, exp_area_in_2150) %>% unique() %>% arrange(exp_area_in_2150)


# ----------------------------------------------------------------------- #
# plot the mean age through time:
# ----------------------------------------------------------------------- #
gg_extrapolate_mean_age <-
  ggplot(data = extrapolate_df_l3 %>% 
           left_join(max_age_extrapolation, by = "site") %>% 
           filter(year < 2122), 
       mapping = aes(x = year, y = mean_age, color = fct_reorder(site, max_mean_age))) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = "Mean duration of abanandonment (years)",
       #title = "Mean age of abandoned land through time",
       color = "Site"
       ) + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) + 
  guides(color = guide_legend(reverse = TRUE)) #+ geom_vline(xintercept = 2125)

# ----------------------------------------------------------------------- #
# plot the expected area through time:
# ----------------------------------------------------------------------- #
gg_extrapolate_area_abn <-
  ggplot(data = extrapolate_df_l3 %>% 
           left_join(max_age_extrapolation, by = "site") %>% 
           filter(year < 2122), 
       mapping = aes(x = year, y = exp_total_area_abn/10^3, 
                     color = fct_reorder(site, max_mean_age))) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = expression("Area abandoned (10"^{3}*" ha)"),
       # title = "Extrapolated accumulation of abandoned land over time",
       color = "Site") + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) +
  scale_color_discrete(breaks = exp_area_in_2150_a1$site) + # to reorder the legend
  guides(color = guide_legend(reverse = TRUE))



# ------------------------------------------------------------------ #
# Save two panel SI figure
ggsave(
  plot = plot_grid(
    gg_extrapolate_mean_age + 
      scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 40)), 
    gg_extrapolate_area_abn + 
      scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 40)),
    labels = "auto", ncol = 2),
  filename = paste0(p_plots, run_label, "/decay/", "extrapolation1_SI", run_label, ".pdf"),
  width = 9, height = 3.75, units = "in", dpi = 400
)
```

```{r si-fig-extrapolated-area-by-age-bin}
# ----------------------------------------------------------------------- #
# Plot extrapolated area by age bin
# ----------------------------------------------------------------------- #
gg_extrapolated_area_by_age_bin <-
  ggplot(data = future_df_l3 %>% 
           filter(year <= 2120) %>%
         mutate(age_bin = cut(age, breaks = seq(from = 0, to = 140, by = 15), right = TRUE)),
       mapping = aes(x = year, y = exp_area_ha / 10^3, 
                     fill = age_bin)) + 
    theme_classic() +
    labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Year", fill = "Age", linetype = NULL) +
    geom_col(position = position_stack(reverse = FALSE)) + 
    scale_fill_brewer(palette = "Greens", direction = 1) +
    
  geom_line(data = extrapolate_df_l3 %>% filter(year <= 2120#, site == "shaanxi"
                                                ),
            mapping = aes(x = year, y = exp_total_area_abn / 10^3,
                          linetype = "Total Area Abandoned"),
            color = "gray50", inherit.aes = FALSE) +
  theme(legend.position = c(0.85, 0.10), 
        legend.spacing = unit(2, units = "mm"), 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  guides(fill = guide_legend(ncol = 2)) +
  facet_wrap(vars(site), scales = "free_y", 
             nrow = 4, ncol = 3, labeller = as_labeller(cap_update_labels))


# ----------------------------------------------------------------------- #
# Plots
# ----------------------------------------------------------------------- #

# final version for the SI
ggsave(plot = gg_extrapolated_area_by_age_bin + 
         labs(title = "Extrapolation 1",
              subtitle = "Assuming i) mean decay rates and ii) constant area abandoned each year.") + 
         facet_wrap(vars(site), nrow = 4, ncol = 3, 
                    labeller = as_labeller(cap_update_labels)), 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolation1_ages", run_label, ".pdf"), 
       width = 7, height = 8, units = "in")


# with title, and total crop extent
ggsave(plot = gg_extrapolated_area_by_age_bin + 
         labs(title = "Extrapolation 1",
              subtitle = "Assuming i) mean decay rates and ii) constant area abandoned each year.") + 
         
         # with max cropland extent for context:
         geom_hline(data = select(area_summary_df, site, total_crop_extent_ha),
             mapping = aes(yintercept = total_crop_extent_ha / 10^3, 
             linetype = "Max. Crop Extent"),
             color = "red"), 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolation1_ages_w_crop_extent", run_label, ".pdf"), 
       width = 7, height = 8.75, units = "in")



# constant scales
ggsave(plot = gg_extrapolated_area_by_age_bin, 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolation1_ages_free_y", run_label, ".pdf"), 
       width = 7, height = 8, units = "in")


 
# wide
ggsave(plot = gg_extrapolated_area_by_age_bin +
         facet_wrap(vars(site), scales = "free_y", nrow = 3, ncol = 4) + 
         theme(legend.position = c(0.88, 0.12),
               legend.spacing = unit(0.5, units = "mm"),
               legend.background = element_rect(fill = "transparent")),
       filename = paste0(p_plots, run_label, "/decay/", "extrapolate_age_by_age_bin_wider", run_label, ".pdf"),
       width = 8, height = 5, units = "in", dpi = 400
)

```

```{r extra-extrapolation-plots}
# ------------------------------------------------------------------ #
# extra plots: not necessary
# ------------------------------------------------------------------ #
# save individual plots:

png(filename = paste0(p_plots, run_label, "/decay/", "extrapolate_mean_age", run_label, ".png"), 
    width = 6, height = 4.5, units = "in", res = 400)
print(gg_extrapolate_mean_age)
dev.off()

png(filename = paste0(p_plots, run_label, "/decay/", "extrapolate_area_abn", run_label, ".png"), 
    width = 6, height = 4.5, units = "in", res = 400)
print(gg_extrapolate_area_abn)
dev.off()





# unused plots
# ---------------------------------------------------------- #
# how much of the abandoned land is older than 50 years old?
# ---------------------------------------------------------- #
old_abn_df <- future_df_l3 %>% filter(age > 50#, exp_area_ha > 0
                                      ) %>%
  group_by(site, year) %>%
  summarise(exp_area_over_50 = sum(exp_area_ha, na.rm = TRUE))

old_abn_df


# only some sites have land over 50 years old:
old_abn_df %>% filter(exp_area_over_50 > 0) %>%
  select(site) %>% unique()


# ----------------------------------------------------------------------- #
# plot the expected area through time:
# ----------------------------------------------------------------------- #
# gg_extrapolate_old_abn <- 
  ggplot(data = old_abn_df %>% filter(year < 2050)
         # %>%
         # left_join(., filter(old_abn_df, year == 2150) %>%
         #             select(site, exp_area_in_ = exp_total_area_abn), 
         #           by = c("site"))
         , 
       mapping = aes(x = year, y = exp_area_over_50/10^3, 
                     color = site)) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = expression("Area abandoned at least 50 years (10"^{3}*" ha)"),
       # title = "Extrapolated accumulation of abandoned land over time",
       color = "Site") + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) + 
  guides(color = guide_legend(reverse = TRUE)) #+ geom_vline(xintercept = 2125)


# just one year:
ggplot(data = future_df_l3 %>% filter(site == "shaanxi", year == 2121),
       mapping = aes(x = year, y = exp_area_ha / 10^3, 
                     fill = cut(age, breaks = seq(from = 0, to = 140, by = 20), right = TRUE))) + 
  theme_classic() + 
  geom_col(position = position_stack(reverse = FALSE)) +
  scale_fill_brewer(palette = "Greens", direction = 1) + 
      labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Year", 
         title = "Area of Abandoned Land, by Age Class",
         fill = "Age")
  


# ----------------------------------------------------------------------- #
# site decay trend
# ----------------------------------------------------------------------- #
gg_extrapolation_mean_trend <-
  ggplot(data = fitted_df_l3 %>% 
           left_join(max_age_extrapolation, by = "site") %>% 
           filter(age < 140),
       mapping = aes(x = age, y = fitted, color = fct_reorder(site, max_age))) +
  theme_classic() +
  geom_line(size = 1.1) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(#title = "Decay of abandoned land over time", 
       #caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site") + 
  guides(col = guide_legend(reverse = TRUE)) + 
  scale_x_continuous(breaks = seq(from = 0, to = 140, by = 20))


# extras, not necessary:
ggsave(plot = plot_grid(
  plot_grid(gg_extrapolation_mean_trend + theme(legend.position = "none"),
            gg_extrapolate_mean_age, ncol = 2, rel_widths = c(1, 1.2),
            labels = c("a", "b")),
  gg_extrapolate_area_abn, labels = c("", "c"),
  nrow = 1, ncol = 2, rel_widths = c(1.75, 1)
  ), 
  filename = paste0(p_plots, run_label, "/decay/", "extrapolation_combo", run_label, ".pdf"), 
    width = 13, height = 4, units = "in"
)

# the tall combo
ggsave(plot = 
         plot_grid(
           gg_extrapolation_mean_trend, 
           plot_grid(gg_extrapolate_mean_age, 
                     gg_extrapolate_area_abn,
                     ncol = 2, #rel_widths = c(1, 1.2),
                     labels = c("b", "c")),
           labels = c("a", ""),
           nrow = 2, ncol = 1, rel_widths = c(1.75, 1)
           ), 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolation_combo_tall", run_label, ".pdf"),
       width = 10, height = 8, units = "in"
)


```

```{r plot-obs-v-exp-abn}
# estimate area-abn function

# ----------------------------------------------------------------------- #
# Function to calculate the total amount of abandoned land in a given year, 
# disaggregated by age, based on the modeled decay rate and the
# initial area abandoned in each year.
# This serves as a starting place for extrapolating the
# area and mean age of abandonment into the future.
# ----------------------------------------------------------------------- #

cc_estimate_area_abn(year = 2000, summarize_area = FALSE) # in the year 2000, how much land has been abandoned, in total? 
cc_estimate_area_abn(year = 2000) %>% summarise(area = sum(exp_area)) %>% as.numeric()



# ----------------------------------------------------------------------- #
# Produce a data.frame of extrapolated (expected) area abandoned in each year
# ----------------------------------------------------------------------- #
extrapolated_df_s <- filter(persistence_dat, site == "shaanxi") %>% group_by(year) %>% 
  summarise(site = unique(site), observed = sum(area_ha)) %>% 
  mutate(
    expected = sapply(year, FUN = function(i) {
      cc_estimate_area_abn(year = i, summarize_area = TRUE)
      }),
    expected_mean = sapply(year, FUN = function(i) {
      cc_extrapolate_abn(extrapolate_to_year = i, summarize_area = TRUE,
                              fitted_values_df = fitted_df_l3) %>% 
        select(exp_total_area_abn) %>% as.numeric()
      })
    ) %>%
  pivot_longer(cols = c("observed", "expected", "expected_mean"),
               names_to = "estimate",
               values_to = "area_ha")

# for all sites, 

extrapolated_df_s %>% print(n = 30)


# ----------------------------------------------------------------------- #
# plot the area, by age class, 
# along with the abandoned area predicted by mean decay rate at that site,
# with both accurate and average initial area abandoned:
# ----------------------------------------------------------------------- #

ggplot(data = filter(persistence_dat, site == "shaanxi"),
       mapping = aes(x = year, y = area_ha / 10^3, 
                           fill = cut(age, 
                                      breaks = c(5, 10, 15, 20, 25, 30),
                                      # breaks = 5, 
                                      right = TRUE, include.lowest = TRUE)
                     
                     )) + 
    theme_classic() +
    labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Year", 
         title = "Area of Abandoned Land, by Age Class",
         fill = "Age",
         color = "Area Estimate Type") +
    geom_col(position = position_stack(reverse = FALSE)) + 
    scale_fill_brewer(palette = "Greens", direction = 1) + 
  scale_y_continuous(n.breaks = 15) + scale_x_continuous(n.breaks = 6) + 
  geom_line(data = obs_v_expected_df %>% filter(site == "shaanxi"),#extrapolated_df_s, 
            mapping = aes(x = year, y = area_ha/10^3, color = estimate), inherit.aes = FALSE,
            size = 1) +
  scale_color_manual(values = c("observed" = "black", 
                                "expected" = "red", 
                                "expected_mean" = "blue"),
                     labels = c(#"value" = "label"
                       "observed" = "Observed", 
                       "expected" = "Mean decay rate, \naccurate initial area abn", 
                       "expected_mean" = "Mean decay rate, \nmean initial area abn"
    ))



obs_v_expected_df <- 
  lapply(1:11, function(i) {
    my_site <- site_df$site[i]
    
    persistence_dat %>% filter(site == my_site) %>% group_by(year) %>% 
      summarise(site = unique(site), observed = sum(area_ha)) %>% 
      mutate(
        expected = 
          sapply(year, FUN = function(i) {
            cc_estimate_area_abn(year = i, summarize_area = TRUE, site_ = my_site)
            }),
        expected_mean = 
          sapply(year, FUN = function(i) {
            cc_extrapolate_abn(extrapolate_to_year = i, summarize_area = TRUE,
                               fitted_values_df = fitted_df_l3,
                               site_ = my_site) %>% 
              select(exp_total_area_abn) %>% as.numeric()
            })
        ) %>%
      pivot_longer(cols = c("observed", "expected", "expected_mean"),
                   names_to = "estimate",
                   values_to = "area_ha")
    }) %>% bind_rows()



persistence_dat$age %>% cut(breaks = 5, right = T, include.lowest = T)
min(persistence_dat$age)
sort(persistence_dat$age)

# all sites:

gg_obs_v_exp <- ggplot(data = persistence_dat,
       mapping = aes(x = year, y = area_ha / 10^3, 
                           fill = cut(age, breaks = seq(5,30,5), 
                                      right = TRUE, include.lowest = TRUE))) + 
    theme_classic() +
    labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Year", 
         title = "Area of Abandoned Land, by Age Class",
         fill = "Age",
         color = "Area Estimate Type") +
    geom_col(position = position_stack(reverse = FALSE)) + 
    scale_fill_brewer(palette = "Greens", direction = 1) + 
  # scale_y_continuous(n.breaks = 15) + scale_x_continuous(n.breaks = 6) + 
  geom_line(data = obs_v_expected_df, 
            mapping = aes(x = year, y = area_ha/10^3, color = estimate), 
            inherit.aes = FALSE,
            size = 1) +
  scale_color_manual(values = c("observed" = "black", 
                                "expected" = "red", 
                                "expected_mean" = "blue"),
                     labels = c(#"value" = "label"
                       "observed" = "Observed", 
                       "expected" = "Mean decay rate, \naccurate initial area abn", 
                       "expected_mean" = "Mean decay rate, \nmean initial area abn"
    )) + 
  facet_wrap(vars(site), scales = "free", labeller = as_labeller(cap_update_labels))


# save
ggsave(plot = gg_obs_v_exp,
       filename = paste0(p_plots, run_label,
       "/obs_v_expected_area_abn", run_label, ".pdf"),
       width = 9, height = 6, units = "in", dpi = 400
)

```



```{r plot-mean-age-in-2050}
# load files:
mean_length_df <- read_csv(file = paste0(p_derived2, "mean_length_df", run_label, ".csv"))
extrapolate_df_l3 <- read_csv(file = paste0(p_derived2, "/extrapolate_df_l3", run_label, ".csv"))
extrapolate_df_l3_a2 <- read_csv(file = paste0(p_derived2, "/extrapolate_df_l3_a2", run_label, ".csv"))


# assumption 1 - constant initial area abandoned
mean_age_in_2050 <- mean_length_df %>% filter(abn_threshold == 5, length_type == "all") %>%
  select(site, mean_age_obs = mean_duration) %>%
  left_join(., extrapolate_df_l3 %>% filter(year == 2050) %>% select(site, mean_age_extrap1 = mean_age), by = "site") %>%
  left_join(., extrapolate_df_l3_a2 %>% filter(year == 2050) %>% select(site, mean_age_extrap2 = mean_age), by = "site") %>%
  arrange(mean_age_obs)
   
gg_mean_age_in_2050 <- mean_age_in_2050 %>%
  pivot_longer(cols = c(2:4), names_to = "variable") %>%
  ggplot(data = ., mapping = aes(x = fct_reorder(site, value), y = value, fill = variable)) + 
  labs(x = NULL, #"Site", 
       y = "Mean abandonment duration (years)") +
  geom_col(position = position_dodge()) + coord_flip() + 
  scale_fill_discrete(name = "Mean duration type: ", 
                      labels = c(mean_age_obs = "Observed (1987-2017)", 
                                 mean_age_extrap1 = "Extrapolation 1 (2050)",
                                 mean_age_extrap2 = "Extrapolation 2 (2050)")) +
  scale_x_discrete(labels = c("belarus" = "Vitebsk, Belarus /\n Smolensk, Russia",
                              "bosnia_herzegovina" = "Bosnia & Herzegovina",
                              "chongqing" = "Chongqing, China",
                              "goias" = "Goiás, Brazil",
                              "iraq" = "Iraq",
                              "mato_grosso" = "Mato Grosso, Brazil",
                              "nebraska" = "Nebraska/Wyoming, USA",
                              "orenburg" = "Orenburg, Russia /\n Uralsk, Kazakhstan",
                              "shaanxi" = "Shaanxi/Shanxi, China",
                              "volgograd" = "Volgograd, Russia",
                              "wisconsin" = "Wisconsin, USA")) +
  theme_classic()

# save
ggsave(plot = gg_mean_age_in_2050,
       filename = paste0(p_plots, run_label, "/mean_age_in_2050", run_label, ".pdf"),
       width = 7, height = 5, units = "in"
       )
```


## Extrapolation 2
In order to change the second assumption, we need to alter the "mean_initial_area_abn" parameter.

```{r extrapolation-2}
# assumption 2.2) We could alternatively assume that the amount of abandoned land each year would be more likely to gradually decline, so that less and less land is abandoned each year.
# - Linear decline in area abandoned over 30 years, so that 0 ha are abandoned in 2050

# Everything starts in 2017. 
persistence_dat %>% filter(site == "shaanxi", year == 2017) %>%
  select(site, year, year_abn, area_ha, initial_area_abn)


# linear decline by 2050.
mean_initial_area_abn %>% filter(site == site_) %>% .$mean_area_abn / (2050-2017)

initial_area_abn_2 <- 
  c(mean_initial_area_abn %>% filter(site == site_) %>% .$mean_area_abn)

year <- 2055

if_else(year <= 2017, mean_initial_area_abn_value,
        if_else(year <= 2050, mean_initial_area_abn_value - 
                  (year - 2017) * 
                  (mean_initial_area_abn_value / (2050-2017)), # incremental decline each year
                0 # no abandonment beyond 2050
          ))

tibble(
    site = site_,
    year = extrapolate_to_year,
    year_abn = 1988:extrapolate_to_year,
    initial = if_else(year_abn <= 2017, mean_initial_area_abn_value,
        if_else(year_abn <= 2050, mean_initial_area_abn_value - 
                  (year_abn - 2017) * 
                  (mean_initial_area_abn_value / (2050-2017)), # incremental decline each year
                0 # no abandonment beyond 2050
          )),
    age = extrapolate_to_year - year_abn + 1) %>% print(n = 150)


# ---------------------------------------------------------------- #
# write new function, to implement updated assumption:
# ---------------------------------------------------------------- #
# see cc_extrapolate_abn_a2()


# ----------------------------------------------------------------------- #
# produce future extrapolation data.frame, for assumption 2
# ----------------------------------------------------------------------- #
future_df_l3_a2 <- 
  lapply(site_df$site, function(y) {
    lapply(1987:2200, function(x) {
      cc_extrapolate_abn_a2(extrapolate_to_year = x,
                            summarize_area = FALSE,
                            fitted_values_df = fitted_df_l3,
                            site_ = y)
      }) %>% 
      bind_rows() %>% filter(!is.na(exp_proportion))
    }) %>% 
  bind_rows() %>%
  filter(exp_area_ha > 0) 



future_df_l3_a2 %>% filter(site == "shaanxi") %>% arrange(desc(year), desc(year_abn)) %>% print(n = 50)
future_df_l3 %>% filter(site == "shaanxi") %>% arrange(desc(year), desc(year_abn)) %>% print(n = 50)


# save future_df_l3
write_csv(future_df_l3_a2, file = paste0(p_dat_derived, run_label, "/future_df_l3_a2", run_label, ".csv"))
# future_df_l3_a2 <- read_csv(file = paste0(p_dat_derived, run_label, "/future_df_l3_a2", run_label, ".csv"))



# ----------------------- #
# calculate the mean age
# ----------------------- #

extrapolate_df_l3_a2 <- future_df_l3_a2 %>% 
  group_by(site, year) %>%
  summarise(exp_total_area_abn = sum(exp_area_ha, na.rm = TRUE),
            mean_age = 
              sum(age*exp_area_ha, na.rm = TRUE) /
              sum(exp_area_ha, na.rm = TRUE)
            )

extrapolate_df_l3_a2 <- bind_rows(extrapolate_df_l3_a2, tibble(site = site_df$site,
       year = 1991, 
       exp_total_area_abn = 0,
       mean_age = NA))

# max mean age:
extrapolate_df_l3_a2 <- extrapolate_df_l3_a2 %>% 
  group_by(site) %>% 
  mutate(max_mean_age = max(mean_age, na.rm = T)) %>%
  arrange(max_mean_age)

# save extrapolate_df_l3_a2
write_csv(extrapolate_df_l3_a2, file = paste0(p_dat_derived, run_label, "/extrapolate_df_l3_a2", run_label, ".csv"))
# extrapolate_df_l3_a2 <- read_csv(file = paste0(p_dat_derived, run_label, "/extrapolate_df_l3_a2", run_label, ".csv"))
```


```{r extrapolation-2-plots}
# ----------------------------------------------------------------------------------- #
# plots
# ----------------------------------------------------------------------------------- #

max_age_extrapolation_a2 <- future_df_l3_a2 %>% 
  filter(exp_area_ha > 0) %>% 
  group_by(site) %>%
  summarise(max_age = max(age, na.rm = TRUE)) %>%
  arrange(max_age)


exp_area_in_2050_a2 <- extrapolate_df_l3_a2 %>% 
           left_join(., filter(extrapolate_df_l3_a2, year == 2050) %>%
                       select(site, exp_area_in_2050 = exp_total_area_abn), 
                   by = c("site")) %>%
  select(site, exp_area_in_2050) %>% unique() %>% arrange(exp_area_in_2050)


# ----------------------------------------------------------------------- #
# plot the mean age through time:
# ----------------------------------------------------------------------- #
gg_extrapolate_mean_age_a2 <-
  ggplot(data = extrapolate_df_l3_a2 %>% 
           left_join(max_age_extrapolation_a2, by = "site") %>% 
           filter(year < 2075
                  ), 
       mapping = aes(x = year, y = mean_age, color = fct_reorder(site, max_mean_age))) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = "Mean duration of abanandonment (years)",
       #title = "Mean age of abandoned land through time",
       color = "Site"
       ) + 
  # scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) + 
    scale_x_continuous(n.breaks = 5) +
  guides(color = guide_legend(reverse = TRUE)) #+ geom_vline(xintercept = 2125)

  
# ----------------------------------------------------------------------- #
# plot the expected area through time:
# ----------------------------------------------------------------------- #
gg_extrapolate_area_abn_a2 <-
  ggplot(data = extrapolate_df_l3_a2 %>% 
           left_join(max_age_extrapolation_a2, by = "site") %>% 
           filter(year < 2075
                  ), 
       mapping = aes(x = year, y = exp_total_area_abn/10^3, 
                     color = fct_reorder(site, max_mean_age))) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = expression("Area abandoned (10"^{3}*" ha)"),
       # title = "Extrapolated accumulation of abandoned land over time",
       color = "Site") + 
  # scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) +
  scale_x_continuous(n.breaks = 5) +
  scale_color_discrete(breaks = exp_area_in_2050_a2$site) + # to reorder the legend
  guides(color = guide_legend(reverse = TRUE))



# ------------------------------------------------------------------ #
# Save two panel SI figure
ggsave(
  plot = plot_grid(
    gg_extrapolate_mean_age_a2, 
    gg_extrapolate_area_abn_a2,
    labels = "auto", ncol = 2),
  filename = paste0(p_plots, run_label, "/decay/", "extrapolation2_SI", run_label, ".pdf"),
  width = 9, height = 3.75, units = "in", dpi = 400
)

# ----------------------------------------------------------------------- #
# Plot extrapolated area by age bin
# ----------------------------------------------------------------------- #

gg_extrapolated_area_by_age_bin_a2 <-
  ggplot(data = future_df_l3_a2 %>% 
           filter(#year <= 2120
                  ) %>%
         mutate(age_bin = cut(age, breaks = seq(from = 0, to = 140, by = 20), right = TRUE)),
       mapping = aes(x = year, y = exp_area_ha / 10^3, 
                     fill = age_bin)) + 
    theme_classic() +
    labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Year", fill = "Age", linetype = NULL) +
    geom_col(position = position_stack(reverse = FALSE)) + 
    scale_fill_brewer(palette = "Greens", direction = 1) +
    
  geom_line(data = extrapolate_df_l3_a2 %>% filter(#year <= 2120#, site == "shaanxi"
                                                ),
            mapping = aes(x = year, y = exp_total_area_abn / 10^3,
                          linetype = "Total Area Abandoned"),
            color = "gray50", inherit.aes = FALSE) +
  theme(legend.position = c(0.85, 0.10), 
        legend.spacing = unit(2, units = "mm"), 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  facet_wrap(vars(site), scales = "free_y",
             nrow = 4, ncol = 3, labeller = as_labeller(cap_update_labels))


# final version for the SI
ggsave(plot = gg_extrapolated_area_by_age_bin_a2 + 
         labs(title = "Extrapolation 2",
              subtitle = "Assuming i) mean decay rates and ii) constant area abandoned each year until 2017, \nthen linear decline in area abandoned each year until reaching 0 in 2050."), 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolation2_ages", run_label, ".pdf"), 
       width = 7, height = 8, units = "in")


# all constant scales:
ggsave(plot = gg_extrapolated_area_by_age_bin_a2 + 
         facet_wrap(vars(site), #scales = "free_y",
                    nrow = 4, ncol = 3, labeller = as_labeller(cap_update_labels)) + 
         labs(title = "Extrapolation 2",
              subtitle = "Assuming i) mean decay rates and ii) constant area abandoned each year until 2017, \nthen linear decline in area abandoned each year until reaching 0 in 2050."), 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolation2_ages_const", run_label, ".pdf"), 
       width = 7, height = 8, units = "in")


```

```{r extrapolation-3-unnecessary}
# 2.3) Limit how much total area can be abandoned, based on the maximum extent of cropland at each site. 
# - There is a constant amount of newly abandoned land each year, based on the same assumption (mean annual gain in abandonment at each site). 
# - But, the amount of abandoned cropland can never exceed the maximum extent of cropland over the course of the time series.
# - So, once the amount of abandoned land reaches the maximum extent of cropland at that site, the new annual gain in abandonment is set to equal the amount that is recultivated each year, based on the recultivation rates.


area_summary_df <- read_csv(file = paste0(p_dat_derived, run_label, "/", "area_summary_df", run_label, ".csv"))

area_summary_df %>%
  select(site, total_crop_extent_ha)

# visualize the total extent of cropland in context with the extrapolated area abandoned

gg_extrapolated_area_by_age_bin + 
  labs(title = "Extrapolation 1",
       subtitle = "Assuming i) mean decay rates and ii) constant area abandoned each year.") + 
  geom_hline(data = select(area_summary_df, site, total_crop_extent_ha), # with max cropland extent for context:
             mapping = aes(yintercept = total_crop_extent_ha / 10^3, 
                           linetype = "Max. Crop Extent"),
             color = "red")

ggsave(plot = gg_extrapolated_area_by_age_bin + 
         labs(title = "Extrapolation 1",
              subtitle = "Assuming i) mean decay rates and ii) constant area abandoned each year.") + 
         
         # with max cropland extent for context:
         geom_hline(data = select(area_summary_df, site, total_crop_extent_ha),
             mapping = aes(yintercept = total_crop_extent_ha / 10^3, 
             linetype = "Max. Crop Extent"),
             color = "red"), 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolation1_ages_w_crop_extent", run_label, ".pdf"), 
       width = 7, height = 8.75, units = "in")

```

```{r mean-age-abn-in-2050}
# ----------------------------------------------------------------------------------- #
# mean age of abandoned land in 2050
# ----------------------------------------------------------------------------------- #

# Extrapolation 1 - constant initial area abandoned

mean_age_in_2050 <- mean_length_df %>% filter(abn_threshold == 5, length_type == "all") %>%
  select(site, mean_age_obs = mean_duration) %>%
  left_join(., extrapolate_df_l3 %>% filter(year == 2050) %>% select(site, mean_age_extrap1 = mean_age), by = "site") %>%
  left_join(., extrapolate_df_l3_a2 %>% filter(year == 2050) %>% select(site, mean_age_extrap2 = mean_age), by = "site") %>%
  arrange(mean_age_obs)
   
mean_age_in_2050 %>%
  pivot_longer(cols = c(2:4), names_to = "variable") %>%
  ggplot(data = ., mapping = aes(x = fct_reorder(site, value), y = value, fill = variable)) + 
  geom_col(position = position_dodge()) + coord_flip() + 
  theme_classic()

mean_length_df %>% filter(abn_threshold == 5, length_type == "all") 

extrapolate_df_l3 %>% filter(year == 2050) %>% arrange(desc(year)) %>% print(n = 50)

extrapolate_df_l3_a2 %>% filter(year == 2050) %>% arrange(desc(year)) %>% print(n = 50)


```




# Supplemental Code

```{r exploration-w-geom_smooth}
gg_persist_mod_base <- ggplot(data = dat, mapping = aes(x = age, y = proportion)) + 
  theme_classic() + 
  geom_point(aes(group = year_abn, color = year_abn), size = 1.25) + 
  labs(title = "Persistence of Abandoned Land",
       subtitle = site_df$description[indx],
       color = "Year Abandoned",
       y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment") + 
  scale_color_distiller(palette = "Greens") + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red", size = 0.75)


# ----------------------------------- plot regular lm ------------------------------------------------- # 
# regular lm
gg_persist_mod_base + 
  geom_smooth(method = "lm", se = FALSE)


# ----------------------------------- y ~ log(x) ------------------------------------------------- #

gg_persist_mod_base + 
  geom_smooth(method = "lm", formula = y ~ log(x), se = FALSE) + 
  geom_vline(xintercept = 
               exp(( 0.5 - coef(lm(proportion ~ log(age), data = dat))[1] ) / 
                     coef(lm(proportion ~ log(age), data = dat))[2]))

# others
gg_persist_mod_base + 
  geom_smooth(method = "lm", formula = y ~ exp(x), se = FALSE)


# ----------------------------------- log(y) ~ x ------------------------------------------------- #

gg_persist_mod_base + 
  geom_smooth(method = "lm", formula = log(y) ~ x,
              se = FALSE)

# simple lm ----------------- #
lm_mod <- lm(log(proportion) ~ age, data = dat)

  # note, needs to be log transformed
ggplot(data = dat, mapping = aes(x = age, y = log(proportion))) + 
  theme_classic() + 
  geom_point(mapping = aes(group = year_abn, color = year_abn), 
            size = 1.25) + 
  labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land",
       subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + 
  theme(legend.position = "bottom", legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 

  # log(y) ~ x
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) + 
  geom_hline(yintercept = log(0.5), linetype = "dashed", color = "red", size = 0.75) 
```


