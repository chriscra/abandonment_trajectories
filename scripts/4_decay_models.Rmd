---
title: "Analysis: Abandonment Decay Models"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
```{r initialize}

source("scripts/0_start.R")
source(paste0(p_proj, "scripts/util/_util_master.R"))

# this already includes lme4, broom.mixed, etc.

# install.packages('TMB', type = 'source')

```


```{r regression-packages}
regression_packages <- c("VIF", "nlme", "MASS", "spdep")
install_missing_packages(regression_packages)
library(VIF) # for selecting models for a linear model. Recommended by Liang.

# gls model - spatial autocorrelation
# spdep has lots of functions for assessing spatial autocorrelation.


```


# Exponential Decay:


Reminder of the framework for the first paper: characterizing abandonment trajectories & recultivation
- Looking at abandonment length (mean age), persistence, turnover (half-life), and predictors of age and recultivation. To a lesser extent, recultivation rates
- Variation between sites
- Combining the half-life and average length of time abandoned to extrapolate age classes into the future. 
- Possibly including aspects of fragmentation and measures of biomass over time (NDVI) - not likely
- Minor discussion of implications for biodiversity and carbon

Paper 1: characterizing abandonment trajectories (length, persistence, predictors)
1) What proportion of abandoned land remains abandoned long-term, and what proportion is recultivated? 
    a) What are the most common land uses of formerly abandoned lands (does this end up in grassland, forest, neither?)?
2) How long does abandonment typically last for? How much annual (or periodic) turnover occurs?
    a) What is the half-life of abandoned land? How does this vary across site, and overtime at each site?
3) How do these result vary across regions?
4) What are key predictors of length of abandonment, and recultivation? (Slope, elevation, soil, climate variables, surrounding landcover, proximity to woody veg/grassland, population, agricultural marginality)
5) How does landscape fragmentation (of grassland, woody vegetation, and agriculture) change over time as a result of abandonment? To what extent does abandonment result in older and more contiguous grassland and forests?
6) Can we discern regeneration in the trajectory of agriculture -> grassland -> woody vegetation? How does biomass (proxied by NDVI, or otherwise) change overtime? 
5) and 6) can and probably should be moved to paper 2 (biodiversity focus).
- Will include discussion of implications for biodiversity and other environmental factors (e.g. carbon), but based largely on existing data on time to biodiversity recovery.


My main questions: 1) how long does abandoned land stay abandoned for, and 2) how durable is abandoned agricultural land? These in turn translate into a series of more concrete questions: 
1) What is the half-life of abandoned agricultural land? 
2) How does the half-life vary over time?
3) How does the average half-life and the rate of change of the half-life differ across sites?

The plots of persistence of abandoned land over time show this


To provide a simple answer to this, I will first calculate the half-life for each of my sites, then look at how the half-life evolves over time at each of the sites. Therefore, I’m trying to model an exponential decay curve, with the proportion of land remaining abandoned (“proportion") as a function of how long the land has been abandoned (“age”). is the 

```{r set-run_label}
run_label <- "_2021_03_13"

# run_label <- "_2021-03-05"

# run_label <- "_b1"
```


```{r load-data}
# load data, produced from the following functions
# cc_calc_persistence() # which is called within
# cc_calc_persistence_all() # which is called within
# cc_summarize_abn_dts() # this is the master call within the cluster script, "analyze_all_sites.R"


site_df <- read_csv(file = paste0(p_dat_derived, "site_df.csv"))
site_df_w_size <- read_csv(file = paste0(p_dat_derived, "site_df_w_size.csv"))


# -------------------------- load summarized data.frames --------------------------- #
indx <- 9
site <- site_df$site[indx] # set site:
site_label <- site_df$label[indx] # set label
blip_label <- "_b1"
load(file = paste0(p_output, "abn_dat_products", blip_label, site_label, ".rds"), verbose = TRUE)

# loads:
area_b1_s
persistence_list_b1_s
abn_area_change_b1_s




# -------------------------- rasters --------------------------- #
# prepared input rasters (derived by Chris)
site_input_raster_files <- list.files(paste0(p_dat_derived, "input_rasters"), full.names = TRUE) %>%
  grep(".tif", ., value = TRUE) #%>% grep("age", ., value = TRUE, invert = TRUE)

r <- lapply(seq_along(site_input_raster_files), function(i) {brick(site_input_raster_files[i])})
names(r) <- site_df$site

# rename raster layers:
for (i in 1:11) {
  if (names(r[i]) == "nebraska") {
    names(r[[i]]) <- paste0("y", 1986:2018)
  } else {
    if (names(r[i]) == "wisconsin") {
      names(r[[i]]) <- paste0("y", 1987:2018)
    } else {
      # everything else, just 1987:2017
      names(r[[i]]) <- paste0("y", 1987:2017)
    }}}

# note: Land use class codes:
#       1. Non-vegetated area (e.g. water, urban, barren land)
#       2. Woody vegetation
#       3. Cropland 
#       4. Herbaceous land (e.g. grassland)

# abandonment age maps (produced by Chris)
age_files <- list.files(paste0(p_dat_derived, "age_rasters"), full.names = TRUE) %>%
  grep(".tif", ., value = TRUE) #%>% grep("age", ., value = TRUE, invert = FALSE)

age_r <- lapply(seq_along(age_files), function(i) {brick(age_files[i])})
names(age_r) <- site_df$site
for (i in seq_along(age_r)) {names(age_r[[i]]) <- paste0("y", 1987:2017)} # remember: these are just 1987:2017

# year of first abandonment maps (from He)
yoa_files <- list.files(paste0(p_dat, "Abandonment/year_of_abandonment/"))



# testers:
bs <- brick(paste0(p_dat, "Abandonment/belarus_small.tif"))
bt <- brick(paste0(p_dat_derived, "belarus_subset.tif"))
names(bs) <- paste0("y", 1987:2017)
names(bt) <- paste0("y", 1987:2017)



# -------------------------- data.tables --------------------------- #
b_age <- fread(input = paste0(p_dat_derived, "belarus_age.csv"))
names(b_age)
s_age <- fread(input = paste0(p_dat_derived, "shaanxi_age.csv"))


b_length <- fread(input = paste0(p_dat_derived, "lengths/", "belarus_length_b1.csv"))
s_length <- fread(input = paste0(p_dat_derived, "lengths/", "shaanxi_length_b1.csv"))

b_max_length <- fread(input = paste0(p_dat_derived, "lengths/", "belarus_max_length_b1.csv"))
s_max_length <- fread(input = paste0(p_dat_derived, "lengths/", "shaanxi_max_length_b1.csv"))

# original data
s_dt <- fread(input = paste0(p_dat_derived, "shaanxi.csv"))
names(s_dt) <- gsub(pattern = "andcover", replacement = "y", names(s_dt))

b_dt <- fread(input = paste0(p_dat_derived, "belarus.csv")) # caution - huge file! 8.4 GB at least. 




```

```{r prep-dat}
str(dat)

blip_label <- "_b1"


pairs(dat)

dat <- persistence_list_b1_s$na_first

dat <- left_join(dat, 
                 dat %>% filter(age == 5) %>% select(year_abn, initial_area_abn = area_ha), 
                 by = "year_abn") %>%
  
  # create bins of year_abn - could also use cut(), e.g. year_bins = cut(year_abn, breaks = 5) 
  # dat %>% mutate(nbins = cut(dat$year_abn, breaks = 5, include.lowest = TRUE)) %>% print(n = 30)
  mutate(year_abn_bins = cut(year_abn, breaks = 5, include.lowest = TRUE)) %>%
  # mutate(year_abn_bins = ifelse(year_abn >= 1988 & year_abn <= 1993, "1988-1993",
  #                          ifelse(year_abn >= 1994 & year_abn <= 1998, "1994-1998",
  #                                 ifelse(year_abn >= 1999 & year_abn <= 2003, "1999-2003",
  #                                        ifelse(year_abn >= 2004 & year_abn <= 2008, "2004-2008",
  #                                               ifelse(year_abn >= 2009 & year_abn <= 2013, "2009-2013", NA)
  #                                        ))))) %>%
  mutate(year_abn_bins = as_factor(year_abn_bins), # convert both to factors
         #year_abn = as_factor(year_abn),
         time = age - 5,
         time_1 = time + 1,
         cohort = factor(year_abn)) 




dat0 <- select(dat, time_1, age, initial_area_abn, cohort, year_abn) # for predictions


# variables of interest

dat$proportion # response variable: the proportion of originally abandoned land that remains in a given year. 
dat$year # the current year, allowing us to measure area abandoned in the current year, relative to the amount initially abandoned
dat$year_abn # cohort of land abandoned in a particular year, which is then followed year after year to track persistence
# ^ probably should be a factor
dat$count # number of pixels, from which area is determined
dat$area_ha # area abandoned, of a given cohort
dat$age # how long that land in that cohort has been abandoned for

dat$time # age - 5; adjusted time abandoned beyond the initial abandonment threshold. So, 0 corresponds to an abandonment age of 5, 1 -> 6, 2 -> 7 etc.

dat$time_1 # age - 4 (i.e. time + 1). This is so that time starts from 1, to avoid issues with taking the log of 0. 

dat$bins # bins of abandoned land of similar ages (5-10 years)
dat$year_abn_bins # bins of land abandoned during the same five to six year window
dat$initial_area_abn # the area (in ha) initially abandoned in a given year (cohort)

dat$cohort # a factor of "year_abn" to be used for cohort 

library(tidyr, data.table)

```

```{r dat_l-all-sites}
# find file path names to persistence data.frames:
persistence_file_paths <- list.files(path = paste0(p_dat_derived, run_label)) %>% 
  grep("pers", ., value = TRUE)

# load csvs into a list
dat_l <- lapply(persistence_file_paths, function(i) {
  read.csv(file = paste0(p_dat_derived, run_label, "/", i))
})

# old, for "_b1", loading .rds, assigning 
# dat_l <- lapply(1:11, FUN = function(x) {
#   load(file = paste0(p_output, "abn_dat_products", run_label, site_df$label[x], ".rds"), verbose = TRUE)
#   # extract just one data.frame
#   assign("dat", eval(parse(text = paste0("persistence_list", run_label, site_df$label[x])))[["na_first"]])
#   })

names(dat_l) <- site_df$site
dat_l <- dat_l %>% bind_rows(.id = "site") %>% as_tibble()

dat_l <- left_join(dat_l,
            dat_l %>% filter(age == 5) %>% select(site, year_abn, initial_area_abn = area_ha), 
            by = c("site", "year_abn")) %>%
  mutate(year_abn_bins = cut(year_abn, breaks = 5, include.lowest = TRUE)) %>%
  mutate(year_abn_bins = as_factor(year_abn_bins), # convert both to factors
         time = age - 5,
         time_1 = time + 1,
         cohort = factor(year_abn)) %>% 
  mutate(site = as_factor(site)) %>% filter(!is.na(proportion)) # remove all na proportions

dat_l_0 <- select(dat_l, site, time_1, age, initial_area_abn, cohort, year_abn) # for predictions
```


```{r dat_l-save, eval = FALSE}
write_csv(dat_l, path = paste0(p_dat_derived, "abn_decay_data", run_label, ".csv"))
```


```{r dat_l-load, eval = FALSE}
# ------------------------------------------ #
# when reloading, must restructure factors:

dat_l <- read_csv(file = paste0(p_dat_derived, "abn_decay_data", run_label, ".csv")) %>%
  mutate(site = as.factor(site),
         bins = as.factor(bins),
         year_abn_bins = as.factor(year_abn_bins),
         cohort = as.factor(cohort))

dat_l0 #<- dat_l
identical(dat_l0, dat_l)
# when is the first year abandonment can take place?
dat_l %>% filter(area_ha > 0) %>% group_by(site) %>% summarise(first_year = min(year_abn))

```

```{r area-dat}
area_file_paths <- list.files(path = paste0(p_dat_derived, run_label)) %>% 
  grep("area", ., value = TRUE)

# load csvs into a list
area_dat <- lapply(area_file_paths, function(i) {
  read.csv(file = paste0(p_dat_derived, run_label, "/", i))
})

names(area_dat) <- site_df$site
area_dat <- area_dat %>% bind_rows(.id = "site") %>% as_tibble()

# ---------------------------------------------------------------------- #
# plot facet grid
# ---------------------------------------------------------------------- #
ggplot(data  = area_dat %>% filter(lc != "Abandoned (>1)")
    ) +
    theme_classic() +
    # theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
    labs(y = expression("Area  (10"^{6}*" ha)") , 
         x = "Year", 
         title = "Area by Land Cover, with Abandonment",
         #subtitle = subtitle,
         color = NULL #"Land Cover"
         ) + 
    geom_line(mapping = aes(x = year, y = area_ha / (10^6), # convert to millions of ha
                            group = lc, color = fct_reorder(lc, lc, .desc = TRUE)),
              size = 1.5) + 
    theme(legend.position = "bottom",
          legend.title = element_text(size = 10)) +
    guides(color = guide_legend(nrow = 2, ncol = 3)) +
    
    scale_color_manual(values = plot_cols) + 
  facet_wrap(vars(site))

```

```{r turnover-dat}
turnover_file_paths <- list.files(path = paste0(p_dat_derived, run_label)) %>% 
  grep("turnover", ., value = TRUE)

# load csvs into a list
turnover_dat <- lapply(turnover_file_paths, function(i) {
  read.csv(file = paste0(p_dat_derived, run_label, "/", i))
})

names(turnover_dat) <- site_df$site
turnover_dat <- turnover_dat %>% bind_rows(.id = "site") %>% as_tibble()

ggplot() +
    theme_classic() + 
    labs(y = expression("Annual area turnover (10"^{3}*" ha)"), 
         x = "Year", 
         #title = "Change in Area of Abandoned Land",
         #subtitle = subtitle,
         fill = NULL, #"Annual Change",
         color = NULL) + 
    scale_color_manual(values = c("black"),
                       labels = "Net Change") + 
    scale_fill_manual(values = brewer_pal(palette = "Greens")(5)[3:2],
                      labels = c("Area Gained", "Area Lost")) + 
    theme(legend.position = "bottom",
      #legend.position = c(0.2, 0.7),
      # legend.direction = "horizontal",
      legend.title = element_text(size = 10)
    ) +
    geom_col(data = filter(turnover_dat, change != "net"),
             mapping = aes(x = year, y = area_ha / (10^3), 
                           group = change, fill = change)) + 
    geom_line(data = filter(turnover_dat, change == "net"),
              mapping = aes(x = year, y = area_ha / (10^3), color = "Net Change in Area"),
              size = 1.5) + 
  facet_wrap(vars(site))

```


```{r run-lm-all-sites}
# run lms for each site individually, store in lists.

# log-log model, with cohort fixed effects
lm_log2_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + log(time + 1):cohort,  
               data = filter(dat_l, site == site_df$site[i]))
})

# log-log-lin model, with cohort fixed effects
# note, time needs to be adjusted to time + 1 in order for the log term to work
lm_log2_lin_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + log(time + 1):cohort + I(time):cohort,  
               data = filter(dat_l, site == site_df$site[i]))
})

  
# linear - log
lm_lin_log_l <- lapply(1:11, FUN = function(i) {
  lm(I(proportion - 1)  ~ 0 + log(time + 1):cohort,  
               data = filter(dat_l, site == site_df$site[i]))
})

# linear - log - linear
lm_lin_log_lin_l <- lapply(1:11, FUN = function(i) {
  lm(I(proportion - 1)  ~ 0 + log(time + 1):cohort + I(time):cohort,  
               data = filter(dat_l, #year_abn < 2011, 
                             site == site_df$site[i]))
})


# linear - log - linear, without cohort fixed effects:
lm_l3_no_cohort_l <- lapply(1:11, FUN = function(i) {
  lm(I(proportion - 1)  ~ 0 + log(time + 1) + I(time),  
               data = filter(dat_l, #year_abn < 2011, 
                             site == site_df$site[i]))
})

# log-log model, without cohort fixed effects
lm_log2_no_cohort_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + log(time + 1),  
               data = filter(dat_l, site == site_df$site[i]))
})

# log-log model, with year_abn (continuous) rather than the categorical cohort
lm_log2_year_abn_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0  + log(time + 1) + log(time + 1):year_abn,  
               data = filter(dat_l, site == site_df$site[i]))
})

# lon-linear (exp. decay)
lm_log_lin_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + time:cohort,  
               data = filter(dat_l, site == site_df$site[i]))
})

# linear:cohort
lm_lin_cohort_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + time:cohort,  
               data = filter(dat_l, site == site_df$site[i]))
})

# linear
lm_0_l <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + time,  
               data = filter(dat_l, site == site_df$site[i]))
})

names(lm_log2_l) <- site_df$site
names(lm_log2_lin_l) <- site_df$site
names(lm_lin_log_l) <- site_df$site
names(lm_lin_log_lin_l) <- site_df$site
names(lm_l3_no_cohort_l) <- site_df$site
names(lm_log2_no_cohort_l) <- site_df$site
names(lm_log2_year_abn_l) <- site_df$site
names(lm_log_lin_l) <- site_df$site
names(lm_lin_cohort_l) <- site_df$site
names(lm_0_l) <- site_df$site

```


```{r mod-equation, results = "asis"}
# install.packages("equatiomatic")
library(equatiomatic)
equatiomatic::extract_eq(lm_lin_log_lin_l$shaanxi, use_coefs = FALSE, wrap = TRUE)

```

```{r save-basic-model-plot-all-sites}
# ------------------------------------------------ #
# linear-log-linear model, with cohort fixed effects
# ------------------------------------------------ #

# create directory, if it doesn't exist for this run yet:

if(!dir.exists(paste0(p_plots, run_label, "/decay/"))) {
  dir.create(paste0(p_plots, run_label,  "/decay/"))
}

i <- 9

# function
cc_save_decay_model_plots()

# save plots
lapply(1:11, function(i) cc_save_decay_model_plots(site_index = i, add_no_cohort = FALSE))
lapply(1:11, function(i) cc_save_decay_model_plots(site_index = i, add_no_cohort = TRUE))




# ------------------------------------------------ #
# for the manuscript main text: shaanxi, lin-log-lin
# ------------------------------------------------ #
mean_coef_tmp_l3_s <- tidy(lm_lin_log_lin_l[[9]]) %>% 
  mutate(site = site_df$site[i],
         coef_term = sub(":*cohort....:*", "", term),
         year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
         cohort = as.factor(year_abn)) %>% 
  group_by(coef_term) %>%
  summarise(mean_est = mean(estimate, na.rm = TRUE)) %>% arrange(coef_term)
  
# plot
gg_lin_log_lin_cohort_tmp_s <-
  ggplot(data = filter(dat_l, site == site_df$site[9]),
         mapping = aes(x = age, y = proportion, 
                       group = year_abn, color = year_abn)) + 
  theme_classic() + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  scale_x_continuous(n.breaks = 6) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(#title = "Decay of abandoned land over time", 
       #subtitle = site_df$description[9], 
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Cohort \n(Year First \nAbandoned)",
       linetype = "") + 

  geom_line(data = mutate(augment(lm_lin_log_lin_l[[9]]),
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          age = time + 5,
                          proportion = .fitted + 1,
                          year_abn = as.numeric(levels(cohort))[cohort])) + 
  
  # site mean coefficients: (note, needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) {
    mean_coef_tmp_l3_s$mean_est[2]*log(x-4) + mean_coef_tmp_l3_s$mean_est[1]*((x-4) - 1) + 1},
    mapping = aes(linetype = "Mean \nDecay \nRate"),
    color = "blue", size = 1, inherit.aes = FALSE) + 
  theme(legend.position = c(0.9, 0.7))

# save ------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "ms_fig_l3_cohort", run_label, "_s.png"), 
  width = 6.5, height = 5.5, 
  units = "in", res = 400)
print(gg_lin_log_lin_cohort_tmp_s)
dev.off()






# ------------------------------------------------ #
# lin-log model, with cohort fixed effects
# ------------------------------------------------ #
# save plots:
for (i in 1:11) {
  
  gg_lin_log_cohort_tmp <- 
    ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
        theme_classic() +
    geom_point(data = filter(dat_l, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) + 
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_lin_log_l[[i]]), 
                          year_abn = as.numeric(levels(cohort))[cohort],
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          age = time + 1 + 4,
                          proportion = .fitted + 1)) + 
    
    # average (needs to be transformed 4 to the right, so that plotting works)
    geom_function(fun = function(x) {(mean(coef(lm_lin_log_l[[i]]), na.rm = TRUE))*log(x-4) + 1},
                  mapping = aes(linetype = "Mean Decay Rate"),
                  color = "blue", size = 1, inherit.aes = FALSE)
  
  png(filename = paste0(p_plots, run_label, "/decay/", "lin-log_cohort", run_label, site_df$label[i], ".png"), 
    width = 8, height = 6, units = "in", res = 400)
  print(gg_lin_log_cohort_tmp)
  dev.off()
  
}




# ------------------------------------------------ #
# log-log model, with cohort fixed effects
# ------------------------------------------------ #
# save plots:
for (i in 1:11) {
  
  gg_log2_cohort_tmp <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
        theme_classic() + 
    geom_point(data = filter(dat_l, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) + 
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_log2_l[[i]]), 
                          year_abn = as.numeric(levels(cohort))[cohort]),
            aes(x = exp(`log(time + 1)`) + 4, y = exp(.fitted))) + 
    
    # average (needs to be transformed 4 to the right, so that plotting works)
    geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[i]]), na.rm = TRUE))},
                  mapping = aes(linetype = "Mean Decay Rate"),
                  color = "blue", size = 1, inherit.aes = FALSE)
  
  png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort", run_label, site_df$label[i], ".png"), 
    width = 8, height = 6, units = "in", res = 400)
  print(gg_log2_cohort_tmp)
  dev.off()
  
}


# ------------------------------------------------ #
# both log-log and linear-log-linear models, together
# ------------------------------------------------ #
# save plots:

for (i in 1:11) {
  
  # log-log
  gg_log2_cohort_tmp <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
        theme_classic() + 
    geom_point(data = filter(dat_l, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) + 
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(subtitle = "log-log model", 
         title = site_df$description[i], 
         caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_log2_l[[i]]), 
                          year_abn = as.numeric(levels(cohort))[cohort],
                          age = exp(`log(time + 1)`) + 4,
                          proportion = exp(.fitted))) + 
    geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[i]]), na.rm = TRUE))},
                  mapping = aes(linetype = "Mean Decay Rate"),
                  color = "blue", size = 1, inherit.aes = FALSE)
  
  # calculate and extract mean coef estimates:
  mean_coef_tmp <- tidy(lm_lin_log_lin_l[[i]]) %>% 
    mutate(site = site_df$site[i],
           coef_term = sub(":*cohort....:*", "", term),
           year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
           cohort = as.factor(year_abn)) %>% 
    group_by(coef_term) %>%
    summarise(mean_est = mean(estimate, na.rm = TRUE)) %>% arrange(coef_term)
    
  # plot
  gg_lin_log_lin_cohort_tmp <- ggplot(data = filter(dat_l, site == site_df$site[i]), 
                                      mapping = aes(x = age, y = proportion, 
                                                    group = year_abn, color = year_abn)) + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(subtitle = "lin-log-lin model", 
         title = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
  
    geom_line(data = mutate(augment(lm_lin_log_lin_l[[i]]),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 1 + 4,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort])) + 
    geom_function(fun = function(x) {
      mean_coef_tmp$mean_est[2]*log(x-4) + mean_coef_tmp$mean_est[1]*((x-4) - 1) + 1},
      mapping = aes(linetype = "Mean Decay Rate"),
      color = "blue", size = 1, inherit.aes = FALSE) + 
    theme(legend.position = "none")

  
  
  y_ranges <- c(ggplot_build(gg_log2_cohort_tmp)$layout$panel_params[[1]]$y.range, 
                ggplot_build(gg_lin_log_lin_cohort_tmp)$layout$panel_params[[1]]$y.range)
  
  png(filename = paste0(p_plots, run_label, "/decay/", "l3_log2_combo", run_label, site_df$label[i], "_2.png"), 
    width = 11, height = 6, units = "in", res = 400)
  
  print(
    plot_grid(gg_log2_cohort_tmp + theme(legend.position = "none") +
                scale_y_continuous(lim = c(min(y_ranges), max(y_ranges)),
                                   breaks = seq(from = round(min(y_ranges), digits = 1), 
                                                to = round(max(y_ranges), digits = 1),
                                                by = 0.1)), 
              gg_lin_log_lin_cohort_tmp +
                scale_y_continuous(lim = c(min(y_ranges), max(y_ranges)),
                                   breaks = seq(from = round(min(y_ranges), digits = 1), 
                                                to = round(max(y_ranges), digits = 1),
                                                by = 0.1)), 
              cowplot::get_legend(gg_log2_cohort_tmp),
                ncol = 3, rel_widths = c(1, 1, 0.25))
    )
  dev.off()
}

```


```{r testing-CI}

ggplot(data = filter(dat_l, site == site_df$site[i]), 
                                      mapping = aes(x = age, y = proportion, 
                                                    group = year_abn, color = year_abn)) + 
    theme_classic() + 
  scale_color_distiller(palette = "Greens") + 
  scale_fill_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year First \nAbandoned)",
         linetype = "") + 
  
    geom_ribbon(data = mutate(augment(lm_lin_log_lin_l[[i]], se_fit = TRUE,
                                      interval = "confidence"),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort]),
                mapping = aes(x = age, y = proportion, 
                              ymin = .lower + 1, #proportion - .se.fit, 
                              ymax = .upper + 1, #proportion + .se.fit, 
                              group = year_abn, color = year_abn, fill = year_abn),
                alpha = 0.4,
                inherit.aes = FALSE) + 
  
      geom_point() + 

    
    # site mean coefficients:
    geom_line(data = fitted, mapping = aes(x = age, y = proportion, linetype = mod),
              # color = brewer_pal(palette = "PiYG")(11)[2], # dark pink
              color = "blue",
              size = 1, inherit.aes = FALSE) +
  
  geom_ribbon(data =   augment(lm_l3_no_cohort_l[[i]],
                               newdata = tibble(time = 5:30 - 5),
                               interval = "confidence") %>%
                mutate(age = time + 5,
                       proportion = .fitted + 1,
                       CI_upper = .upper + 1,        
                       CI_lower = .lower + 1),
              mapping = aes(x = age, ymax = CI_upper, ymin = CI_lower), 
              inherit.aes = FALSE,
              alpha = 0.3) + 
    
    scale_linetype_discrete(label = c("l3" = ifelse(add_no_cohort, "\nMean Decay Rate\n",
                                                    "Mean \nDecay \nRate"),
                                      "l3_no_cohort" = "Decay Rate \n(No fixed effects)"))


-0.0934 + 1.96*0.00219
-0.0977

```


```{r no-cohort-fixed-effects}
lm_l3_no_cohort_l

mean_coef_tmp
i <- 9
for (i in 1:11) {
  # calculate and extract mean coef estimates:
  mean_coef_tmp_no_cohort <- 
    tidy(lm_l3_no_cohort_l[[i]]) %>% 
    rename(coef_term = term) %>%
    mutate(site = site_df$site[i],
           term = ifelse(grepl("log", coef_term), "log", "lin"))
    
  # plot
  gg_l3_no_cohort_tmp <-
    ggplot(data = filter(dat_l, site == site_df$site[i]), 
                                      mapping = aes(x = age, y = proportion, 
                                                    group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year First \nAbandoned)",
         linetype = "") + 
  
    geom_line(data = mutate(augment(lm_l3_no_cohort_l[[i]]),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1
                            # ,
                            # year_abn = as.numeric(levels(cohort))[cohort]
                            ), 
              mapping = aes(x = age, y = proportion), 
              inherit.aes = FALSE) + 
    
  
    # site mean coefficients: (note, needs to be transformed 4 to the right, so that plotting works)
    geom_function(fun = function(x) {
        filter(mean_coef_tmp_no_cohort, term == "log")$estimate * log(x-4) +
          filter(mean_coef_tmp_no_cohort, term == "lin")$estimate * ((x-4) - 1) + 1},
      mapping = aes(linetype = "Mean Decay Rate \n(No fixed effects)"),
      color = "blue", size = 1, inherit.aes = FALSE) #+ theme(legend.position = c(0.9, 0.82))
  
  
  png(filename = paste0(p_plots, run_label, "/decay/", "l3_no_cohort", run_label, site_df$label[i], ".png"), 
    # width = 6.5, height = 6, 
    width = 7, height = 6, 
    units = "in", res = 400)
  print(gg_l3_no_cohort_tmp)
  dev.off()
}


# combo plot with l3 with and without cohort fixed effects:

```



```{r cohort-range}
cohort_range <- dat_l$year_abn %>% unique()
new_dat <- tibble(time = rep(0:(length(cohort_range) - 1), time = length(cohort_range)),
                  cohort = as_factor(rep(cohort_range, each = length(cohort_range))))
# 
# # replace 
# tibble(time = rep(0:25, time = 26), cohort = as_factor(rep(1988:2013, each = 26))) # with
# new_dat

```



```{r full-extrapolation}
# plot trajectory of each cohort out 30 years in full:

# plot log2
ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
    geom_point(data = filter(dat_l, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) + 
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_log2_l[[i]],
                                    newdata = new_dat),
                            age = time + 5,
                            proportion = exp(.fitted),
                            year_abn = as.numeric(levels(cohort))[cohort])) + 
    geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[i]]), na.rm = TRUE))},
                  mapping = aes(linetype = "Mean Decay Rate"),
                  color = "blue", size = 1, inherit.aes = FALSE)



# plot lin-log-lin
i <- 9
mean_coef_tmp <- tidy(lm_lin_log_lin_l[[i]]) %>% 
    mutate(site = site_df$site[i],
           coef_term = sub(":*cohort....:*", "", term),
           year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
           cohort = as.factor(year_abn)) %>% 
    group_by(coef_term) %>%
    summarise(mean_est = mean(estimate, na.rm = TRUE)) %>% arrange(coef_term)


ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
    geom_point(data = filter(dat_l, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_lin_log_lin_l[[i]],
                                    newdata = new_dat),
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort])) + 
  geom_function(fun = function(x) {
      mean_coef_tmp$mean_est[2]*log(x-4) + mean_coef_tmp$mean_est[1]*((x-4) - 1) + 1},
      mapping = aes(linetype = "Mean Decay Rate"),
      color = "blue", size = 1, inherit.aes = FALSE)



# ------------------------------------------------ #
# save both log-log and linear-log-linear models, with full extrapolation
# ------------------------------------------------ #
# save plots:
for (i in 1:11) {
  # calculate and extract mean coef estimates:
  mean_coef_tmp <- tidy(lm_lin_log_lin_l[[i]]) %>% 
    mutate(site = site_df$site[i],
           coef_term = sub(":*cohort....:*", "", term),
           year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
           cohort = as.factor(year_abn)) %>% 
    group_by(coef_term) %>%
    summarise(mean_est = mean(estimate, na.rm = TRUE)) %>% arrange(coef_term)
    
  # plot
  gg_lin_log_lin_cohort_tmp <- ggplot(data = filter(dat_l, site == site_df$site[i]), 
                                      mapping = aes(x = age, y = proportion, 
                                                    group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: (proportion - 1) ~ 0 + log():cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
  
    geom_line(data = mutate(augment(lm_lin_log_lin_l[[i]], 
                                    newdata = new_dat),
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort])) + 
    geom_function(fun = function(x) {
      mean_coef_tmp$mean_est[2]*log(x-4) + mean_coef_tmp$mean_est[1]*((x-4) - 1) + 1},
      mapping = aes(linetype = "Mean Decay Rate"),
      color = "blue", size = 1, inherit.aes = FALSE)
  
  
  # log-log
  gg_log2_cohort_tmp <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point(data = filter(dat_l, site == site_df$site[i])) + scale_color_distiller(palette = "Greens") +
    scale_x_continuous(n.breaks = 6) + 
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(title = "Decay of abandoned land over time", 
         subtitle = site_df$description[i], 
         caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort (Year \nFirst Abandoned)",
         linetype = "") + 
    
    # fitted values
    geom_line(data = mutate(augment(lm_log2_l[[i]], 
                                    newdata = new_dat), 
                            age = time + 5,
                            proportion = exp(.fitted),
                            year_abn = as.numeric(levels(cohort))[cohort])) + 
    geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[i]]), na.rm = TRUE))},
                  mapping = aes(linetype = "Mean Decay Rate"),
                  color = "blue", size = 1, inherit.aes = FALSE)
  
  
  y_ranges <- c(ggplot_build(gg_log2_cohort_tmp)$layout$panel_params[[1]]$y.range, 
                ggplot_build(gg_lin_log_lin_cohort_tmp)$layout$panel_params[[1]]$y.range)
  
  png(filename = paste0(p_plots, run_label, "/decay/", "l3_log2_combo_extrapolation", run_label, site_df$label[i], ".png"), 
    width = 13, height = 7.5, units = "in", res = 400)
  
  print(plot_grid(
    gg_log2_cohort_tmp + theme(legend.position = "none") + coord_cartesian(ylim = y_ranges[1:2]), 
    gg_lin_log_lin_cohort_tmp + coord_cartesian(ylim = y_ranges[1:2]),
    ncol = 2, rel_widths = c(1, 1.3), align = "v", axis = "l")
    )
  
  # print(
  #   plot_grid(gg_log2_cohort_tmp + theme(legend.position = "none") + 
  #               scale_y_continuous(lim = c(min(y_ranges), max(y_ranges)),
  #                                  breaks = seq(from = round(min(y_ranges), digits = 1), 
  #                                               to = round(max(y_ranges), digits = 1),
  #                                               by = 0.1)), 
  #             gg_lin_log_lin_cohort_tmp +
  #               scale_y_continuous(lim = c(min(y_ranges), max(y_ranges)),
  #                                  breaks = seq(from = round(min(y_ranges), digits = 1), 
  #                                               to = round(max(y_ranges), digits = 1),
  #                                               by = 0.1)), 
  #             ncol = 2, rel_widths = c(1, 1.3), align = "v", axis = "l")
  #   )
  # 
  dev.off()
}
```


```{r AIC}

mod_ll <- list("lm_log2_l" = lm_log2_l,
               "lm_log2_lin_l" = lm_log2_lin_l,
               #"lm_log2_lin_l_not0" = lm_log2_lin_l_not0,
               "lm_lin_log_l" = lm_lin_log_l,
               "lm_lin_log_lin_l" = lm_lin_log_lin_l,
               "lm_l3_no_cohort_l" = lm_l3_no_cohort_l,
               #"lm_lin_log_lin_l_not0" = lm_lin_log_lin_l_not0,
               # "lm_log2_no_cohort_l" = lm_log2_no_cohort_l,
               # "lm_log2_year_abn_l" = lm_log2_year_abn_l,
               #"lm_0_l" = lm_0_l,
               "lm_log_lin_l" = lm_log_lin_l
               )

mod_ll_mega <- list(
  "log(p) ~ 0 + log(time + 1):cohort:site" = lm_mega_log2_l,
  "log(p) ~ 0 + log(time + 1):cohort:site + \ntime:cohort:site" = lm_mega_log2_lin_l,
  "p - 1 ~ 0 + log(time + 1):cohort:site" = lm_mega_lin_log_l,
  "p - 1 ~ 0 + log(time + 1):cohort:site + \ntime:cohort:site" = lm_mega_lin_log_lin_l,
  "p - 1 ~ 0 + log(time + 1):site + \ntime:site" = lm_mega_l3_no_cohort_l,
  "log(p) ~ 0 + log(time + 1):site" = lm_mega_log2_no_cohort_l,
  "log(p) ~ 0 + log(time + 1):site + \nlog(time + 1):year_abn:site" = lm_mega_log2_year_abn_l,
  "log(p) ~ 0 + time:cohort:site" = lm_mega_log_lin_l,
  "log(p) ~ 0 + time:site" = lm_mega_log_lin_no_cohort_l,
  "log(p) ~ 0 + time:cohort:site" = lm_mega_lin_cohort_l,
  "log(p) ~ 0 + time" = lm_mega_0_l,
  "p - 1 ~ 0 + log(time + 1):year_abn:site + \ntime:year_abn:site" = lm_mega_l3_cont)

# Calculate AIC
mod_AIC <- lapply(mod_ll, 
  FUN = function(x) {
    lapply(x, FUN = function(y) {glance(y)}) %>% bind_rows(.id = "site")
    }
  ) %>% 
  bind_rows(.id = "mod") %>% 
  select(site, AIC, mod, everything()) %>% 
  arrange(site, AIC)

mod_AIC_mega <- lapply(mod_ll_mega, function(x) glance(x)) %>% 
  bind_rows(.id = "mod") %>%
  select(mod, AIC, everything()) %>% 
  arrange(AIC)


# save mod_AIC
write_csv(mod_AIC, path = paste0(p_dat_derived, "mod_AIC", run_label, ".csv"))
# 
# # re load
# mod_AIC <- read.csv(file = paste0(p_dat_derived, "mod_AIC.csv"))

# view results
mod_AIC %>% 
  arrange(site, AIC) %>% select(site, AIC, mod, adj.r.squared) %>% print(n = 150)

gg_AIC <- ggplot(data = mod_AIC,
       mapping = aes(x = fct_reorder(site, desc(AIC)), y = -AIC, 
                     group = fct_reorder(mod, AIC), fill = fct_reorder(mod, AIC))) + 
  theme_classic() +
  geom_col(position = position_dodge(0.9)) +
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  labs(x = "Site", y = "Absolute Value AIC (larger is better)", fill = "Model")


# Save png
png(filename = paste0(p_plots, run_label, "/decay/", "mod_AIC_plot", run_label, ".png"), 
    width = 10, height = 5, units = "in", res = 400)
print(gg_AIC)
dev.off()


# mega AIC figure
gg_AIC_mega <-
  ggplot(data = mod_AIC_mega,
       mapping = aes(y = fct_reorder(mod, AIC), x = -AIC, 
                     group = fct_reorder(mod, AIC), fill = fct_reorder(mod, AIC))) + 
  theme_classic() +
  geom_col(position = position_dodge(0.9)) +
  # theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  labs(y = "Model", x = "Absolute Value AIC (larger is better)", fill = "Model") +
  theme(legend.position = "none",
        plot.margin = margin(4, 20, 4, 4, "pt"))

gg_AIC_mega

ggsave(plot = gg_AIC_mega, 
       filename = paste0(p_plots, run_label, "/decay/", "mod_AIC_mega_plot", run_label, ".png"), 
    width = 5, height = 4, units = "in")

glimpse



# at all sites, the lin-log-lin cohort model has the lowest AIC (i.e. best performance).
```

```{r nebraska-log2-v-log-lin}
dat %>% select(-proportion)

gg_nebraska_log2 <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = filter(dat_l, site == "nebraska")) + scale_color_distiller(palette = "Greens") + 
  #scale_x_continuous(n.breaks = 30) + 
  scale_y_continuous(limits = c(0.4, 1)) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(title = "Decay of abandoned land over time", subtitle = site_df$description[7], 
       caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
       x = "Time since initial abandonment (years)", y = "Proportion of abandoned land remaining",
       color = "Cohort (Year \nFirst Abandoned)") + 
  
  # log-log
  geom_line(data = mutate(augment(lm_log2_l$nebraska, 
                                  newdata = filter(dat_l, site == "nebraska") %>% select(-proportion)),
                          proportion = exp(.fitted))) + 
  
  # average (needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l$nebraska), na.rm = TRUE))},
                mapping = aes(linetype = "Mean Decay Rate"),
                color = "blue", size = 1, #linetype = "dashed", 
                inherit.aes = FALSE) + 
  scale_linetype(name = "")
  

gg_nebraska_log_lin <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = filter(dat_l, site == "nebraska")) + scale_color_distiller(palette = "Greens") + 
  #scale_x_continuous(n.breaks = 30) + 
  scale_y_continuous(limits = c(0.4, 1)) +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(title = "Decay of abandoned land over time", subtitle = site_df$description[7], 
       caption = "lm formula: log(proportion) ~ 0 + time:cohort",
       x = "Time since initial abandonment (years)", y = "Proportion of abandoned land remaining",
       color = "Cohort (Year \nFirst Abandoned)") + 
  
  # log-lin
  geom_line(data = mutate(augment(lm_log_lin_l$nebraska, 
                                  newdata = filter(dat_l, site == "nebraska") %>% select(-proportion)),
                          proportion = exp(.fitted))) + 
  
  # average (needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) {exp( mean(coef(lm_log_lin_l$nebraska), na.rm = TRUE)* (x - 5))},
                mapping = aes(linetype = "Mean Decay Rate"),
                color = "blue", size = 1, #linetype = "dashed", 
                inherit.aes = FALSE) + 
  scale_linetype(name = "")


# save the plot
png(filename = paste0(p_plots, run_label, "/decay/", "nebraska_log2_log_lin", run_label, ".png"), 
    width = 10, height = 5, units = "in", res = 400)
print(plot_grid(gg_nebraska_log2, gg_nebraska_log_lin + theme(legend.position = "none"),
                rel_widths = c(1.4, 1)))
dev.off()


```

```{r run-mega-lm}

# log-log model, with cohort fixed effects
lm_mega_log2_l <- lm(log(proportion) ~ 0 + log(time + 1):cohort:site, data = dat_l)


# log-log-lin model, with cohort fixed effects
# note, time needs to be adjusted to time + 1 in order for the log term to work
lm_mega_log2_lin_l <- lm(log(proportion) ~ 0 + log(time + 1):cohort:site + I(time):cohort:site,  
               data = dat_l)

  
# linear - log
lm_mega_lin_log_l <- lm(I(proportion - 1)  ~ 0 + log(time + 1):cohort:site,  
               data = dat_l)

# linear - log - linear
lm_mega_lin_log_lin_l <- lm(I(proportion - 1)  ~ 0 + log(time + 1):cohort:site + I(time):cohort:site,  
               data = dat_l)

# linear-log-linear model, with year_abn (continuous) rather than the categorical cohort fixed effects
lm_mega_l3_cont <- lm(I(proportion - 1)  ~ 0 + log(time + 1):year_abn:site + I(time):year_abn:site,  
               data = dat_l)


# linear - log - linear, without cohort fixed effects:
lm_mega_l3_no_cohort_l <- lm(I(proportion - 1)  ~ 0 + log(time + 1):site + I(time):site,  
               data = dat_l)

# log-log model, without cohort fixed effects
lm_mega_log2_no_cohort_l <- lm(log(proportion) ~ 0 + log(time + 1):site,  
               data = dat_l)

# log-log model, with year_abn (continuous) rather than the categorical cohort
lm_mega_log2_year_abn_l <- lm(log(proportion) ~ 0  + log(time + 1):site + log(time + 1):year_abn:site,  
               data = dat_l)


# lon-linear (exp. decay)
lm_mega_log_lin_l <- lm(log(proportion) ~ 0 + time:cohort:site,  
               data = dat_l)


lm_mega_log_lin_no_cohort_l <- lm(log(proportion) ~ 0 + time:site,  
               data = dat_l)

# linear:cohort
lm_mega_lin_cohort_l <- 
  lm(log(proportion) ~ 0 + time:cohort:site,  
               data = dat_l)


# linear
lm_mega_0_l <- lm(log(proportion) ~ 0 + time,  
               data = dat_l)

```


```{r mega-lm}
# note: it shouldn't make a difference whether you run the model for each site individually or as one mega model. For simplicity, I'm going to continue with the site specific models, since that is how I've largely coded things so far. 

# constructing a model of all sites, with cohort and site fixed effects
str(dat_l)

# ------------------------------------------------ #
# linear - log - linear, with cohort and site fixed effects
# ------------------------------------------------ #
lm_mega_l3_cohort_site_l <- lm(
  I(proportion - 1)  ~ 0 + log(time + 1):cohort:site + I(time):cohort:site 
  # + log(time + 1):site + I(time):site
  ,  
  data = dat_l #filter(dat_l, year_abn < 2011)#, #year_abn < 2011))
  )


lm_mega_l3_site_l <- lm(
  I(proportion - 1)  ~ 0 + log(time + 1):site + I(time):site,  
  data = filter(dat_l)#, #year_abn < 2011))
  )


coef_l3_mega <- tidy(lm_mega_lin_log_lin_l) %>%
  mutate(site = gsub("site", "", str_extract(term, "site[a-z,_]*")),
         year_abn = as.integer(str_extract(term, "[1-2][0-9][0-9][0-9]")),
         coef_term = ifelse(grepl("log", term), "log", "lin"))

coef_l3_mega %>% filter(is.na(year_abn)) %>% print(n = 22)
coef_l3_mega %>% filter(site == "belarus", coef_term == "log")

augment(lm_mega_lin_log_lin_l)

mean_coef_l3_mega <- coef_l3_mega %>%
  group_by(site, coef_term) %>% # group by site, term and coef_term (though you only need one of these)
  summarise(estimate = mean(estimate, na.rm = TRUE)) %>%
  mutate(mod = "l3") %>% ungroup()

coef_l3_no_cohort_mega <- tidy(lm_mega_l3_no_cohort_l) %>%
  mutate(site = gsub("site", "", str_extract(term, "site[a-z,_]*")),
         coef_term = ifelse(grepl("log", term), "log", "lin"),
         mod = "l3_no_cohort") %>%
  select(site, coef_term, mod, estimate)

coefs_l3_mega <- bind_rows(mean_coef_l3_mega, coef_l3_no_cohort_mega) %>%
  mutate(mod = as_factor(mod))

fitted <- bind_rows(
  tibble(age = 5:30,
         mod = "l3",
         a = filter(coefs_l3_mega, mod == "l3", coef_term == "log")$estimate,
         b = filter(coefs_l3_mega, mod == "l3", coef_term == "lin")$estimate),
  tibble(age = 5:30,
         mod = "l3_no_cohort",
         a = filter(coefs_l3_mega, mod == "l3_no_cohort", coef_term == "log")$estimate,
         b = filter(coefs_l3_mega, mod == "l3_no_cohort", coef_term == "lin")$estimate)) %>%
    mutate(proportion = a * log(age-4) + b * ((age-4) - 1) + 1)



fitted_l3_mega <- lapply(1:11, function(i) {
    bind_rows(
      tibble(age = 5:30,
           site = site_df$site[i],
           mod = "l3",
           a = filter(coefs_l3_mega, mod == "l3", site == site_df$site[i], coef_term == "log")$estimate,
           b = filter(coefs_l3_mega, mod == "l3", site == site_df$site[i], coef_term == "lin")$estimate),
      tibble(age = 5:30,
           site = site_df$site[i],
           mod = "l3_no_cohort",
           a = filter(coefs_l3_mega, mod == "l3_no_cohort", site == site_df$site[i], coef_term == "log")$estimate,
           b = filter(coefs_l3_mega, mod == "l3_no_cohort", site == site_df$site[i], coef_term == "lin")$estimate) 
      ) %>%
      mutate(proportion = a * log(age-4) + b * ((age-4) - 1) + 1)
}) %>% bind_rows()

View(fitted_l3_mega)
View(coef_l3_mega)

head(fitted_l3_mega)
tidy(lm_lin_log_lin_l$belarus) %>% 
  mutate(coef_term = sub(":*cohort....:*", "", term)) %>% 
  group_by(coef_term) %>%
  summarise(mean_coef = mean(estimate, na.rm = TRUE))





# ------------------------------------------------ #
# log-log model, with cohort and site fixed effects
# ------------------------------------------------ #
lm_log2_cohort_site <- lm(log(proportion) ~ 0 + log(time + 1):cohort:site, data = dat_l)

tidy(lm_log2_cohort_site) %>% mutate(site = sub(".*:site", "", term),
                                     year_abn = as.integer(gsub(".*:cohort|:site.*", "", term)),
                                     cohort = as.factor(year_abn)) %>%
  filter(site == "belarus")

# note: the coefficients seem to be (almost) exactly the same as the individual sites:
test <- tidy(lm_log2_cohort_site) %>% 
  mutate(site = sub(".*:site", "", term),
         year_abn = as.integer(gsub(".*:cohort|:site.*", "", term)),
         cohort = as.factor(year_abn))

left_join(coef_df, test, by = c("site", "cohort")) %>%
  mutate(diff = estimate.x - estimate.y) %>% filter(diff > 0) %>% .$diff #%>% print(n = 50)



# ---------- mega lm, with just site fixed effects, akin to lm_log2_no_cohort_l --------- #
lm_log2_site <- lm(log(proportion) ~ 0 + log(time + 1):site, data = dat_l)


lm(log(proportion) ~ 0 + log(time + 1):cohort:site, data = dat_l)

dat_l[2092, ]
augment(lm_log2_cohort_site) %>% filter(.hat < 1) %>% arrange(desc(.hat))

dat_l[-2092, ]
plot(lm_log2_cohort_site, 1)

plot(lm_log2_site, 1)
plot(lm_log2_l$shaanxi, 1)
dev.off()

lm_log2_no_cohort_l$shaanxi



# ------------------------------------------------ #
# diagnostic plots
# ------------------------------------------------ #
png(filename = paste0(p_plots, run_label, "/decay/", "resid_fitted_mega_lm", run_label, ".png"), 
    width = 5, height = 5, units = "in", res = 400)
# without the outlier:
plot(lm(log(proportion) ~ 0 + log(time + 1):cohort:site, data = dat_l[-2092, ]), 1, main = "Model with all sites, all cohorts")
dev.off()

png(filename = paste0(p_plots, run_label, "/decay/", "mega_lm_diag_plots", run_label, ".png"), 
    width = 7, height = 7, units = "in", res = 400)
par(mfrow = c(2,2))
plot(lm(log(proportion) ~ 0 + log(time + 1):cohort:site, data = dat_l[-2092, ]), main = "Model with all sites, all cohorts")
dev.off()

# need to run again without the values that it drops
car::qqPlot(lm(log(proportion) ~ 0 + log(time + 1):cohort:site, 
               data = filter(dat_l[-2092, ], year_abn < 2013)))

```

```{r decay-facet-grid}


# plots ------------------------------------------------ #


# gg_decay_mega_plus <-
  ggplot(data = dat_l, 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
         linetype = "") + 
  
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort])) +

  geom_line(data = fitted_l3_mega, 
            mapping = aes(x = age, y = proportion, linetype = mod),
              # color = brewer_pal(palette = "PiYG")(11)[2], # dark pink
              color = "blue",
              size = 1, inherit.aes = FALSE) +
  scale_linetype_discrete(label = c("l3" = "Mean Decay Rate\n(Across F.E.)",
                                      "l3_no_cohort" = "Decay Rate (No F.E.)")) + 
  theme(legend.position = c(0.9, 0.12), 
        legend.spacing = unit(2, units = "mm"), 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) + 
  coord_cartesian(ylim = c(0.3, 1)) +
  facet_wrap(vars(site))


gg_decay_mega <-
  ggplot(data = dat_l, 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point(size = 0.8) + scale_color_distiller(palette = "Greens") + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year Abandoned)",
         linetype = "") + 
  
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort])) +

  geom_line(data = fitted_l3_mega %>% filter(mod == "l3"), 
            mapping = aes(x = age, y = proportion, linetype = mod),
              # color = brewer_pal(palette = "PiYG")(11)[2], # dark pink
              color = "blue",
              size = 1, inherit.aes = FALSE) +
  scale_linetype_discrete(label = c("l3" = "Mean Decay Rate\n(Across Cohorts)",
                                      "l3_no_cohort" = "Decay Rate (No F.E.)")) + 
  theme(legend.position = c(0.93, 0.2),
        legend.spacing = unit(2, units = "mm"),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  coord_cartesian(ylim = c(0.3, 1)) +
  facet_wrap(vars(site), nrow = 2)

  
# --------------------------------------------------------------- #

ggsave(plot = gg_decay_mega_plus, 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid_plus", run_label, ".pdf"), 
    width = 8, height = 8, units = "in")


ggsave(plot = gg_decay_mega, 
       filename = paste0(p_plots, run_label, "/decay/", "decay_mod_grid_wider", run_label, ".pdf"), 
    width = 9, height = 5, units = "in")


# ---------------------------------------------------- #
# just Shaanxi

gg_shaanxi_decay_base <- 
  ggplot(data = dat_l %>% filter(site == "shaanxi"), 
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    # scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort\n(Year Abandoned)",
         linetype = "") + 
  scale_x_continuous(breaks = seq(5, 30, by = 5)) +
  theme(legend.position = c(0.87, 0.75),
        legend.spacing = unit(2, units = "mm"),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0))

gg_shaanxi_decay_trends <-
  gg_shaanxi_decay_base + 
    geom_line(data = mutate(augment(lm_mega_lin_log_lin_l, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1,
                            year_abn = as.numeric(levels(cohort))[cohort]) %>% 
               filter(site == "shaanxi"))

gg_shaanxi_decay_trends_w_mean <-
  gg_shaanxi_decay_trends +
  geom_line(data = fitted_l3_mega %>% filter(mod == "l3") %>% filter(site == "shaanxi"), 
            mapping = aes(x = age, y = proportion, linetype = mod),
              # color = brewer_pal(palette = "PiYG")(11)[2], # dark pink
              color = "blue",
              size = 1, inherit.aes = FALSE) +
  scale_linetype_discrete(label = c("l3" = "Mean Decay Rate\n(Across Cohorts)",
                                      "l3_no_cohort" = "Decay Rate (No F.E.)")) # + 
  # theme(legend.position = c(0.85, 0.75),
  #       legend.spacing = unit(2, units = "mm"),
  #       legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) +
  # coord_cartesian(ylim = c(0.5, 1)) #+
  #facet_wrap(vars(site), nrow = 2)


# ---------------------------------------------------------- #
# just shaanxi, for presentation:
# ---------------------------------------------------------- #

# just the data points:
ggsave(plot = gg_shaanxi_decay_base, 
       filename = paste0(p_plots, run_label, "/presentation/", "decay_mod_example_shaanxi_points", run_label, ".pdf"), 
    width = 6.25, height = 5, units = "in")

# with trends:
ggsave(plot = gg_shaanxi_decay_trends, 
       filename = paste0(p_plots, run_label, "/presentation/", "decay_mod_example_shaanxi_trends", run_label, ".pdf"), 
    width = 6.25, height = 5, units = "in")

# with trends, and mean:
ggsave(plot = gg_shaanxi_decay_trends_w_mean, 
       filename = paste0(p_plots, run_label, "/presentation/", "decay_mod_example_shaanxi_trends_w_mean", run_label, ".pdf"), 
    width = 6.25, height = 5, units = "in")




# super simplified version of the plot:


gg_decay_simple <-
  ggplot() + 
    theme_classic() + 
    geom_hline(yintercept = 0.5, linetype = "dashed") +
    labs(x = "t", 
         y = expression(P[y])) + 
  scale_x_continuous(breaks = seq(5, 30, by = 5)) +
  geom_line(data = fitted_l3_mega %>% filter(mod == "l3") %>% filter(site == "mato_grosso"), 
            mapping = aes(x = age, y = proportion, linetype = mod),
              color = brewer_pal(palette = "Greens")(9)[7], 
              size = 1, inherit.aes = FALSE) + 
    theme(legend.position = "none")

ggsave(plot = gg_decay_simple, 
       filename = paste0(p_plots, run_label, "/presentation/", "decay_simple_example", run_label, ".pdf"), 
    width = 2, height = 2, units = "in")
  
```



# Check Assumptions

```{r Oscar}
# chat with Oscar

# best models so far:
lm_mod_log2_cohort
lm_mod_cohort_slope0
lmer_mod_slope0


# plots
lm_mod_cohort_slope0
ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 

  labs(title = "log(proportion) ~ 0 + time:cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + time:cohort, data = dat)), 
                          year_abn = as.numeric(levels(cohort))[cohort], age = time + 5),
            aes(x = age, y = exp(.fitted)))


# lmer_mod_slope0
lmer_mod_slope0
ggplot(data = augment(lmer_mod_slope0) %>% mutate(year_abn = as.numeric(levels(cohort))[cohort],
                                                       age = time + 5),
       mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = dat) +
  geom_line(aes(y = exp(.fitted)), size = 1) + 
  
  # average of the model
  geom_line(aes(y = exp(.fixed)), size = 1.5, color = "red") + 
  
  # lm_mod0
  geom_line(data = augment(lm_mod0, newdata = mutate(data.frame(time = 0:25), age = time + 5)),
            aes(x = age, y = exp(.fitted)),
            color = "blue", size = 1.5, inherit.aes = FALSE) + 
  
  scale_color_distiller(palette = "Greens") + 
  
  geom_hline(yintercept = 0.5)


# log log 0
lm_mod_log2_cohort
ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(title = "log(proportion) ~ 0 + log(time + 1):cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1):cohort, 
                                     data = mutate(dat, time + 1 = time + 1))), 
                          year_abn = as.numeric(levels(cohort))[cohort]),
            aes(x = exp(`log(time + 1)`) - 1 + 5, y = exp(.fitted))) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))
```

```{r diag-plots}
# -------------------------------------------------------------------------------------------------- #
# ------------------------------------- log-log diagnostics plots ---------------------------------- #
# -------------------------------------------------------------------------------------------------- #

# ----------------------- diagnostics plot, shaanxi ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_diag", run_label, "_s.png"), 
    width = 8, height = 8, units = "in", res = 400)
par(mfrow = c(2,2))
plot(lm_mod_log2_cohort)
plot(lm_log2_l[[9]])
dev.off()

tidy(lm_log2_l[[9]])


# ----------------------- diagnostics plot, all sites in sequence ----------------------- #
lapply(1:11, FUN = function(i) {
  
  png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_diag", run_label, site_df$label[i],".png"), 
    width = 8, height = 8, units = "in", res = 400)
  par(mfrow = c(2,2))
  plot(lm_log2_l[[i]], 1, main = site_df$site[i])
  plot(lm_log2_l[[i]], 2)
  plot(lm_log2_l[[i]], 3)
  plot(lm_log2_l[[i]], 4)

  dev.off()
  
})

# ----------------------- fitted vs. residuals diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_diag_resid_v_fitted", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) plot(lm_log2_l[[i]], 1, main = site_df$site[i])
dev.off()


# ----------------------- QQ diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_diag_qq", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) plot(lm_log2_l[[i]], 2, main = site_df$site[i])
dev.off()




# -------------------------------------------------------------------------------------------------- #
# ------------------------------------- lin-log diagnostics plots ---------------------------------- #
# -------------------------------------------------------------------------------------------------- #

# ----------------------- fitted vs. residuals diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "lin-log_cohort_diag_resid_v_fitted", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) plot(lm_lin_log_l[[i]], 1, main = site_df$site[i])
dev.off()


# ----------------------- QQ diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "lin-log_cohort_diag_qq", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) {qqnorm(residuals(lm_lin_log_l[[i]]), main = paste0("QQ: ", site_df$site[i]))}
dev.off()







qqplot(lm_lin_log_lin_l[[i]])
qqnorm(residuals(lm_lin_log_lin_l[[i]]))
abline(0, 1, col = 'red')
qqline(residuals(lm_lin_log_lin_l[[i]]))
qqline(lm_lin_log_lin_l$belarus$residuals)

# why doesn't the QQ plot work for the lms that start with a linear term?
lm_log2_l
lm_lin_log_lin_l

lm_log2_l[[1]]
lm_lin_log_lin_l[[1]]
lm_log2_lin_l[[1]]

i <- 1
dev.off()
par(mfrow = c(3, 4))
plot(lm(formula = log(proportion) ~ 0 + log(time + 1):cohort + I(time):cohort, 
        data = filter(dat_l, site == site_names[i])))

plot(lm(formula = I(proportion - 1) ~ 0 + log(time + 1):cohort + I(time):cohort, 
        data = filter(dat_l, year_abn < 2012, site == site_names[i])))

dev.off()
par(mfrow = c(3, 4))
for (i in 1:11) {plot(lm_lin_log_lin_l[[i]], 2, main = site_df$site[i])}
```


```{r save-l3-diag-plots}
# -------------------------------------------------------------------------------------------------- #
# --------------------------------- lin-log-lin diagnostics plots ---------------------------------- #
# -------------------------------------------------------------------------------------------------- #

# ----------------------- fitted vs. residuals diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_diag_resid_v_fitted", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) plot(lm_lin_log_lin_l[[i]], 1, main = site_df$site[i])
dev.off()


# ----------------------- QQ diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_diag_qq", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) {qqnorm(residuals(lm_lin_log_lin_l[[i]]), main = paste0("QQ: ", site_df$site[i]))}
dev.off()

# using car, but with a subset of the data, year_abn < 2011
library(car)

# ----------------------- QQ diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_diag_qq_subset", run_label, ".png"), 
    width = 9, height = 8, units = "in", res = 400)
par(mfrow = c(3, 4))
for (i in 1:11) {
  qqPlot(lm(formula = I(proportion - 1) ~ 0 + log(time + 1):cohort + I(time):cohort, 
        data = filter(dat_l, year_abn < 2011, site == site_names[i])),
       ylab = "Sample Quantiles",
       main = paste0("QQ: ", site_df$site[i]))
}
dev.off()


```

```{r resid-v-covariates}

# save figure of residuals vs. time:

# ------ #  put together df of residuals:

# all sites individually, combined
resid_df_log2 <- lapply(lm_log2_l, augment) %>% bind_rows(.id = "site") %>%
  bind_cols(., dat_l) %>% mutate(mod = "log_log")
resid_df_l3 <- lapply(lm_lin_log_lin_l, augment) %>% bind_rows(.id = "site") %>%
  bind_cols(., dat_l) %>% mutate(mod = "lin_log_lin")
resid_df_lin_log <- lapply(lm_lin_log_l, augment) %>% bind_rows(.id = "site") %>%
  bind_cols(., dat_l) %>% mutate(mod = "lin_log")

mega_resid_df <- bind_rows(resid_df_log2, resid_df_l3, resid_df_lin_log)


# save multiple model diagnostics plots ---------------- #

png(filename = paste0(p_plots, run_label, "/decay/", "resid_time_multi", run_label, ".png"), 
    width = 10, height = 5, units = "in", res = 400)
print(
  ggplot(data = mega_resid_df %>% filter(.std.resid > -10)
         , aes(x = time, y = .std.resid, color = year_abn)) + 
    geom_point(alpha = 0.8, position = position_jitter()) + 
    scale_color_distiller(palette = "Greens") + 
    labs(y = "Residuals", x = "Time Past Abandonment Threshold") + 
    facet_wrap(facets = vars(mod))
)
dev.off()




# -------------------------------------------------------------- #

mega_lm_mod_l3 <- augment(lm_mega_lin_log_lin_l) %>% 
  mutate(time = round(exp(`log(time + 1)`), digits = 0) - 1,
         age = time + 5,
         # proportion = .fitted + 1,
         year_abn = as.numeric(levels(cohort))[cohort]) %>%
  left_join(., dat_l, by = c("site", "year_abn", "cohort", "time", "age"))

names(mega_lm_mod_l3)

names(dat_l)

plot(lm_mega_lin_log_lin_l)
hist(mega_lm_mod_l3$.std.resid)
arrange(mega_lm_mod_l3, .std.resid)

ggplot(data = mega_lm_mod_l3 %>% filter(.std.resid > -10, site != "mato_grosso")
         , aes(x = time, y = .std.resid, color = year_abn)) + 
    geom_point(alpha = 0.8, position = position_jitter()) + 
    scale_color_distiller(palette = "Greens") + 
    labs(y = "Residuals", x = "Time Past Abandonment Threshold (Years)",
         caption = "Excluding Mato Grosso")

# q-q
ggplot(data = mega_lm_mod_l3 %>% filter(.std.resid > -10, site != "mato_grosso"), 
       aes(sample = .std.resid)) +
  stat_qq() +
  stat_qq_line()

qqPlot(mega_lm_mod_l3$.std.resid)
qqPlot(lm_mega_lin_log_lin_l)

par(mfrow = c(2,2))
plot(lm_mega_lin_log_lin_l)
dev.off()






# ------------------------------ old -------------------------------- #

lm_mod_log2_cohort

plot(lm_mod_log2_cohort)
augment(lm_mod_log2_cohort) %>% arrange(desc(.hat))

# just one site
resid_df1 <-  bind_cols(augment(lm_mod_log2_cohort), # with the tester model from above
                        filter(dat_l, site == "shaanxi"))


# residuals from the full model including all sites
resid_df_all <- bind_cols(dat_l, 
                          augment(lm_log2_cohort_all_site))



lapply(list(#"lm_log2_lin_l" = lm_log2_lin_l,
            #"lm_log2_lin_l_not0" = lm_log2_lin_l_not0,
            #"lm_lin_log_lin_l_not0" = lm_lin_log_lin_l_not0,
            #"lm_log2_no_cohort_l" = lm_log2_no_cohort_l,
            #"lm_log2_year_abn_l" = lm_log2_year_abn_l,
            #"lm_0_l" = lm_0_l,
            #"lm_log_lin_l" = lm_log_lin_l,
            "lm_log2_l" = lm_log2_l,
            "lm_lin_log_l" = lm_lin_log_l,
            "lm_lin_log_lin_l" = lm_lin_log_lin_l
            ), 
       FUN = function(x){lapply(x, augment) %>% bind_rows(.id = "site")}) %>% bind_cols(., .id = "mod", dat_l)




# resid_df <- bind_cols(select(dat, year, year_abn, initial_area_abn, 
#                              area_ha, age, proportion, time, time + 1, 
#                              cohort1 = cohort),
#                       augment(lm_mod_log2_cohort))

resid_df_all <- bind_cols(select(dat_l, year, year_abn, initial_area_abn, 
                             area_ha, age, proportion, time, time + 1, 
                             cohort1 = cohort),
                      augment(lm_log2_cohort_site))

gg_resid_1 <- ggplot(data = resid_df, aes(x = time, y = .std.resid, color = year_abn)) + 
  geom_point(alpha = 0.8, position = position_jitter()) + scale_color_distiller(palette = "Greens") + labs(y = "Residuals", x = "Time Past Abandonment Threshold")


resid_df <- bind_rows()

gg_resid_1
gg_resid_1 %+% resid_df_lin_log[-2092, ]
gg_resid_1 %+% resid_df_log2[-2092, ]
gg_resid_1 %+% resid_df_l3[-2092, ]

ggplot(data = resid_df_lin_log[-2092, ], aes(x = time, y = .std.resid, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + labs(y = "Residuals", x = "Time Past Abandonment Threshold")

ggplot(data = resid_df_log2,#[-2092, ], 
       aes(x = time, y = .std.resid, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + labs(y = "Residuals", x = "Time Past Abandonment Threshold")

ggplot(data = resid_df_l3,#[-2092, ], 
       aes(x = time, y = .std.resid, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + labs(y = "Residuals", x = "Time Past Abandonment Threshold")




mega_resid_df %>% mutate(index = 1:nrow(.)) %>% select(index, everything()) %>% arrange(.std.resid) # mato_grosso


gg_resid_1 + facet_wrap(facets = vars(site...10))


gg_resid_2 <- ggplot(data = resid_df, aes(x = initial_area_abn, y = .std.resid, color = year_abn)) + 
  geom_point(position = position_jitter(width = 20)) + scale_color_distiller(palette = "Greens") + 
  labs(y = "Residuals", x = "Initial Area Abandoned") + theme(legend.position = "none")


# save, shaanxi
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_resid", run_label, "_s.png"), 
    width = 10, height = 5, units = "in", res = 400)
plot_grid(gg_resid_1, gg_resid_2, rel_widths = c(1.2, 1))
dev.off()


# save
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_resid", run_label, "_all.png"), 
    width = 10, height = 5, units = "in", res = 400)
plot_grid(gg_resid_1 %+% resid_df_all[-2092, ],
          gg_resid_2 %+% resid_df_all[-2092, ], 
          rel_widths = c(1.2, 1))
dev.off()



# --------------------------------------------------------------------- #
par(mfrow = c(2,2))
plot(lm_mod_log2_cohort)
augment(lm_mod_log2_cohort) %>% arrange(desc(.hat))





# plot for just shaanxi
str(resid_df)
gg_resid_time <- ggplot(data = resid_df, 
                        aes(x = time, y = .std.resid, color = year_abn)) + 
  geom_point() + 
  scale_color_distiller(palette = "Greens") + 
  labs(y = "Residuals", x = "Time Past Abandonment Threshold")

gg_resid_area <- ggplot(data = resid_df, 
                        aes(x = initial_area_abn, y = .std.resid, color = year_abn)) + 
  geom_point(position = position_jitter(width = 20)) + 
  scale_color_distiller(palette = "Greens") + 
  labs(y = "Residuals", x = "Initial Area Abandoned") + 
  theme(legend.position = "none")



#install.packages("cowplot")
library(cowplot)
# all sites
cowplot::plot_grid(gg_resid_time, gg_resid_area, rel_widths = c(1.2, 1))


# all sites
cowplot::plot_grid(
  gg_resid_time %+% resid_df[-2092, ], # without outlier
  gg_resid_area %+% resid_df[-2092, ], # without outlier
  rel_widths = c(1.2, 1))


# residuals from the model with all sites: 
cowplot::plot_grid(
  gg_resid_time %+% resid_df_all[-2092, ], # without outlier
  gg_resid_area %+% resid_df_all[-2092, ], # without outlier
  rel_widths = c(1.2, 1))



# to plot specific sites:
cowplot::plot_grid(
  gg_resid_time %+% filter(resid_df[-2092, ], site...1 == "shaanxi"), # without outlier
  gg_resid_area %+% filter(resid_df[-2092, ], site...1 == "shaanxi"), # without outlier
  rel_widths = c(1.2, 1))

```

```{r check-assumptions}

# ------- check assumptions of the lm ------------------------------------------------- #
lm_mod
par(mfrow = c(2,2))
plot(mod_l[[9]])
residuals(lm_mod)
broom::augment(lm_mod)

# plot model diagnostics:
par(mfrow = c(2,2)) # create a plotting panel with two rows and two columns (allowing you to put 4 plots on the same plotting panel)
plot(lm_mod) # check for violations of model assumptions

dev.off()

# description of the four diagnostic plots from: http://www.sthda.com/english/articles/39-regression-model-diagnostics/161-linear-regression-assumptions-and-diagnostics-in-r-essentials/
# 1. Residuals vs Fitted. Used to check the linear relationship assumptions. A horizontal line, without distinct patterns is an indication for a linear relationship, which is good.
# 2. Normal Q-Q. Used to examine whether the residuals are normally distributed. Good if residuals points follow the straight dashed line.
# 3. Scale-Location (or Spread-Location). Used to check the homogeneity of variance of the residuals (homoscedasticity). Horizontal line with equally spread points is a good indication of homoscedasticity.
# 4. Residuals vs Leverage. Used to identify influential cases, that is extreme values that might influence the regression results when included or excluded from the analysis. 



# ------------------------------------- Umesh's notes on assumptions ------------------------------------------------ #
# assumptions to check:
# a. LINEAR RELATIONSHIP between the predictor (x) and the response (y); i.e., y = mx + C
# b. the data points are STATISTICALLY INDEPENDENT (study design issue)
# c. no outliers influence the relationship unduly (look at the Residuals vs Leverage plot; also the Normal Q-Q plot)
# d. CONSTANT, or EQUAL VARIANCE (fancily called HOMOSCEDASTICITY; look at the Residuals vs Fitted plot)
# e. ERRORS ARE NORMALLY DISTRIBUTED (look at the Normal Q-Q plot)

# ------------------ a. Linear relationship plot to check.
ggplot(data = dat, mapping = aes(x = age, y = log(proportion), group = year_abn, color = year_abn)) + 
  theme_classic() + 
  geom_point(size = 1.25) + 
  labs(title = "Persistence of Abandoned Land") + 
  scale_color_distiller(palette = "Greens") + 
  theme(legend.position = "bottom", legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_smooth(method = "lm", se = FALSE) + 
  geom_smooth(method = "lm", aes(x = age, y = log(proportion)), se = FALSE, inherit.aes = FALSE, color = "blue") + 
  geom_hline(yintercept = log(0.5), linetype = "dashed", color = "red", size = 0.75)
# yes?

# ------------------ b. Statistically independent? I don't think the points are independent. Each cohort of abandoned land (i.e. land that was all initially abandoned in a give year) can constitute a group. This is especially the case if I'm looking at area, rather than proportion.
pairs(dat)
plot(proportion ~ year_abn, data = dat)
plot(area_ha ~ initial_area_abn, data = dat)
plot(proportion ~ initial_area_abn, data = dat)

# If the points are not independent, and they belong to a particular cohort of abandoned land, I have two options: 
# add cohorts as a categorical fixed effect, calculating either unique intercepts, unique slopes, or both depending on the identity of the cohort. 
# Or, I could model these cohort groups as random effects (meaning that we expect the behavior or each cohort group to be drawn from a normal distribution with a particular mean and standard deviation), and move to a linear mixed effects model next. 

# other option: Bayesian hierarchical model. 
install.packages("brms") # Hamiltonian monte carlo.


# continuing with Umesh's diagnostics:
# ------------------ c.
# c. no outliers influence the relationship unduly (look at the Residuals vs Leverage plot; also the Normal Q-Q plot)
# the residuals should lie along the dotted line in the QQ plot, and the leverage plot should look straight as well.


# ------------------ d.
# d. CONSTANT, or EQUAL VARIANCE (fancily called HOMOSCEDASTICITY; look at the Residuals vs Fitted plot)
# this first plot should have a pretty horizontal line across it, with good horizontal spread, and vertical spread. An even distribution along the x axis (fitted values) across values of y indicates a lack of *bias*. An even spread across the y axis across values of x shows homoscedasticity. Constant variance among residuals.  

# ------------------ e.
# e. Error ARE NORMALLY DISTRIBUTED (look at the Normal Q-Q plot)
# looks good

plot(lm_mod, 2)

# can also 

# check normality of residuals
hist(residuals(lm_mod)) # or
ggplot(data = data.frame(.resid = residuals(lm_mod)), aes(x = .resid)) + geom_histogram() # looks normal to me?


ggplot(data = augment(lmer_mod_offset), aes(x = .resid)) + geom_histogram() # looks normal to me?
ggplot(data = augment(lmer_mod_offset), aes(x = `log(proportion)`)) + geom_histogram() # looks normal to me?


plot(lmer_mod)
qqnorm(residuals(lmer_mod))

plot(lmer_mod_offset)
qqnorm(residuals(lmer_mod_offset))



# --------------------------------- checking assumptions for lmers -------------------------- #
names(mod_l)
plot(mod_l$lm_mod_cohort_slope0)
plot(mod_l$lm_mod_log2_cohort)

qqnorm(residuals(mod_l[[8]]))
tidy(mod_l[[8]])
coef(mod_l[[8]])
augment(mod_l[[8]])
plot(mod_l$lm_mod_cohort_slope0$residuals)

ggplot(data = augment(mod_l$lm_mod_cohort_slope0), aes(x = .std.resid)) + geom_histogram() # looks normal to me?
ggplot(data = augment(mod_l[[8]]), aes(x = `log(proportion)`)) + geom_histogram() # this doesn't look all that normal to me

# leverage
ggplot(data = augment(mod_l[[8]]), aes(x = .hat)) + geom_histogram()



lapply(mod_l, summary)
```

```{r shapiro-wilk}
# http://www.sthda.com/english/wiki/normality-test-in-r
# https://www.r-bloggers.com/2019/08/shapiro-wilk-test-for-normality-in-r/

```


```{r car}
# resource from Oscar: 
# https://dss.princeton.edu/training/Regression101R.pdf

install.packages("car")
library(car)

lm_log2_l$shaanxi # # run first for shaanxi only
lm_log2_l # then the whole list of sites
lm_log2_cohort_site # finally, for the mega model

# 1. Residuals vs. fitted values ------------------------- # 
# plot model diagnostics: 
par(mfrow = c(2,2)) # create a plotting panel with two rows and two columns (allowing you to put 4 plots on the same plotting panel)
plot(lm_log2_l[[9]]) # check for violations of model assumptions
dev.off()

# Now, with car
residualPlots(lm_log2_l[[9]])
plot(lm_log2_l[[9]], 1)
residualPlots(lm_log2_l[[9]], ~ cohort, fitted=FALSE)

# all sites at once:
par(mfrow = c(3, 4))
for (i in 1:11) residualPlots(lm_log2_l[[i]])

# 2. Added variable plots - Influential variables ------------------------- # 
avPlots(lm_log2_l[[9]])


# 3. Outliers - QQ-Plots -------------------------------------------------- # 
# qqnorm
qqnorm(residuals(lm_log2_l[[9]]))
plot(lm_log2_l[[9]], 2)
qqPlot(lm_log2_l[[9]], id.n = 3)
qqPlot(lm_log2_l[[9]], simulate = T, envelope = 0.9)
dev.off()

tidy(lm_log2_l[[9]]) %>% tail()


# bonferonni test:
outlierTest(lm_log2_l$shaanxi)

lm_log2_l$shaanxi$model
plot(lm(formula = log(proportion) ~ 0 + log(time + 1):cohort, 
   data = filter(dat_l, site == site_df$site[9])[-19, ]))


influenceIndexPlot(lm_log2_l$shaanxi, id.n=3)

par(mfrow=c(1,1))
influencePlot(lm_log2_l$shaanxi)
outlier_list <- influencePlot(lm_log2_l$shaanxi) %>% rownames() %>% as.numeric()

influencePlot(lm(formula = log(proportion) ~ 0 + log(time + 1):cohort, 
   data = filter(dat_l, site == site_df$site[9])[-c(outlier_list), ]))

influencePlot(lm(formula = log(proportion) ~ 0 + log(time + 1):cohort, 
   data = filter(dat_l, site == site_df$site[9])[-349, ]))

par(mfrow=c(2,2))
plot(lm(formula = log(proportion) ~ 0 + log(time + 1):cohort, 
   data = filter(dat_l, site == site_df$site[9])[-349, ]))
warnings()
car::update()

Prestige
lm_
qqPlot(lm_log2_no_out$shaanxi, #line = "robust",
	envelope=.99)
qqPlot(lm_log2_no_out$shaanxi)

class(lm_log2_l$shaanxi)

lm_out <- lm(log(proportion) ~ 0 + log(time + 1):cohort,  
               data = dat %>% filter(year_abn < 2012) %>% .[-c(134, 150), ])
qqPlot(lm_out)
par(mfrow = c(2,2)); plot(lm_out)

```

```{r lm-no-outliers}
dat_no_outliers <- dat_l %>%
  filter(year_abn < 2012)

lm_log2_no_out <- lapply(1:11, FUN = function(i) {
  lm(log(proportion) ~ 0 + log(time + 1):cohort,  
               data = filter(dat_no_outliers, 
                             site == site_df$site[i]))
})
names(lm_log2_no_out) <- site_df$site



ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = filter(dat_l, site == "shaanxi")) + 
  scale_color_distiller(palette = "Greens") + scale_x_continuous(n.breaks = 30) + 
  labs(title = "Decay of abandoned land over time", #subtitle = site_df$description[indx], 
       caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
       x = "Time since initial abandonment (years)", y = "Proportion of abandoned land remaining",
       color = "Cohort (Year \nFirst Abandoned)") + 
  geom_line(data = mutate(augment(lm_log2_l[[9]], 
                                  newdata = filter(dat_l, site == "shaanxi") %>% 
                                    select(time, cohort, site, year_abn, age)),
                          proportion = exp(.fitted))) + 
  
  # add the mean coefficient (needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_log2_l[[9]]), na.rm = TRUE))},
                mapping = aes(linetype = "Mean Decay Rate"),
                color = "blue", size = 1, #linetype = "dashed", 
                inherit.aes = FALSE) +
  scale_linetype(name = "")


cc_add_mod_results <- function(mod, site_name = "shaanxi", input_dat) {
  gg_temp <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = filter(input_dat, site == site_name)) + 
  scale_color_distiller(palette = "Greens") + scale_x_continuous(n.breaks = 30) + 
  labs(title = "Decay of abandoned land over time", subtitle = site_name, 
       caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
       x = "Time since initial abandonment (years)", y = "Proportion of abandoned land remaining",
       color = "Cohort (Year \nFirst Abandoned)") + 
    
  geom_line(data = mutate(augment(mod, 
                                  newdata = filter(input_dat, site == site_name) %>% 
                                    select(time, cohort, site, year_abn, age)),
                          proportion = exp(.fitted))) + 
  
  # add the mean coefficient (needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) { (x-4) ^ (mean(coef(mod), na.rm = TRUE))},
                mapping = aes(linetype = "Mean Decay Rate"),
                color = "blue", size = 1, #linetype = "dashed", 
                inherit.aes = FALSE) +
  scale_linetype(name = "")
  
  print(gg_temp)
}

cc_add_mod_results(mod = lm_log2_l$shaanxi, site_name = "shaanxi", input_dat = dat_l)

cc_add_mod_results(mod = lm_log2_no_out$shaanxi, site_name = "shaanxi", input_dat = dat_no_outliers)

plot(lm_log2_no_out$shaanxi)

```

# Coef. Plots (lin-log-lin)

```{r coef-all-sites-l3}
# extract coefficients for log-log-cohort model for all sites
coef_df_l3 <- lapply(lm_lin_log_lin_l, FUN = function(x) {
  tidy(x, conf.int = TRUE) %>% 
    mutate(coef_term = sub(":*cohort....:*", "", term),
         year_abn = ifelse(coef_term == "log(time + 1)", gsub(".*cohort", "", term), parse_number(term)),
         year_abn = as.numeric(year_abn),
         cohort = as.factor(year_abn))
}) %>% bind_rows(.id = "site") %>%
    mutate(term_long = term,
           term = as_factor(ifelse(coef_term == "I(time)", "lin", "log"))) %>%
  select(site, cohort, term, estimate, coef_term, everything())


# calculate mean coefficients per site, for both lin and log terms
mean_coef_df_l3 <- coef_df_l3 %>% 
  group_by(site, coef_term, term) %>% # group by site, term and coef_term (though you only need one of these)
  summarise(mean = mean(estimate, na.rm = TRUE),
            mean_low = mean(conf.low, na.rm = TRUE),
            mean_high = mean(conf.high, na.rm = TRUE)) %>% ungroup()


# pivot wider, for use below in the calculation of projections
mean_coef_df_wide_l3 <- mean_coef_df_l3 %>%
  pivot_wider(id_cols = c(site, term), 
              names_from = term,
              names_glue = "{term}_{.value}",
              values_from = c(mean, mean_low, mean_high)) %>%  
  
  # calculate the time_to_0.5
  mutate(time_to_0.5 = ((log_mean * lambertW0((lin_mean * exp(lin_mean/log_mean + 0.5/log_mean - 1/log_mean))/log_mean))/lin_mean) + 4,
         time_to_0.5_low = ((log_mean_low * lambertW0((lin_mean_low * exp(lin_mean_low/log_mean_low + 0.5/log_mean_low - 1/log_mean_low))/log_mean_low))/lin_mean_low) + 4,
         time_to_0.5_high = ((log_mean_high * lambertW0((lin_mean_high * exp(lin_mean_high/log_mean_high + 0.5/log_mean_high - 1/log_mean_high))/log_mean_high))/lin_mean_high) + 4
         )



# join to all coef df
coef_df_l3 <- left_join(coef_df_l3, 
                        mean_coef_df_l3 %>% select(-term),
                        by = c("site","coef_term"))# %>% filter(site == "belarus") %>% print(n = 30) # for testing purposes



# pivot coef_df_wide_l3
coef_df_wide_l3 <- 
  coef_df_l3 %>%
  pivot_wider(id_cols = c(site, cohort, year_abn, term), 
              names_from = term,
              names_glue = "{term}_{.value}",
              values_from = estimate) %>%
  mutate(time_to_0.5 = ((log_estimate * lambertW0((lin_estimate * exp(lin_estimate/log_estimate + 0.5/log_estimate - 1/log_estimate))/log_estimate))/lin_estimate) + 4)


# join mean half time to coef_df_wide_l3
coef_df_wide_l3 <- left_join(coef_df_wide_l3,
                             mean_coef_df_wide_l3 %>% select(site, lin_mean, log_mean, mean_time_to_0.5 = time_to_0.5),
                             by = c("site"))
  


# calculate the proportion remaining at various times, projection
mean_coef_proj_l3 <- bind_rows(mean_coef_df_wide_l3, 
                          
                          # time + 1 = i + 4 (since time is age - 5)
                          lapply(c(0, 5, 10, 15, 20, 25, 35, 45), FUN = function(x) {
                            mean_coef_df_wide_l3 %>%
                             # need to update this to reflect the new formula:
                              #{mean_coef_tmp$mean_est[2]*log(x-4) + mean_coef_tmp$mean_est[1]*((x-4) - 1) + 1}
                              # mean*log(x) + mean*(x - 1) + 1
                               mutate(mean = log_mean*log(x + 1) + lin_mean*(x) + 1,
                                     mean_low = log_mean_low*log(x + 1) + lin_mean_low*(x) + 1,
                                     mean_high = log_mean_high*log(x + 1) + lin_mean_high*(x) + 1,
                                     term = paste0("yr_", x + 5))
                            }))



seq(from = 0.1, to = 0.5, by = 0.1)
select(mean_coef_df_wide_l3, -contains("half_"))



# calculate time to various proportions:
time_to_l3 <- bind_rows(#select(mean_coef_df_wide_l3, -contains("half_")), 
                          
                          # time = i + 4 (since time_1 is age - 4)
                          lapply(seq(from = 0, to = 1,# 0.9, 
                                     by = 0.1), FUN = function(x) {
                            select(mean_coef_df_wide_l3, -contains("half_")) %>%
                                         
                                         # solve a log(u) + b(u-1) + 1 - p = 0 for u : 
                                         # (in this case, u = t + 1, so we're solving for t + 1. 
                                         # Remember that age = t + 5 = u + 4)
                                         
                                         # age = (a * lambertW0((b * exp((b + p - 1)/a))/a))/b + 4
                                           
                              # where p is the proportion, a is the log coef, and b is the linear coef.
                               mutate(
                                 time_to_value = ((log_mean * lambertW0((lin_mean * exp((lin_mean + x - 1)/log_mean)) / 
                                                                        log_mean)) / lin_mean) + 4,
                                 time_to_value_low = ((log_mean_low * 
                                                         lambertW0((lin_mean_low * exp((lin_mean_low + x - 1)/log_mean_low)) / 
                                                                     log_mean_low)) / lin_mean_low) + 4,
                                 time_to_value_high = ((log_mean_high * 
                                                          lambertW0((lin_mean_high * exp((lin_mean_high + x - 1)/log_mean_high)) /
                                                                      log_mean_high)) / lin_mean_high) + 4,
                                     proportion = paste0("p_", x),
                                 p = x)
                            }))


# save dfs:
coef_df_l3
coef_df_wide_l3
mean_coef_df_l3
mean_coef_df_wide_l3
mean_coef_proj_l3
time_to_l3

```

```{r save-coefs}
save(coef_df_l3, 
     coef_df_wide_l3, 
     mean_coef_df_l3, 
     mean_coef_df_wide_l3, 
     mean_coef_proj_l3, 
     time_to_l3,
     file = paste0(p_dat_derived, run_label, "/decay_mod_coef_dfs.rds"))


load(file = paste0(p_dat_derived, run_label, "/decay_mod_coef_dfs.rds"), 
     verbose = TRUE)
```


```{r l3-half-life}
# how long does it take for each site to reach 0.5?

install.packages("lamW")
library(lamW)
lambertW0()

lm_lin_log_lin_l$shaanxi
i <- 3
for (i in 1:11) {
  a <- filter(mean_coef_df_wide_l3, site == site_df$site[i])$log_mean # log coef
  b <- filter(mean_coef_df_wide_l3, site == site_df$site[i])$lin_mean # lin coef
  p <- 0.5 # proportion of interest 
  # W(z) # is the product log function
  
  # solve a log(u) + b(u-1) + 1 - p = 0 for u
  # (in this case, u = t + 1, so we're solving for t + 1; age = t + 5; age = u - 1 + 5 = u + 4)
  
  # u = (a W((b e^(b/a + p/a - 1/a))/a))/b
  # t + 1 = (a W((b e^(b/a + p/a - 1/a))/a))/b
  # age = (a W((b e^(b/a + p/a - 1/a))/a))/b - 1 + 5 = 
  # age = (a W((b e^(b/a + p/a - 1/a))/a))/b + 4
  
  print(site_df$site[i])
  print((a * lambertW0((b * exp((b + p - 1)/a))/a))/b + 4)
}


# solve a log(u) + b(u-1) + 1 - p = 0 for u (in this case, u = t + 1, so we're solving for t + 1)



# plot mean half times for each site:
gg_time_to_0.5_l3 <- ggplot(data = mean_coef_df_wide_l3,
                          mapping = aes(x = fct_reorder(site, desc(time_to_0.5)), 
                                        y = time_to_0.5, color = site)) + 
  theme_classic() +
  geom_point(size = 2) + 
  #geom_errorbar(mapping = aes(ymin = time_to_0.5_low, ymax = time_to_0.5_high), width = 0.3) +
  labs(y = "Mean Time to Half (Years)", x = "Site", 
       title = "Time required for abandoned land to decay by half",
       subtitle = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       caption = "Error bars represent the mean of high and low cofficients from 95% confidence interval") + 
  # geom_vline(xintercept = 0, linetype = "dashed") +
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none", plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm"))

# save
png(filename = paste0(p_plots, run_label, "/decay/", "time_to_0.5_l3", run_label, ".png"), 
    width = 6, height = 5, units = "in", res = 400)
print(gg_time_to_0.5_l3)
dev.off()

coef_df_wide_l3 %>% select(site, mean_time_to_0.5) %>% unique() %>% arrange(mean_time_to_0.5)




# time to various proportions...
time_to_l3 %>% select(time_to_0.5, time_to_value, proportion) %>% print(n=55)

time_to_l3 %>% select(-contains(c("low", "high")))


# --------------------------------------------------------- #
# alternative visualization of how quickly things decay
# time from 1 to 0.5
# --------------------------------------------------------- #

gg_time_to_range_l3 <-
  ggplot(data = time_to_l3 %>% filter(p >= 0.5),
       mapping = aes(y = fct_reorder(site, desc(time_to_0.5)), 
                     x = time_to_value, group = site, fill = p)) + 
  theme_classic() +
  geom_point(size = 4, pch = 21) + 
  labs(x = "Decay time to proportion (Years)", y = NULL, # "Site", 
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       fill = "Proportion \nremaining:") +
  scale_fill_distiller(palette = "Greens", direction = 1) + 
  theme(legend.position = c(0.9, 0.70)) + 
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_x_continuous(breaks = seq(from = 5, to = 50, by = 5))

# save
png(filename = paste0(p_plots, run_label, "/decay/", "time_to_range_l3", run_label, ".png"), 
    width = 5, height = 4, units = "in", res = 400)
print(gg_time_to_range_l3)
dev.off()


# --------------------------------------------------------- #
# time to go from 1 to 0
# --------------------------------------------------------- #
gg_time_to_range_all_l3 <-
  ggplot(data = time_to_l3, #%>% filter(p %in% seq(from = 0, to = 0.8, by = 0.2)),
       mapping = aes(y = fct_reorder(site, desc(time_to_0.5)), 
                     x = time_to_value, group = site, fill = p)) + 
  theme_classic() +
  geom_point(size = 4, pch = 21) + 
  labs(x = "Full decay time (Years)", y = NULL, # "Site", 
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       fill = "Proportion \nremaining:") +
  scale_fill_distiller(palette = "Greens", direction = 1) + 
  theme(legend.position = c(0.9, 0.70)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_x_continuous(breaks = seq(from = 0, to = 140, by = 10))

# save
pdf(file = paste0(p_plots, run_label, "/decay/", "time_to_range_all_l3", run_label, ".pdf"), 
    width = 7, height = 4#, units = "in", res = 400
    )
print(gg_time_to_range_all_l3)
dev.off()
```




```{r plot-mean-coef-per-site-l3}

# quasi half-lives
# lapply(lm_log2_l, FUN = function(i) cc_half_life(i, confint = TRUE)) %>% bind_rows(.id = "site")

mean_coef_df_l3

gg_mean_coef_site_l3 <- 
  ggplot(data = mutate(mean_coef_df_l3, term = fct_relevel(term, c("log", "lin"))),
                            mapping = aes(x = mean, y = fct_reorder2(site, desc(term), desc(mean)))) + 
  theme_classic() +
  geom_point() + 
  geom_errorbar(mapping = aes(xmin = mean_low, xmax = mean_high), width = 0.3) +
  labs(x = "Mean Coefficients", y = NULL, 
       title = "Mean Decay Rates By Site",
       subtitle = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       caption = "Error bars represent the mean of high and low cofficients from 95% confidence interval") + 
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme(plot.caption = element_text(face = "italic")) + 
  facet_grid(cols = vars(term), switch = "y",
             labeller = labeller(term = c(#old = "new",
               log = "Log term coefficient", #  {log(time):cohort}
               lin = "Linear term coefficient")), # {(time - 1):cohort}
             scales = "free")

# save
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_coefs_by_site", run_label, ".png"), 
    width = 7, height = 5, units = "in", res = 400)
print(gg_mean_coef_site_l3)
dev.off()

mean_coef_proj_l3$term %>% unique()

gg_example_proportions_by_site_l3 <-
  ggplot(data = mean_coef_proj_l3 %>% filter(!is.na(term), #term != "p5"
                                             term %in% c("yr_10", "yr_15", "yr_20", "yr_25", "yr_30")
                                             ),
                              mapping = aes(y = mean, x = fct_reorder2(site, desc(term),
                                                                       mean),
                                            ymin = mean_low, ymax = mean_high, #col = site, 
                                            group = term, color = fct_reorder(term, desc(mean)))) + 
  theme_classic() +
  coord_cartesian(ylim = c(0, 1)) +
  # ylim(0, 1) +
  geom_point(position = position_dodge(0.7), size = 1.75) + 
  geom_errorbar(#mapping = aes(ymin = mean_low, ymax = mean_high), 
                width = 0.7, position = position_dodge(0.7)) +
  labs(y = "Proportion of abandoned land remaining", 
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       #caption = "Error bars represent the mean of 95% confidence interval coefficient estimates",
       #title = "Decay rates by site",
       x = "Site" 
       ) + 
  theme(plot.caption = element_text(face = "italic"),
        axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0),
        legend.position = "right"#, plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")
        ) + 
  scale_color_discrete(name = "Proportion \nremaining \nafter: ", 
                      labels = c(yr_5 = "5 years", yr_10 = "10 years", #old = "new",
                                 yr_15 = "15 years", yr_20 = "20 years", 
                                 yr_25 = "25 years", yr_30 = "30 years",
                                 yr_40 = "40 years", yr_50 = "50 years")) #+ 
  # guides(col = guide_legend(ncol = 2, byrow = TRUE))


# save
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_decay_proportions_by_site", run_label, ".png"), 
    width = 8, height = 4.5, units = "in", res = 400)
print(gg_example_proportions_by_site_l3)
dev.off()


```

```{r fitted_df_l3}
mean_coef_df_wide_l3
mean_coef_df_l3
lm_lin_log_lin_l$shaanxi
dat_l

# make a data.frame with fitted values for the mean coef
fitted_df_l3 <- lapply(site_df$site, FUN = function(x) {
  data.frame(site = x,
             time = 1:150 - 1,
             lin_mean = filter(mean_coef_df_wide_l3, site == x)$lin_mean,
             log_mean = filter(mean_coef_df_wide_l3, site == x)$log_mean) %>%
    mutate(fitted = log_mean*log(time + 1) + lin_mean*(time) + 1,
           fitted = ifelse(fitted >= 0, fitted, 0), # fitted proportion can't be less than 0!
           time_to_0.5 = ((log_mean * lambertW0((lin_mean * exp(lin_mean/log_mean + 0.5/log_mean - 1/log_mean))/log_mean))/lin_mean) + 4,
           age = time + 5)
}) %>% bind_rows() %>% as_tibble()


f0 <- fitted_df_l3
```


```{r mean-trend-by-site-l3}
# plot it, reordering the factors by the coefficient (to make the legend easier to read)
# gg_model_curves_by_site_l3 <-
  ggplot(data = fitted_df_l3 %>% filter(age < 140),
       mapping = aes(x = age, y = fitted, color = fct_reorder(site, time_to_0.5))) +
  theme_classic() +
  geom_line(size = 1.1) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") + 
      geom_hline(yintercept = 0, linetype = "dashed") +

  labs(#title = "Decay of abandoned land over time", 
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site") + 
  guides(col = guide_legend(reverse = TRUE))


gg_model_curves_by_site_l3 %+% filter(fitted_df_l3, time < 50)


png(filename = paste0(p_plots, run_label, "/decay/", "model_decay_curves_by_site_l3", run_label, ".png"), 
    width = 7, height = 6, units = "in", res = 400)
print(gg_model_curves_by_site_l3 %+% 
        filter(fitted_df_l3, time < 50)
      )
dev.off()


# save wide
png(filename = paste0(p_plots, run_label, "/decay/", "model_decay_curves_by_site_l3_wide", run_label, ".png"), 
    width = 10, height = 5, units = "in", res = 400)
print(gg_model_curves_by_site_l3 + 
        scale_x_continuous(n.breaks = 15) + 
        theme(legend.position = c(0.9, 0.65)))
dev.off()

# combo
png(filename = paste0(p_plots, run_label, "/decay/", "model_decay_curves_by_site_l3_combo", run_label, ".png"), 
    width = 10.5, height = 6, units = "in", res = 400)
print(plot_grid(gg_model_curves_by_site_l3 + theme(legend.position = "none") + labs(caption = ""),
                gg_model_curves_by_site_l3 %+% 
                  filter(fitted_df_l3, time < 50) + 
                  theme(legend.position = "none"),
                cowplot::get_legend(gg_model_curves_by_site_l3),
                ncol = 3, rel_widths = c(1, 1, 0.4)))
dev.off()




gg_model_curves_by_site_l3 + coord_cartesian(xlim = c(4.9, 5.1), ylim = c(0.9, 1.1))



# could also manually reorder the factors like so:
coef_level_order <- mean_coef_proj %>% 
  filter(term == "coef") %>% 
  arrange(desc(mean)) %>% 
  select(site) %>% 
  unlist(use.names = FALSE)

mean_coef_df %>% mutate(site = fct_relevel(site, coef_level_order)) %>% .$site
```

```{r plot-coef-all-sites-l3}

# plot all coefficients
ggplot(data = coef_df_wide_l3 %>% filter(),
       mapping = aes(x = year_abn, y = time_to_0.5#, group = site, color = site
                     )
       ) + 
  theme_classic() +
  geom_point(position = position_jitter()) + 
  #geom_errorbar(mapping = aes(ymin = conf.low, ymax = conf.high), width = 0.3) +
  labs(y = "Time For Half of Land to be Recultivated (Years)",
       x = "Cohort (Year of Initial Abandonment)", 
       # title = "Half Times",
       # subtitle = "lin-log-lin model",
       # caption = "Error bars represent 95% confidence interval",
       color = "Site") + 
  theme(#axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "bottom",
        plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  geom_smooth(method = "lm", se = TRUE) +
  facet_wrap(vars(site), scales = "free_y")# + 


# with quadrants:
coef_df_l3 %>% group_by(site, term) %>% summarise(count = n())

coef_df_wide_l3 %>% select(site, mean_time_to_0.5) %>% unique() %>% arrange(mean_time_to_0.5)

gg_l3_cohort_coef_all <-
  ggplot(data = coef_df_wide_l3 %>% 
           arrange(mean_time_to_0.5) %>%
           mutate(site_reorder = rep(1:11, each = length(cohort_range)),
                  cluster = cut(site_reorder, breaks = c(1, 3, 6, 9, 11),
                                labels = c("a", "b", "c", "d"), 
                                include.lowest = TRUE),
                  time_to_0.5_breaks = cut(mean_time_to_0.5, breaks = 4)),
         mapping = aes(x = year_abn, y = time_to_0.5, color = fct_reorder(site, mean_time_to_0.5))) +
  theme_classic() +
  geom_point(size = 2) + 
  labs(y = "Time for half of cohort to be recultivated (years)",
       x = "Cohort (Year of Initial Abandonment)", 
       # title = "Model Coefficients", 
       # caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       color = "Site") + 
  theme(legend.position = "right", 
        plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  geom_smooth(method = "lm", se = FALSE)  + 
  facet_wrap(~ cluster, scales = "free_y",
             labeller = labeller(cluster = c(#old = "new",
               a = "Q1, mean half time \n(fastest recultivation)",
               b = "Q2, mean half time",
               c = "Q3, mean half time",
               d = "Q4, mean half time \n(slowest recultivation)")))



# ------------------------------------------------------------- #
# save:
png(filename = paste0(p_plots, run_label, "/decay/", "l3_cohort_coefs_all", run_label, ".png"), 
    width = 9, height = 7, units = "in", res = 400)
print(gg_l3_cohort_coef_all)
dev.off()
# ------------------------------------------------------------- #





```

```{r l3-rate-of-change}
lm_coef_l3 <- lm(time_to_0.5 ~ year_abn * site - 1, data = filter(coef_df_wide_l3, !is.na(time_to_0.5)))

par(mfrow = c(2, 2))
plot(lm_coef_l3)


coef(lm_coef)[1]
as.numeric(tidy(lm_coef, conf.int = TRUE)[1, "estimate"])


 tidy(lm_coef_l3, conf.int = TRUE) %>%
  mutate(termm = ifelse(grepl("year_abn", term), "slope", "int"),
         site = gsub("site|year_abn:", "", term)) %>%
   print(n = 22)

# create table of regression coefficients for the rate of change of the "time to half" 
 
coef_df2_l3 <- tidy(lm_coef_l3, conf.int = TRUE) %>%
  mutate(termm = ifelse(grepl("year_abn", term), "slope", "int"),
         site = gsub("site|year_abn:", "", term)) %>% 
  pivot_wider(id_cols = c(site, termm), names_from = termm, values_from = c(estimate, conf.low, conf.high)) %>% 
  mutate(
    estimate_slope = ifelse(site == "belarus", 0, estimate_slope),
    conf.low_slope = ifelse(site == "belarus", 0, conf.low_slope),
    conf.high_slope = ifelse(site == "belarus", 0, conf.high_slope),
    estimate_slope = estimate_slope + as.numeric(tidy(lm_coef_l3, conf.int = TRUE)[1, "estimate"]),
    conf.low_slope = conf.low_slope + as.numeric(tidy(lm_coef_l3, conf.int = TRUE)[1, "conf.low"]),
    conf.high_slope = conf.high_slope + as.numeric(tidy(lm_coef_l3, conf.int = TRUE)[1, "conf.high"])
    ) %>% 
  filter(site != "year_abn")


# plot right on:
# ------------------------ use this one ---------------------------- #
gg_coef_rate_change_by_site_l3_horiz <-
  ggplot(data = left_join(coef_df2_l3, mean_coef_df_wide_l3, by = "site"),
         aes(x = fct_reorder(site, estimate_slope), 
             y = estimate_slope, 
             color = fct_reorder(site, time_to_0.5), 
             fill = fct_reorder(site, time_to_0.5))) + 
  theme_classic() +
  geom_col() + 
  geom_errorbar(mapping = aes(ymin = conf.low_slope, ymax = conf.high_slope), width = 0.2) +
  geom_hline(yintercept = 0) + 
  labs(title = "Changes in Half Time over time, by site", 
       x = "Site", y = "Rate of Change of Half Time (years per year)") + 
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none",
        plot.margin = unit(c(0.4, 0.6, 0.2, 0.2), "cm"))


# vertical
gg_coef_rate_change_by_site_l3_vert <-
  ggplot(data = left_join(coef_df2_l3, mean_coef_df_wide_l3, by = "site"),
         aes(y = fct_reorder(site, estimate_slope), 
             x = estimate_slope)) + 
  theme_classic() +
  geom_point() + 
  geom_errorbar(mapping = aes(xmin = conf.low_slope, xmax = conf.high_slope), width = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed") + 
  labs(y = "Site", 
       x = "Rate of change of recultivation speed \n(time to recultivate half of area, \nyears per year)") + 
  theme(legend.position = "none",
        plot.margin = unit(c(0.4, 0.6, 0.2, 0.2), "cm"))


gg_coef_rate_change_by_site_l3_horiz
gg_coef_rate_change_by_site_l3_vert

# save

png(filename = paste0(p_plots, run_label, "/decay/", 
                      "l3_cohort_coefs_rate_of_change_h", run_label, ".png"), 
    width = 5, height = 5, units = "in", res = 400)
print(gg_coef_rate_change_by_site_l3_horiz)
dev.off()

png(filename = paste0(p_plots, run_label, "/decay/", 
                      "l3_cohort_coefs_rate_of_change_v", run_label, ".png"), 
    width = 5.5, height = 3.5, units = "in", res = 400)
print(gg_coef_rate_change_by_site_l3_vert)
dev.off()



# -------------- for presentation ------------------- #
# combo quadrant with coefs:

ggsave(plot = plot_grid(gg_l3_cohort_coef_all + theme(legend.position = "bottom"),
                        gg_coef_rate_change_by_site_l3_vert,
                        ncol = 2, rel_widths = c(1, 0.6), align = "h", axis = "b"),
       filename = paste0(p_plots, run_label, "/presentation/", "rate_of_change_recultivation_speed", run_label, ".pdf"), 
       width = 11, height = 6, units = "in")

```


# Extrapolation

Q1. What would the age classes look like in 30 years:
a) assuming the average decay rate holds for the next 30 years
b) assuming the trend in decay rate continues for the next 30 years (i.e. slowing down in Shaanxi, speeding up in Belarus)
c) assuming we shift the decay curve

Q2. What would the mean age of abandoned land look like in 30 years, following the same assumptions?

How to calculate this?
factors:
1. initial amount of land abandoned. (drawn from a range of abandoned values, constrained by how much land is available?)
2. The decay rate - how much of the initial amount of land that was abandoned is still abandoned, in time t? This gives us the proportion of the original amount remaining, which we can then multiply by the initial amount abandoned.
3. 

```{r extrapolation-testing}
dat_l
lm_lin_log_lin_l$shaanxi

# in the year 2000, how much land is abandoned, according to the decay rates?
# 1988 cohort, after 13 years of decay + 1989 cohort, after 12 years of decay + 1990 cohort, after 11 years of decay, etc.


coef_df_l3
mean_coef_df_l3 # calculate mean coefficients per site, for both lin and log terms
mean_coef_df_wide_l3 # pivot wider, for use below in the calculation of projections
coef_df_wide_l3  # pivot coef_df_wide_l3
mean_coef_proj_l3  # calculate the proportion remaining at various times, projection
time_to_l3 # calculate time to various proportions:


fitted_df_l3 # fitted values, which are equal to the predicted proportion of a given cohort in a given age, using the mean coefficient for the site over the whole time-series.
filter(fitted_df_l3, site == "shaanxi", age == 6) %>% .$fitted

# to get the mean coef estimates, you can use mean_coef_df_l3, mean_coef_df_wide_l3, or calculate and extract mean coef estimates manually (see chunk "save-basic-model-plot..." above)
gg_lin_log_lin_cohort_tmp + 
  geom_hline(yintercept = ) + 
  geom_vline(xintercept = 30)

# age = time + 5
# time = age - 5
# time + 1

# expected proportion remaining at a particular age, on average, at site 9 ("shaanxi")
lm_lin_log_lin_l$shaanxi
# lm(formula = I(proportion - 1) ~ 0 + log(time + 1):cohort + I(time):cohort, 
#     data = filter(dat_l, site == site_df$site[i]))
# p - 1 ~ 0 + a*log(time + 1) + b*time
# p = a*log(time + 1) + b*time + 1
# p = a*log(age - 4) + b*(age - 5) + 1
mean_coef_df_wide_l3[9, ]$log_mean*log(age - 4) + 
  mean_coef_df_wide_l3[9, ]$lin_mean*(age - 5) + 1

fitted_df_l3 %>% filter(site == "shaanxi") %>% print(n = 20)

age <- 23
mean_coef_df_wide_l3[9, ]$log_mean*log(age - 4) + 
  mean_coef_df_wide_l3[9, ]$lin_mean*(age - 5) + 1


age <- 30 

# mean trend line:
# mean_coef_tmp$mean_est[2]*log(x-4) + mean_coef_tmp$mean_est[1]*((x-4) - 1) + 1
x

# year: 2000
# cohort: 1988, in the year 2000 (estimate)
filter(dat_l, site == "shaanxi", year_abn == 1988) %>% .$initial_area_abn %>% unique() *
  filter(fitted_df_l3, site == "shaanxi", age == 2000 - 1988 + 1) %>% .$fitted

# actual:
dat_l %>% filter(site == "shaanxi", year_abn == 1988, year == 2000) %>% .$area_ha

data.frame(
  year_abn = 1988:(2000-4),
  sapply(1988:(2000-4), FUN = function(i) {
  filter(dat_l, site == "shaanxi", year_abn == i) %>% 
    select(initial_area_abn) %>% unique() %>% .$initial_area_abn * 
    
    # proportion
    filter(fitted_df, site == "shaanxi", age == 2000 - i + 1) %>% .$fitted
})
)



# I need the proportion, and the age
# Let's say we have the average area abandoned in 2020.
# In 2050, that will be 2050-2020 + 1 years old.
# The the proportion should be 
fitted_df_l3 %>% filter(site == "shaanxi", age == 31)


fitted_df_l3 %>% filter(site == "shaanxi") %>% print(n = 100)

age <- 31
mean_coef_df_wide_l3[9, ]$log_mean*log(age - 4) + 
  mean_coef_df_wide_l3[9, ]$lin_mean*(age - 5) + 1

fitted_df_l3 %>% filter(age == 31)
```


```{r fun-estimate-area-abn}
# ----------------------------------------------------------------------- #

# Function to calculate the total amount of abandoned land in a given year, 
# disaggregated by age, based on the modeled decay rate and the
# initial area abandoned in each year.
# This serves as a starting place for extrapolating the
# area and mean age of abandonment into the future.

# ----------------------------------------------------------------------- #

filter(fitted_df_l3, site == "shaanxi") %>% print(n = 20)

# parameters for testing
year <- 2000
i <- c(1988:(year - 4))[1]

# Function:
cc_estimate_area_abn <- function(year, summarize_area = TRUE, site_ = "shaanxi") {
  df <- lapply(1988:(year - 4), FUN = function(i) {
    
    df_tmp <- data.frame(year_abn = i) %>% 
      mutate(initial_area_abn = filter(dat_l, site == site_, year_abn == i) %>% 
               .$initial_area_abn %>% unique(),
             age_ = year - i + 1,
             exp_proportion = filter(fitted_df_l3, site == site_, 
                                     age == age_) %>% .$fitted,
             
             # exp_proportion = mean_coef_tmp$mean_est[2]*log(age - 4) + 
             #   mean_coef_tmp$mean_est[1]*((age - 4) - 1) + 1,
             
             exp_area = initial_area_abn*exp_proportion
             )
    }) %>% bind_rows() 
  
  if(summarize_area) {
    df <- df %>% summarise(area = sum(exp_area)) %>% as.numeric() }
  
  df
}



# test:

cc_estimate_area_abn(year = 2000, summarize_area = FALSE) # in the year 2000, how much land has been abandoned, in total? 
cc_estimate_area_abn(year = 2000) %>% summarise(area = sum(exp_area)) %>% as.numeric()
```


```{r mean-initial-area-abn}
# ----------------------------------------------------------------------- #
# Average area initially abandoned at each site, in a data.frame
# ----------------------------------------------------------------------- #
mean_initial_area_abn <- dat_l %>% filter(age == 5) %>%
  select(site, year_abn, initial_area_abn = area_ha) %>%
  group_by(site) %>%
  summarise(mean = mean(initial_area_abn))

mean_initial_area_abn

site_df_w_size # likely in km2
# 100 h in km2

mean_initial_area_abn <- mean_initial_area_abn %>% 
  left_join(. , select(mutate(site_df_w_size, area_ha = area*100),
                       site, area_ha)) %>%
  mutate(percent_of_total = 100*mean/area_ha)



# ----------------------------------------------------------------------- #
# plot the average initial area abandoned for each site
# ----------------------------------------------------------------------- #
gg_mean_area_by_site <- ggplot(data = mean_initial_area_abn, 
       mapping = aes(y = fct_reorder(site, desc(mean)), x = mean)) + 
  geom_col() + theme_classic() +
  labs(x = "Additional area abandoned in each year, on average", y = "Site",
       title = "Additional area abandoned each year, on average")


# as a percentage of the total area of each site
ggplot(data = mean_initial_area_abn, 
       mapping = aes(y = fct_reorder(site, desc(mean)), x = 100*mean/area_ha)) + 
  geom_col() + theme_classic() +
  labs(x = "Additional area abandoned in each year, on averag", y = "Site",
       title = "Additional area abandoned each year, on average",
       subtitle = "As a percent of total area in site")

# as a percentage of the amount of cropland in the previous year:


# ----------------------------------------------------------------------- #
# Plot the initial area abandoned in each year:
# note, this matches the gains in the panel figure showing the turnover. 
# ----------------------------------------------------------------------- #
test1 <- dat_l %>% group_by(site, year_abn) %>% summarise(initial_area_abn = unique(initial_area_abn))
test1 <- ungroup(test1)


ggplot(data = test1, #%>% filter(site== "belarus"),
       mapping = aes(x = year_abn, y = initial_area_abn)) +
  theme_classic() + 
  geom_col() + labs(y = "Initial Area Abandoned", x = "Year Abandoned") + 
  facet_wrap(~ site, nrow = 3, ncol = 4, scales = "free")



```

```{r trend-in-annual-gain-area-abn}

ggplot(data = turnover_dat %>% filter(change == "gain"), 
       mapping = aes(x = year, y = area_ha / (10^3))) + 
  theme_classic() +
    geom_col() + 
  geom_smooth(method = "lm") + 
  facet_wrap(vars(site))



turnover_dat %>% filter(change == "gain") %>%
  group_by(site) %>%
  summarise(mean = mean(area_ha))

# as a percentage of the available agricultural land:
area_dat %>% filter(lc == "Cropland")
1992 - 5 # five years prior to be labelled abandoned, when the land was first uncultivated.

turnover_dat %>% filter(change == "gain") %>% rename(area_abn = area_ha) %>%
  left_join(., area_dat %>% rename(area_crop = area_ha, year_crop = year) %>%
              mutate(year = year_crop + 5),
            by = c("site", "year")) %>%
  filter(lc == "Cropland") %>%
  mutate(abn_crop_percent = 100 * area_abn / area_crop) %>%
  ggplot(mapping = aes(x = year, y = abn_crop_percent)) + 
  theme_classic() +
  geom_col() + 
  geom_smooth(method = "lm") + 
  facet_wrap(vars(site), scales = "free_y") + 
  labs(y = "Annual area abandoned (ha) as a percentage \nof cropland area in year prior to abandonment",
       x = "Year")
  

turnover_dat
area_dat %>% mutate(year_og = year, year = year_og + 5)


area_dat %>% select(lc) %>% unique()
```


```{r fun-extrapolate_mean_age}
# ----------------------------------------------------------------------- #
# Function extrapolate mean age based on mean area abandoned in each year
# ----------------------------------------------------------------------- #

cc_extrapolate_abn <- function(extrapolate_to_year = 2100, 
                                    summarize_area = TRUE, 
                                    fitted_values_df,
                                    site_ = "shaanxi") {
  
  future_df <- tibble(
    site = site_,
    year = extrapolate_to_year,
    year_abn = 1988:extrapolate_to_year,
    mean_initial_area_abn = mean_initial_area_abn %>% filter(site == site_) %>% .$mean, 
    age = extrapolate_to_year - year_abn + 1) %>%
    
    # match with fitted values (expected proportions)
    left_join(.,
              filter(fitted_values_df, site == site_) %>% 
                select(age, exp_proportion = fitted),
              by = c("age")) %>%
    
    mutate(exp_area_ha = mean_initial_area_abn * exp_proportion)
  
  if(summarize_area) {
    future_df <- future_df %>% 
    summarise(exp_total_area_abn = sum(exp_area_ha, na.rm = TRUE),
              mean_age = 
                sum(age*exp_area_ha, na.rm = TRUE) /
                sum(exp_area_ha, na.rm = TRUE))
  }
  
  future_df
}
```


```{r extrapolate-future-df}
# ----------------------------------------------------------------------- #
# produce future extrapolation data.frame
# ----------------------------------------------------------------------- #
future_df_l3 <- 
  lapply(site_df$site, function(y) {
    lapply(1987:2150, function(x) {
      cc_extrapolate_abn(extrapolate_to_year = x,
                              summarize_area = FALSE,
                              fitted_values_df = fitted_df_l3,
                              site_ = y)
      }) %>% bind_rows() %>% filter(!is.na(exp_proportion))
    })  %>% bind_rows() %>%
  filter(exp_area_ha > 0)

future_df_l3 %>% filter(site == "shaanxi") %>% arrange(desc(year), desc(year_abn))


# save future_df_l3
write_csv(future_df_l3, path = paste0(p_dat_derived, run_label, "/future_df_l3", run_label, ".csv"))
# future_df_l3 <- read_csv(file = paste0(p_dat_derived, run_label, "/future_df_l3", run_label, ".csv"))

# ----------------------- #
# calculate the mean age
# ----------------------- #

extrapolate_df_l3 <- future_df_l3 %>% 
  group_by(site, year) %>%
  summarise(exp_total_area_abn = sum(exp_area_ha, na.rm = TRUE),
            mean_age = 
              sum(age*exp_area_ha, na.rm = TRUE) /
              sum(exp_area_ha, na.rm = TRUE)
            )

extrapolate_df_l3 <- bind_rows(extrapolate_df_l3, tibble(site = site_df$site,
       year = 1991, 
       exp_total_area_abn = 0,
       mean_age = NA))

# max mean age:
extrapolate_df_l3 <- extrapolate_df_l3 %>% 
  group_by(site) %>% 
  mutate(max_mean_age = max(mean_age, na.rm = T)) %>%
  arrange(max_mean_age)



# save extrapolate_df_l3
write_csv(extrapolate_df_l3, file = paste0(p_dat_derived, run_label, "/extrapolate_df_l3", run_label, ".csv"))
```


```{r plot-extrapolations}
# save extrapolate_df_l3
extrapolate_df_l3 <- read_csv(file = paste0(p_dat_derived, run_label, "/extrapolate_df_l3", run_label, ".csv"))
# ----------------------------------------------------------------------- #
# plot the mean age through time:
# ----------------------------------------------------------------------- #

gg_extrapolate_mean_age <-
  ggplot(data = extrapolate_df_l3 %>% filter(year < 2122), 
       mapping = aes(x = year, y = mean_age, 
                     color = fct_reorder(site, max_mean_age))) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = "Mean age of abanandoned lands (years)",
       #title = "Mean age of abandoned land through time",
       color = "Site"
       ) + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) + 
  guides(color = guide_legend(reverse = TRUE)) #+ geom_vline(xintercept = 2125)


png(filename = paste0(p_plots, run_label, "/decay/", "extrapolate_mean_age", run_label, ".png"), 
    width = 6, height = 4.5, units = "in", res = 400)
print(gg_extrapolate_mean_age)
dev.off()

# ----------------------------------------------------------------------- #
# plot the expected area through time:
# ----------------------------------------------------------------------- #
gg_extrapolate_area_abn <-
  ggplot(data = extrapolate_df_l3 %>% filter(year < 2122) %>%
         left_join(., filter(extrapolate_df_l3, year == 2150) %>%
                     select(site, exp_area_in_ = exp_total_area_abn), 
                   by = c("site")), 
       mapping = aes(x = year, y = exp_total_area_abn/10^3, 
                     color = fct_reorder(site, exp_area_in_))) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = expression("Area abandoned (10"^{3}*" ha)"),
       # title = "Extrapolated accumulation of abandoned land over time",
       color = "Site") + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) + 
  guides(color = guide_legend(reverse = TRUE)) #+ geom_vline(xintercept = 2125)

png(filename = paste0(p_plots, run_label, "/decay/", "extrapolate_area_abn", run_label, ".png"), 
    width = 6, height = 4.5, units = "in", res = 400)
print(gg_extrapolate_area_abn)
dev.off()

```


```{r plot-obs-v-exp-abn}
# ----------------------------------------------------------------------- #
# Produce a data.frame of extrapolated (expected) area abandoned in each year
# ----------------------------------------------------------------------- #
extrapolated_df_s <- filter(dat_l, site == "shaanxi") %>% group_by(year) %>% 
  summarise(site = unique(site), observed = sum(area_ha)) %>% 
  mutate(
    expected = sapply(year, FUN = function(i) {
      cc_estimate_area_abn(year = i, summarize_area = TRUE)
      }),
    expected_mean = sapply(year, FUN = function(i) {
      cc_extrapolate_abn(extrapolate_to_year = i, summarize_area = TRUE,
                              fitted_values_df = fitted_df_l3) %>% 
        select(exp_total_area_abn) %>% as.numeric()
      })
    ) %>%
  pivot_longer(cols = c("observed", "expected", "expected_mean"),
               names_to = "estimate",
               values_to = "area_ha")

# for all sites, 

extrapolated_df_s %>% print(n = 30)


# ----------------------------------------------------------------------- #
# plot the area, by age class, 
# along with the abandoned area predicted by mean decay rate at that site,
# with both accurate and average initial area abandoned:
# ----------------------------------------------------------------------- #

ggplot(data = filter(dat_l, site == "shaanxi"),
       mapping = aes(x = year, y = area_ha / 10^3, 
                           fill = cut(age, breaks = 5, right = TRUE))) + 
    theme_classic() +
    labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Year", 
         title = "Area of Abandoned Land, by Age Class",
         fill = "Age",
         color = "Area Estimate Type") +
    geom_col(position = position_stack(reverse = FALSE)) + 
    scale_fill_brewer(palette = "Greens", direction = 1) + 
  scale_y_continuous(n.breaks = 15) + scale_x_continuous(n.breaks = 6) + 
  geom_line(data = extrapolated_df_s, 
            mapping = aes(x = year, y = area_ha/10^3, color = estimate), inherit.aes = FALSE,
            size = 1) +
  scale_color_manual(values = c("observed" = "black", 
                                "expected" = "red", 
                                "expected_mean" = "blue"),
                     labels = c(#"value" = "label"
                       "observed" = "Observed", 
                       "expected" = "Mean decay rate, \naccurate initial area abn", 
                       "expected_mean" = "Mean decay rate, \nmean initial area abn"
    ))



# next steps: I think this is working... but I need to double check that the expected area calculation is correct. And then I need to figure out a way to extrapolate the initial_area_abn, so I can carry out the extrapolation farther into the future.

# rather than the fitted_df, calculate the expected proportion directly from the coef.

# ..... ? need to figure out a good way to add the average initial_area_abn to the df, and then recalculate the exp_proportion directly from the coef, and then calculate the sum.
```


```{r plot-extrapolated-area-by-age-bin}
# ----------------------------------------------------------------------- #
# Plot extrapolated area by age bin
# ----------------------------------------------------------------------- #
future_df_l3 %>% filter(exp_area_ha > 0) %>% arrange(desc(age))
future_df_l3 %>% select(age) %>% max() %>% signif(2) / 9

future_df_l3 %>% mutate(
  age_bin = cut(age, breaks = seq(from = 0, to = 140, by = 15), right = TRUE))

gg_extrapolated_area_by_age_bin <-
  ggplot(data = future_df_l3 %>% 
           filter(year <= 2120#, site == "shaanxi"
                                        ) %>%
         mutate(age_bin = cut(age, breaks = seq(from = 0, to = 140, by = 15), right = TRUE)),
       mapping = aes(x = year, y = exp_area_ha / 10^3, 
                     fill = age_bin)) + 
    theme_classic() +
    labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Year", fill = "Age", linetype = NULL) +
    geom_col(position = position_stack(reverse = FALSE)) + 
    scale_fill_brewer(palette = "Greens", direction = 1) +
    
  geom_line(data = extrapolate_df_l3 %>% filter(year <= 2120#, site == "shaanxi"
                                                ),
            mapping = aes(x = year, y = exp_total_area_abn / 10^3,
                          linetype = "Total Area Abandoned"),
            color = "gray50", inherit.aes = FALSE) +
  theme(legend.position = c(0.85, 0.10), 
        legend.spacing = unit(2, units = "mm"), 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  facet_wrap(vars(site), scales = "free_y", nrow = 4, ncol = 3)

  

ggsave(plot = gg_extrapolated_area_by_age_bin, 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolate_age_by_age_bin_tall", run_label, ".pdf"), 
       width = 7, height = 8, units = "in")


 
# wide
ggsave(plot = gg_extrapolated_area_by_age_bin +
         facet_wrap(vars(site), scales = "free_y", nrow = 3, ncol = 4) + 
         theme(legend.position = c(0.88, 0.12),
               legend.spacing = unit(0.5, units = "mm"),
               legend.background = element_rect(fill = "transparent")),
       filename = paste0(p_plots, run_label, "/presentation/", "extrapolate_age_by_age_bin_wider", run_label, ".pdf"),
       width = 8, height = 5, units = "in", dpi = 400
)


# ---------------------------------------------------------- #
# how much of the abandoned land is older than 50 years old?
# ---------------------------------------------------------- #
old_abn_df <- future_df_l3 %>% filter(age > 50#, exp_area_ha > 0
                                      ) %>%
  group_by(site, year) %>%
  summarise(exp_area_over_50 = sum(exp_area_ha, na.rm = TRUE))

old_abn_df

future_df_l3 %>% filter(age > 50, exp_area_ha > 0) %>%
  select(site) %>% unique()

max_age_extrapolation <- future_df_l3 %>% 
  filter(exp_area_ha > 0) %>% 
  group_by(site) %>%
  summarise(max_age = max(age, na.rm = TRUE)) %>%
  arrange(max_age)

ggplot(data = max_age_extrapolation,
       mapping = aes(y = reorder(site, desc(max_age)), x = max_age)) +
  geom_point() + theme_classic()

# only some sites have land over 50 years old:
old_abn_df %>% filter(exp_area_over_50 > 0) %>%
  select(site) %>% unique()


# ----------------------------------------------------------------------- #
# plot the expected area through time:
# ----------------------------------------------------------------------- #
# gg_extrapolate_old_abn <- 
  ggplot(data = old_abn_df %>% filter(year < 2050)
         # %>%
         # left_join(., filter(old_abn_df, year == 2150) %>%
         #             select(site, exp_area_in_ = exp_total_area_abn), 
         #           by = c("site"))
         , 
       mapping = aes(x = year, y = exp_area_over_50/10^3, 
                     color = site)) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = expression("Area abandoned at least 50 years (10"^{3}*" ha)"),
       # title = "Extrapolated accumulation of abandoned land over time",
       color = "Site") + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) + 
  guides(color = guide_legend(reverse = TRUE)) #+ geom_vline(xintercept = 2125)


# just one year:
ggplot(data = future_df_l3 %>% filter(site == "shaanxi", year == 2121),
       mapping = aes(x = year, y = exp_area_ha / 10^3, 
                     fill = cut(age, breaks = seq(from = 0, to = 140, by = 20), right = TRUE))) + 
  theme_classic() + 
  geom_col(position = position_stack(reverse = FALSE)) +
  scale_fill_brewer(palette = "Greens", direction = 1) + 
      labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Year", 
         title = "Area of Abandoned Land, by Age Class",
         fill = "Age")
  




```

```{r extrapolation-panel}

max_age_extrapolation <- future_df_l3 %>% 
  filter(exp_area_ha > 0) %>% 
  group_by(site) %>%
  summarise(max_age = max(age, na.rm = TRUE)) %>%
  arrange(max_age)

extrapolate_df_l3 %>% left_join(max_age_extrapolation, by = "site")
fitted_df_l3 %>% left_join(max_age_extrapolation, by = "site")

# ----------------------------------------------------------------------- #
# site decay trend
# ----------------------------------------------------------------------- #
gg_extrapolation_panel_trend_a <-
  ggplot(data = fitted_df_l3 %>% 
           left_join(max_age_extrapolation, by = "site") %>% 
           filter(age < 140),
       mapping = aes(x = age, y = fitted, color = fct_reorder(site, max_age))) +
  theme_classic() +
  geom_line(size = 1.1) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(#title = "Decay of abandoned land over time", 
       #caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site") + 
  guides(col = guide_legend(reverse = TRUE)) + 
  scale_x_continuous(breaks = seq(from = 0, to = 140, by = 20))


exp_area_in_2150 <- extrapolate_df_l3 %>% 
           left_join(., filter(extrapolate_df_l3, year == 2150) %>%
                       select(site, exp_area_in_2150 = exp_total_area_abn), 
                   by = c("site")) %>%
  select(site, exp_area_in_2150) %>% unique() %>% arrange(exp_area_in_2150)

# ----------------------------------------------------------------------- #
# plot the expected area through time:
# ----------------------------------------------------------------------- #
gg_extrapolation_panel_area_c <-
  ggplot(data = extrapolate_df_l3 %>% 
           left_join(max_age_extrapolation, by = "site") %>% 
           filter(year < 2122), 
       mapping = aes(x = year, y = exp_total_area_abn/10^3, 
                     color = fct_reorder(site, max_age))) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = expression("Area abandoned (10"^{3}*" ha)"),
       # title = "Extrapolated accumulation of abandoned land over time",
       color = "Site") + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) +
  scale_color_discrete(breaks = exp_area_in_2150$site) + # to reorder the legend
  guides(color = guide_legend(reverse = TRUE))

# ----------------------------------------------------------------------- #
# mean age through time
# ----------------------------------------------------------------------- #
gg_extrapolation_panel_age_b <-
  ggplot(data = extrapolate_df_l3 %>% 
           left_join(max_age_extrapolation, by = "site") %>% 
           filter(year < 2122), 
       mapping = aes(x = year, y = mean_age, color = fct_reorder(site, max_age))) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = "Mean age of abanandoned lands (years)",
       #title = "Mean age of abandoned land through time",
       color = "Site"
       ) + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) + 
  guides(color = guide_legend(reverse = TRUE)) #+ geom_vline(xintercept = 2125)



# save

ggsave(plot = plot_grid(
  plot_grid(gg_extrapolation_panel_trend_a + theme(legend.position = "none"),
            gg_extrapolation_panel_age_b, ncol = 2, rel_widths = c(1, 1.2),
            labels = c("a", "b")),
  gg_extrapolation_panel_area_c, labels = c("", "c"),
  nrow = 1, ncol = 2, rel_widths = c(1.75, 1)
  ), 
  filename = paste0(p_plots, run_label, "/decay/", "extrapolation_combo", run_label, ".pdf"), 
    width = 13, height = 4, units = "in"
)



# the tall combo, the one I end up using
ggsave(plot = 
         plot_grid(
           gg_extrapolation_panel_trend_a, 
           plot_grid(gg_extrapolation_panel_age_b, 
                     gg_extrapolation_panel_area_c,
                     ncol = 2, #rel_widths = c(1, 1.2),
                     labels = c("b", "c")),
           labels = c("a", ""),
           nrow = 2, ncol = 1, rel_widths = c(1.75, 1)
           ), 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolation_combo_tall", run_label, ".pdf"),
       width = 10, height = 8, units = "in"
)
```

## Extrapolating site mean decay without cohort f.e. (l3)

```{r extrapolating-l3-no-cohort}

    # geom_function(fun = function(x) {
    #     filter(mean_coef_tmp_no_cohort, term == "log")$estimate * log(x-4) +
    #       filter(mean_coef_tmp_no_cohort, term == "lin")$estimate * ((x-4) - 1) + 1}
    
  
coef_df_l3_no_cohort <- lapply(lm_l3_no_cohort_l, FUN = function(x) {
  tidy(x)  
}) %>% bind_rows(.id = "site") %>%
    mutate(term_long = term,
           term = as_factor(ifelse(term_long == "I(time)", "lin", "log")))


# make a data.frame with fitted values for the mean coef
fitted_df_l3_no_cohort <- lapply(site_df$site, FUN = function(x) {
  data.frame(site = x,
             time = 1:150 - 1,
             log_est = filter(coef_df_l3_no_cohort, site == x, term == "log")$estimate,
             lin_est = filter(coef_df_l3_no_cohort, site == x, term == "lin")$estimate) %>%
    mutate(fitted = log_est*log(time + 1) + lin_est*(time) + 1,
           fitted = ifelse(fitted >= 0, fitted, 0), # fitted proportion can't be less than 0!
           age = time + 5)
}) %>% bind_rows() %>% as_tibble()


# ----------------------------------------------------------------------- #
# produce future extrapolation data.frame
# ----------------------------------------------------------------------- #
future_df_l3_no_cohort <- 
  lapply(site_df$site, function(y) {
    lapply(1987:2150, function(x) {
      cc_extrapolate_abn(extrapolate_to_year = x, 
                              summarize_area = FALSE, 
                              fitted_values_df = fitted_df_l3_no_cohort,
                              site_ = y)
      }) %>% bind_rows() %>% filter(!is.na(exp_proportion))
    })  %>% bind_rows() %>% 
  filter(exp_area_ha > 0)

extrapolate_df_l3_no_cohort <- 
  future_df_l3_no_cohort %>% 
  group_by(site, year) %>%
  summarise(exp_total_area_abn = sum(exp_area_ha, na.rm = TRUE),
            mean_age = 
              sum(age*exp_area_ha, na.rm = TRUE) /
              sum(exp_area_ha, na.rm = TRUE)
            )

extrapolate_df_l3_no_cohort <- bind_rows(extrapolate_df_l3_no_cohort, tibble(site = site_df$site,
       year = 1991, 
       exp_total_area_abn = 0,
       mean_age = NA))

write_csv(future_df_l3_no_cohort, path = paste0(p_dat_derived, run_label, "/future_df_l3_no_fe", run_label, ".csv"))
write_csv(extrapolate_df_l3_no_cohort, path = paste0(p_dat_derived, run_label, "/extrapolate_df_l3_no_fe", run_label, ".csv"))


# ----------------------------------------------------------------------- #
# plot the mean age through time:
# ----------------------------------------------------------------------- #


gg_extrapolate_mean_age_no_cohort <- gg_extrapolate_mean_age %+% 
  extrapolate_df_l3_no_cohort + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2150, by = 20))


gg_extrapolate_mean_age_no_cohort

png(filename = paste0(p_plots, run_label, "/decay/", "extrapolate_mean_age_no_fe", run_label, ".png"), 
    width = 6, height = 4.5, units = "in", res = 400)
print(gg_extrapolate_mean_age_no_cohort)
dev.off()

# ----------------------------------------------------------------------- #
# plot the expected area through time:
# ----------------------------------------------------------------------- #

gg_extrapolate_area_abn_no_cohort <-
  ggplot(data = extrapolate_df_l3_no_cohort %>% 
           left_join(.,
                   filter(extrapolate_df_l3_no_cohort, year == 2150) %>%
                     select(site, exp_area_in_ = exp_total_area_abn),
                   by = c("site")), 
       mapping = aes(x = year, y = exp_total_area_abn / 10^3, 
                     color = fct_reorder(site, exp_area_in_)
                     )) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = expression("Area abandoned (10"^{3}*" ha)"),
       # title = "Extrapolated accumulation of abandoned land over time",
       color = "Site") + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2150, by = 20)) + 
  guides(color = guide_legend(reverse = TRUE)) #+ geom_vline(xintercept = 2125)


png(filename = paste0(p_plots, run_label, "/decay/", "extrapolate_area_abn_no_fe", run_label, ".png"), 
    width = 6, height = 4.5, units = "in", res = 400)
print(gg_extrapolate_area_abn_no_cohort)
dev.off()





# ----------------------------------------------------------------------- #
# plot the expected area through time, with age bins:
# ----------------------------------------------------------------------- #

gg_extrapolated_area_by_age_bin_no_cohort <-
  ggplot(data = future_df_l3_no_cohort %>% filter(year <= 2120#, site == "shaanxi"
                                        ),
       mapping = aes(x = year, y = exp_area_ha / 10^3, 
                     fill = cut(age, breaks = seq(from = 0, to = 140, by = 15), right = TRUE))) + 
    theme_classic() +
    labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
         x = "Year", fill = "Age", linetype = NULL) +
    geom_col(position = position_stack(reverse = FALSE)) + 
    scale_fill_brewer(palette = "Greens", direction = 1) +
    
  geom_line(data = extrapolate_df_l3_no_cohort %>% filter(year <= 2120#, site == "shaanxi"
                                                ),
            mapping = aes(x = year, y = exp_total_area_abn / 10^3,
                          linetype = "Total Area Abandoned"),
            color = "gray50") +
    
  facet_wrap(vars(site), scales = "free_y", nrow = 4, ncol = 3) +
  theme(legend.position = c(0.85, 0.10), 
        legend.spacing = unit(2, units = "mm"), 
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0)) + 
  guides(fill = guide_legend(ncol = 2))


ggsave(plot = gg_extrapolated_area_by_age_bin_no_cohort, 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolate_age_by_age_bin_no_fe", run_label, ".pdf"), 
    width = 7, height = 8, units = "in")



```

```{r extrapolation-panel}

max_age_extrapolation_no_cohort <- future_df_l3_no_cohort %>% 
  filter(exp_area_ha > 0) %>% 
  group_by(site) %>%
  summarise(max_age = max(age, na.rm = TRUE)) %>%
  arrange(max_age)

# ----------------------------------------------------------------------- #
# site decay trend
# ----------------------------------------------------------------------- #
gg_extrapolation_panel_no_fe_trend_a <-
  ggplot(data = fitted_df_l3_no_cohort %>% 
           left_join(max_age_extrapolation_no_cohort, by = "site") %>% 
           filter(age < 140),
       mapping = aes(x = age, y = fitted, color = fct_reorder(site, max_age))) +
  theme_classic() +
  geom_line(size = 1.1) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(#title = "Decay of abandoned land over time", 
       #caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort + (time):cohort",
       x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site") + 
  guides(col = guide_legend(reverse = TRUE)) + 
  scale_x_continuous(breaks = seq(from = 0, to = 140, by = 20))


exp_area_in_2150_no_fe <- extrapolate_df_l3_no_cohort %>% 
           left_join(., filter(extrapolate_df_l3_no_cohort, year == 2150) %>%
                       select(site, exp_area_in_2150 = exp_total_area_abn), 
                   by = c("site")) %>%
  select(site, exp_area_in_2150) %>% unique() %>% arrange(exp_area_in_2150)

# ----------------------------------------------------------------------- #
# plot the expected area through time:
# ----------------------------------------------------------------------- #
gg_extrapolation_panel_no_fe_area_c <-
  ggplot(data = extrapolate_df_l3_no_cohort %>% 
           left_join(max_age_extrapolation_no_cohort, by = "site") %>% 
           filter(year < 2122), 
       mapping = aes(x = year, y = exp_total_area_abn/10^3, 
                     color = fct_reorder(site, max_age))) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = expression("Area abandoned (10"^{3}*" ha)"),
       # title = "Extrapolated accumulation of abandoned land over time",
       color = "Site") + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) +
  scale_color_discrete(breaks = exp_area_in_2150_no_fe$site) + # to reorder the legend
  guides(color = guide_legend(reverse = TRUE))

# ----------------------------------------------------------------------- #
# mean age through time
# ----------------------------------------------------------------------- #
gg_extrapolation_panel_no_fe_age_b <-
  ggplot(data = extrapolate_df_l3_no_cohort %>% 
           left_join(max_age_extrapolation_no_cohort, by = "site") %>% 
           filter(year < 2122), 
       mapping = aes(x = year, y = mean_age, color = fct_reorder(site, max_age))) + 
  geom_line(size = 1) + 
  theme_classic() + 
  labs(x = "Year", y = "Mean age of abanandoned lands (years)",
       #title = "Mean age of abandoned land through time",
       color = "Site"
       ) + 
  scale_x_continuous(breaks = seq(from = 2000, to = 2120, by = 20)) + 
  guides(color = guide_legend(reverse = TRUE)) #+ geom_vline(xintercept = 2125)



# with fixed effects

ggsave(plot = 
         plot_grid(
           plot_grid(gg_extrapolation_panel_no_fe_trend_a + theme(legend.position = "none"),
                     gg_extrapolation_panel_no_fe_age_b, ncol = 2, rel_widths = c(1, 1.2),
                     labels = c("a", "b")),
           gg_extrapolation_panel_no_fe_area_c, labels = c("", "c"),
           nrow = 1, ncol = 2, rel_widths = c(1.75, 1)
           ), 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolation_combo_no_fe", run_label, ".pdf"),
       width = 13, height = 4, units = "in"
)


ggsave(plot = 
         plot_grid(
           gg_extrapolation_panel_no_fe_trend_a, 
           plot_grid(gg_extrapolation_panel_no_fe_age_b, 
                     gg_extrapolation_panel_no_fe_area_c,
                     ncol = 2, #rel_widths = c(1, 1.2),
                     labels = c("b", "c")),
           labels = c("a", ""),
           nrow = 2, ncol = 1, rel_widths = c(1.75, 1)
           ), 
       filename = paste0(p_plots, run_label, "/decay/", "extrapolation_combo_no_fe_tall", run_label, ".pdf"),
       width = 10, height = 8, units = "in"
)

```

## Gradual decline of area abandoned each year

```{r}

```



```{r persistence-exp}
run_dfs %>% filter(area_ha > 0) %>%
  select(year_abn) %>% 
  unique()

run_dfs %>% filter(area_ha > 0) %>%
  select(year_abn) %>% 
  factor()

run_dfs %>% select(site) %>% unique()

```


# Supplemental Code

## Exploration
```{r basic-persistence-plots}


gg_persist_base <- ggplot(data = dat) + 
  theme_classic() + 
  labs(title = "Persistence of Abandoned Land",
       subtitle = site_df$description[indx],
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
  theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0))

# raw area
gg_persistence_count <- gg_persist_base + 
  geom_line(mapping = aes(x = age, y = area_ha / 10^3,
                          group = year_abn, color = year_abn), 
            size = 1.25) + 
  labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
       x = "Years since initial abandonment")
  
# as percentage
gg_persistence_proportion <- gg_persist_base + 
  geom_line(mapping = aes(x = age, y = proportion,
                          group = year_abn, color = year_abn), 
            size = 1.25) + 
  labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment")

# na_first ----------- #
gg_persistence_count_na_first <- gg_persist_base + 
  geom_line(mapping = aes(x = year, y = area_ha / 10^3,
                          group = year_abn, color = year_abn), 
            size = 1.25) + 
  labs(y = expression("Area abandoned (10"^{3}*" ha)") , 
       x = "Year")

gg_persistence_proportion_na_first <- gg_persist_base + 
  geom_line(mapping = aes(x = year, y = proportion,
                          group = year_abn, color = year_abn), 
            size = 1.25) + 
  labs(y = "Proportion remaining abandoned", 
       x = "Year")

```


```{r abandonment-persistence}

# average proportion of abandoned land remaining, across time abandoned

df_av <- persistence_list_b1_s$na_last %>%
  mutate(year_abn = as_factor(year_abn)) %>%
  group_by(time_abn) %>%
  summarise(count = n(),
            sd = sd(proportion, na.rm = TRUE), 
            se = sd/sqrt(count),
            proportion = mean(proportion), 
            year_abn = as_factor("mean"))
df_av


# as percentage
gg_persistence_proportion # see basic-persistence-plots chunk

gg_persistence_proportion + geom_line(data = df_av, mapping = aes(x = time_abn, y = proportion),
              size = 3)


# ----------------------------------- plot ------------------------------------------------- #


gg_half_life_s <- gg_persistence_proportion + 
  geom_hline(yintercept = 0.5, linetype="dashed", 
             color = "red", size = 0.75) +
  geom_ribbon(data = df_av, aes(x = time_abn, ymin = proportion - 1.96*se, ymax=proportion + 1.96*se), 
              color = "gray", fill = "gray", alpha=0.5) + 
  geom_line(data = df_av, mapping = aes(x = time_abn, y = proportion),
              size = 2, color = "black")

gg_half_life_s
df_av %>% filter(proportion <= 0.51)



# save basic half-life plot with 
png(filename = paste0(p_plots, run_label, "/decay/", "half_life", run_label, site_label, ".png"), 
    width = 7, height = 5, units = "in", res = 400)
print(gg_half_life_s)
dev.off()
```

```{r exp-geom_smooth}
gg_persist_mod_base <- ggplot(data = dat, mapping = aes(x = age, y = proportion)) + 
  theme_classic() + 
  geom_point(aes(group = year_abn, color = year_abn), size = 1.25) + 
  labs(title = "Persistence of Abandoned Land",
       subtitle = site_df$description[indx],
       color = "Year Abandoned",
       y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment") + 
  scale_color_distiller(palette = "Greens") + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "red", size = 0.75)

png(filename = paste0(p_plots, run_label, "/decay/", "raw_persist_data", run_label, site_label, ".png"), 
    width = 5, height = 5, units = "in", res = 400)
print(gg_persist_mod_base)
dev.off()

# ----------------------------------- plot average proportion ------------------------------------------------- #
gg_persist_mod_base + 
  geom_hline(yintercept = 0.5, linetype="dashed", 
             color = "red", size = 0.75) +
  geom_ribbon(data = df_av, aes(x = time_abn, ymin = proportion - 1.96*se, ymax=proportion + 1.96*se), 
              color = "gray", fill = "gray", alpha=0.5) + 
  geom_line(data = df_av, mapping = aes(x = time_abn, y = proportion),
              size = 2, color = "black")


# ----------------------------------- plot regular lm ------------------------------------------------- #

# regular lm
gg_persist_mod_base + 
  geom_smooth(method = "lm", se = FALSE)


# ----------------------------------- y ~ log(x) ------------------------------------------------- #

gg_persist_mod_base + 
  geom_smooth(method = "lm", formula = y ~ log(x), se = FALSE) + 
  geom_vline(xintercept = 
               exp(( 0.5 - coef(lm(proportion ~ log(age), data = dat))[1] ) / 
                     coef(lm(proportion ~ log(age), data = dat))[2]))

# others
gg_persist_mod_base + 
  geom_smooth(method = "lm", formula = y ~ exp(x), se = FALSE)


# ----------------------------------- log(y) ~ x ------------------------------------------------- #

gg_persist_mod_base + 
  geom_smooth(method = "lm", formula = log(y) ~ x,
              se = FALSE)

# simple lm ----------------- #
lm_mod <- lm(log(proportion) ~ age, data = dat)

  # note, needs to be log transformed
ggplot(data = dat, mapping = aes(x = age, y = log(proportion))) + 
  theme_classic() + 
  geom_point(mapping = aes(group = year_abn, color = year_abn), 
            size = 1.25) + 
  labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land",
       subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + 
  theme(legend.position = "bottom", legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 

  # log(y) ~ x
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) + 
  geom_hline(yintercept = log(0.5), linetype = "dashed", color = "red", size = 0.75) + 
  geom_vline(xintercept = cc_half_life(lm_mod))
```


```{r cc_half_life}
# ----------------------------------- calculate the half-life  ------------------------------------------------- #

augment(lm_mod)
coef(lm_mod)

# log(y) = b0 + b1*x
# log(y) - b0 = b1*x
# ( log(y) - b0 ) / b1 = x
# ( log(0.5) - b0 ) / b1 = half-life
# ( log(0.5) - intercept ) / slope = half-life

(log(0.5) - coef(lm_mod)["(Intercept)"]) / coef(lm_mod)["age"] # = x 

# function to do this, set up to work for both lm and lmer outputs

cc_half_life <- function(model_out, cohort = TRUE, confint = FALSE, 
                         type = "log-log", fixed_effect = "time") {
  
  if(cohort) {
    mean_coef <- tidy(model_out, conf.int = TRUE) %>%
      summarise_at(c("estimate", "conf.low", "conf.high"), mean, na.rm = TRUE)
    
    
    if(type == "log-log") {
      warning("Producing time to 50%, not true half-life. (Log-log relationships do not have true half-lives)")
      half_life_df <- data.frame("half-life" = 0.5^(1/mean_coef$estimate),
                 "conf.low" = 0.5^(1/mean_coef$conf.low),
                 "conf.high" = 0.5^(1/mean_coef$conf.high)
               )
    }
    
    if(type == "semi-log") {
      half_life_df <- data.frame("half-life" = log(0.5)/mean_coef$estimate,
                 "conf.low" = log(0.5)/mean_coef$conf.low,
                 "conf.high" = log(0.5)/mean_coef$conf.high
               )
    }
    
    } else {
      
      params <- tidy(model_out, conf.int = TRUE) %>% as.data.frame()
      
      int <- params[which(params$term == "(Intercept)"), "estimate"]
      int.low <- params[which(params$term == "(Intercept)"), "conf.low"]
      int.high <- params[which(params$term == "(Intercept)"), "conf.high"]
      slope <- params[which(params$term == fixed_effect), "estimate"]
      slope.low <- params[which(params$term == fixed_effect), "conf.low"]
      slope.high <- params[which(params$term == fixed_effect), "conf.high"]
      
      if("(Intercept)" %in% params$term) {
        half_life_df <- data.frame("half-life" = (log(0.5) - int) / slope,
                                   "conf.low" = (log(0.5) - int.low) / slope.low,
                                   "conf.high" = (log(0.5) - int.high) / slope.high
                                   )
        } else {
        half_life_df <- data.frame("half-life" = (log(0.5)) / slope,
                                   "conf.low" = (log(0.5)) / slope.low,
                                   "conf.high" = (log(0.5)) / slope.high
        )
        }
    }
  
  if(fixed_effect == "time") {half_life_df <- half_life_df + 5}
  
  if (confint) {half_life_df} else {half_life_df[, 1]}

}

tidy(lm_mod)
tidy(lmer_mod)

cc_half_life(lm_mod, cohort = FALSE, confint = TRUE, fixed_effect = "time")
cc_half_life(lm_mod, confint = TRUE)
cc_half_life(lmer_mod, cohort = FALSE, confint = TRUE, fixed_effect = "age")

cc_half_life(lmer_mod_slope, fixed_effect = "age", cohort = FALSE, confint = TRUE)
cc_half_life(lmer_mod_slope0, fixed_effect = "time", cohort = FALSE, confint = TRUE)


tidy(lm_mod_log2_cohort) %>% select(estimate) %>% unlist() %>% mean(., na.rm = TRUE)



cc_half_life(lm_mod_log2_cohort, type = "log-log", cohort = TRUE, confint = TRUE)
cc_half_life(lm_mod_cohort_slope0, type = "semi-log", cohort = TRUE, confint = TRUE)

cc_half_life(lm_mod_log2_cohort, type = "log-log")
cc_half_life(lm_mod_log2_cohort)
cc_half_life(lm_mod_cohort_slope0, type = "semi-log")


mean_coef$conf.high

0.5^(1/mean_coef$estimate)

cc_half_life(lm_mod_log2_cohort, cohort = TRUE, type = "log-log", confint = TRUE)


```



```{r lm}
# as shown above, the lm call to model basic exponential decay is as follows:
mod_decay_s <- lm(log(proportion) ~ age, data = dat) # or
lm_mod <- lm(log(proportion) ~ time, data = dat)


# extract coefficients, summary, confint, etc., along with other useful functions
summary(lm_mod)
coef(lm_mod)
confint(lm_mod)
tidy(lm_mod, conf.int = TRUE) 

augment(lm_mod) # to get predicted values, etc. along with the input response and predictor variables

cc_half_life(lm_mod, confint = TRUE)

# ------- plot half life with lm curve ------------------------------------------------- #

# two ways to plot the model results, either
gg_persist_mod_base + 
  
  # add fitted values, exponentiated
  geom_line(data = augment(lm_mod, newdata = mutate(data.frame(age = 5:30), time = age - 5)), 
            aes(x = age, y = exp(.fitted)),
            color = "red", size = 2) + 
  
  # or add as a function
  geom_function(fun = function(x) {exp(coef(lm_mod)[2]*x + coef(lm_mod)[1])},
                color = "blue", size = 1)




# fancier plot
# prepare to be plotted
model_estimates <- data.frame(
  age = 5:30,
  int = tidy(lm_mod) %>% filter(term == "(Intercept)") %>% select(estimate) %>% unlist(use.names = FALSE),
  int_low = tidy(lm_mod, conf.int = TRUE) %>% filter(term == "(Intercept)") %>% select(conf.low) %>% unlist(use.names = FALSE),
  int_high = tidy(lm_mod, conf.int = TRUE) %>% filter(term == "(Intercept)") %>% select(conf.high) %>% unlist(use.names = FALSE),
  slope = tidy(lm_mod) %>% filter(term == "age") %>% select(estimate) %>% unlist(use.names = FALSE),
  slope_low = tidy(lm_mod, conf.int = TRUE) %>% filter(term == "age") %>% select(conf.low) %>% unlist(use.names = FALSE),
  slope_high = tidy(lm_mod, conf.int = TRUE) %>% filter(term == "age") %>% select(conf.high) %>% unlist(use.names = FALSE)
  ) %>%
  mutate(estimate = exp(int + slope* age),
         lower = exp(int_low + slope_low* age),
         upper = exp(int_high + slope_high* age))


# much easier to do this:

gg_half_life_lm_s <- gg_persist_mod_base + 
  # make and add confidence interval
  geom_ribbon(data = mutate(data.frame(age = 5:30),
                            lower = exp(confint(lm_mod)[2, 1]*age +
                                          confint(lm_mod)[1, 1]),
                            upper = exp(confint(lm_mod)[2, 2]*age +
                                          confint(lm_mod)[1, 2])),
              mapping = aes(ymin = lower, ymax = upper, x = age), inherit.aes = FALSE, 
              fill = "dark gray", alpha = 0.5, color = "dark gray", linetype = "solid") +
  geom_function(fun = function(x) {exp(coef(lm_mod)[2]*x + 
                                         coef(lm_mod)[1])},
                color = "dark blue", size = 1) + 
  annotate("text", x = 24, y = 0.8, label = "half-life = 23.17 years", fontface = "italic", angle = 90) + 
  geom_vline(xintercept = cc_half_life(lm_mod))




# save
png(filename = paste0(p_plots, run_label, "/decay/", "half_life_lm", run_label, "_s.png"), 
    width = 5, height = 5, units = "in", res = 400)
print(gg_half_life_lm_s)
dev.off()






# with coord_trans
ggplot(data = dat %>% mutate(year_abn = as.numeric(levels(year_abn))[year_abn]),
       mapping = aes(x = (age), y = (proportion), group = year_abn, color = year_abn)) + 
  # theme_classic() + 
  geom_point(size = 1) + 
  labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment") + 
  scale_color_distiller(palette = "Greens") +
  coord_trans(y = "log", x = "log") 
#+ scale_y_log10()
```

```{r lm0-int}

# -------------------- consistent intercept ----------------------------- #
# dat_shift

dat$time # this has been rescaled to allow for the intercept at (0, 1)

lm_mod0 <- lm(log(proportion) ~ 0 + time, data = dat)
# note, this is the same as running: lm(log(proportion) ~ 0 + I(age - 5), data = dat)

lm_mod0
coef(lm_mod0)
# y = exp(beta1 * t)
exp( coef(lm_mod0) * 0)
for (t in 0:10) {
  print(
    exp( coef(lm_mod0) * t)
  )
}
# each time step, the amount from the previous time step is multiplied by e ^ coef
exp(coef(lm_mod0))

exp( coef(lm_mod0) * 5) / 
  exp( coef(lm_mod0) * 4)



lm(log(proportion) ~ time, data = dat) # note, this is the same as lm(formula = log(proportion) ~ age, data = dat) (lm_mod)
lm(log(proportion) ~ 0 + age, data = dat) # this doesn't quite work, since it sets the intercept to (0, 1), since the proportions start at age = 5. 
lm_mod0

# Note that lm(y ~ x, data = dat) is the same as lm(y ~ 1 + x, data = dat). 
# The 1 in the longer notation represents that we want lm to estimate an intercept. 
# If we change this to a 0, explicitly, lm only calculates a slope coefficient for x.  This is what we've done above. 


# lm_mod_offset <- lm(log(proportion) ~ 0 + time, data = dat)
# lm_mod_offset1 <- lm(log(proportion) ~ time, data = dat)


ggplot(data = dat, mapping = aes(x = time, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  
  # lm_mod0
  geom_line(data = augment(lm_mod0, newdata = mutate(data.frame(time = 0:25), age = time + 5)),
            aes(x = time, y = exp(.fitted)),
            color = "red", size = 1, inherit.aes = FALSE)


# 0 + age
ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(title = "log(proportion) ~ 0 + age") + 
  geom_function(fun = function(x) {exp( coef(lm(log(proportion) ~ 0 + age, data = dat)) * (x - 5))},
                color = "blue", size = 1, linetype = "solid", inherit.aes = FALSE) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))

coef(lm(log(proportion) ~ 0 + age, data = dat))


# comparing to the original lm_mod
gg_persist_mod_base + 
  geom_line(data = augment(lm_mod, newdata = data.frame(age = 5:30)), 
            aes(x = age, y = exp(.fitted)), 
            color = "red", size = 2)

gg_persist_mod_base + scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5)) + 
  
  # lm_mod
  geom_line(data = augment(lm_mod, newdata = mutate(data.frame(time = 0:25), age = time + 5)),
            aes(x = age, y = exp(.fitted)),
            color = "green", size = 1, inherit.aes = FALSE) + 
  
  # lm_mod0
  geom_line(data = augment(lm_mod0, newdata = mutate(data.frame(time = 0:25), age = time + 5)),
            aes(x = age, y = exp(.fitted)),
            color = "red", size = 1, inherit.aes = FALSE) + 
  
  # age, slope only, starting at 1. 
  geom_line(data = augment(lm(log(proportion) ~ 0 + age, data = dat), 
                           newdata = mutate(data.frame(time = 0:25), age = time + 5)),
            aes(x = age, y = exp(.fitted)),
            color = "blue", size = 1, inherit.aes = FALSE)
  



# or...
ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() +
  geom_line(data = augment(lm_mod, newdata = mutate(data.frame(time = 0:25), age = time + 5)),
            aes(x = age, y = exp(.fitted)),
            color = "green", size = 1, inherit.aes = FALSE) + 
  
  # add fitted values, exponentiated
  geom_line(data = augment(lm_mod0, newdata = mutate(data.frame(time = 0:25), age = time + 5)),
            aes(x = age, y = exp(.fitted)),
            color = "red", size = 1, inherit.aes = FALSE) + 
  scale_color_distiller(palette = "Greens")





```


```{r lm-log2}
# log2

lm_mod_log2 <- lm(log(proportion) ~ log(age), data = dat)
summary(lm_mod)
summary(lm_mod_cohort)
summary(lm_mod_log2)


# log-log plot
ggplot(data = dat, mapping = aes(x = log(age), y = log(proportion), group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens")

ggplot(data = dat, mapping = aes(x = log(time + 1), y = log(proportion), group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  geom_smooth(method = "lm", se = 0)



plot_grid(ggplot(data = dat, mapping = aes(x = log(age), y = log(proportion), group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  geom_smooth(method = "lm", se = 0, formula = y ~ x),
  ggplot(data = dat, mapping = aes(x = log(time + 1), y = log(proportion), group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  geom_smooth(method = "lm", se = 0, formula = y ~ 0 + x))


ggplot(data = dat, 
       mapping = aes(x = time + 1, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() +
  scale_color_distiller(palette = "Greens") + 
  coord_trans(y = "log", x = "log") + 
  geom_smooth(method = "lm", se = 0)




ggplot(data = dat, mapping = aes(x = log(age), y = log(proportion), group = year_abn, color = year_abn)) + 
  geom_point() +
  # add fitted values, exponentiated
  # geom_line(data = augment(lm_mod, newdata = data.frame(age = 5:30)),
  #           aes(x = age, y = exp(.fitted)),
  #           color = "red", size = 1, inherit.aes = FALSE) +
  # geom_line(data = mutate(augment(lm_mod_cohort), year_abn = as.numeric(levels(cohort))[cohort]),
  #           aes(x = age, y = exp(.fitted))) + 
  scale_color_distiller(palette = "Greens") + 
  geom_smooth(method = "lm", se = 0, aes(x = log(age), y = log(proportion)), inherit.aes = FALSE)



ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  theme_classic() + 
  labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land: Shaanxi Province",
       subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + 
  theme(legend.position = "bottom",
        legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  scale_x_continuous(n.breaks = 10) +
  
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black", size = 0.75) + 
  geom_point(data = dat) +
  
  geom_line(data = augment(lm_mod_log2, newdata = data.frame(age = 5:30)),
            aes(x = age, y = exp(.fitted)),
            color = gg_colors[5], size = 1.5, inherit.aes = FALSE) + 
  geom_vline(xintercept = (0.5/exp(coef(lm_mod_log2)[1]))^(1/coef(lm_mod_log2)[2]), 
             color = gg_colors[5]) + 
  annotate("text", fontface = "italic", angle = 90, size = 3.5,
           x = cc_half_life(lm_mod_log2, fixed_effect = "time") + 5, 
           y = 0.85, label = paste0(
             "lm_mod0: \n", 
             round((0.5/exp(coef(lm_mod_log2)[1]))^(1/coef(lm_mod_log2)[2]), 2), 
             " years")) + 
  geom_function(fun = function(x) { x^(coef(lm_mod_log2)[2])*exp(coef(lm_mod_log2)[1])},
                color = gg_colors[5], size = 1, linetype = "dashed", inherit.aes = FALSE)
  


# log - log, with intercept 0
lm_mod_log2_0 <- lm(log(proportion) ~ 0 + log(time + 1), data = dat)

ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(title = "log(proportion) ~ 0 + log(time + 1):cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1), data = dat))),
            aes(x = exp(`log(time + 1)`) + 4, y = exp(.fitted)), inherit.aes = FALSE) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))



```



```{r lm-cohort}

# add cohort as a fixed effect predictor variable. This is analogous to a parallel slopes lm, where cohort just changes the intercept coefficient, and age has the same role across all

lm_mod
lm_mod_cohort_int <- lm(log(proportion) ~ time + cohort - 1, data = dat) # parallel slopes, unique intercepts
lm_mod_cohort_slope <- lm(log(proportion) ~ time + time:cohort, data = dat) # single intercept, unique slopes

lm_mod_cohort_slope0 <- lm(log(proportion) ~ 0 + time:cohort, data = dat) # no global intercept (i.e. 1), unique slopes

lm_mod_cohort_x <- lm(log(proportion) ~ time * cohort - 1, data = dat) # allowing for all cohorts to have individual intercepts and slopes with age

lm_mod_cohort

coef(lm_mod_cohort)
summary(lm_mod_cohort)
tidy(lm_mod_cohort, conf.int = TRUE) 
augment(lm_mod_cohort)
coef(lm_mod_cohort)


ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 

  # lm_mod_cohort_slope0
  geom_line(data = mutate(augment(lm_mod_cohort_slope0), 
                          year_abn = as.numeric(levels(cohort))[cohort], 
                          age = time + 5),
            aes(x = age, y = exp(.fitted))) + 
  
  # geom_function(fun = function(x) {exp( mean(coef(lm_mod_cohort_slope0), na.rm = TRUE)*x)},
  #               color = "blue", size = 1, linetype = "solid", inherit.aes = FALSE)
  
  geom_function(fun = function(x) {exp( mean(coef(lm_mod_cohort_slope0), na.rm = TRUE)* (x - 5))},
                color = "blue", size = 1, linetype = "solid", inherit.aes = FALSE)


# plot
ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 

  # lm_mod
  # geom_line(data = augment(lm_mod, newdata = data.frame(age = 5:30)),
  #           aes(x = age, y = exp(.fitted)),
  #           color = "red", size = 1, inherit.aes = FALSE) +

  # lm_mod_cohort_slope0
  geom_line(data = mutate(augment(lm_mod_cohort_slope0), 
                          year_abn = as.numeric(levels(cohort))[cohort], 
                          age = time + 5),
            aes(x = age, y = exp(.fitted))) + 
  
  # geom_function(fun = function(x) {exp( mean(coef(lm_mod_cohort_slope0), na.rm = TRUE)*x)},
  #               color = "blue", size = 1, linetype = "solid", inherit.aes = FALSE)
  
  geom_function(fun = function(x) {exp( mean(coef(lm_mod_cohort_slope0), na.rm = TRUE)* (x - 5))},
                color = "blue", size = 1, linetype = "solid", inherit.aes = FALSE) + 
  geom_vline(xintercept = 26.26429)

  
  # add individual cohort curves
  # geom_function(fun = function(x) {exp(coef(lm_mod_cohort)["age"]*x + 
  #                                       coef(lm_mod_cohort)["cohort1988"])},
  #               color = "blue", size = 1, linetype = "solid", inherit.aes = FALSE) +
  # geom_function(fun = function(x) {exp(coef(lm_mod_cohort)["age"]*x + 
  #                                       coef(lm_mod_cohort)["cohort2010"])},
  #               color = "orange", size = 1, linetype = "solid", inherit.aes = FALSE)
  



          
p1 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  
  labs(title = "log(proportion) ~ time + cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ time + cohort, data = dat)),
                          year_abn = as.numeric(levels(cohort))[cohort], age = time + 5),
            aes(x = age, y = exp(.fitted)))

p2 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  
  labs(title = "log(proportion) ~ time + time:cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ time + time:cohort, data = dat)),
                          year_abn = as.numeric(levels(cohort))[cohort], age = time + 5),
            aes(x = age, y = exp(.fitted)))

p3 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 

  labs(title = "log(proportion) ~ cohort + time:cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ cohort + time:cohort, data = dat)),
                          year_abn = as.numeric(levels(cohort))[cohort], age = time + 5),
            aes(x = age, y = exp(.fitted)))

p4 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 

  labs(title = "log(proportion) ~ time + cohort + time:cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ time + cohort + time:cohort, data = dat)), 
                          year_abn = as.numeric(levels(cohort))[cohort], age = time + 5),
            aes(x = age, y = exp(.fitted)))

p5 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 

  labs(title = "log(proportion) ~ 0 + time:cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + time:cohort, data = dat)), 
                          year_abn = as.numeric(levels(cohort))[cohort], age = time + 5),
            aes(x = age, y = exp(.fitted)))
lm_mod_cohort_slope0

p6 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 

  labs(title = "log(proportion) ~ 0 + log(time + 1):cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1):cohort, 
                                     data = dat)), 
                          year_abn = as.numeric(levels(cohort))[cohort],
                          age = exp(`log(time + 1)`) - 1 + 5),
            aes(x = age, y = exp(.fitted))) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))



lm(log(I(proportion - 1)) ~ log(I(age - 5)):cohort, data = dat)

lm_mod_log2_cohort

dat %>% mutate(time2 = time + 1, 
                log_time2 = log(time2))

lm(log(I(proportion - 1)) ~ log(I(age - 5)):cohort, data = dat)

# newdata = data.frame(age = 5:30, cohort = factor(rep(1988:2013))
# geom_function(fun = function(x) { x^(coef(lm_mod_log2)[2])*exp(coef(lm_mod_log2)[1])},
#                 color = gg_colors[5], size = 1, linetype = "dashed", inherit.aes = FALSE)



# plot_grid
plot_grid(p1, p2, p3, p4, p5, p6)
```

```{r lm-log2-cohort}
# lm_mod_log2_cohort <- lm(log(proportion) ~ 0 + log(age):cohort, data = dat)

lm_mod_log2_cohort <- lm(log(proportion) ~ 0 + log(time + 1):cohort, data = dat)

plot(lm_mod_log2_cohort)
summary(lm_mod_log2_cohort)
tidy(lm_mod_log2_cohort)
glance(lm_mod_log2_cohort)
formula(lm_mod_log2_cohort)
augment(lm_mod_log2_cohort)

# compare time vs. age:
lm(log(proportion) ~ log(time + 1) + cohort + log(time + 1):cohort, data = dat)
lm(log(proportion) ~ log(time + 1):cohort, data = dat)
lm(log(proportion) ~ log(age):cohort, data = dat)
lm(log(proportion) ~ log(time + 1):cohort, data = dat)
lm(log(proportion) ~ log(age):cohort, data = dat)



# plot time
ggplot(data = dat, mapping = aes(x = time, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  geom_line(data = mutate(augment(lm_mod_log2_cohort), 
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          proportion = exp(.fitted),
                          year_abn = as.numeric(levels(cohort))[cohort])) + 
  scale_x_continuous(n.breaks = 30) + 
  geom_function(fun = function(x) { (x+1) ^ coef(lm_mod_log2_cohort)[1]},
                size = 1, linetype = "dashed", inherit.aes = FALSE)


# plot with age
ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  #scale_x_continuous(breaks = seq(from = 0, to = 40, by = 5), limits = c(5, 40)) + 
  geom_hline(yintercept = 0.5) + 
  labs(subtitle = "log(proportion) ~ 0 + log(time + 1):cohort") + 
  geom_line(data = mutate(augment(lm_mod_log2_cohort), 
                          year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5,
                          proportion = exp(.fitted))) + 
  
  # average (needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) { (x - 4) ^ (mean(coef(lm_mod_log2_cohort), na.rm = TRUE))},
                color = "blue", size = 1, linetype = "solid", inherit.aes = FALSE) 
  
  geom_line(data = mutate(augment()))
  
  # half-life: cc_half_life(lm_mod_log2_cohort)
  geom_vline(xintercept = cc_half_life(lm_mod_log2_cohort))


# log log scale
ggplot(data = dat, mapping = aes(x = log(time + 1), y = log(proportion), group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  # geom_smooth(method = "lm", se = 0) + 
  # geom_line(data = mutate(augment(lm_mod_log2_cohort), 
  #                         time = round(exp(`log(time + 1)`), digits = 0) - 1,
  #                         proportion = exp(.fitted),
  #                         year_abn = as.numeric(levels(cohort))[cohort]))#,
  #           #aes(x = exp(`log(time + 1)`) - 1 + 5, y = exp(.fitted)))
  
  # alternatively
  geom_line(data = mutate(augment(lm_mod_log2_cohort), 
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          proportion = exp(.fitted),
                          year_abn = as.numeric(levels(cohort))[cohort]))





1 ^ mean(coef(lm_mod_log2_cohort), na.rm = TRUE)
2 ^ mean(coef(lm_mod_log2_cohort), na.rm = TRUE)






# comparison plots:

p1 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  
  labs(title = "log(proportion) ~ time + cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ time + cohort, data = dat)),
                          year_abn = as.numeric(levels(cohort))[cohort], age = time + 5),
            aes(x = age, y = exp(.fitted)))

p7 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  
  labs(title = "log(proportion) ~ time + cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1), data = dat)),
                          # year_abn = as.numeric(levels(cohort))[cohort], 
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          age = time + 5,
                          proportion = exp(.fitted)),
            aes(x = age, y = exp(.fitted)), inherit.aes = FALSE)
```


```{r calculating-mean-coef}
# is the mean coefficient the same as lm without cohort?

pm1 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  
  labs(title = "log(proportion) ~ 0 + log(time + 1)") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1), 
                                     data = filter(dat_l, site == "shaanxi"))),
                          # year_abn = as.numeric(levels(cohort))[cohort], 
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          age = time + 5),
            aes(x = age, y = exp(.fitted)), size = 1, inherit.aes = FALSE)

mean_coef_df[9, 2] %>% as.numeric()

mean(coef(lm_log2_l$shaanxi), na.rm = TRUE)

lm_log2_l$shaanxi
lm(log(proportion) ~ 0 + log(time + 1), 
   data = filter(dat_l, site == "shaanxi"))


plot(lm(log(proportion) ~ 0 + log(time + 1), 
        data = filter(dat_l, site == "shaanxi")))

glance(lm(log(proportion) ~ 0 + log(time + 1), 
          data = filter(dat_l, site == "shaanxi")))

w_mean <- tidy(lm_log2_l$shaanxi) %>% 
  mutate(weight = 26:1) %>% 
  filter(!is.na(estimate)) %>%
  group_by() %>% 
  summarise(weighted_mean = sum(estimate * weight) / sum(weight)) %>%
  as.numeric()

lm(log(proportion) ~ 0 + log(time + 1), 
          data = filter(dat_l, site == "shaanxi"))

dat %>% group_by(cohort) %>% summarise(n = n()) %>% print(n = 30)




# save plot with different approaches:
png(filename = paste0(p_plots, run_label, "/decay/", "mean_coef_alt", run_label, ".png"), 
    width = 7, height = 5, units = "in", res = 400)

pl1 + 
  # mean coefficient
  geom_function(fun = function(x) { (x - 4) ^ mean(coef(lm_mod_log2_cohort), na.rm = TRUE)},
                size = 1, color = "red", linetype = "dashed", inherit.aes = FALSE) + 
  
  # weighted mean of the coefficient
  geom_function(fun = function(x) { (x - 4) ^ w_mean},
                size = 1, color = "red", inherit.aes = FALSE) + 
  
  # lm without cohort fixed effects
  geom_function(fun = function(x) { (x - 4) ^ 
      coef(lm(log(proportion) ~ 0 + log(time + 1), 
              data = filter(dat_l, site == "shaanxi")))},
      size = 1, color = "blue", inherit.aes = FALSE) + 
  
  # mean of the year_abn model
  geom_function(fun = function(x) { (x - 4) ^  
      (coef(lm_mod_log2_year_abn)[1] + coef(lm_mod_log2_year_abn)[2] * mean(1988:2013))},
                size = 1, color = "orange", linetype = "dotted", inherit.aes = FALSE) + 
  
  labs(title = "Alternative methods for calculating site mean decay coefficient") +
  annotate("text", fontface = "bold", x = 26, y = 0.64, label = "mean coef (cohort)", size = 3.5, angle = -8) + 
  annotate("text", fontface = "bold", x = 26, y = 0.69, label = "mean coef (year_abn)", size = 3.5, angle = -8) + 
  annotate("text", fontface = "bold", x = 26, y = 0.60, label = "weighted mean", size = 3.5, angle = -8) + 
  annotate("text", fontface = "bold", x = 27, y = 0.56, label = "lm w/o cohort f.e.", size = 3.5, angle = -8)

dev.off()








# lin-log-lin model coefficients
lm_lin_log_l$belarus

tidy(lm(I(proportion - 1)  ~ 0 + log(time + 1):cohort + I(time):cohort,  
               data = filter(dat_l, #year_abn < 2011, 
                             site == site_df$site[i])), conf.int = TRUE) %>%
  print(n=100)

# what do I do with the p.value? does this allow me to weight the site average model relationship?


names(lm_lin_log_lin_l) <- site_df$site
```

```{r continuous-year-abn}


lm_mega_l3_cont <- lm(I(proportion - 1)  ~ 0 + log(time + 1):site + log(time + 1):year_abn:site + 
                                         I(time):site + I(time):year_abn:site,  
               data = dat_l)

lm(I(proportion - 1)  ~ 0 + log(time + 1) + log(time + 1):year_abn + I(time) + I(time):year_abn,  
               data = dat_l%>% filter(site == "shaanxi")) %>%
  equatiomatic::extract_eq(wrap = TRUE, terms_per_line = 1)

lm_mega_l3_cont

  # plot
  # gg_tmp <-
    ggplot(data = filter(dat_l#, site == site_df$site[9]
                         ), 
                                      mapping = aes(x = age, y = proportion, 
                                                    group = year_abn, color = year_abn)) + 
    theme_classic() + 
    geom_point() + scale_color_distiller(palette = "Greens") + 
    scale_x_continuous(n.breaks = 6) +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
         x = "Time since initial abandonment (years)", 
         y = "Proportion of abandoned land remaining",
         color = "Cohort \n(Year First \nAbandoned)",
         linetype = "") + 
  
    geom_line(data = mutate(augment(lm_mega_l3_cont, se_fit = TRUE),
                            time = round(exp(`log(time + 1)`), digits = 0) - 1,
                            age = time + 5,
                            proportion = .fitted + 1
              )) + 
      facet_wrap(vars(site))



```


## Intuition behind log-log

An exponential decay curve (lon-linear, or semi-log) makes intuitive sense, if we assume that the amount of abandoned land declines by a constant proportion each time step. In this case, the amount at t+1 = the amount at t multiplied by e^(coef) . The log-lin relationship is as follows, lm( log(y) ~ x ):
log(y) = b1 * x + C
assuming no intercept
log(y) = b1 * x
e ^ log(y) =  e ^ (b1 * x)
y = e ^ (b1 * x)


A log-log curve corresponds to a monomial ( y = a * x^k ), where the slope of the log-log line corresponds to k, the power term.
lm( log(y) ~ log(x) ):
log(y) = b1 * log(x) + C
assuming no intercept
log(y) = b1 * log(x)
e ^ log(y) = e ^ ( b1 * log(x) )
y = ( e ^ log(x) ) ^ (b1)
y = x ^ b1

With multiple cohorts, the math works out like this
log(y) = b1 * log(x) * cohort1 + b2 * log(x) * cohort2 + b3 * log(x) * cohort3 + ... + bn * log(x) * cohortn; where n is the number of cohorts (in our case, 26)

e ^ log(y) = e ^ ( b1 * log(x) * cohort1 + b2 * log(x) * cohort2 + b3 * log(x) * cohort3 + ... )
y = e ^ (b1 * log(x) * cohort1) * e ^ (b2 * log(x) * cohort2) * e ^ (b3 * log(x) * cohort3) * e ^ (...)

cohort1, cohort2, etc. are dummy variables that are 1 or 0, depending on whether it is that cohort or not. So, all the other terms reduce to multiplying by e ^ 0 or 1. So, each cohort's curve reduces to:
y = x ^ b1

This means that rather than declining by a constant proportion each time step, as with the exponential decay function (e ^ coef), the decay rate changes as a function of time. The proportional decrease over time is equal to:
y(x+1) / y(x)
(x + 1) ^ b1 / x ^ b1
((x + 1) / x ) ^ b1

So, from t = 4 to t = 5, the amount of abandoned land declines by (5 / 4) ^ b1 
As t gets large, ((t + 1) / t) gets closer and closer to 1. 

```{r log-intuition}
ggplot(data = dat, mapping = aes(x = time, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  geom_line(data = mutate(augment(lm_mod_log2_cohort), 
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          proportion = exp(.fitted),
                          year_abn = as.numeric(levels(cohort))[cohort])) + 
  scale_x_continuous(n.breaks = 30) + 
  geom_function(fun = function(t) {(t + 1) ^ coef(lm_mod_log2_cohort)[1]},
                size = 1, linetype = "dashed", inherit.aes = FALSE)
  


# cohort 1's function:
# y = x ^ b1
coef(lm_mod_log2_cohort)[1]
# y = 1 ^ ()

mutate(augment(lm_mod_log2_cohort), 
       time = round(exp(`log(time + 1)`), digits = 0) - 1,
       proportion = exp(.fitted))




ft <- augment(lm_mod_log2_cohort, 
              newdata = data.frame(time = 0:25, 
                                   cohort = factor(1988))) %>% 
  mutate(y = .fitted + 1)

for (i in 1:26) {print(ft$y[i + 1] / ft$y[i])}

(2/1)^coef(lm_mod_log2_cohort)[1]
(5/4)^coef(lm_mod_log2_cohort)[1]



1 ^ coef(lm_mod_log2_cohort)[1]
2 ^ coef(lm_mod_log2_cohort)[1]
3 ^ coef(lm_mod_log2_cohort)[1]
4 ^ coef(lm_mod_log2_cohort)[1]
5 ^ coef(lm_mod_log2_cohort)[1]

data.frame(time = 1:26) %>% mutate(y = time ^ coef(lm_mod_log2_cohort)[1]) %>% head()



```


```{r cohort-v-year_abn}
# ---- #
# comparing cohort as a categorical variable to year_abn as a continuous variable.
pl0 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(title = "log(proportion) ~ 0 + log(time + 1)") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1), data = dat)), 
                          #year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5
                          ),
            aes(x = age, y = exp(.fitted)), inherit.aes = FALSE) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))

pl1 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(title = "log(proportion) ~ 0 + log(time + 1):cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1):cohort, 
                                     data = mutate(dat, time + 1 = time + 1))), 
                          year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5),
            aes(x = age, y = exp(.fitted))) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))

pl2 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(title = "log(proportion) ~ 0 + log(time + 1):year_abn") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1):year_abn, 
                                     data = dat)), 
                          #year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5),
            aes(x = age, y = exp(.fitted), size = year_abn)) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))

pl3 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(title = "log(proportion) ~ 0 + log(time + 1)*year_abn") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1)*year_abn, 
                                     data = dat)), 
                          #year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5),
            aes(x = age, y = exp(.fitted)), size = 1) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))



# plot_grid
plot_grid(pl0, pl1, pl2, pl3)

lm(log(proportion) ~ 0 + log(time + 1)*year_abn, data = dat) %>% coef()
lm(log(proportion) ~ 0 + log(time + 1):year_abn, data = dat) %>% coef()
lm(log(proportion) ~ 0 + log(time + 1)*year_abn, data = dat) %>% coef()

test1 <- lm(log(proportion) ~ 0 + log(time + 1) + year_abn + log(time + 1):year_abn, data = dat)
test2 <- lm(log(proportion) ~ 0 + log(time + 1) + log(time + 1):year_abn, data = dat)
lm(log(proportion) ~ 0 + year_abn + log(time + 1):year_abn, data = dat) %>% coef()

coef(test1)
coef(test2)

coef(test1)[1] + coef(test1)[3] * 1988
coef(test2)[1] + coef(test2)[2] * 1988



mean(1988:2013) * lm_mod_log2_year_abn


pl4 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(subtitle = "log(proportion) ~ 0 + log(time + 1) + year_abn + log(time + 1):year_abn") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1) + year_abn + log(time + 1):year_abn, 
                                     data = dat)), 
                          #year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5),
            aes(x = age, y = exp(.fitted)), size = 1) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))


# this one doesn't make sense
pl5 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(subtitle = "log(proportion) ~ 0 + year_abn + log(time + 1):year_abn") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + year_abn + log(time + 1):year_abn, 
                                     data = dat)), 
                          #year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5),
            aes(x = age, y = exp(.fitted)), size = 1) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))

# ** if taking the year_abn approach, this specification should be used.
pl6 <- ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(subtitle = "log(proportion) ~ 0 + log(time + 1) + log(time + 1):year_abn") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1) + log(time + 1):year_abn, data = dat)), 
                          #year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5),
            aes(x = age, y = exp(.fitted)), size = 1) + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))



# comparing the two
ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(subtitle = "log(proportion) ~ 0 + log(time + 1) + year_abn + log(time + 1):year_abn") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1) + year_abn + log(time + 1):year_abn, 
                                     data = dat)), 
                          #year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5),
            aes(x = age, y = exp(.fitted)), size = 1, color = "red") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1) + log(time + 1):year_abn, 
                                     data = dat)), 
                          #year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5),
            aes(x = age, y = exp(.fitted)), size = 1, color = "blue") + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))


# plot_grid
plot_grid(pl3, pl4, pl5, pl6)



# ---------------------- run model, and compare AIC --------------------------------------- #
lm_mod_log2_cohort
lm_mod_log2_year_abn <- lm(log(proportion) ~ 0 + log(time + 1) + log(time + 1):year_abn, data = dat)

glance(lm_mod_log2_cohort) %>% select(AIC)
glance(lm_mod_log2_year_abn) %>% select(AIC) 
# conclusion: allowing the coefficients to vary between cohorts as categorical variables, rather than as continuous variables, improves the model fit dramatically.


lm(log(proportion) ~ 0 + log(time + 1) + log(time + 1):year_abn, data = dat)


ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  # lm_mod_log2_cohort
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1):cohort, 
                                     data = dat)), 
                          year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5),
            aes(x = age, y = exp(.fitted)), size = 1, color = "red") + 
  
  # with year_abn, even spacing between cohorts.
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1) + log(time + 1):year_abn, 
                                     data = dat)), 
                          #year_abn = as.numeric(levels(cohort))[cohort],
                          age = round(exp(`log(time + 1)`), digits = 0) - 1 + 5),
            aes(x = age, y = exp(.fitted)), size = 1, color = "blue") + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))

```

```{r save-log2-cohort-shaanxi-plots}

# ----------------------- log-log cohort plot ----------------------- #

gg_log2_cohort <- ggplot(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = dat) + scale_color_distiller(palette = "Greens") + 
  scale_x_continuous(n.breaks = 30) + 
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(title = "Decay of abandoned land over time", subtitle = site_df$description[indx], caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
       x = "Time since initial abandonment (years)", y = "Proportion of abandoned land remaining",
       color = "Cohort (Year \nFirst Abandoned)") + 
  geom_line(data = mutate(augment(lm_mod_log2_cohort, newdata = dat0),
                          proportion = exp(.fitted))) + 
  
  # average (needs to be transformed 4 to the right, so that plotting works)
  geom_function(fun = function(x) { (x-4) ^ (mean(coef(lm_mod_log2_cohort), na.rm = TRUE))},
                mapping = aes(linetype = "Mean Decay Rate"),
                color = "blue", size = 1, #linetype = "dashed", 
                inherit.aes = FALSE) + 
  scale_linetype(name = "")


# save the plot
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort", run_label, "_s.png"), 
    width = 8, height = 6, units = "in", res = 400)
print(gg_log2_cohort)
dev.off()



# ----------------------- diagnostics plot ----------------------- #
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_diag", run_label, "_s.png"), 
    width = 8, height = 8, units = "in", res = 400)
par(mfrow = c(2,2))
plot(lm_mod_log2_cohort)
dev.off()



# ----------------------- log-log cohort residuals plot ----------------------- #


```


```{r add-initial-area-abn}
lm_mod_log2_cohort_area <- lm(log(proportion) ~ 0 + log(time + 1):cohort:initial_area_abn, data = dat)

summary(lm_mod_log2_cohort_area)
tidy(lm_mod_log2_cohort_area)
glance(lm_mod_log2_cohort_area)
glance(lm_mod_log2_cohort)

ggplot(data = dat, mapping = aes(x = time, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(title = "log(proportion) ~ time + cohort") + 
  geom_line(data = mutate(augment(lm(log(proportion) ~ 0 + log(time + 1):cohort, data = dat)),
                          year_abn = as.numeric(levels(cohort))[cohort], 
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          proportion = exp(.fitted)))

ggplot(data = dat, mapping = aes(x = time + 1, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(title = "log(proportion) ~ time + cohort") + 
  geom_line(data = augment(lm(log(proportion) ~ 0 + log(time + 1)*cohort:initial_area_abn, data = dat), 
                           newdata = dat0, interval = "confidence") %>%
              mutate(proportion = exp(.fitted), lower = exp(.lower), upper = exp(.upper)))


# plot time + 1
ggplot(data = dat, mapping = aes(x = time + 1, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  geom_line(data = mutate(augment(lm_mod_log2_cohort), 
                          time = round(exp(`log(time + 1)`), digits = 0) - 1,
                          proportion = exp(.fitted),
                          year_abn = as.numeric(levels(cohort))[cohort])) + 
  scale_x_continuous(n.breaks = 30) + 
  geom_function(fun = function(x) { x ^ coef(lm_mod_log2_cohort)[1]},
                size = 1, linetype = "dashed", inherit.aes = FALSE)


ggplot(data = dat, mapping = aes(x = cohort, y = initial_area_abn)) + geom_point()

# compare different specifications:
pa1 <- ggplot(data = dat, mapping = aes(x = time + 1, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(subtitle = "log(proportion) ~ 0 + log(time + 1):cohort:initial_area_abn") + 
  geom_line(data = augment(lm(log(proportion) ~ 0 + log(time + 1):cohort:initial_area_abn, data = dat), 
                           newdata = dat0, interval = "confidence") %>%
              mutate(proportion = exp(.fitted), lower = exp(.lower), upper = exp(.upper)))

pa2 <- ggplot(data = dat, mapping = aes(x = time + 1, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(subtitle = "log(proportion) ~ 0 + log(time + 1):initial_area_abn") + 
  geom_line(data = augment(lm(log(proportion) ~ 0 + log(time + 1):initial_area_abn, data = dat), 
                           newdata = dat0, interval = "confidence") %>%
              mutate(proportion = exp(.fitted), lower = exp(.lower), upper = exp(.upper)))

pa3 <- ggplot(data = dat, mapping = aes(x = time + 1, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  labs(subtitle = "log(proportion) ~ 0 + log(time + 1):cohort*initial_area_abn") + 
  geom_line(data = augment(lm(log(proportion) ~ 0 + log(time + 1):cohort*initial_area_abn, data = dat), 
                           newdata = dat0, interval = "confidence") %>%
              mutate(proportion = exp(.fitted), lower = exp(.lower), upper = exp(.upper)))



plot_grid(pl1, pa1, pa2, pa3)

augment(lm(log(proportion) ~ 0 + log(time + 1):cohort, data = filter(dat, cohort %in% c(1988:2012))), 
        newdata = filter(dat0, cohort %in% c(1988:2012)), interval = "confidence") %>%
  mutate(proportion = exp(.fitted))


dat %>% arrange(desc(year_abn))


ggplot(data = dat, mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point() + scale_color_distiller(palette = "Greens") + 
  # lm_mod_log2_cohort
  geom_line(data = augment(lm(log(proportion) ~ 0 + log(time + 1):cohort, data = dat), 
                           newdata = dat0, interval = "confidence") %>%
              mutate(proportion = exp(.fitted)), 
            size = 1, color = "red") + 
  
  # 
  geom_line(data = augment(lm(log(proportion) ~ 0 + log(time + 1):initial_area_abn, data = dat), 
                           newdata = dat0, interval = "confidence") %>%
              mutate(proportion = exp(.fitted)), 
            color = "blue") + 
  scale_x_continuous(breaks = seq(from = 0, to = 30, by = 5))


coef(lm(log(proportion) ~ 0 + log(time + 1):cohort + log(time + 1):cohort:initial_area_abn, data = dat))
coef(lm(log(proportion) ~ 0 + log(time + 1):cohort, data = dat))
coef(lm(log(proportion) ~ 0 + log(time + 1):initial_area_abn + log(time + 1):cohort, data = dat))

coef(lm(log(proportion) ~ 0 + log(time + 1):initial_area_abn, data = dat))


```


```{r lmer}
# Since each cohort of abandoned land represents a particular group, with related values, I will model each cohort as a random effect, with random intercept and random slopes

# here's how the lmer call will work:


# lmer_mod <- lmer(
#   log(proportion) ~  # response variable
#        age + # fixed effect (i.e. what we're curious about)
#        (1 + age|cohort), # random effects (modeling coefficients as random values drawn from a common error distribution, i.e. essentially random differences that we want to control for). 
#      # The 1 represents the random intercept, meaning that the initial starting point can vary for each cohort (year_abn). If this was all we wanted, but with the same relationship to age for each cohort, we'd just have (1|year_abn)
#      # The "age|year_abn" term represents the random slopes, meaning that the relationship between proportion and age (the slope/coefficient) is allowed to vary across the cohorts.
#      data = dat) 

# random slopes, constant intercept

lmer_mod_slope <- lmer(log(proportion) ~ age + (0 + age|cohort), data = dat)
lmer(log(proportion) ~ age + (0 + age|cohort), data = dat) %>% coef()


# random slopes and random intercepts
lmer_mod_slope_int <- lmer(log(proportion) ~ age + (1 + age|cohort), data = dat) # or age + (age|cohort)
lmer(log(proportion) ~ age + (1 + age|cohort), data = dat) %>% coef()


# just random intercepts would look like this
lmer_mod_int <- lmer(log(proportion) ~ age + (1|cohort), data = dat)
lmer(log(proportion) ~ age + (1|cohort), data = dat) %>% coef()




# -------------------------- lmer offset ---------------------------------------- #
# lmer offset: random slopes, but only slope, i.e. no global intercept (so that the intercept is forced to be 1).
# this is the one I intend to use.
lmer_mod_slope0 <- lmer(log(proportion) ~ 0 + time + (0 + time|cohort), data = dat)
# ---------------------------------------------------------------------------- #





lmer_mod_slope
lmer_mod_slope_int
lmer_mod_int
lmer_mod_slope0

augment(lmer_mod_slope0)
fixef(lmer_mod_slope0)*1
exp(fixef(lmer_mod_slope0)*0)

coef(lmer_mod_slope0)
ranef(lmer_mod_slope0)$cohort
fixef(lmer_mod_slope0)

-0.03543644 + ranef(lmer_mod_slope0)$cohort[1:6, ]
head(coef(lmer_mod_slope0)$cohort)

dev.off()

# plot lmers


cc_half_life(lmer_mod_slope0, fixed_effect = "time") + 5
cc_half_life(lmer_mod_slope)
cc_half_life(lmer_mod_slope_int)


ggplot(data = augment(lmer_mod_slope0) %>% mutate(year_abn = as.numeric(levels(cohort))[cohort],
                                                       age = time + 5),
       mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn)) + 
  geom_point(data = dat) +
  geom_line(aes(y = exp(.fitted)), size = 1) + 
  geom_line(aes(y = exp(.fixed)), size = 1.5, color = "red") + 
  geom_vline(xintercept = cc_half_life(lmer_mod_slope0, fixed_effect = "time") + 5) + 
  
  # add fitted values, exponentiated
  geom_line(data = augment(lm_mod0, newdata = mutate(data.frame(time = 0:25), age = time + 5)),
            aes(x = age, y = exp(.fitted)),
            color = "blue", size = 1.5, inherit.aes = FALSE) + 
  
  scale_color_distiller(palette = "Greens") + 
  
  geom_line(data = augment(lmer_mod_slope) %>% mutate(year_abn = as.numeric(levels(cohort))[cohort]),
            aes(x = age, y = exp(.fixed), group = ), size = 1, color = "pink") +
  
  geom_hline(yintercept = 0.5)


# 




ggplot(data = data.frame(ranef(lmer_mod_slope0)$cohort)) + geom_histogram(aes(x = time))












# old crud


lmer_mod1 # (1 + age|year_abn)
lmer_mod # (0 + age|year_abn)

?isSingular
isSingular(lmer_mod) # FALSE
isSingular(lmer_mod1) # TRUE
summary(lmer_mod)
lmer_mod_coef <- tidy(lmer_mod)
lmer_mod_confint <- confint(lmer_mod) %>%
  as_tibble(rownames = "term_conf") %>%
  rename(lower = "2.5 %",
         upper = "97.5 %")

lmer_mod_coef %>% arrange(desc(effect))
lmer_mod_confint


lmer_mod_coef <- bind_cols(lmer_mod_coef %>% arrange(desc(effect)), lmer_mod_confint)


lmer_mod1_coef <- tidy(lmer_mod1)
lmer_mod1_confint <- confint(lmer_mod1) %>%
  as_tibble(rownames = "term_conf") %>%
  rename(lower = "2.5 %",
         upper = "97.5 %")

lmer_mod1_coef <- bind_cols(lmer_mod1_coef %>% arrange(desc(effect)),
                            lmer_mod1_confint)




summary(lmer_mod1)
coef(lmer_mod)
fixef(lmer_mod)
broom.mixed::tidy(lmer_mod)
test <- tidy(lmer_mod) %>% 
  mutate(lower = estimate - 1.96*std.error,
         upper = estimate + 1.96*std.error)

test[which(test$term == "age"), "estimate"]
test[which(test$term == "age"), "lower"] %>% unlist()
test[which(test$term == "age"), "upper"] %>% unlist()


confint(lmer_mod1)
tidy(lmer_mod1)


lmer_mod_coef
lmer_mod_coef[which(lmer_mod_coef$term == "(Intercept)"), "estimate"]
filter(lmer_mod_coef, term == "(Intercept)")$estimate

fixef(lmer_mod)
(log(0.5) - fixef(lmer_mod)["(Intercept)"])/(fixef(lmer_mod)["age"]) # (log(0.5) - int)/coeff = 30.25
(log(0.5) - fixef(lmer_mod1)["(Intercept)"])/(fixef(lmer_mod1)["age"]) # (log(0.5) - int)/coeff = 30.25

(log(0.5) - filter(lmer_mod_coef, term == "(Intercept)")$estimate) / 
  (filter(lmer_mod_coef, term == "age")$estimate) # (log(0.5) - int)/coeff = 30.25
(log(0.5) - filter(lmer_mod1_coef, term == "(Intercept)")$estimate) / 
  (filter(lmer_mod1_coef, term == "age")$estimate) # (log(0.5) - int)/coeff = 30.25



predict(lmer_mod)


plot(lmer_mod)
plot(lmer_mod1)
initial_area_abn

```

```{r plot-lmers}

show_col(hue_pal()(5))
gg_colors <- hue_pal()(5)
gg_colors[2]

gg_lmer_comparison <- 
  ggplot(data = mutate(augment(lmer_mod_slope0), 
                       year_abn = as.numeric(levels(cohort))[cohort],
                       age = time + 5),
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
  theme_classic() + 
  labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land: Shaanxi Province",
       subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + 
  theme(legend.position = "bottom",
        legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  scale_x_continuous(n.breaks = 10) +
  
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black", size = 0.75) + 
  geom_point(data = dat) + geom_line(data = dat, size = 1, alpha = 0.25) +
  #geom_line(aes(y = exp(.fitted)), size = 1) + 
  
  
  # lmer_mod_slope0
  geom_line(aes(y = exp(.fixed)), size = 1.5, color = gg_colors[1]) + 
  geom_vline(xintercept = cc_half_life(lmer_mod_slope0, fixed_effect = "time") + 5,
             color = gg_colors[1]) + 
  annotate("text", fontface = "bold", angle = 90, size = 3.5,
           x = cc_half_life(lmer_mod_slope0, fixed_effect = "time") + 5, 
           y = 0.95, label = paste0(
             "lmer_mod_slope0: \n", 
             round(cc_half_life(lmer_mod_slope0, fixed_effect = "time") + 5, 2), 
             " years")) + 

  # lmer_mod_slope
  geom_line(data = augment(lmer_mod_slope) %>% mutate(year_abn = as.numeric(levels(cohort))[cohort]),
            aes(y = exp(.fixed)), size = 1.5, color = gg_colors[2]) + 
  geom_vline(xintercept = cc_half_life(lmer_mod_slope), color = gg_colors[2]) + 
  annotate("text", fontface = "italic", angle = 90, size = 3.5,
           x = cc_half_life(lmer_mod_slope), 
           y = 0.85, label = paste0(
             "lmer_mod_slope: \n", 
             round(cc_half_life(lmer_mod_slope), 2), 
             " years")) + 
  
  # lmer_mod_slope_int
  geom_line(data = augment(lmer_mod_slope_int) %>% mutate(year_abn = as.numeric(levels(cohort))[cohort]),
            aes(y = exp(.fixed)), size = 1.5, color = gg_colors[3]) + 
  geom_vline(xintercept = cc_half_life(lmer_mod_slope_int), color = gg_colors[3]) + 
  annotate("text", fontface = "italic", angle = 90, size = 3.5,
           x = cc_half_life(lmer_mod_slope_int), 
           y = 0.85, label = paste0(
             "lmer_mod_slope_int: \n", 
             round(cc_half_life(lmer_mod_slope_int), 2), 
             " years")) + 
  
  # lm_mod0
  geom_line(data = augment(lm_mod0, newdata = mutate(data.frame(time = 0:25), age = time + 5)),
            aes(x = age, y = exp(.fitted)),
            color = gg_colors[4], size = 1.5, inherit.aes = FALSE) + 
  geom_vline(xintercept = cc_half_life(lm_mod0, fixed_effect = "time") + 5, color = gg_colors[4]) + 
  annotate("text", fontface = "italic", angle = 90, size = 3.5,
           x = cc_half_life(lm_mod0, fixed_effect = "time") + 5, 
           y = 0.85, label = paste0(
             "lm_mod0: \n", 
             round(cc_half_life(lm_mod0, fixed_effect = "time") + 5, 2), 
             " years")) + 
  
  
  # log log
  geom_line(data = augment(lm_mod_log2, newdata = data.frame(age = 5:30)),
            aes(x = age, y = exp(.fitted)),
            color = gg_colors[5], size = 1.5, inherit.aes = FALSE) + 
  geom_vline(xintercept = (0.5/exp(coef(lm_mod_log2)[1]))^(1/coef(lm_mod_log2)[2]), 
             color = gg_colors[5]) + 
  annotate("text", fontface = "italic", angle = 90, size = 3.5,
           x = (0.5/exp(coef(lm_mod_log2)[1]))^(1/coef(lm_mod_log2)[2]), 
           y = 0.75, label = paste0(
             "lm_mod_log2: \n", 
             round((0.5/exp(coef(lm_mod_log2)[1]))^(1/coef(lm_mod_log2)[2]), 2), 
             " years"))
  # geom_function(fun = function(x) { x^(coef(lm_mod_log2)[2])*exp(coef(lm_mod_log2)[1])},
  #               color = gg_colors[5], size = 1, linetype = "dashed", inherit.aes = FALSE)


gg_lmer_comparison

gg_lmer_comparison + geom_function(fun = function(x) {exp( mean(coef(lm_mod_cohort_slope0), na.rm = TRUE)* (x - 5))},
                color = "blue", size = 1, linetype = "solid", inherit.aes = FALSE)

# save
png(filename = paste0(p_plots, run_label, "/decay/", "lmer_comparison", run_label, "_s.png"), 
    width = 8, height = 6, units = "in", res = 400)
print(gg_lmer_comparison)
dev.off()


gg_lmer_slope0


gg_lmer_slope0 <- ggplot(data = mutate(augment(lmer_mod_slope0), 
                       year_abn = as.numeric(levels(cohort))[cohort],
                       age = time + 5),
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn)) + 
  theme_classic() + 
  labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land: Shaanxi Province",
       subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + 
  theme(legend.position = "bottom",
        legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  scale_x_continuous(n.breaks = 10) +
  
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "black", size = 0.75) + 
  geom_line(aes(y = exp(.fixed)), size = 1.5, color = gg_colors[1]) + 

  
  geom_point(data = dat) + geom_line(data = dat, size = 1, alpha = 0.25) +
  geom_line(aes(y = exp(.fitted)), size = 1) + 
  
  
  # lmer_mod_slope0
  geom_vline(xintercept = cc_half_life(lmer_mod_slope0, fixed_effect = "time") + 5,
             color = gg_colors[1]) + 
  annotate("text", fontface = "italic", angle = 90, size = 3.5,
           x = cc_half_life(lmer_mod_slope0, fixed_effect = "time") + 5, 
           y = 0.85, label = paste0(
             "lmer_mod_slope0: \n", 
             round(cc_half_life(lmer_mod_slope0, fixed_effect = "time") + 5, 2), 
             " years"))



# save
png(filename = paste0(p_plots, run_label, "/decay/", "lmer_slope0", run_label, "_s.png"), 
    width = 7, height = 6, units = "in", res = 400)
print(gg_lmer_slope0)
dev.off()

gg_lmer_comparison
gg_lmer_slope0
```

```{r lmer-area}
# --------------------------------------------------------- #
# start with basic lm
# log(proportion) ~ age + initial_area_abn
# --------------------------------------------------------- #
lm_area_p <- lm(log(proportion) ~ age + initial_area_abn, data = dat)

summary(lm_area_p)
plot(lm_area)
coef(lm_area)
tidy(lm_area)
augment(lm_area)
summary(dat$initial_area_abn)
exp(0.5063)


plot_base <- ggplot(data = persistence_list_b1_s$na_first) + 
  theme_classic() + 
  geom_line(mapping = aes(x = age, y = proportion, 
                          group = year_abn, color = year_abn), 
            size = 1) + 
 labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land: Shaanxi Province",
       subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
  theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_hline(yintercept = 0.5, linetype="dashed", 
             color = "black", size = 0.75)

# initial_area_abn
ggplot(data = dat) + 
  theme_classic() + 
  geom_line(mapping = aes(x = age, y = proportion, 
                          group = year_abn, 
                          color = year_abn), 
            size = 1) + 
 labs(y = "Proportion remaining abandoned", x = "Years since initial abandonment") + 
  scale_color_distiller(palette = "Greens") + 
  geom_point(data = dat %>% mutate(prediction = exp(predict(lm_area_p))),
             mapping = aes(x = age, y = prediction), alpha = 0.5)


# trying cut to make bins
ggplot(data = dat,
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = cut(year_abn, breaks = 5))) + 
  theme_classic() + 
  geom_line() + 
  labs(y = "Proportion remaining abandoned", x = "Years since initial abandonment")

ggplot(data = dat %>% mutate(year_abn =
                               as.numeric(levels(year_abn))[year_abn]),
       mapping = aes(x = age, y = proportion, 
                     group = year_abn, color = year_abn_bins)) + 
  theme_classic() + 
  geom_line() + 
  labs(y = "Proportion remaining abandoned", x = "Years since initial abandonment")

#plot relationship between initial area abandoned and the year abandoned
ggplot(data = dat %>% 
         filter(proportion == 1) %>% 
         mutate(year_abn = as.numeric(levels(year_abn))[year_abn]), 
       mapping = aes(x = year_abn, y = initial_area_abn)) + 
  theme_classic() +
  geom_point() + 
  geom_smooth(method = "lm", formula = y ~ x, mapping = aes(x = year_abn, y = initial_area_abn))



# --------------------------------------------------------- #
# now, 
# log(proportion) ~ age + initial_area_abn
# --------------------------------------------------------- #

lm_area <- lm(log(area_ha) ~ age, data = dat)
summary(lm_area)
plot(lm_area)

ggplot(data = dat %>% mutate(year_abn =
                               as.numeric(levels(year_abn))[year_abn])) + 
  theme_classic() + 
  geom_line(mapping = aes(x = age, y = proportion, 
                          group = year_abn, 
                          color = year_abn), 
            size = 1) + 
 labs(y = "Proportion remaining abandoned", x = "Years since initial abandonment") + 
  scale_color_distiller(palette = "Greens") + 
  geom_point(data = dat %>% mutate(prediction = exp(predict(lm_area_p))),
             mapping = aes(x = age, y = prediction), alpha = 0.5)


hist(dat$proportion)
ggplot(data = dat, mapping = aes(x = log(proportion))) + 
  geom_histogram(binwidth = 0.015)
  






# add to basic lmer, proportions
str(dat)
lmer_mod2 <- lmer(log(proportion) ~ 
       age + initial_area_abn + # fixed effect (i.e. what we're curious about)
       (1 + age|year_abn), # random effects (random intercept, and random slopes)
     data = dat)
summary(lmer_mod2)






lmer_mod_area <- lmer(log(area_ha) ~ 
       age + # fixed effect (i.e. what we're curious about). Do I include a term for initial_area_abn?
       (1 + age|year_abn), # random effects (random intercept, and random slopes)
       data = dat)

# the initial_area_abn should be correlated with each cohort (year_abn), so I'm not sure I need to include it. Better ask Alex about this.

lmer(log(area_ha) ~ age + (1 + initial_area_abn|year_abn), data = persistence_list_b1_s$na_first)
# pull out the initial area abn...^^^

summary(lmer_mod_area)
tidy(lmer_mod_area)


# plot results --------------------------------------------------- #

plot_base <- ggplot(data = persistence_list_b1_s$na_first) + 
  theme_classic() + 
  geom_line(mapping = aes(x = age, y = proportion, 
                          group = year_abn, color = year_abn), 
            size = 1) + 
 labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land: Shaanxi Province",
       subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
  theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_hline(yintercept = 0.5, linetype="dashed", 
             color = "black", size = 0.75)

plot_base +
  
  # lmer_mod
  stat_function(fun = function(x) {exp(filter(lmer_mod_coef, term == "age")$estimate*x + 
                                        filter(lmer_mod_coef, term == "(Intercept)")$estimate)},
                color = gg_colors[2], size = 1, linetype = "solid") + 
  geom_ribbon(data = mutate(data.frame(x = 5:35),
                            lower = exp(filter(lmer_mod_coef, term == "age")$lower*x +
                                          filter(lmer_mod_coef, term == "(Intercept)")$lower),
                            upper = exp(filter(lmer_mod_coef, term == "age")$upper*x +
                                          filter(lmer_mod_coef, term == "(Intercept)")$upper)),
              mapping = aes(ymin = lower, ymax = upper, x = x),
              fill = gg_colors[2], alpha = 0.1, color = gg_colors[2], linetype = "dashed") +
  annotate("text", fontface = "italic", angle = 90,
           x = ((log(0.5) - filter(lmer_mod_coef, term == "(Intercept)")$estimate) /     
                      (filter(lmer_mod_coef, term == "age")$estimate)), 
           y = 0.85, label = "lmer (random slopes): \n34.35 years", size = 3.5) + 
  geom_vline(xintercept = 
               ((log(0.5) - filter(lmer_mod_coef, term == "(Intercept)")$estimate) /     
                  (filter(lmer_mod_coef, term == "age")$estimate)), 
             color = gg_colors[2], linetype = "solid")
    


```

## Old model runs coefficient plots:

### Log-log (log2) coefficient plots

```{r coef-over-time-s}
tidy(lm_mod_log2_cohort) %>%
  mutate(year_abn = 1988:2013)

tidy(lm_mod_log2_cohort, conf.int = TRUE) %>% mutate(year_abn = 1988:2013) %>% print(n = 30)

gg_coef_time_s <- ggplot(data = tidy(lm_mod_log2_cohort, conf.int = TRUE) %>% mutate(year_abn = 1988:2013),
       mapping = aes(x = year_abn, y = estimate)) + 
  theme_classic() +
  geom_point() + 
  geom_errorbar(mapping = aes(ymin = conf.low, ymax = conf.high), width = 0.3) +
  labs(y = "Model Coefficient (Power Term)",
       x = "Cohort (Year of Initial Abandonment)", 
       title = paste0("Model Coefficients: ", site_df$description[indx]),
       subtitle = "log(proportion) ~ 0 + log(time + 1):cohort",
       caption = "Error bars represent 95% confidence interval"
       # fill = "Site"
       ) + 
  theme(#axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none", plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  geom_smooth(method = "lm")


# half lives over time
# y = x ^ coef
# 0.5 = x ^ coef
tidy(lm_mod_log2_cohort, conf.int = TRUE) %>% 
  mutate(hl = 0.5^(1/estimate),
         hl_low = 0.5^(1/conf.low),
         hl_high = 0.5^(1/conf.high),
         p_25 = 20^(estimate)
         )


half_life_df <- mutate(tidy(lm_mod_log2_cohort, conf.int = TRUE), 
                       hl = 0.5^(1/estimate) + 4,
                       hl_low = 0.5^(1/conf.low) + 4,
                       hl_high = 0.5^(1/conf.high) + 4,
                       year_abn = 1988:2013,
                       p_25 = 21^(estimate),
                       p_25_low = 21^(conf.low),
                       p_25_high = 21^(conf.high)
                       )

half_life_df %>% print(n = 30)


gg_prop_at_25_s <- 
  ggplot(data = half_life_df,
       mapping = aes(x = year_abn, y = p_25)) + 
  theme_classic() +
  geom_point() + 
  geom_errorbar(mapping = aes(ymin = p_25_low, ymax = p_25_high), width = 0.3) +
  labs(y = "Proportion remaining after 25 years", x = "Cohort (Year of Initial Abandonment)", 
       title = paste0("Decay rates over time: ", site_df$description[indx]),
       subtitle = "log(proportion) ~ 0 + log(time + 1):cohort",
       caption = "Error bars represent 95% confidence interval") + 
  geom_smooth(method = "lm") +
  # scale_y_continuous(limits = c(0, 250)) +
  theme(plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm"))


gg_half_life_s <- 
  ggplot(data = half_life_df,
       mapping = aes(x = year_abn, y = hl)) + 
  geom_point() + 
  geom_errorbar(mapping = aes(ymin = hl_low, ymax = hl_high), width = 0.3) +
  labs(y = "Half-Life (Years)", x = "Cohort (Year of Initial Abandonment)", 
       title = paste0("Model Coefficients: ", site_df$description[indx]),
       subtitle = "log(proportion) ~ 0 + log(time + 1):cohort",
       caption = "Error bars represent 95% confidence interval") + 
  theme( plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  #geom_smooth(method = "lm") + 
  scale_y_continuous(limits = c(0, 250))



# save
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_coef_time", run_label, "_s.png"), 
    width = 6, height = 5, units = "in", res = 400)
print(gg_coef_time_s)
dev.off()

# save
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_prop_at_25", run_label, "_s.png"), 
    width = 6, height = 5, units = "in", res = 400)
print(gg_prop_at_25_s)
dev.off()


```


```{r coef-all-sites-log2}
# extract coefficients for log-log-cohort model for all sites
coef_df <- lapply(lm_log2_l, FUN = function(x) {
  tidy(x, conf.int = TRUE) %>% 
    mutate(year_abn = as.integer(gsub(".*cohort", "", term)),
           cohort = as.factor(year_abn))
}) %>% bind_rows(.id = "site")

# mean_coef per site
mean_coef_df <- coef_df %>% 
  group_by(site) %>% 
  summarise(mean = mean(estimate, na.rm = TRUE),
            mean_low = mean(conf.low, na.rm = TRUE),
            mean_high = mean(conf.high, na.rm = TRUE)) %>% 
  mutate(term = "coef")

# join to all coef df
coef_df <- left_join(coef_df, 
                     mean_coef_df %>% select(-term),
                     by = "site")


# calculate the proportion remaining at various times, projection
mean_coef_proj <- bind_rows(mean_coef_df, 
                          
                          # age = i + 4 (since i = time + 1 = age - 4)
                          lapply(c(6, 16, 26, 36, 46), FUN = function(x) {
                            mean_coef_df %>%
                              mutate(mean = x^(mean),
                                     mean_low = x^(mean_low),
                                     mean_high = x^(mean_high),
                                     term = paste0("p", x + 4))
                            }))

mean_coef_proj %>% select(term) %>% unique
```


```{r plot-coef-all-sites}
# plot all coefficients
ggplot(data = coef_df %>% filter(),
       mapping = aes(x = year_abn, y = estimate, group = site, color = site)) + 
  theme_classic() +
  geom_point(position = position_jitter()) + 
  #geom_errorbar(mapping = aes(ymin = conf.low, ymax = conf.high), width = 0.3) +
  labs(y = "Model Coefficient (Power Term)",
       x = "Cohort (Year of Initial Abandonment)", 
       title = "Model Coefficients",
       subtitle = "log(proportion) ~ 0 + log(time + 1):cohort",
       caption = "Error bars represent 95% confidence interval",
       color = "Site") + 
  theme(#axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "bottom",
        plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  geom_smooth(method = "lm", se = FALSE) # + 
  # plot line manually
  # geom_abline(slope = 8.812e-04 - 5.977038e-03, intercept = 1.004106e+01)


# with quadrants:
gg_log2_cohort_coef_all <- 
  ggplot(data = coef_df %>% 
           arrange(mean) %>%
           mutate(site_reorder = rep(1:11, each = 26),
                  cluster = cut(site_reorder, breaks = c(1, 3, 6, 9, 11),
                                labels = c("a", "b", "c", "d"), 
                                include.lowest = TRUE),
                  mean_coef = cut(mean, breaks = 4)),
         mapping = aes(x = year_abn, y = estimate, color = fct_reorder(site, mean))) +
  theme_classic() +
  geom_point(size = 2) + 
  labs(y = "Model Coefficient (Power Term)",
       x = "Cohort (Year of Initial Abandonment)", 
       title = "Model Coefficients", #subtitle = "log(proportion) ~ 0 + log(time + 1):cohort",
       color = "Site") + 
  theme(legend.position = "right", 
        plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  geom_smooth(method = "lm", se = FALSE)  + 
  facet_wrap(~ cluster, labeller = labeller(cluster = c(#old = "new",
    a = "Q1, mean decay rate (fastest)",
    b = "Q2, mean decay rate",
    c = "Q3, mean decay rate",
    d = "Q4, mean decay rate (slowest)")))



# ------------------------------------------------------------- #
# save:
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_coefs", run_label, "_all.png"), 
    width = 9, height = 7, units = "in", res = 400)
print(gg_log2_cohort_coef_all)
dev.off()
# ------------------------------------------------------------- #








# ---------------------------------------- #
# tester:
ggplot(data = coef_df %>% 
       mutate(site_n = rep(1:11, each = 26),
              site_reorder = rep(site_mean_decay_order, each = 26), 
              cluster = cut(site_reorder, breaks = 4, include.lowest = TRUE),
              # to customize which site is in which quadrant
              cluster1 = ifelse(site_n %in% c(1, 5, 10), "a",
                               ifelse(site_n %in% c(2, 6, 11), "b",
                                      ifelse(site_n %in% c(3, 7, 9), "c", 
                                             ifelse(site_n %in% c(4, 8), "d", NA))))),
       mapping = aes(x = year_abn, y = estimate, 
                     group = fct_reorder(site, mean), color = fct_reorder(site, mean))) +
  theme_classic() +
  geom_point(position = position_jitter()) + 
  theme(legend.position = "bottom") + 
  geom_smooth(method = "lm", se = FALSE)  + 
  facet_wrap(vars(cluster))
```





```{r plot-mean-coef-per-site}

# quasi half-lives
lapply(lm_log2_l, FUN = function(i) cc_half_life(i, confint = TRUE)) %>% bind_rows(.id = "site")


gg_mean_coef_site <- ggplot(data = mean_coef_proj %>% filter(term == "coef"),
                            mapping = aes(x = mean, y = fct_reorder(site, mean))) + 
  theme_classic() +
  geom_point() + 
  geom_errorbar(mapping = aes(xmin = mean_low, xmax = mean_high), width = 0.3) +
  labs(x = "Mean Coefficient (Power Term)", y = NULL, 
       title = "Mean Decay Rates By Site",
       subtitle = "log(proportion) ~ 0 + log(time + 1):cohort",
       caption = "Error bars represent the mean of high and low cofficients from 95% confidence interval") + 
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme(plot.caption = element_text(face = "italic"))

# save
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_coefs_by_site", run_label, ".png"), 
    width = 5, height = 6, units = "in", res = 400)
print(gg_mean_coef_site)
dev.off()


gg_example_proportions_by_site <- ggplot(data = mean_coef_proj %>% filter(term != "coef"),
                              mapping = aes(y = mean, x = fct_reorder(site, desc(mean)),
                                            ymin = mean_low, ymax = mean_high, #col = site, 
                                            group = term, color = term)) + 
  theme_classic() +
  geom_point(position = position_dodge(0.7)) + 
  geom_errorbar(#mapping = aes(ymin = mean_low, ymax = mean_high), 
                width = 0.3, position = position_dodge(0.7)) +
  labs(y = "Proportion of abandoned land remaining", 
       #subtitle = "log(proportion) ~ 0 + log(time + 1):cohort",
       #caption = "Error bars represent the mean of 95% confidence interval coefficient estimates",
       #title = "Decay rates by site",
       x = "Site" 
       ) + 
  theme(plot.caption = element_text(face = "italic"),
        axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0),
        legend.position = "right"#, plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")
        ) + 
  scale_color_discrete(name = "Proportion \nremaining \nafter: ", 
                      labels = c(p10 = "10 years", #old = "new",
                                 p20 = "20 years", p30 = "30 years",
                                 p40 = "40 years", p50 = "50 years")) #+ 
  # guides(col = guide_legend(ncol = 2, byrow = TRUE))


png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_decay_proportions_by_site", run_label, ".png"), 
    width = 7.5, height = 4.5, units = "in", res = 400)
print(gg_example_proportions_by_site)
dev.off()

# save old
gg_coef_p25_by_site
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_coef_p25_by_site", run_label, ".png"), 
    width = 6, height = 7, units = "in", res = 400)
print(gg_coef_p25_by_site)
dev.off()
```

```{r mean-trend-by-site}
# make a data.frame with fitted values for the mean coef
fitted_df <- lapply(site_df$site, FUN = function(x) {
  data.frame(site = x,
             time_1 = 1:50,
             coef = filter(mean_coef_proj, term == "coef", site == x)$mean) %>%
    mutate(fitted = (time_1) ^ coef,
           age = time_1 + 4)
}) %>% bind_rows()

# plot it, reordering the factors by the coefficient (to make the legend easier to read)
gg_model_curves_by_site <- ggplot(data = fitted_df, 
       mapping = aes(x = age, y = fitted, color = fct_reorder(site, coef))) +
  geom_line() +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(title = "Decay of abandoned land over time", 
       caption = "lm formula: log(proportion) ~ 0 + log(time + 1):cohort",
       x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site") + 
  guides(col = guide_legend(reverse = TRUE))


png(filename = paste0(p_plots, run_label, "/decay/", "model_decay_curves_by_site", run_label, ".png"), 
    width = 7, height = 6, units = "in", res = 400)
print(gg_model_curves_by_site)
dev.off()


# could also manually reorder the factors like so:
coef_level_order <- mean_coef_proj %>% 
  filter(term == "coef") %>% 
  arrange(desc(mean)) %>% 
  select(site) %>% 
  unlist(use.names = FALSE)

mean_coef_df %>% mutate(site = fct_relevel(site, coef_level_order)) %>% .$site
```


```{r coef-rate-of-change-per-site}
lm_coef <- lm(estimate ~ year_abn * site - 1, data = coef_df)
par(mfrow = c(2, 2))
plot(lm_coef)

coef(lm_coef)[1]
as.numeric(tidy(lm_coef, conf.int = TRUE)[1, "estimate"])


coef_df2 <- tidy(lm_coef, conf.int = TRUE) %>%
  mutate(termm = ifelse(grepl("year_abn", term), "slope", "int"),
         site = gsub("site|year_abn:", "", term)) %>% 
  pivot_wider(id_cols = c(site, termm), names_from = termm, values_from = c(estimate, conf.low, conf.high)) %>% 
  mutate(
    estimate_slope = ifelse(site == "belarus", 0, estimate_slope),
    conf.low_slope = ifelse(site == "belarus", 0, conf.low_slope),
    conf.high_slope = ifelse(site == "belarus", 0, conf.high_slope),
    estimate_slope = estimate_slope + as.numeric(tidy(lm_coef, conf.int = TRUE)[1, "estimate"]),
    conf.low_slope = conf.low_slope + as.numeric(tidy(lm_coef, conf.int = TRUE)[1, "conf.low"]),
    conf.high_slope = conf.high_slope + as.numeric(tidy(lm_coef, conf.int = TRUE)[1, "conf.high"])
    ) %>% 
  filter(site != "year_abn")


# plot right on:
# ------------------------ use this one ---------------------------- #
gg_coef_rate_change_by_site <- ggplot(data = left_join(coef_df2, mean_coef_df, by = "site"),
                                      aes(x = fct_reorder(site, estimate_slope), 
                                          y = estimate_slope, 
                                          color = fct_reorder(site, mean), 
                                          fill = fct_reorder(site, mean))) + 
  theme_classic() +
  geom_col() + 
  geom_errorbar(mapping = aes(ymin = conf.low_slope, ymax = conf.high_slope), width = 0.2) +
  geom_hline(yintercept = 0) + 
  labs(title = "Changes in Decay Rate over time, by site", 
       x = "Site", y = "Rate of Change of Model Coefficients (per year)") + 
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none",
        plot.margin = unit(c(0.4, 0.6, 0.2, 0.2), "cm"))

# save
png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_coefs_rate_of_change_by_site", run_label, ".png"), 
    width = 5, height = 5, units = "in", res = 400)
print(gg_coef_rate_change_by_site)
dev.off()



# plot, flipped
gg_coef_rate_change_by_site_flipped <- ggplot(data = left_join(coef_df2, mean_coef_df, by = "site"), 
                                      aes(x = fct_reorder(site, estimate_slope), 
                                          y = estimate_slope, 
                                          color = fct_reorder(site, mean)
                                          )) + 
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_point() + 
  geom_errorbar(mapping = aes(ymin = conf.low_slope, ymax = conf.high_slope), width = 0.3) +
  labs(title = "Changes in Decay Rate over time, by site", 
       x = "Site", y = "Rate of Change of Model Coefficients (per year)") + 
  theme(#axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none",
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  coord_flip()

png(filename = paste0(p_plots, run_label, "/decay/", "log2_cohort_coefs_rate_of_change_by_site_flip", run_label, ".png"), 
    width = 5, height = 6, units = "in", res = 400)
print(gg_coef_rate_change_by_site_flipped)
dev.off()



# -------------------------------------------------------------- #
# alternatively, I can just pull the second year_abn coefficient from the 
coef_df2 %>% mutate(
  year_abn_slope = sapply(lm_log2_year_abn_l, FUN = function(x) coef(x)[2]),
  diff = estimate_slope - year_abn_slope

)

sapply(lm_log2_year_abn_l, FUN = function(x) coef(x)[2])
```


### Lin-log coef. plots

```{r coef-all-sites-lin_log}
# extract coefficients for log-log-cohort model for all sites
coef_df_lin_log <- lapply(lm_lin_log_l, FUN = function(x) {
  tidy(x, conf.int = TRUE) %>% 
    mutate(year_abn = as.integer(gsub(".*cohort", "", term)),
           cohort = as.factor(year_abn))
}) %>% bind_rows(.id = "site")

# mean_coef per site
mean_coef_df_lin_log <- coef_df_lin_log %>% 
  group_by(site) %>% 
  summarise(mean = mean(estimate, na.rm = TRUE),
            mean_low = mean(conf.low, na.rm = TRUE),
            mean_high = mean(conf.high, na.rm = TRUE)) %>% 
  mutate(term = "coef")

# join to all coef df
coef_df_lin_log <- left_join(coef_df_lin_log, 
                     mean_coef_df_lin_log %>% select(-term),
                     by = "site")


# calculate the proportion remaining at various times, projection
mean_coef_proj_lin_log <- bind_rows(mean_coef_df_lin_log, 
                          
                          # time = i + 4 (since time_1 is age - 4)
                          lapply(c(6, 16, 26, 36, 46), FUN = function(x) {
                            mean_coef_df_lin_log %>%
                              mutate(mean = (mean*log(x) + 1),
                                     mean_low = (mean_low*log(x) + 1),
                                     mean_high = (mean_high*log(x) + 1),
                                     term = paste0("p", x + 4))
                            }))

mean_coef_proj %>% select(term) %>% unique
```


```{r plot-coef-all-sites-lin-log}
# plot all coefficients
ggplot(data = coef_df_lin_log %>% filter(),
       mapping = aes(x = year_abn, y = estimate, group = site, color = site)) + 
  theme_classic() +
  geom_point(position = position_jitter()) + 
  #geom_errorbar(mapping = aes(ymin = conf.low, ymax = conf.high), width = 0.3) +
  labs(y = "Model Coefficient (Power Term)",
       x = "Cohort (Year of Initial Abandonment)", 
       title = "Model Coefficients",
       subtitle = "log(proportion) ~ 0 + log(time + 1):cohort",
       caption = "Error bars represent 95% confidence interval",
       color = "Site") + 
  theme(#axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "bottom",
        plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  geom_smooth(method = "lm", se = FALSE) # + 
  # plot line manually
  # geom_abline(slope = 8.812e-04 - 5.977038e-03, intercept = 1.004106e+01)


# with quadrants:
gg_lin_log_cohort_coef_all <- 
  ggplot(data = coef_df_lin_log %>% 
           arrange(mean) %>%
           mutate(site_reorder = rep(1:11, each = 26),
                  cluster = cut(site_reorder, breaks = c(1, 3, 6, 9, 11),
                                labels = c("a", "b", "c", "d"), 
                                include.lowest = TRUE),
                  mean_coef = cut(mean, breaks = 4)),
         mapping = aes(x = year_abn, y = estimate, color = fct_reorder(site, mean))) +
  theme_classic() +
  geom_point(size = 2) + 
  labs(y = "Model Coefficient (Power Term)",
       x = "Cohort (Year of Initial Abandonment)", 
       title = "Model Coefficients", subtitle = "(proportion - 1) ~ 0 + log(time + 1):cohort",
       color = "Site") + 
  theme(legend.position = "right", 
        plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  geom_smooth(method = "lm", se = FALSE)  + 
  facet_wrap(~ cluster, labeller = labeller(cluster = c(#old = "new",
    a = "Q1, mean decay rate (fastest)",
    b = "Q2, mean decay rate",
    c = "Q3, mean decay rate",
    d = "Q4, mean decay rate (slowest)")))



# ------------------------------------------------------------- #
# save:
png(filename = paste0(p_plots, run_label, "/decay/", "lin_log_cohort_coefs_all", run_label, ".png"), 
    width = 9, height = 7, units = "in", res = 400)
print(gg_lin_log_cohort_coef_all)
dev.off()
# ------------------------------------------------------------- #
```





```{r plot-mean-coef-per-site-lin-log}
lm_lin_log_l
gg_mean_coef_site_lin_log <- ggplot(data = mean_coef_proj_lin_log %>% filter(term == "coef"),
                            mapping = aes(x = mean, y = fct_reorder(site, mean))) + 
  theme_classic() +
  geom_point() + 
  geom_errorbar(mapping = aes(xmin = mean_low, xmax = mean_high), width = 0.3) +
  labs(x = "Mean Coefficient (log term)", y = NULL, 
       title = "Mean Decay Rates By Site",
       subtitle = "(proportion - 1) ~ 0 + log(time + 1):cohort",
       caption = "Error bars represent the mean of high and low cofficients from 95% confidence interval") + 
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme(plot.caption = element_text(face = "italic"))

# save
png(filename = paste0(p_plots, run_label, "/decay/", "lin_log_cohort_coefs_by_site", run_label, ".png"), 
    width = 5, height = 6, units = "in", res = 400)
print(gg_mean_coef_site_lin_log)
dev.off()


gg_example_proportions_by_site_lin_log <- ggplot(data = mean_coef_proj_lin_log %>% filter(term != "coef"),
                              mapping = aes(y = mean, x = fct_reorder(site, desc(mean)),
                                            ymin = mean_low, ymax = mean_high, #col = site, 
                                            group = term, color = term)) + 
  theme_classic() +
  geom_point(position = position_dodge(0.7)) + 
  geom_errorbar(#mapping = aes(ymin = mean_low, ymax = mean_high), 
                width = 0.3, position = position_dodge(0.7)) +
  labs(y = "Proportion of abandoned land remaining", 
       subtitle = "(proportion - 1) ~ 0 + log(time + 1):cohort",
       #caption = "Error bars represent the mean of 95% confidence interval coefficient estimates",
       #title = "Decay rates by site",
       x = "Site" 
       ) + 
  theme(plot.caption = element_text(face = "italic"),
        axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0),
        legend.position = "right"#, plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")
        ) + 
  scale_color_discrete(name = "Proportion \nremaining \nafter: ", 
                      labels = c(p10 = "10 years", #old = "new",
                                 p20 = "20 years", p30 = "30 years",
                                 p40 = "40 years", p50 = "50 years")) #+ 
  # guides(col = guide_legend(ncol = 2, byrow = TRUE))


png(filename = paste0(p_plots, run_label, "/decay/", "lin_log_cohort_decay_proportions_by_site", run_label, ".png"), 
    width = 7.5, height = 4.5, units = "in", res = 400)
print(gg_example_proportions_by_site_lin_log)
dev.off()

```

```{r mean-trend-by-site-lin-log}
# make a data.frame with fitted values for the mean coef
fitted_df_lin_log <- lapply(site_df$site, FUN = function(x) {
  data.frame(site = x,
             time = 1:50,
             coef = filter(mean_coef_proj_lin_log, term == "coef", site == x)$mean) %>%
    mutate(fitted = (coef*log(time) + 1),
           age = time + 4)
}) %>% bind_rows()

# plot it, reordering the factors by the coefficient (to make the legend easier to read)
gg_model_curves_by_site_lin_log <- ggplot(data = fitted_df_lin_log, 
       mapping = aes(x = age, y = fitted, color = fct_reorder(site, coef))) +
  geom_line() +
  geom_hline(yintercept = 0.5, linetype = "dashed") + 
  labs(title = "Decay of abandoned land over time", 
       subtitle = "lin-log model",
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort",
       x = "Time since initial abandonment (years)", 
       y = "Proportion of abandoned land remaining",
       color = "Site") + 
  guides(col = guide_legend(reverse = TRUE))


png(filename = paste0(p_plots, run_label, "/decay/", "model_decay_curves_by_site_lin_log", run_label, ".png"), 
    width = 7, height = 6, units = "in", res = 400)
print(gg_model_curves_by_site_lin_log)
dev.off()



mean_coef_df %>% mutate(site = fct_relevel(site, coef_level_order)) %>% .$site
```


```{r coef-rate-of-change-per-site}
lm_coef_lin_log <- lm(estimate ~ year_abn * site - 1, data = coef_df_lin_log)
par(mfrow = c(2, 2))
plot(lm_coef_lin_log)

coef(lm_coef_lin_log)[1]
as.numeric(tidy(lm_coef, conf.int = TRUE)[1, "estimate"])


coef_df2_lin_log <- tidy(lm_coef_lin_log, conf.int = TRUE) %>%
  mutate(termm = ifelse(grepl("year_abn", term), "slope", "int"),
         site = gsub("site|year_abn:", "", term)) %>% 
  pivot_wider(id_cols = c(site, termm), names_from = termm, values_from = c(estimate, conf.low, conf.high)) %>% 
  mutate(
    estimate_slope = ifelse(site == "belarus", 0, estimate_slope),
    conf.low_slope = ifelse(site == "belarus", 0, conf.low_slope),
    conf.high_slope = ifelse(site == "belarus", 0, conf.high_slope),
    estimate_slope = estimate_slope + as.numeric(tidy(lm_coef_lin_log, conf.int = TRUE)[1, "estimate"]),
    conf.low_slope = conf.low_slope + as.numeric(tidy(lm_coef_lin_log, conf.int = TRUE)[1, "conf.low"]),
    conf.high_slope = conf.high_slope + as.numeric(tidy(lm_coef_lin_log, conf.int = TRUE)[1, "conf.high"])
    ) %>% 
  filter(site != "year_abn")


# plot right on:
# ------------------------ use this one ---------------------------- #
gg_coef_rate_change_by_site_lin_log <- ggplot(data = left_join(coef_df2_lin_log, mean_coef_df_lin_log, by = "site"),
                                      aes(x = fct_reorder(site, estimate_slope), 
                                          y = estimate_slope, 
                                          color = fct_reorder(site, mean), 
                                          fill = fct_reorder(site, mean))) + 
  theme_classic() +
  geom_col() + 
  geom_errorbar(mapping = aes(ymin = conf.low_slope, ymax = conf.high_slope), width = 0.2) +
  geom_hline(yintercept = 0) + 
  labs(title = "Changes in Decay Rate over time, by site", 
       x = "Site", y = "Rate of Change of Model Coefficients (per year)",
       caption = "lm formula: (proportion - 1) ~ 0 + log(time + 1):cohort") + 
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none",
        plot.margin = unit(c(0.4, 0.6, 0.2, 0.2), "cm"))

# save
png(filename = paste0(p_plots, run_label, "/decay/", "lin_log_cohort_coefs_rate_of_change_by_site", run_label, ".png"), 
    width = 5, height = 5, units = "in", res = 400)
print(gg_coef_rate_change_by_site_lin_log)
dev.off()



# plot, flipped
gg_coef_rate_change_by_site_flipped_lin_log <- ggplot(data = left_join(coef_df2_lin_log, mean_coef_df, by = "site"), 
                                      aes(x = fct_reorder(site, estimate_slope), 
                                          y = estimate_slope, 
                                          color = fct_reorder(site, mean)
                                          )) + 
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_point() + 
  geom_errorbar(mapping = aes(ymin = conf.low_slope, ymax = conf.high_slope), width = 0.3) +
  labs(title = "Changes in Decay Rate over time, by site", 
       x = "Site", y = "Rate of Change of Model Coefficients (per year)") + 
  theme(#axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none",
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm")) + 
  coord_flip()

png(filename = paste0(p_plots, run_label, "/decay/", "lin_log_cohort_coefs_rate_of_change_by_site_flip", run_label, ".png"), 
    width = 5, height = 6, units = "in", res = 400)
print(gg_coef_rate_change_by_site_flipped_lin_log)
dev.off()


```


## old half-life stuff

```{r half-life-over-time-by-site}
# build data frames of half lives for each model


grep("time", lapply(mod_l, formula))
grep("lmer", names(mod_l))

mod_l[6:9]


hl1 <- lapply(mod_l[6:8], FUN = function(x) {
  coef(x)$cohort %>%
  as_tibble(rownames = "cohort") %>%
  rename(int = "(Intercept)", coeff = age) %>% 
  mutate(half_life = (log(0.5) - int)/coeff,
         year_abn = as.numeric(cohort),
         mod = names(x))
})

bind_rows(hl1, .id = "mod")

hl4 <- coef(mod_l[[9]])$cohort %>%
  as_tibble(rownames = "year_abn") %>%
  rename(coeff = time) %>% 
  mutate(half_life = log(0.5)/coeff + 5,
         year_abn = as.numeric(year_abn),
         mod = "lmer_mod_slope0")

lmer_mod1_half_lives <- coef(lmer_mod1)$year_abn %>%
  as_tibble(rownames = "year_abn") %>%
  rename(int = "(Intercept)", coeff = age) %>% 
  mutate(half_life = (log(0.5) - int)/coeff,
         year_abn = as.numeric(year_abn),
         mod = "lmer1")

mod_l_coef <- lapply(mod_l, FUN = function(x) if(class(x) == "lm") {coef(x)} else {coef(x)[[1]]})





mod_l[c(1,3,7)]

# combine the data.frames to compare models
half_life_mod_comparison <- bind_rows(lmer_mod_half_lives, 
                                      lmer_mod_slope0_half_lives,
                                      lmer_mod1_half_lives, 
                                      select(mod_ind_df, !cohort)) %>% 
  mutate(mod = as_factor(mod))



gg_mod_comp_s <- 
  ggplot(data = half_life_mod_comparison) + theme_classic() +
  geom_smooth(method = "lm", formula = y ~ x,
              mapping = aes(x = year_abn, y = half_life, 
                            fill = mod, color = mod),
              #color = "blue", fill = "gray", 
              size = 1.5, alpha = 0.25, show.legend = FALSE) +
  geom_point(mapping = aes(x = year_abn, y = half_life, color = mod), 
             alpha = 078) + 
  labs(y = "Half life (years)", x = "Year Abandoned", 
       title = "Persistence of Abandoned Land", subtitle = site_df$description[9],
       color = "Model Type")


# save plots

png(filename = paste0(p_plots, run_label, "/decay/", "half_life_cohorts", run_label, "_s.png"), 
    width = 6, height = 5, units = "in", res = 400)
print(gg_mod_comp_s)
dev.off()
```


```{r plot-half-life-lm-vs-lmer}
# plot half-life for full site:
summary(lmer_mod)
summary(lmer_mod1)

lmer_mod_coef
lmer_mod1_coef
show_col(hue_pal()(3))
gg_colors <- hue_pal()(3)
gg_colors[2]

gg_half_life_lm_s

gg_half_life_lm_lmer_s <- 
  ggplot(data = persistence_list_b1_s$na_first) + 
  # base plot
  theme_classic() + 
  geom_line(mapping = aes(x = age, y = proportion, 
                          group = year_abn, color = year_abn), 
            size = 1, alpha = 0.25) + 
  geom_point(mapping = aes(x = age, y = proportion,
                           group = year_abn, color = year_abn), 
            size = 1) + 
  labs(y = "Proportion remaining abandoned", 
       x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land: Shaanxi Province",
       subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
  theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_hline(yintercept = 0.5, linetype="dashed", 
             color = "black", size = 0.75) + 
  
  # lmer_mod
  stat_function(fun = function(x) {exp(filter(lmer_mod_coef, term == "age")$estimate*x + 
                                        filter(lmer_mod_coef, term == "(Intercept)")$estimate)},
                color = gg_colors[2], size = 1, linetype = "solid") + 
  geom_ribbon(data = mutate(data.frame(x = 5:35),
                            lower = exp(filter(lmer_mod_coef, term == "age")$lower*x +
                                          filter(lmer_mod_coef, term == "(Intercept)")$lower),
                            upper = exp(filter(lmer_mod_coef, term == "age")$upper*x +
                                          filter(lmer_mod_coef, term == "(Intercept)")$upper)),
              mapping = aes(ymin = lower, ymax = upper, x = x),
              fill = gg_colors[2], alpha = 0.1, color = gg_colors[2], linetype = "dashed") +
  annotate("text", fontface = "italic", angle = 90,
           x = ((log(0.5) - filter(lmer_mod_coef, term == "(Intercept)")$estimate) /     
                      (filter(lmer_mod_coef, term == "age")$estimate)), 
           y = 0.85, label = "lmer (random slopes): \n34.35 years", size = 3.5) + 
  geom_vline(xintercept = 
               ((log(0.5) - filter(lmer_mod_coef, term == "(Intercept)")$estimate) /     
                  (filter(lmer_mod_coef, term == "age")$estimate)), 
             color = gg_colors[2], linetype = "solid") + 
    
  # lmer_mod1  
  stat_function(fun = function(x) {exp(filter(lmer_mod1_coef, term == "age")$estimate*x + 
                                        filter(lmer_mod1_coef, term == "(Intercept)")$estimate)},
                color = gg_colors[3], size = 1, linetype = "solid") + 
  geom_ribbon(data = mutate(data.frame(x = 5:35),
                            lower = exp(filter(lmer_mod1_coef, term == "age")$lower*x +
                                          filter(lmer_mod1_coef, term == "(Intercept)")$lower),
                            upper = exp(filter(lmer_mod1_coef, term == "age")$upper*x +
                                          filter(lmer_mod1_coef, term == "(Intercept)")$upper)),
              mapping = aes(ymin = lower, ymax = upper, x = x),
              fill = gg_colors[3], alpha = 0.1, color = gg_colors[3], linetype = "dashed") +
  annotate("text", fontface = "italic", angle = 90,
           x = ((log(0.5) - filter(lmer_mod1_coef, term == "(Intercept)")$estimate) /     
                      (filter(lmer_mod1_coef, term == "age")$estimate)), 
           y = 0.86, label = "lmer (random int. & slopes): \n30.26 years", size = 3.5) + 
  geom_vline(xintercept = 
               ((log(0.5) - filter(lmer_mod1_coef, term == "(Intercept)")$estimate) /     
                  (filter(lmer_mod1_coef, term == "age")$estimate)), 
             color = gg_colors[3], linetype = "solid") + 
  
  # lmer_mod2
  stat_function(fun = function(x) {exp(filter(lmer_mod1_coef, term == "age")$estimate*x + 
                                        filter(lmer_mod1_coef, term == "(Intercept)")$estimate)},
                color = gg_colors[3], size = 1, linetype = "solid") + 
  
  # lm
  stat_function(fun = function(x) {exp(lm_mod$coefficients["age"]*x +
                                         lm_mod$coefficients["(Intercept)"])},
                color = gg_colors[1], size = 1) + 
  annotate(x = ((log(0.5) - lm_mod$coefficients["(Intercept)"]) /     
                      (lm_mod$coefficients["age"])), 
           y = 0.88, label = "lm: \n23.17 years", 
           "text", fontface = "italic", angle = 90, size = 3.5) + 
  geom_vline(xintercept = ((log(0.5) - lm_mod$coefficients["(Intercept)"]) /
                             (lm_mod$coefficients["age"])), 
             color = gg_colors[1]) + 
  geom_ribbon(data = mutate(data.frame(x = 5:35),
                            lower = exp(confint(lm_mod)["age", 1]*x +
                                          confint(lm_mod)["(Intercept)", 1]),
                            upper = exp(confint(lm_mod)["age", 2]*x +
                                          confint(lm_mod)["(Intercept)", 2])),
              mapping = aes(ymin = lower, ymax = upper, x = x),
              fill = gg_colors[1], alpha = 0.1, color = gg_colors[1], linetype = "dashed")

  
gg_half_life_lm_lmer_s

# save
png(filename = paste0(p_plots, run_label, "/decay/", "half_life_lm_lmer", run_label, "_s.png"), 
    width = 7, height = 6, units = "in", res = 400)
print(gg_half_life_lm_lmer_s)
dev.off()
```


```{r half-life-lm-all-sites}

# ------- calc lm for each site ------------------------------------------------- #
# calculate exponential decay curve for each site:

decay_models <- lapply(1:11, FUN = function(i) {
  load(file = paste0(p_output, "abn_dat_products", blip_label, site_df$label[i], ".rds"), verbose = TRUE)
# eval(parse(text = paste0("persistence_list", blip_label, site_label)))
  
  assign("persistence_list", eval(parse(text = paste0("persistence_list", blip_label, site_df$label[i]))))
  
  model <- lm(log(proportion) ~ age, data = persistence_list$na_first)

})

names(decay_models) <- site_df$site
plot(decay_models$shaanxi)
broom::tidy(decay_models$shaanxi)
broom::tidy(mod_decay_s)


# make a data.frame of coefficients
decay_models_coeff <- lapply(decay_models, coefficients) %>% 
  bind_rows(.id = "site") %>%
  rename(int = "(Intercept)", coeff = age) %>% 
  mutate(half_life = (log(0.5) - int)/coeff)

# calculate confidence intervals
conf <- lapply(decay_models, FUN = function(i) {
  conf <- confint(i) %>% 
    as_tibble(rownames = "rownames") %>% 
    mutate(rownames = ifelse(rownames == "age", "coeff", "int")) %>%
    rename("lower" = "2.5 %", "upper" = "97.5 %") %>% 
    pivot_wider(names_from = rownames, values_from = c(lower, upper))
}) %>% bind_rows(.id = "site")

# join data.frames
decay_models_coeff <- left_join(decay_models_coeff, conf, by = "site") %>%
  mutate(half_life_lower = (log(0.5) - lower_int)/lower_coeff,
         half_life_upper = (log(0.5) - upper_int)/upper_coeff)


# plot
gg_half_life_all_sites <- ggplot(data = decay_models_coeff) + 
  theme_classic() + 
  geom_col(mapping = aes(x = site, y = half_life, fill = site)) + 
  geom_errorbar(mapping = aes(x = site, ymin = half_life_lower, ymax = half_life_upper, #color = site
                              ), width = 0.3) +
  labs(y = "Half-life (years)",
       x = "Site", 
       title = "Half-life of abandoned agricultural land",
       caption = "Error bars represent 95% confidence interval",
       fill = "Site") + 
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0), 
        legend.position = "none", plot.caption = element_text(face = "italic"),
        plot.margin = unit(c(0.4, 0.5, 0.2, 0.2), "cm"))




# save plots
# ----------------------------------- save ------------------------------------------------- #

png(filename = paste0(p_plots, run_label, "/decay/", "half_life_all_sites", run_label, ".png"), 
    width = 5, height = 5, units = "in", res = 400)
print(gg_half_life_all_sites)
dev.off()






# old ----------------------------------------------------------------------- #

# calculating the average proportion at each time_abn, across all sites.
# this replicated df_av, but for all sites

mean_persistence_df <- lapply(1:11, FUN = function(i) {
  load(file = paste0(p_output, "abn_dat_products", blip_label, site_df$label[i], ".rds"), verbose = TRUE)
# eval(parse(text = paste0("persistence_list", blip_label, site_label)))
  
  assign("persistence_list", eval(parse(text = paste0("persistence_list", blip_label, site_df$label[i]))))
  
  df_tmp <- persistence_list$na_last %>%
    mutate(year_abn = as_factor(year_abn)) %>%
    group_by(time_abn) %>%
    summarise(count = n(),
              sd = sd(proportion, na.rm = TRUE), 
              se = sd/sqrt(count),
              mean_proportion = mean(proportion), 
              year_abn = as_factor("mean")) %>%
    mutate(site = site_df$site[i])
  
  df_tmp
})

mean_persistence_df <- bind_rows(mean_persistence_df)

# save
write_csv(mean_persistence_df, path = paste0(p_dat_derived, "mean_persistence_df.csv"))

# re load
mean_persistence_df <- read.csv(file = paste0(p_dat_derived, "mean_persistence_df.csv"))




# plotting the average persistence over time
gg_mean_persistence_all <- ggplot(data = mean_persistence_df) +
  labs(title = "Mean persistence over time", x = "Time abandoned (years)", 
       y = "Mean proportion of abandoned land remaining abandoned") + 
  geom_line(mapping = aes(x = time_abn, y = mean_proportion, group = site, color = site), size = 1) + 
  theme_classic() + theme(legend.position = "right")

# save
png(filename = paste0(p_plots, run_label, "/decay/", "mean_persistence_all", run_label, ".png"), 
    width = 7, height = 5, units = "in", res = 400)
print(gg_mean_persistence_all)
dev.off()

mean_persistence_df %>% filter(mean_proportion < 0.52 & mean_proportion > 0.49) %>% select(site, time_abn, mean_proportion) %>% as.data.frame()



```


```{r half-life-lm-bins}
# ----------------------------------------------------------------------------------- #
# plot persistence for bins of year abandoned
# bins for year_abn
test$year_abn %>% unique %>% length 
test <- persistence_list$na_first
test <- test %>% 
      mutate(year_abn_bins = ifelse(year_abn >= 1988 & year_abn <= 1993, "1988-1993",
                           ifelse(year_abn >= 1994 & year_abn <= 1998, "1994-1998",
                                  ifelse(year_abn >= 1999 & year_abn <= 2003, "1999-2003",
                                         ifelse(year_abn >= 2004 & year_abn <= 2008, "2004-2008",
                                                ifelse(year_abn >= 2009 & year_abn <= 2013, "2009-2013", NA)
                                         ))))) %>%
      mutate(year_abn_bins = as_factor(year_abn_bins))

year_abn_bins_av <- test %>% group_by(year_abn_bins, age) %>% summarise(mean_proportion = mean(proportion), count = n())


ggplot(data = year_abn_bins_av) + 
  theme_classic() + 
  labs(y = "Proportion remaining abandoned", #x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land", color = "Year Abandoned") + 
  # scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
  theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0),
        legend.position = "bottom") + 
  geom_line(size = 1.25,
            mapping = aes(x = age, 
                   # x = age, # (replicates the plot from na_last, which is called time_abn)
                   y = mean_proportion, group = year_abn_bins, color = year_abn_bins))


```


```{r half-life-lm-indiv-cohorts}
# half-life for each individual cohort for a particular site
persistence_list$na_first$year_abn %>% unique() %>% length()

# load data set, assign to generic "persistence_list"
load(file = paste0(p_output, "abn_dat_products", blip_label, "_s", ".rds"), verbose = TRUE)
assign("persistence_list", eval(parse(text = paste0("persistence_list", blip_label, "_s"))))


# run an lm() for each cohort, individually
mod_ind <- lapply(1988:2013, FUN = function(i) {
  model <- lm(log(proportion) ~ age, data = filter(persistence_list_b1_s$na_first, year_abn == i))
})

names(mod_ind) <- paste0("y", 1988:2013)

mod_ind_df <- lapply(mod_ind, coefficients) %>% bind_rows(.id = "cohort") %>%
  rename(int = "(Intercept)", coeff = age) %>% 
  mutate(half_life = (log(0.5) - int)/coeff,
         year_abn = gsub("y", "", cohort),
         year_abn = as.numeric(year_abn),
         mod = "lm")

# note: this is the same as the lm_mod_cohort_x 

mod_ind_df
coef(lm_mod_cohort_x)["age"]
coef(lm_mod_cohort_x)[grep("1990", names(coef(lm_mod_cohort_x)))]
tidy(lm_mod_cohort_x) %>% filter(grepl("age", term)) %>% mutate(new = estimate + coef(lm_mod_cohort_x)["age"])


gg_half_life_over_time_s <- ggplot(data = mod_ind_df) + theme_classic() +
  geom_smooth(method = "lm", formula = y ~ x,
              mapping = aes(x = year_abn, y = half_life),
              color = "blue", fill = "gray", size = 1.5, alpha = 0.5) + 
  geom_point(mapping = aes(x = year_abn, y = half_life)) + 
  labs(y = "Half life (years)", x = "Year Abandoned", 
       title = "Persistence of Abandoned Land", subtitle = site_df$description[9],
       color = "Year Abandoned")
  


ggplot(data = persistence_list_b1_s$na_first) + 
  theme_classic() + 
  geom_point(mapping = aes(x = age, y = proportion, group = year_abn, color = year_abn), size = 1.25) + 
  labs(y = "Proportion remaining abandoned", x = "Years since initial abandonment", 
       title = "Persistence of Abandoned Land", subtitle = NULL, #subtitle,
       color = "Year Abandoned") + 
  scale_color_distiller(palette = "Greens") + theme(legend.position = "bottom") +
  theme(legend.text = element_text(angle = 320, vjust = 1, hjust = 0)) + 
  geom_hline(yintercept = 0.5, linetype="dashed", color = "red", size = 0.75) + 
  # make and add confidence interval
  geom_ribbon(data = mutate(data.frame(x = 5:30),
                            lower = exp(confint(mod_decay_s)[2, 1]*x + confint(mod_decay_s)[1, 1]),
                            upper = exp(confint(mod_decay_s)[2, 2]*x + confint(mod_decay_s)[1, 2])),
              mapping = aes(ymin = lower, ymax = upper, x = x), 
              fill = "dark gray", alpha = 0.5, color = "dark gray", linetype = "solid") +
  stat_function(fun = function(x) {exp(mod_decay_s$coefficients[2]*x + mod_decay_s$coefficients[1])}, color = "dark blue", size = 1) + 
  annotate("text", x = 24, y = 0.8, label = "half-life = 23.17 years", fontface = "italic", angle = 90) + 
  geom_vline(xintercept = 23.16972)

```


## brms

```{r bayesian-persistence-model}
# other option: Bayesian hierarchical model. 
install.packages("brms") # Hamiltonian monte carlo.
library(brms)

lm(I(proportion - 1)  ~ 0 + log(time+1):cohort + I(time):cohort,  
               data = filter(dat_l, #year_abn < 2011, 
                             site == site_df$site[i]))
names(lm_lin_log_lin_l) <- site_df$site



brm(formula,
    data,
    family = gaussian())

```



