---
title: "R Notebook"
output: html_notebook
editor_options:
  chunk_output_type: console
bibliography: /Users/christophercrawford/Google Drive/Library/library.bib
---
R notebook for loading and processing the land cover time-series raster data from @Yin2020.


```{r initialize}
source("scripts/0_start.R")

# define color palette for plotting:
# 1. Non-veg
# 2. Woody veg
# 3. Crop
# 4. Grassland
plot_cols <- c("gray80", # gray, 1. Non-veg
               terrain.colors(9)[1], # dark green, 2. Woody veg
               terrain.colors(9)[5], # gold, 3. Crop
               terrain.colors(9)[3] # light green, 4. Grassland
               )
plot_cols_new <- c("gray80", # gray, 1. Non-veg
               terrain.colors(9)[5], # gold, 2 (formerly 3) Crop
               terrain.colors(9)[3], # light green, 3 (formerly 4) Grassland
               terrain.colors(9)[1]  # dark green, 4 (formerly 2) Woody veg
               )

plot_breaks <- c(0, 1, 2, 3, 4)

# show_col(terrain.colors(20))
# show_col(topo.colors(20))
# show_col(cm.colors(20))
# 
# show_col(plot_cols)
# show_col(plot_cols[c(1, 3, 2)])
```

```{r load-data}
# Land use class codes:
#       1. Non-vegetated area (e.g. water, urban, barren land)
#       2. Woody vegetation
#       3. Cropland 
#       4. Herbaceous land (e.g. grassland)

bs <- brick(paste0(p_dat, "Abandonment/belarus_small.tif"))
bs_dt <- as.data.table.raster(bs)


# GEE
p_eefull <- "/Users/christophercrawford/Google Drive/_Projects/data/Abandonment/eefull/"
ee_files <- list.files(p_eefull)

b1 <- brick(paste0(p_eefull, ee_files[1]))
s <- brick(paste0(p_eefull, ee_files[7]))
s
plot(s[[1]])
ncell(b1)
ncell(s)
res(s)
res(b1)
nlayers(b1)
nlayers(s)
raster::area(s[[1]])
22592862 * res(s)[1] * res(s)[2]
34668544 * res(b1)[1] * res(b1)[2]


res(b1)[1] * 110 * 1000 # about 30 m checks out
res(s)[1] * 110 * 1000 # about 30 m checks out
b

plot(s[[1]], main = "Shaanxi 1987", breaks = plot_breaks, col = plot_cols)

# just belarus files, but not necessary
# b_files <- list.files(p_eefull) %>%
#   grep("belarus", ., value = TRUE)


b <- lapply(1:6, function(i) {
    brick(paste0(p_eefull, ee_files[i]))})
names(b) <- ee_files[1:6]

# Shaanxi is much much smaller than Belarus
ncell(s) # 94.4 M
ncell(b87_r) # 22.59 M
# they have the same resolution
res(s)
res(b)




# as data.tables
dt <- as.data.table.raster(s)
object_size(dt)
dt <- dt_s
names(dt) <- gsub("andcover", "y", names(dt))
ncol(dt)
dt[, .N, by = .(y1987)] # one year


fwrite(dt, file = paste0(p_dat_derived, "shaanxi.csv"))
dt <- fread(input = paste0(p_dat_derived, "shaanxi.csv"))
```



```{r simple-plots}
show_col(plot_cols) # (topleft = 1, topright = 2, bottomleft = 3, bottomright = 4)
# gray,         1. Non-veg
# dark green,   2. Woody veg
# gold,         3. Crop
# light green,  4. Grassland

plot(b87_r, main = "Belarus 1987", breaks = plot_breaks, col = plot_cols)
plot(bs$smolensk1987, add = T, legend = F, col = "blue")
plot(bt$smolensk1987, add = T, legend = F, col = "red")
bs

plot(bs$smolensk1987, main = "Subset: Belarus 1987", 
     breaks = plot_breaks, col = plot_cols)

plot(bt$smolensk1987, main = "Subset Subset: Belarus 1987", 
     breaks = plot_breaks, col = plot_cols)


# --------------
# animate
# --------------
# https://www.rdocumentation.org/packages/raster/versions/3.1-5/topics/animate

animate(bt, pause = 0.5, zlim = c(1, 4), maxpixels=5000, n=1,
        breaks = plot_breaks, col = plot_cols)

```


```{r final-processing-workflow-w-tictoc}
# script for computing cluster

library(raster)
library(data.table)
library(devtools)
library(tictoc)

# devtools::install_github("ldemaz/dtraster")
library(dtraster)

tic("Full script")

file <- "/Users/christophercrawford/Google Drive/_Projects/data/Abandonment/belarus_small.tif"
name <- "shaanxi"
path <- p_dat_derived

# load custom filtering functions
source("scripts/util/_util_dt_filter_functions.R")


tic("load raster")
r <- brick(file)

nlayers(r) # 31 years in the time series
names(r) <- paste0("y", 1:nlayers(r))
toc()



# load as a data.table
tic("load data.table")
dt <- as.data.table.raster(r)
toc()

# update names of data.table, if not already updated
names(dt) <- gsub("andcover", "y", names(dt))

# write out data.table as a csv
fwrite(dt, file = paste0(path, name, ".csv"))


# ----------------------
# start heavy processing

tic("update land cover classes")
cc_update_lc(dt, crop_code = 0, noncrop_code = 1)
toc()

tic ("remove NAs")
dt <- na.omit(dt)
toc()

tic("filter non abandonment pixels")
dt <- cc_remove_non_abn(dt)
toc()


tic("calculate age")
cc_calc_age(dt)
toc()


tic("erase non abandonment periods")
cc_erase_non_abn_periods(dt)
toc()


tic("write out cleaned abandonment age data.table")
fwrite(dt, file = paste0(path, name, "_age.csv"))
toc()
path

tic("make diff")
dt_diff <- cc_diff_dt(dt)
toc()

# write out dt_diff
tic("write out dt_diff")
fwrite(dt_diff, file = paste0(path, name, "_diff.csv"))
toc()


tic("extract length")
length <- cc_extract_length(dt_diff)
toc()


# write out length
length <- data.table(length = length)
fwrite(length, file = paste0(path, name, "_length.csv"))

# write out 

# explore some stats:
length[, .N, by = length]
length[, mean(length)] # mean time abandoned if using no threshold
length[length >= 5, mean(length)] # mean time abandoned, if using 3 year abandonment definition threshold


# final toc()
toc()
```

```{r shaanxi-processing}
# script for computing cluster

library(raster)
library(data.table)
library(devtools)
library(tictoc)

# devtools::install_github("ldemaz/dtraster")
library(dtraster)
path_in <- "/Users/christophercrawford/Google Drive/_Projects/data/Abandonment/eefull/"
path_out <- p_dat_derived

# shaanxi run
name <- "shaanxi"
file <- paste0(path_in, name, ".tif")

# load custom filtering functions
source("scripts/util/_util_dt_filter_functions.R")

# load raster
r <- brick(file)

nlayers(r) # 31 years in the time series
names(r) <- gsub("andcover", "y", names(r))
# names(r) <- paste0("y", 1986 + 1:nlayers(r))


# load as a data.table
dt <- as.data.table.raster(r)

# write out data.table as a csv
fwrite(dt, file = paste0(path_out, name, ".csv"))


# # read in data.table directly
# dt <- fread(file = paste0(path_out, name, ".csv"))
# nrow(dt) # pre processing 22,592,862
# nrow(dt) # 8,290,074 # post processing
# 
# # update names of data.table, if not already updated
# names(dt) <- gsub("andcover", "y", names(dt))


# ----------------------
# start heavy processing 

tic()
# update land cover classes
cc_update_lc(dt, crop_code = 0, noncrop_code = 1)

# remove NAs
dt <- na.omit(dt)

# filter non abandonment pixels
dt <- cc_remove_non_abn(dt)

# calculate age
cc_calc_age(dt)

# erase non abandonment periods
cc_erase_non_abn_periods(dt)

# write out cleaned abandonment age data.table
fwrite(dt, file = paste0(path_out, name, "_age.csv"))

# make diff
dt_diff <- cc_diff_dt(dt)

# write out dt_diff
fwrite(dt_diff, file = paste0(path_out, name, "_diff.csv"))

# extract length
length <- cc_extract_length(dt_diff)

# write out length
length <- data.table(length = length)
fwrite(length, file = paste0(path_out, name, "_length.csv"))



# explore some stats:
length[, .N, by = length]
length[, mean(length)] # mean time abandoned if using no threshold
length[length >= 5, mean(length)] # mean time abandoned, if using 3 year abandonment definition threshold

toc()
```

```{r save-age-rasters}

# as a function

age_r <- cc_save_age_rasters(name = "shaanxi")
names(age_r) <- paste0("y", 1987:2017)
plot(age_r$y2017, main = "Age of abandonment in 2017")

age_r <- brick("/Users/christophercrawford/Google Drive/_Projects/abandonment_trajectories/data_derived/shaanxi_age_1.tif")
identical(age_r, age_r1)

cellStats(age_r[[31]] - age_r1[[31]], "sum")


# works fine for shaanxi, but running into issues with belarus... see below


# -------------
# development

dt <- fread(file = paste0(path_out, name, "_age.csv"))

s2017 <- dt[, .(x, y, y2017)]

# convert age dt to raster
age_r <- dt_to_raster(dt, crs(s))


plot(age_r$y2017, main = "Age of Abandonment, 2017")
rasterVis::levelplot(age_r$y2017)
# animate
names(age_r)
animate(age_r, pause = 0.3, main = paste0("Abandonment Age, ", 1987:2017), maxpixels = 500000, n = 1)

names(age_r)
# write raster
writeRaster(age_r, filename = paste0(p_dat_derived, name, "_age.tif"))
names(age_r)

# reload, and rename
age_r <- brick(paste0(p_dat_derived, name, "_age.tif"))
names(age_r) <- paste0("y", 1987:2017)

# just 2017
age_2017_r <- dt_to_raster(dt[, .(x, y, y2017)], crs(s), filename = paste0(p_dat_derived, name, "_age_2017.tif"))


plot(age_r$y2017, main = "Age of abandonment in 2017")


# final code
r <- dt_to_raster(dt, crs("+proj=longlat +datum=WGS84 +no_defs"))
writeRaster(r, filename = paste0(directory, name, "_age.tif"))
brick(paste0(directory, name, "_age.tif"))
```

```{r merging-belarus-chunks}
# -------------------------------
# merge original belarus rasters

belarus <- merge(b[[1]], 
                 b[[2]],
                 b[[3]],
                 b[[4]],
                 b[[5]],
                 b[[6]])
names(belarus) <- paste0("y", 1987:2017)
tic()
writeRaster(belarus, filename = paste0(p_dat_derived, "belarus.tif"))
toc()

plot(belarus$y1987, col = plot_cols, breaks = plot_breaks, main = "merged")
plot(b87_r, col = plot_cols, breaks = plot_breaks, main = "1987 direct")
plot(b87_r - belarus$y1987)

cellStats(belarus$y1987 - b87_r, "sum")



# -------------------------------
# save Belarus 1 as a raster:
# b1_age_r <- cc_save_age_rasters(name = "belarus1")  

# manually
b1_age_r1 <- dt_to_raster(b1_age[1:2000000], crs("+proj=longlat +datum=WGS84 +no_defs"))
b1_age_r2 <- dt_to_raster(b1_age[2000001:4000000], crs("+proj=longlat +datum=WGS84 +no_defs"))

plot(b1_age_r1$y2017)
plot(b1_age_r2$y2017, add = T)

# -------------------------------
# test merging belarus chunks
merge_test <- merge(b1_age_r1, b1_age_r2)
merge_test
ncell(merge_test)
ncell(b1_age_r1) + ncell(b1_age_r2)
plot(merge_test$layer.31)
plot(extent(b1_age_r1), add = T, col = "black")
plot(extent(b1_age_r2), add = T, col = "black")
b1_age_r3 <- dt_to_raster(b1_age[1:4000000], crs("+proj=longlat +datum=WGS84 +no_defs"))
cellStats(merge_test - b1_age_r3, "sum") # these are the same, and it looked like it worked just fine, subtracting sequentially.


# try merging a full brick
b11 <- dt_to_raster(b1_age[1:100000][order(x),], crs("+proj=longlat +datum=WGS84 +no_defs"))
b12 <- dt_to_raster(b1_age[100001:200000][order(x),], crs("+proj=longlat +datum=WGS84 +no_defs"))
plot(b12$y2017)
test <- dt_to_raster(b1_age[1:200][order(x),], crs("+proj=longlat +datum=WGS84 +no_defs"))

writeRaster(b1_age_r, filename = paste0(directory, "belarus1", "_age.tif"))
plot(b1_age_r$y2017)

# reload, and assign names
b1_age_r <- brick(paste0(directory, "belarus1", "_age.tif"))
names(b1_age_r) <- paste0("y", 1987:2017)

plot(b1_age_r$y2017, main = "Age of abandonment in 2017")

```

```{r belarus-processing}

# belarus runs, for loop
run <- 1 # change this for each belarus run

# initial test
tic()
cc_process_rasters(input_raster_file = paste0(p_eefull, list.files(p_eefull)[1]),
                     name = paste0("belarus", 1), 
                     path_out = p_dat_derived,
                     gsub_pattern = "smolensk")
toc()

tic()
for(run in 1:6) {
  cc_process_rasters(input_raster_file = paste0(p_eefull, list.files(p_eefull)[run]),
                     name = paste0("belarus", run), 
                     path_out = p_dat_derived,
                     gsub_pattern = "smolensk")
}
toc()




# -------------------------------
# load and check the belarus data
b1_dt <- fread(input = paste0(p_dat_derived, "belarus1.csv"))
b1_diff <- fread(input = paste0(p_dat_derived, "belarus1_diff.csv"))

b1_age <- fread(input = paste0(p_dat_derived, "belarus1_age.csv"))
b2_age <- fread(input = paste0(p_dat_derived, "belarus2_age.csv"))
b3_age <- fread(input = paste0(p_dat_derived, "belarus3_age.csv"))
b4_age <- fread(input = paste0(p_dat_derived, "belarus4_age.csv"))
b5_age <- fread(input = paste0(p_dat_derived, "belarus5_age.csv"))
b6_age <- fread(input = paste0(p_dat_derived, "belarus6_age.csv"))


# save rasters:
cc_save_age_rasters(name = "belarus1") # not enough memory

dt <- fread(file = paste0(p_dat_derived, "belarus1_age.csv"))
shaanxi_age <- fread(file = paste0(p_dat_derived, "shaanxi_age.csv"))
nrow(dt)
nrow(shaanxi_age)
r <- dt_to_raster(dt, crs("+proj=longlat +datum=WGS84 +no_defs"))
writeRaster(r, filename = paste0(p_dat_derived, "belarus1_age.tif"))

env_size(ls())
plot(r)

# ------------------------------
# merge and save 2017 age layer as a raster
# test merge
b_age_2017 <- rbindlist(list(b1_age[, .(x, y, y2017)],
                            b2_age[, .(x, y, y2017)],
                            b3_age[, .(x, y, y2017)],
                            b4_age[, .(x, y, y2017)],
                            b5_age[, .(x, y, y2017)],
                            b6_age[, .(x, y, y2017)])
                       )

fwrite(b_age_2017, file = paste0(p_dat_derived, "belarus_age_2017.csv"))

b_age_2017_r <- dt_to_raster(b_age2017, crs("+proj=longlat +datum=WGS84 +no_defs"))
plot(b_age_2017_r, main = "Belarus, 2017 - age of abandoned croplands")
plot(extent(b[[1]]), add = T, col = "black")
plot(extent(b[[2]]), add = T, col = "black")
plot(extent(b[[3]]), add = T, col = "black")
plot(extent(b[[4]]), add = T, col = "black")
plot(extent(b[[5]]), add = T, col = "black")
plot(extent(b[[6]]), add = T, col = "black")

extent(b[[1]])

writeRaster(b_age2017_r, filename = paste0(p_dat_derived, "belarus_age_2017.tif"))
b_age2017_r <- raster(paste0(p_dat_derived, "belarus_age_2017.tif"))



b1_length <- fread(input = paste0(p_dat_derived, "belarus1_length.csv"))

b_length


env_size(ls())

# ------------------------------- #
# ultimately I processed the merged Belarus raster file in one go on adroit, using the script: 
# /Users/christophercrawford/Google Drive/_Projects/abandonment_trajectories/scripts/cluster/process_calc_age_belarus.R
# ------------------------------- #


```

```{r inspect-adroit-belarus}
# check cluster output to make sure it worked correctly

# merge individual lengths

b1_length <- fread(input = paste0(p_dat_derived, "belarus1_length.csv"))
b2_length <- fread(input = paste0(p_dat_derived, "belarus2_length.csv"))
b3_length <- fread(input = paste0(p_dat_derived, "belarus3_length.csv"))
b4_length <- fread(input = paste0(p_dat_derived, "belarus4_length.csv"))
b5_length <- fread(input = paste0(p_dat_derived, "belarus5_length.csv"))
b6_length <- fread(input = paste0(p_dat_derived, "belarus6_length.csv"))

b_length_merge <- rbindlist(list(b1_length,
                                 b2_length,
                                 b3_length,
                                 b4_length,
                                 b5_length,
                                 b6_length))
# load the full belarus length file
b_length <- fread(input = paste0(p_dat_derived, "belarus_length.csv"))
# the order is off, because of the way the length extraction code works, extracting each year's column individually, and rbinding those.


# check to see if they're identical
identical(b_length[order(length)], b_length_merge[order(length)])


# initial stats on length, Belarus


# explore some stats:
s_length <- fread(input = paste0(p_dat_derived, "shaanxi_length.csv"))
s_length
b_length
s_length[, .N, by = length]
b_length[, .N, by = length]

object_size(b_length)
s_length[, site := "shaanxi"]
b_length[, site := "belarus"]

length_all <- rbindlist(list(s_length, b_length))
object_size(length_all)

dat <- length_all[, .(mean_length = mean(length)), by = site]
dat2 <- length_all[length >= 5, .(mean_length_thr5 = mean(length)), by = site]
dat <- merge(dat, dat2, by = "site", sort = FALSE)


dat[, mean_length2 := length_all[length >= 5, mean(length), by = site]]
# mean time abandoned, if using 5 year abandonment definition threshold, following Yin et al. 2020

```

```{r histograms}
# plot histograms
# beware... because of the way the bins are determined, the default histogram automatically lumps 1 and 2 together. better to first distill the data and use ggplot 
hist(s_length[[1]], main = "Histogram of Length of Time Abandoned \n Shaanxi/Shanxi Provinces, China", xlab = "Time (years)")

hist(b_length[[1]])

hist(length_all[site == "shaanxi", length], main = "Histogram of Abandonment Period Lengths \n Shaanxi/Shanxi Provinces, China", xlab = "Time (years)")

hist(length_all[site == "belarus", length], main = "Histogram of Abandonment Period Lengths \n Belarus/Russia", xlab = "Time (years)")

hist(b_length[[1]], main = "Histogram of Abandonment Period Lengths \n Belarus/Russia", xlab = "Time (years)")
toc()

hist(b_length[[1]], main = "right = TRUE")
hist(b_length[[1]], right = FALSE, main = "right = FALSE")


# to use with ggplot, first distill the data

b_distill <- b_length[, .(freq = .N), by = length]
b_distill[, site := "belarus"]
s_distill <- s_length[, .(freq = .N), by = length]
s_distill[, site := "shaanxi"]

distill <- rbind(b_distill, s_distill)

# ggplots
# both site histograms
ggplot(data = distill) + 
  geom_col(mapping = aes(x = length, y = freq), fill = "black") +
  facet_grid(rows = vars(site), scales = "free") +
  theme_classic()

# just belarus
ggplot(data = b_distill) + 
  geom_col(mapping = aes(x = length, y = freq), fill = "black") +
  theme_classic()

ggplot(data = b_length, aes(length)) + 
  geom_histogram() +
  theme_classic() # took forever!! Beware...
```


```{r calc-max-age}
# calculate the maximum length of time abandoned for each pixel:
# not sure this code works yet... try with a smaller dt first. 
dt <- b1_age[1:100000]
dt
tic()
dt[, max_length := max(.SD), .SDcols = -c("x", "y"), by = .(x, y)]
toc() # 14.56 sec
getDTthreads() # ? no speed up ?

# testing function: it works!
dt1 <- b1_age[1:100000]
cc_calc_max_age(dt1, name = "belarus1")
identical(dt[, .(x,y,max_length)], dt1)
dt1 <- fread(input = paste0(p_dat_derived, "belarus1_max_length.csv"))

286.417 * nrow(b1_age)/nrow(dt) / 60 # 41 minutes, 40 minutes for the full dataset

max1 <- dt_to_raster(dt[, .(x, y, max_length)], crs("+proj=longlat +datum=WGS84 +no_defs"))

# one can also directly calculate this using raster::calc(), which ends up being faster.
tic()
max <- calc(b1_age_r1, fun = function(r){max(r, na.rm = TRUE)})
toc()
plot(max) # 130.958 sec
warnings()

cellStats(max1 - max, "sum")
plot(max1)
plot(max)
```


```{r parallel-dt}

```


```{r animation}

# with animate package
install.packages("animation")
library(animation)
saveGIF(animate(age_r, main = paste0("Abandonment Age, ", 1987:2017), maxpixels = 500000, n = 1), movie.name = paste0(p_dat_derived, name, "_age_animation.gif"))


# with magick
library(magick)

age_gif <- image_read(paste0(p_dat_derived, name, "_age_animation.gif"))
age_gif2 <- image_animate(age_gif)
image_write(age_gif2, paste0(p_dat_derived, name, "_age_animation2.gif"))



# try a simpler method, just magick

# make it into a function:

# take an animation made with raster::animate(), and save it as a GIF with animation::saveGIF()
cc_save_gif <- function(raster, titles = names(raster), file_out, npixels = 5000,
                        frames_per_second = 5) {
  
  # use animation::saveGIF() to save raster::animate()
  saveGIF(animate(raster, main = titles, maxpixels = npixels, n = 1), 
          movie.name = file_out)
  
  gif <- image_animate(image_read(file_out), fps = frames_per_second)
  image_write(gif, file_out)
}

age_r
paste0("Abandonment Age, ", 1987:2017) # titles, or names(age_r) by default
paste0(p_dat_derived, name, "_age_animation.gif") # file_out


cc_save_gif(age_r, npixels = 500000, paste0("Abandonment Age, ", 1987:2017),
            frames_per_second = 5,
            file_out = paste0(p_dat_derived, name, "_age_animation.gif"))


```

```{r plot-length}
length
dt[, .N, by = andcover1987]
# out of 
11550730 + # 1 (grassland or woody vegetation)
  8135598 # 0 (crop) 
19686328 # 19 M cells (19,686,328)
dt # 8,290,074 of them were abandoned at some point (even just fallowed)
nrow(dt)/19686328 * 100 # 42.11 %

summary(length[[1]])
  #  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  # 1.000   2.000   4.000   6.617  10.000  30.000

length[length >= 3, summary(length)]
  #  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  # 3.000   4.000   7.000   9.596  14.000  30.000 

length[length >= 5, summary(length)]
   # Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   # 5.00    6.00   10.00   12.01   15.00   30.00

object_size(length)
object_size(dt)
object_size(dt_diff)

hist(length[[1]], main = "Histogram of Length of Time Abandoned \n Shaanxi/Shanxi Provinces, China", xlab = "Time (years)")


# rasters:
plot(s[[1]], main = "Shaanxi 1987", breaks = plot_breaks, col = plot_cols)
plot(s[[31]], main = "Shaanxi 2017", breaks = plot_breaks, col = plot_cols)


```
```{r plot-trajectory-per-pixel}
ncell(bt)
# subset the data.table, for plotting
sub <- bs_dt[1:10, -c(1,2)]
sub[, pixel := c(1:10)]

sub <- dt[1:10, -c(1,2)]
sub

names(sub) <- gsub("y", "", names(sub))
sub[, pixel := c(1:10)]



sub_melt <- melt(sub, id.vars = "pixel", 
                 variable.name = "year", 
                 value.name = "land_use", na.rm = TRUE)

sub_melt$year <- gsub("y", "", sub_melt$year)

str(sub_melt)

# set colors for plotting
show_col(terrain.colors(9))

lc_cols <- scale_color_manual(name = "Land Cover",
                     labels = c("1" = "1. Non-veg",
                                "2" = "2. Woody veg",
                                "3" = "3. Crop",
                                "4" = "4. Grassland"),
                     values = c("1" = "gray80",
                                "2" = terrain.colors(9)[1], # dark green
                                "3" = terrain.colors(9)[5], # gold
                                "4" = terrain.colors(9)[3] # light green
                                )
                     ) 

# this plot shows the land-use trajectories of 10 individual pixels.
gg_10_px_traj <- ggplot(data = sub_melt, 
                        mapping = aes(x = year, y = land_use, group = pixel)) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 320, vjust = 1, hjust = 0)) +
  geom_line(mapping = aes(color = factor(land_use)), size = 2) +
  facet_grid(rows = vars(pixel), scales = "free_x", switch = "x") + 
  ylim(1, 4) + lc_cols

gg_10_px_traj
#       1. Non-vegetated area (e.g. water, urban, barren land)
#       2. Woody vegetation
#       3. Cropland 
#       4. Herbaceous land (e.g. grassland)


```